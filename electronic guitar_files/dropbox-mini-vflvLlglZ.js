(function(){var b,a,c;Function.prototype.defer=Function.prototype.defer.wrap(function(e){var d;d=$A(arguments).slice(1);this.__tb__=get_stack_rep();return e.apply(this,d)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(f){var d,g;d=$A(arguments).slice(1);try{return f.apply(this,d)}catch(h){g=h;return assert(0,g.toString())}});b={cache:{},set:function(e,f,d){var g;g=b.cache[e];if(g==null){g=b.cache[e]={}}g.value=f;return g.expires=d?new Date().getTime()+d:0},get:function(d){var e;e=b.cache[d];if((e==null)||new Date().getTime()>e.expires){delete b.cache[d];return false}return e.value}};Function.prototype.cached=function(d){var g,e;e=Math.random();g=this;return function(){var f;f=b.get(e);if(f!==false){return f}f=g();b.set(e,f,d);return f}};Array.prototype.sort_by_key=function(e,g){var d;if(g==null){g=false}d=g?-1:1;return this.sort(function(f,h){f=e(f);h=e(h);if(f<h){return d*-1}else{if(f>h){return d*1}else{return 0}}})};Array.prototype.contains=function(d){return this.indexOf(d)!==-1};Array.prototype.remove=function(e,d){d=d||e+1;return this.splice(e,d-e)};Array.prototype.removeItem=function(e){var d;d=this.indexOf(e);if(d>=0){return this.remove(d)}else{return false}};Array.prototype.dict_by=function(d){var g,h,f,j,e;f={};for(g=j=0,e=this.length;j<e;g=++j){h=this[g];f[this[g][d]]=this[g]}return f};Array.prototype.unique=function(){var h,f,g,e,d;h={};for(g=0,e=this.length;g<e;g++){f=this[g];if(typeof f!=="string"){return this}h[f]=0}d=[];for(f in h){d.push(f)}return d};String.prototype.widthSplit=function(g){var d,f,e,h;if(g==null){g=15}d=[];f=this;h=0;e=f.substring(h,h+g);while(e!==""){d.push(e);h+=g;e=f.substring(h,h+g)}return d};Object.extend(Effect.Transitions,{EaseIn:function(d){return Math.pow(d,2)},EaseOut:function(d){return Math.pow(d,0.5)}});(function(f){var e,d;e=function(k){var h,o,n,l,p,j,i,m,g;if(k){if(Object.isArray(k)){h=[];for(j=0,m=k.length;j<m;j++){o=k[j];h.push(HTML.escape(o).toHTML())}k=new HTML(h.join(""))}else{if(k.top||k.bottom||k.before||k.after){l=["top","bottom","before","after"];for(i=0,g=l.length;i<g;i++){n=l[i];p=k[n];if(p){k[n]=arguments.callee(p)}}}else{if(Util.isElm(k)||k.toElement||k.toHTML){}else{k=HTML.escape(k)}}}}return k};return Element.addMethods({db_observe:function(h,g,i){return h.observe(g,function(j){return i(j,h)})},smoothScrollIntoView:function(j,i){var n,h,g,m,l,k;if(i==null){i={}}n={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};i=Object.extend(n,i);g=j.viewportOffset(j);h=j.getDimensions();k=document.viewport.getDimensions();l=i.padding||0;if(g.top>l&&(g.top+h.height)<(k.height-l)){return}m=g.top<l?-1*Math.floor(k.height/4):-1*Math.floor(3*k.height/4);i.offset=i.offset||m;return new Effect.ScrollTo(j,i)},__sert:function(g,h){return Element.insert(g,e(h))},__date:function(g,h){return Element.update(g,e(h))},replace:d=function(g,h){return f(g,e(h))}})})(Element.replace);a=function(d){if(d!=null?d.target:void 0){try{return document.activeElement=d.target===document?null:d.target}catch(e){}}};c=function(d){try{return document.activeElement=null}catch(e){}};if(document.addEventListener){document.addEventListener("focus",a,true);document.addEventListener("blur",c,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(e,d){var f;if(d==null){d="0"}f=this;while(f.length<e){f=d+f}return f.toString()};String.prototype.reverse=function(){var f,e,d;d=this.split("");e=d.reverse();f=e.join("");return f};String.prototype.count=function(d){return(this.length-this.gsub(d,"").length)/d.length};String.prototype.repeat=function(d){return(new Array(d+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,m,k){var q,p,u,j,f,d,r,n,l,g,e,s,t,o,i,h;if(k==null){k={}}this.orig_req={url:m,options:k};this.start_time=datetime.time();k.method=k.method||"post";k.evalJS=false;k.suppress_nonstandard_headers=true;k.parameters=k.parameters||{};k.parameters.t=Constants.TOKEN;k.parameters.is_xhr=true;if(k.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){k.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){k.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){k.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){k.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&m.indexOf("/")===0){k.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){k.parameters.restrict=Ajax.DBRequest.restrict}p=k.cleanUp||(function(){});this.subject_user=k.subject_user||k.job_user;if(k.job){this.job_id=Util.nonce();k.parameters.job_id=this.job_id;ProgressWatcher.watch(this,k.dont_hide_progress_on_complete)}if(!k.no_watch){RequestWatcher.watch(this,!!k.job)}r=k.onFailure;n=k.onSuccess;d=k.onComplete;f=(function(v){return function(w){var y,x;if(k.parameters.xhr_retry||!k.allow_retries){return false}if((x=w.status)===0||x===500||x===502||x===503){v.orig_req.options.parameters.xhr_retry=true;v.orig_req.options.onFailure=r;v.orig_req.options.onSuccess=n;y=new Ajax.DBRequest(v.orig_req.url,v.orig_req.options);return true}return false}})(this);j=(function(v){return function(x){var w;if(k.noAutonotify||k.no_watch){return}if(x.status!==0&&x.status<400){return}w={url:v.orig_req.url,response_code:x.status,source_type:"web",request_id:x.getHeader("X-Dropbox-Request-Id")};return new Ajax.DBRequest("/web_response_code_log",{noAutonotify:true,no_watch:true,parameters:w})}})(this);k.onFailure=function(w){var y,v,x;if(Job.handled(w.request.job_id)){return}j(w);if(f(w)){return}if(!k.noAutonotify){if(!Constants.IS_PROD&&w.status===500&&w.getHeader("X-Debug-Url")){m=w.getHeader("X-Debug-Url");y=_("There was a problem completing this request.")+(' <a href="'+m+'" target="_blank">View debug</a>');Notify.error(new HTML(y))}else{Notify.error()}}p(false);if(r){r(w)}if(w.status===403){v=Util.session_storage_get("reload-timestamp");if(!v||datetime.time()-v>30*1000){Util.session_storage_set("reload-timestamp",datetime.time());location.reload(true)}}return assert(k.noAutonotify||((x=w.status)===403||x===404||x===502),"Ajax "+w.status+" on "+w.request.url)};k.onComplete=(function(v){return function(w){if(w.responseText.length&&d){if(w.responseText.indexOf("async_task_started:")!==0){return d(w)}}}})(this);k.onSuccess=(function(v){return function(F){var E,w,L,I,G,x,K,z,B,J,y,C,H,D,A;y=datetime.time()-F.request.start_time;if(Job.handled(F.request.job_id)){return}if(!F.responseText.length){if(!k.job){j(F);if(f(F)){return}if(!k.noAutonotify){if(!F||F.status!==0){Notify.error()}}if(r){r(F)}}}else{if(F.responseText.indexOf("err:")===0){if(!k.noAutonotify){x=F.responseText.substr(4);if(k.html_in_error_msg){x=new HTML(x)}Notify.error(x)}if(r){r(F)}}else{if(F.responseText.indexOf("async_task_started:")===0){v.async_task_id=F.responseText.split(":")[1];ProgressWatcher.watch(v)}else{if(n){if(F.responseText.indexOf("ok:")===0){Notify.success(F.responseText.substr(3))}n(F)}}J=F.getHeader("X-Server-Response-Time")||"-1";if(k.log_timing){WebTimingLogger.log_ajax_transition.defer(y,void 0,void 0,void 0,J,m=URLUtil.absolutize(v.url))}E=$j("#cprofile");if(!k.no_watch&&E.length){B=""+Constants.REQUEST_ID+"-"+(F.getHeader("X-Dropbox-Request-Id"));m=F.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");I="Ajax: "+m+" ("+J+"ms)";K="/profile/cprofile?request_id="+B;z=F.request.url;if(z.indexOf(Constants.BLOCK_CLUSTER)!==-1){K+="&block=1"}else{D=Constants.BATCH_THUMB_ENDPOINTS;for(C=0,H=D.length;C<H;C++){L=D[C];if(z.indexOf(L)!==-1){K+="&block=1";break}}}G=$j('<a class="ajax" target="_new" />').attr("href",K).text(I);w=E.find(".ajax");if(w.length>=10){w.last().remove()}E.prepend(G)}if($j("#gandalf_panel").length&&F.request.url.substring(0,14)!=="/gandalf_panel"){if((A=window.gandalf_panel)!=null){A.add(F.request.url,F.getHeader("X-Dropbox-Request-Id"))}}}}return p(true)}})(this);k.onException=function(w,x){var y,v;if(window.console){throw x}y=("Error with AJAX callback for: "+m+" :::: ")+x.toString();v=get_stack_rep();v.pop();return global_report_exception(y,window.location.href,"",v.join("\n"))};if(k.job){m+=(m.indexOf("?")===-1?"?":"&")+"long_running=1"}if(k.subject_user&&!((o=k.parameters)!=null?o[Constants.UID_PARAM_NAME]:void 0)){m=URI.parse(m).updateQuery(Constants.UID_PARAM_NAME,k.subject_user).toString()}q=$H({url:m});if(k.parameters){q.update(k.parameters);i=q.keys();for(g=0,s=i.length;g<s;g++){u=i[g];h=["passwd","password","oauth","ccn","host_id"];for(e=0,t=h.length;e<t;e++){l=h[e];if(u.indexOf(l)!==-1){q.unset(u)}}}q.unset("t")}k.onSuccess.__tb_ajax_info__=k.onFailure.__tb_ajax_info__=Object.toJSON(q);return $super(m,k)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(Util.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())})}).call(this);var __slice=[].slice;if(!window.$j){window.$j=window.jQuery}if(!Function.prototype.bind){Function.prototype.bind=function(a){var e,d,b,c;if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}e=Array.prototype.slice.call(arguments,1);c=this;b=function(){};d=function(){return c.apply((this instanceof b&&a?this:a),e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;d.prototype=new b();return d}}jQuery.fn.curry=function(){var a,c,b;c=arguments[0],b=arguments[1],a=3<=arguments.length?__slice.call(arguments,2):[];if(b==null){b=window}return function(){var d;d=1<=arguments.length?__slice.call(arguments,0):[];return c.apply(b,__slice.call(a).concat(__slice.call(d)))}};jQuery.fn.stripTags=function(a){return a.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.controller=function(a){if(a!=null){return this.data("jscontroller",a)}else{return this.data("jscontroller")}};jQuery.fn.hasScrollBar=function(){return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){return dom.viewport_offset(this)};jQuery.fn.visible=function(){return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(b,a){dom.clone_position(this,b,a);return this};jQuery.format=function(b,a){return b.replace(/\{([^}]+)\}/g,function(d,c){if(c in a){return a[c]}else{return d}})};jQuery.cachedScript=function(b,a){a=$j.extend(a||{},{dataType:"script",cache:true,url:b});return jQuery.ajax(a)};(function(){var b,a,c;b=380;a=function(g,e,f,d){if(typeof g==="function"){return g.call(e[0],f,d)}};c="ontouchstart" in window;return jQuery.fn.tappable=function(d,e){var h,g,f;g={cancelOnMove:true,touchDelay:0,callback:null,touchstartCallback:null};f=false;h=function(i){if(!f){f=true;setTimeout(function(){return f=false},b);return i()}else{}};if(typeof e==="undefined"){e=d;d=null}switch(typeof e){case"function":g.callback=e;break;case"object":$.extend(g,e)}if(c){this.on("touchstart",d,function(k){var j,i;j=jQuery(this);i=j.prop("tappable");a(g.touchstartCallback,j,k);if(!i){i={event:k,attached:0};j.prop("tappable",i)}i.attached++;return window.setTimeout((function(){if(i){return j.addClass("touched")}}),g.touchDelay)});this.on("touchend",d,function(k){var j,i;j=jQuery(this);i=j.prop("tappable");if(i){k=i.event;if(0===--i.attached){j.removeProp("tappable").removeClass("touched")}h(function(){return a(g.callback,j,k,true)});return document.activeElement.blur()}});if(g.cancelOnMove){this.on("touchmove",d,function(){return jQuery(this).removeProp("tappable").removeClass("touched")})}this.on("touchcancel",d,function(i){return jQuery(this).removeProp("tappable").removeClass("touched")})}this.on("click",d,function(i){return h(function(){return a(g.callback,jQuery(this),i,false)})});return this}})();jQuery.browser=Browser;jQuery.addSubjectParam=function(c,a){var b;if(c.subject_user&&!((b=c.data)!=null?b[Constants.UID_PARAM_NAME]:void 0)){return a[Constants.UID_PARAM_NAME]=String(c.subject_user)}};jQuery.ajaxPrefilter(function(a,d,c){var b;if(!d.noDropboxDefaults){b={t:Constants.TOKEN,is_xhr:true};jQuery.addSubjectParam(d,b);if(jQuery.ajaxSettings.restrict!=null){b.restrict=jQuery.ajaxSettings.restrict}a.data=$j.param($j.extend(d.data,b),d.traditional);return false}});jQuery.ajax.retryOnce=function(d,a,b){var c;if(a!=="abort"&&((c=d.status)===0||c===500||c===502||c===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var Multiaccount;Multiaccount={set_logged_out_role:function(a){return this.logged_out_role=a},set_team_name:function(a){return this.team_name=a},show_page_login_modal:function(b){var a;if(!this.logged_out_role){return}a={role:this.logged_out_role};if(typeof b==="string"){a.success_href=b}else{if(typeof b==="function"){a.on_success=b}}MultiaccountLogin.show_modal(a);return false}};var T,Trace,UIButton,URLUtil,Util,Velocity,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Util={get_browse_root:function(a){if(!Viewer.get_viewer().is_paired){return"/home"}else{if(a.role===Constants.ROLE_PERSONAL){return"/personal"}else{return"/work"}}},set_min_body_height_to_viewport_height:function(){var a;a=$(document.body);if(a!=null?a.style:void 0){return a.style.minHeight=dom.viewport_dimensions().height+"px"}},scroll_to_thumb:function(a){var e,d,c,b;d=a.cumulativeOffset().top;e=a.getHeight();b=dom.scroll_offsets().top;c=dom.viewport_dimensions().height;if(d<b||d+e>b+c){return dom.scroll_to(0,d-c/2)}},decode_sort_key:function(c){var e,d,b,a;a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(typeof e==="string"){a.push(base64.decode(e))}else{a.push(e)}}return a},sort_by_rank_or_key:function(a,b){if((a.sort_rank!=null)&&(b.sort_rank!=null)){return a.sort_rank-b.sort_rank}assert((a.sort_key!=null)&&(b.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(a,b)},sort_by_key:function(a,b){return this._sort_by_key(a,b)},_sort_by_key:function(b,g){var d,a,c,f,e;a=b.sort_key;c=g.sort_key;for(d=f=0,e=a.length;0<=e?f<e:f>e;d=0<=e?++f:--f){if(c[d]==null){return 1}if(typeof a[d]!==typeof c[d]){if(typeof a[d]==="string"){return 1}else{return -1}}else{if(a[d]!==c[d]){if(a[d]>c[d]){return 1}else{return -1}}}}if(c.length>a.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(a,e,c,b){var h,f,i,g,d;g=$$(c);d=[];for(f=0,i=g.length;f<i;f++){h=g[f];d.push((function(j){var k;if(a!==j){Sprite.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}k=e?"arrow-up-gray":"arrow-down-gray";return Sprite.src(j.down("img"),"web",k)}})(h))}return d},add_sort_arrow_mouseover_j:function(a,e,c,b){var h,f,i,g,d;g=$j(c);d=[];for(f=0,i=g.length;f<i;f++){h=g[f];d.push((function(j){var k;if(a.attr("data-sort")!==$j(j).attr("data-sort")){Sprite.src($j(j).find("img")[0],"web","downtick-spacer");return $j(j).removeClass("bolded")}else{$j(j).addClass("bolded");if($j(j).hasClass("noarrow")){return}k=e?"arrow-up-gray":"arrow-down-gray";return Sprite.src($j(j).find("img")[0],"web",k)}})(h))}return d},one_line_fit:function(a){var c,b;c=$$(a);if(c.length<2){return}b=(function(d){return function(){var m,j,i,g,l,h,e,f,k;i=c[0];l=c[c.length-1];g=i.cumulativeOffset().top;h=l.cumulativeOffset().top;if(g!==h){m=parseInt(i.getStyle("font-size"),10);e=m-1;if(e<8){return}for(f=0,k=c.length;f<k;f++){j=c[f];j.style.fontSize=e+"px"}return b()}}})(this);return b()},nice_list:function(b){var f,e,d,a,c;if(!b){return""}else{if(b.length===1){return b[0]}else{if(b.length===2){return _("%(x)s and %(y)s").format({x:b[0],y:b[1]})}}}c=_("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);assert(c.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");e=c[0];d=c[1];a=c[2];f=c[3];return[e,b.slice(0,-1).join(d),a,b[b.length-1],f].join("")},list_em_snippet:function(c,b){var g,e,d,f,j,h;d="";b-=new Emstring("...").length;for(e=j=0,h=c.length;0<=h?j<h:j>h;e=0<=h?++j:--j){f=c[e];if(e!==0){f=", "+f}g=new Emstring(f).length;if(g>b){break}b-=g;d+=f}return{str:d,snipped:c.length-e}},start_of_day:function(a){var b;b=new Date();b.setTime(a.getTime());b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return b},to_iso8601_date:function(e,b,c){var a;if(b==null){b=false}if(c==null){c=false}if(b){a=e.getUTCFullYear().toString()+"-"+(e.getUTCMonth()+1).toString().lpad(2)+"-"+e.getUTCDate().toString().lpad(2);if(c){a+=" "+e.getUTCHours().toString().lpad(2)+":"+e.getUTCMinutes().toString().lpad(2)+":"+e.getUTCSeconds().toString().lpad(2)}}else{a=e.getFullYear().toString()+"-"+(e.getMonth()+1).toString().lpad(2)+"-"+e.getDate().toString().lpad(2);if(c){a+=" "+e.getHours().toString().lpad(2)+":"+e.getMinutes().toString().lpad(2)+":"+e.getSeconds().toString().lpad(2)}}return a},to_mysql_date:function(f,a,c){var b,g,e;b=f.getFullYear().toString()+"-"+(f.getMonth()+1).toString().lpad(2)+"-"+f.getDate().toString().lpad(2);e=f.getHours().toString().lpad(2)+":"+f.getMinutes().toString().lpad(2)+":"+f.getSeconds().toString().lpad(2);g="."+f.getMilliseconds().toString().lpad(3);if(!a){return b}if(!c){return b+" "+e}return b+" "+e+g},from_mysql_date:function(b){var d,f,c,h,a,g,e;h=b.split(" ");d=h[0];g=h.length>1?h[1]:false;f=d.split("-");assert(f.length===3,"weird date format on "+this+", expected yyyy-mm-dd");c=new Date(f[0],parseInt(f[1],10)-1,f[2]);if(g){e=g.split(":");assert(e.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");c.setHours(e[0]);c.setMinutes(e[1]);a=e[2].split(".");c.setSeconds(a[0]);if(a.length>1){c.setMilliseconds(a[1])}}return c},make_table:function(a,h){var c,g,i,b,e,d,f;i=new Element("table",h);b=new Element("tbody");i.__sert(b);for(g in a){f=a[g];d=new Element("tr");e=new Element("td").insert(g);c=new Element("td").insert(f);d.__sert(e);d.__sert(c);b.__sert(d)}return i},validate_email:function(a){var b;b=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return b.test(a)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(c){var b,a;a=this.scried;b=a[c];if(!b){b=$(c);a[c]=b}return b},urlquote:function(a){return a.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var b,a;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(b=$("ieconsole"))!=null?b.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(a=console.log)!=null?a.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(d,c){var b;b=this.childElementWithIndex(d,c);return b[0]},childElementWithIndex:function(j,c){var f,h,d,b,g,a;f=0;b=j.childNodes;for(d=g=0,a=b.length;g<a;d=++g){h=b[d];if(h.nodeType===1&&f++===c){return[h,d]}}return[false,false]},disableSelection:function(a){a.onselectstart=function(){return false};a.unselectable="on";a.style.MozUserSelect="none";return a.style.cursor="default"},enableSelection:function(a){a.onselectstart=function(){return true};a.unselectable="off";a.style.MozUserSelect="";return a.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(a,h,f,e){var c,d,b,g;if(!f){f=function(i,j){return i-j}}c=a.length;d=0;while(c>d){b=Math.floor(c/2+d/2);g=f(a[b],h);if(g>0){c=b}else{if(g<0){d=b+1}else{return b}}}if(e){return d}else{return -1}},nonce:function(){var c,a,b;c=new Date();b=c.getTime().toString();a=Math.floor(Math.random()*1000000).toString().lpad(6);return b+a},focus:function(b){if(b){b=$(b);try{return b.focus()}catch(a){}}},sumStyles:function(d,e){var a,c,f,b;c=0;if(d){for(f=0,b=e.length;f<b;f++){a=e[f];c+=parseInt(d.getStyle(a),10)||0}}return c},syncHeight:function(a){var b;if(a==null){a=".sync-height"}$$(a).invoke("setStyle",{height:"auto"});b=$$(a).invoke("getHeight").max();b-=this.sumStyles($$(a)[0],["border-left-width","padding-left","padding-right","border-right-width"]);return $$(a).invoke("setStyle",{height:b>0?""+b+"px":"auto"})},async_load_script:function(b){var a;a=function(){var d,c;c=document.createElement("script");c.src=b;c.type="text/javascript";c.async=true;d=document.getElementsByTagName("script")[0];return d.parentNode.insertBefore(c,d)};if(document.readyState==="complete"){return a()}else{if(window.attachEvent!=null){return window.attachEvent("onload",a)}else{return window.addEventListener("load",a,false)}}},smart_window_load:function(a){if(document.readyState==="complete"){return a.defer()}else{return Event.observe(window,"load",a)}},isNumber:function(a){return !isNaN(Number(a,10))},shorten_url:function(a,b){return new Ajax.DBRequest("/shorten_url",{parameters:{url:a},onSuccess:function(c){return b(c.responseText)}})},falsy_to_empty:function(a){return a||""},preloaded_images:{},preload_image:function(d,c,b){var a;if(this.preloaded_images[d]){return}a=new Image();if(c!=null){Element.extend(a).observe("error",c)}if(b!=null){Element.extend(a).observe("load",b)}a.src=d;return this.preloaded_images[d]=a},get_preloaded_image:function(a){if(this.preloaded_images[a]){return this.preloaded_images[a].clone()}else{return new Element("img",{src:a})}},clear_selected:function(){var a;if(window.getSelection){a=window.getSelection();if(a.removeAllRanges){return a.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(a){var c,b;c=20;b=dom.viewport_dimensions();return a>b.width-c},freshbutton_overlay:function(b,a){var d,c;c=b instanceof jQuery&&b||$j(b);d=a instanceof jQuery&&a||$j(a);c.on("mouseover",(function(e){return function(){return d.addClass("hovered")}})(this));c.on("mouseout",(function(e){return function(){d.removeClass("hovered");return d.removeClass("pressed")}})(this));c.on("mousedown",(function(e){return function(){d.removeClass("hovered");return d.addClass("pressed")}})(this));return c.on("mouseup",(function(e){return function(){return d.removeClass("pressed")}})(this))},isElm:function(a){if(typeof HTMLElement==="object"){return a instanceof HTMLElement}else{return a&&typeof a==="object"&&a.nodeType===1&&typeof a.nodeName==="string"}},_track_twitter_chars_left:function(b,c){var a;clearInterval(this.chars_left_interval);a=(function(d){return function(){var e,f;e=$("twitter-chars");f=c-$F(b).strip().length;if(f<0){e.addClassName("too-long")}else{e.removeClassName("too-long")}return e.__date(f)}})(this);return this.chars_left_interval=setInterval(a,250)},session_storage_set:function(a,b){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(a,JSON.stringify(b))},session_storage_get:function(a){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(a))}},pdf_plugins:function(){var c,b,a;a=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return c=(function(){var g,e,f,d;f=window.navigator.plugins;d=[];for(g=0,e=f.length;g<e;g++){b=f[g];if(a.test(b.name)){d.push(b)}}return d})()},get_window_location:function(){return window.location}};Util.scrollLeft=Util.scrollLeft.cached(50);Util.scrollTop=Util.scrollTop.cached(50);UIButton=(function(){a.prototype.selector=function(){return".ui-button"};a.prototype.over=function(b,c){return c.addClassName("over")};a.prototype.out=function(b,c){return c.removeClassName("over")};a.prototype.down=function(b,c){return c.addClassName("down")};a.prototype.up=function(b){return $$(this.selector()+".down").invoke("removeClassName","down")};function a(){this.clear=__bind(this.clear,this);this.up=__bind(this.up,this);this.listen()}a.prototype.active=function(c,d){var b;b=$j(d);if(b.hasClass("ui-button-dropdown")){if(b.hasClass("active")){$j(document).trigger("dropdownClosed",[1])}else{$j(document).trigger("dropdownOpened",[1])}}return b.toggleClass("active")};a.prototype.clear=function(i){var c,b,h,k,j,g,d,l,f;j=$(i.target);b=this.selector()+".active";g=j.match(b)&&j||j.up(b);h=0;f=$$(b);for(d=0,l=f.length;d<l;d++){k=f[d];c=$j(k);if(g!==k){if(c.hasClass("active")&&c.hasClass("ui-button-dropdown")){h+=1}c.removeClass("active")}}return $j(document).trigger("dropdownClosed",[h])};a.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return a})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var c,e,b,d,a;new UIButton();if(Util.ie8){d=$$("#page-header a, #page-footer a");a=[];for(e=0,b=d.length;e<b;e++){c=d[e];if(c.target==="_blank"){a.push(c.target="")}else{a.push(void 0)}}return a}});event_load.window_load(function(){return Util.syncHeight()});Trace=(function(){var a;a=[];return{log:function(){var b;b=datetime.time()+": "+$A(arguments).join(" ");return a.push(b)},get:function(){return a.join("\n")}}})();T=function(){return Trace.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var a;T("dom:loaded");a=function(){var b,c;b=$("page-content");if(b){c=dom.viewport_dimensions();if(c.width<b.getWidth()){return $(document.body).addClassName("absolutize")}else{return $(document.body).removeClassName("absolutize")}}};Event.observe(window,"resize",a);return a()});Event.observe(window,"load",function(){return T("window:load")});URLUtil={absolutize:function(a){if(a.startsWith("https://")||a.startsWith("http://")){return a}else{if(a.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+a}else{return assert(0,"absolutize is confused by "+a)}}}};Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var a,b;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:dom.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}b=this.scroll_container!=null?this.scroll_container.scrollTop:dom.scroll_offsets().top;a=Math.abs(this.max_delta_y)<Math.abs(b-this.old_y);if(a){this.max_delta_y=b-this.old_y;return this.old_y=b}},start_capture:function(a){this.scroll_container=a;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(a){if(a==null){a=false}assert(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(a){return this.last_nonzero_velocity}return this.velocity}};var DomUtil;DomUtil={fromElm:function(a){return $(a).innerHTML},updateFromElm:function(b,a){b=$(b);a=$(a);return b.update(this.fromElm(a))},fillVal:function(h,e){var b,g,d,f,a,c;f=$$("."+e);c=[];for(g=0,d=f.length;g<d;g++){b=f[g];b=$(b);if(b.tagName==="INPUT"){b.value=h;c.push(b.defaultValue=h)}else{if(b.innerHTML===""&&((a=b.tagName)==="A"||a==="B"||a==="INPUT"||a==="I"||a==="LABEL"||a==="SELECT"||a==="SPAN"||a==="TEXTAREA")){Util.log("Filling an empty value; this may look broken in IE7",b)}c.push(b.innerHTML=h)}}return c},copy_to_clipboard:function(j,g,k){var d,c,a,b,h,f;d=$("hold_clipboard");d.value=j;if(d.createTextRange){f=d.createTextRange();if(f&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return f.execCommand("Copy")}catch(i){h=i;k=k||_("Please copy the text below:");g=g||_("Copy text");this.fillVal(j,"text-to-copy");this.fillVal(k,"copy-modal-body");Modal.show(g,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){a=document.createElement("div");a.id="flashcb";document.body.appendChild(a)}$("flashcb").innerHTML="";c=encodeURIComponent(d.value);b='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=b}}};var VideoUtil,_log_video_experience;VideoUtil={_video_counter:0,embed:function(h,n){var m,c,i,d,a,j,l,b,f,k,e,g;if(n==null){n={}}if(!this.can_embed_type(n.type)){if(n.onError!=null){setTimeout((function(){return n.onError("needflash")}),0)}return document.createElement("div")}if(n.preload===void 0){n.preload="auto"}c="video-"+this._video_counter;this._video_counter+=1;b=$j("<video/>",{"class":"video-js vjs-default-skin vjs-big-play-centered",id:c,controls:n.controls});b=b[0];e=-1;g=["width","height","preload","poster","autoplay"];for(f=0,k=g.length;f<k;f++){d=g[f];if(n[d]){b.setAttribute(d,n[d])}}a=$j("<source/>",{src:n.src,type:n.type});a=a[0];b.appendChild(a);if(typeof h==="string"){h=$j(h)[0]}h.innerHTML="";h.appendChild(b);i=function(){var p,r,o,q;o=this;if(n.onError){if(Constants.new_web_player){o.on("error",n.onError)}else{o.addEvent("error",n.onError)}}if(typeof n.onReady==="function"){n.onReady()}q=function(){if(o.hls!=null){return o.hls.fillBuffer()}};if(Constants.new_web_player){if(Browser){if(Browser.ipad){p=0;$j(document).on("dropdownOpened modalOpened",function(t,s){p+=s;return $j(o.el_).children("video").removeAttr("controls")});$j(document).on("dropdownClosed modalClosed",function(t,s){p-=s;if(p===0){return $j(o.el_).children("video").attr("controls","controls")}})}if(Browser.msie&&Browser.version==="9.0"){o.on("playing",function(){return o.removeClass("vjs-seeking")})}}if(o.techName==="Hls"){o.on("seeked",function(){return o.controlBar.currentTimeDisplay.updateContent()})}o.on("pause",function(){e=setInterval(q,500);if(o.ended()){return o.removeClass("vjs-has-started")}});o.on("play",function(){clearInterval(e);return e=-1});o.on("dispose",function(){return clearInterval(e)});o.on("ended",function(){return o.src({type:n.type,src:n.src})})}if(n.type==="application/vnd.apple.mpegurl"&&Constants.new_web_player){_log_video_experience(o)}r=function(){if(Constants.new_web_player){return o.addClass("show-truncated-bar")}else{return $j("#truncated-video-message-bar").text(l).css("display","inherit")}};if(!n.metadata&&n.metadata_link){return $j.ajax(n.metadata_link,{data:{},type:"GET",noDropboxDefaults:true,xhrFields:{withCredentials:true},success:function(s){if(typeof n.metadata_cb==="function"){n.metadata_cb(s)}if(s.is_truncated){return r.defer()}}})}else{if(n.metadata&&n.metadata.is_truncated){return r.defer()}}};l=_("The clip displayed here is a preview. To view the entire video, download or add it to your Dropbox.");if(Constants.new_web_player){if(Constants.transcoder_hls4web){vjs.Hls.GOAL_BUFFER_LENGTH=120}vjs.TruncatedBar=vjs.Component.extend();vjs.TruncatedBar.prototype.options_={loadEvent:"play",components:{}};vjs.TruncatedBar.prototype.createEl=function(){var o;o=vjs.createEl("div",{className:"truncated-bar",id:"truncated-video-message-bar"});o.textContent=l;return o};vjs.options.children.TruncatedBar={}}m={swf:Constants.static_url_video_js_swf,flashVars:{contentType:n.type,hlsDebugLevel:Constants.hls_debug_level}};if(Constants.new_web_player){j=Constants.transcoder_hls4web?["html5","hls","flash"]:["flash"];return vjs(b,{flash:m,techOrder:j},i)}else{return _V_(b,{flash:m},i)}},can_embed_type:function(b){var a;if((typeof(a=document.createElement("video")).canPlayType==="function"?a.canPlayType(b):void 0)!==""){return true}if(FlashDetect.installed&&FlashDetect.majorAtLeast(10)){return b==="application/vnd.apple.mpegurl"||b==="video/flv"||b==="video/mp4"}return false}};_log_video_experience=function(r){var A,s,H,n,d,C,z,E,k,l,i,o,G,t,y,e,c,a,j,x,b,D,q,h,g,F,m,B,u,w,v,f,p;k=[250,500,1500];n=null;E=null;z=null;e=0;d=-1;H=false;C=null;s=-1;o=[];c=true;j=0;A={};for(b=0,D=k.length;b<D;b++){G=k[b];A[G.toString()]=0}a=null;x=[];i=100;t=function(){var J,M,L,K,I;J={};for(K=0,I=k.length;K<I;K++){G=k[K];L=A[G.toString()];J[G.toString()]=Math.round(L/j*100)||0}M={duration:Math.round(r.duration()*1000),initial_bitrate:k[d]||0,initial_play_wait:C||0,bitrate_percentages:JSON.stringify(J),stalls:e,quality_events:JSON.stringify(o),xhr_errors:JSON.stringify(x),percentage_watched:i};y();return $j.ajax({url:"/video_web_play_log",type:"POST",data:M})};y=function(){var J,I;n=null;E=null;z=null;e=0;d=-1;H=false;C=null;s=-1;o=[];c=true;j=0;A={};for(J=0,I=k.length;J<I;J++){G=k[J];A[G.toString()]=0}a=null;x=[];return i=100};h=function(){f();return t()};w=function(){f();i=Math.round(r.currentTime()/r.duration()*100);if(!isFinite(i)){i=0}return t()};p=function(){if(!c){return}a=Date.now();return c=false};f=function(){var I;if(c){return}I=Date.now()-a;j+=I;A[k[s].toString()]+=I;return c=true};F=function(){if(n===null){z=n=Date.now()}return E=Date.now()};q=function(){var I;if(Constants.new_web_player){I=r.hls.selectPlaylist().attributes.BANDWIDTH/1000;s=k.indexOf(I);d=s}p();if(H){return}C=Date.now()-n;return H=true};g=function(){return f()};u=function(){return E=Date.now()};v=function(){f();if(Date.now()-E>5000){return e+=1}};B=function(J){var I;if(r.paused()){return}f();I=s;s=J.data.level;if(Date.now()-n<1000){d=s}else{o.push([k[I],k[s],Date.now()-z])}z=Date.now();return p()};m=function(){var J,I;if(r.ended()||r.error()||r.paused()){return}f();J=r.hls.selectPlaylist().attributes.BANDWIDTH/1000;s=k.indexOf(J);I=s;if(Date.now()-n<1000){d=s}else{o.push([k[I],k[s],Date.now()-z])}z=Date.now();return p()};if(Constants.new_web_player){r.on("play",F);r.on("pause",g);r.on("canplay",q);r.on("waiting",v);r.on("seeking",u);r.on("ended",h);r.on("shutdown",w);r.on("mediachange",m);if(r.techName==="Hls"){l=videojs.Hls.xhr;return videojs.Hls.xhr=function(I,J){var K;K=function(M,L){var N;if(M){N="";if(this.responseType===""||this.responseType==="text"){N=this.responseText}x.push([this.status.toString(),N,L])}return J.call(this,M,L)};return l.call(this,I,K)}}}else{r.addEvent("play",F);r.addEvent("pause",g);r.addEvent("canplay",q);r.addEvent("waiting",v);r.addEvent("seeking",u);r.addEvent("qualityswitch",B);return r.addEvent("ended",h)}};var RequestWatcher;RequestWatcher={reqs:[],working_msg:_("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(b,c){var a;a=this.reqs;if(!a.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(c){b.skip_message=true}return a.push([b,datetime.time()])},check_up:function(){return this.scan(false)},remove:function(a){return this.scan(a)},scan:function(f){var j,b,d,a,h,g,c,i,e;b=datetime.time();d=[];e=this.reqs;for(c=0,i=e.length;c<i;c++){a=e[c];h=a[0];g=a[1];j=b-g;if(h.transport.readyState===4){this.clearWorkingMessage();continue}if(j>4000&&!h.skip_message){h.skip_message=true;if(Notify.isShown()&&Notify.current()===!UndoAction.undo_notification){this.last_notification=Notify.success(this.working_msg)}}if(j>this.TIMEOUT*1000&&h.job){h.transport.abort()}if(h!==f){d.push([h,g])}else{h.transport.abort()}}this.reqs=d;if(!d.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(Notify.isShown()&&Notify.current()===this.last_notification){return Notify.clear()}}};$j(function(){var c,b,d,a;d=Prototype.Browser;a=[];for(c in d){b=d[c];if(b===true){a.push($j(document.body).addClass(c.toLowerCase()))}}return a});var HTML5_HISTORY,HashRouter,__slice=[].slice;HTML5_HISTORY=Modernizr.history;$j((function(a){return function(){return DBHistory.init()}})(this));HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(a){return window.location.href=a},_replace_location:function(a){return window.location.replace(a)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(a,b){this.callback_map[a]=b;if(!this.watch_timer){return this.init()}},check_hash:function(){var b,c,d,f,e,a;f=this._get_location().split("#")[1];if(f!=null){f=f.replace(/%27/g,"'")}if(this.last_hash===f){return}this.last_hash=f;if(this.last_prefix&&f===""){f=this.last_prefix+":"}else{if(!f){return}}a=f.split(":");e=a.first();this.last_prefix=e;d=this.callback_map[e];if(d!=null){c=(function(){var j,h,i,g;i=a.slice(1);g=[];for(j=0,h=i.length;j<h;j++){b=i[j];g.push(decodeURIComponent(b))}return g})();d.apply(null,c)}return $(document).fire("db:hash_change",{hash:f})},_prepare_hash:function(c){var b,a;a=$A(c).map(Util.falsy_to_empty);b=a.map(encodeURIComponent);return b.join(":")},set_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b)},replace_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b,true)},_set_hash:function(b,a){if(b===""){b="/"}this.last_hash=b;if(!a){return this._set_location("#"+b)}else{return this._replace_location("#"+b)}}};var MultiaccountLogin;MultiaccountLogin={$element:function(){return $j("#login-modal")},set_during_login_callback:function(a){assert(!this._during_login_callback,"already have a during_login_callback");return this._during_login_callback=a},show_modal:function(d){var b,a,f,e,c;if(d==null){d={}}b=$j.isFunction(this.$element)?this.$element():this.$element;assert(b!=null?b.length:void 0,"MultiaccountLogin needs its @$element to be set");assert(!((d.on_success!=null)&&(d.success_href!=null)),"on_success and success_href are mutually exclusive");if(d.user!=null){c=Viewer.get_viewer().get_user_by_id(String(d.user),true)}else{if(d.user_id!=null){c=Viewer.get_viewer().get_user_by_id(d.user_id,true)}else{if(d.role!=null){c=Viewer.get_viewer().get_user_by_role(d.role,true)}}}assert(c!=null,"invalid user");f=c.role;assert(!Viewer.get_viewer().is_user_signed_in(c),"called MultiaccountLogin for a user that's already signed in");if(f==="personal"){e=_("Sign in to your personal Dropbox")}else{e=_("Sign in to your %(team_name)s Dropbox").format({team_name:Viewer.get_viewer().team_name})}b.find("form").controller().reset();b.find("form").controller().set_input_value("login_email",c.email);a=(function(g){return function(){var h;$j("#modal form")[0].ajax_submitted=true;Viewer.get_viewer()._sign_in_all_users();Multiaccount.set_logged_out_role(null);h=function(j){var m,l,i,k;k=$j("#modal form");for(l=0,i=k.length;l<i;l++){m=k[l];m.ajax_submitted=false}if(j!=null){Notify.error(j);Viewer.get_viewer()._sign_out_user_by_id(c.id);Multiaccount.set_logged_out_role(c.role);Modal.hide();return}if(d.success_href!=null){if(window.location.href!==d.success_href){return window.location.href=d.success_href}else{return window.location.reload()}}else{Modal.hide();return typeof d.on_success==="function"?d.on_success():void 0}};if((g._during_login_callback!=null)&&(d.success_href==null)){g._during_login_callback(c,h)}else{h()}return false}})(this);$j(document).off(LoginForm.MULTI_LOGIN_SUCCESS);$j(document).on(LoginForm.MULTI_LOGIN_SUCCESS,a);Modal.show(e,b[0],false,false,416,false,"switch-login-modal",true,true);return b.find('input[name="login_password"]').focus()}};var SF_VIEWS;SF_VIEWS={CURRENT:"current",PAST:"past"};var SharingState;SharingState=(function(){function a(){}a.set_role=function(b){$j(".shared-folder-role-param").val(b);return this.role=b};a.set_is_merged=function(b){return this.is_merged=b};a.set_team_name=function(b){return this.team_name=b};a.set_team_permissions=function(c,b){if(c==null){c=false}if(b==null){b=false}this.team_only=c;return this.show_groups=b};a.set_not_logged_in_role_and_email=function(c,b){this.not_logged_in_role=c;return this.not_logged_in_email=b};a.set_show_inbox=function(b){return this.show_inbox=b};return a})();var SharingUtil;SharingUtil=(function(){function a(){}a.success_string_for_recipients=function(b){var c;if(b.length===1){if(b[0].indexOf("@")===-1){c=_("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:b[0]})}else{c=_("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:b[0]})}}else{if(b.length===2){if(b[0].indexOf("@")===-1){if(b[1].indexOf("@")===-1){c=_("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:b[0],recipient_second:b[1]})}else{c=_("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:b[0],recipient_second:b[1]})}}else{if(b[1].indexOf("@")===-1){c=_("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:b[0],recipient_second:b[1]})}else{c=_("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:b[0],recipient_second:b[1]})}}}else{if(b[0].indexOf("@")===-1){c=_("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:b[0],num_others:b.length-1})}else{c=_("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:b[0],num_others:b.length-1})}}}return c};return a})();var SharingApi,UserlessSharingApi;SharingApi=(function(){function a(b){this.user=b}a.prototype.invite_more_to_folder=function(c,b,e,g,d,f){var h;h={ns_id:c,emails:b.emails||[],fb_ids:b.fb_ids||[],group_ids:b.group_ids||[],new_style_group_ids:b.new_style_group_ids||[],custom_message:e||"",access_type:g};return this._make_request("/share_ajax/invite_more",h,d,f,true)};a.prototype.update_member_access_type=function(b,g,e,c,d){var f;f={ns_id:b,member_uid:g,access_type:e};return this._make_request("/share_ajax/update_member_access_type",f,c,d)};a.prototype.update_group_access_type=function(c,f,b,d,e){var g;g={ns_id:c,group_gid:f,can_edit:b};return this._make_request("/share_ajax/update_group_access_type",g,d,e)};a.prototype.update_invite_access_type=function(f,d,b,c){var e;e={invite_id:f,access_type:d};return this._make_request("/share_ajax/update_invite_access_type",e,b,c)};a.prototype.share_folder=function(j,e,d,i,h,c,k,b,l,f){var g,m;g={emails:d.emails||[],fb_ids:d.fb_ids||[],group_ids:d.group_ids||[],new_style_group_ids:d.new_style_group_ids||[],custom_message:i||"",audience:h,inviter:c,shared_link_policy:k,access_type:b,folder_settings:1};if(j){g.folder_name=e;m="/share_ajax/new"}else{g.path=e;m="/share_ajax/existing"}if(h||c){g.custom_folder_settings=1}return this._make_request(m,g,l,f,true)};a.prototype.unshare_folder=function(c,b,d){var e;e={ns_id:c,async:true};if(b){e.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",e,d)};a.prototype.leave_folder=function(c,b,d){var e;e={ns_id:c};if(b){e.keep_files=true}return this._make_request("/share_ajax/leave?long_running",e,d)};a.prototype.transfer_ownership=function(b,d,c){var e;e={ns_id:b,user_id:d};return this._make_request("/share_ajax/change_sf_owner",e,c)};a.prototype.cancel_invite=function(b,e,c){var d;d={ns_id:b,invite_id:e};return this._make_request("/share_ajax/cancel_invite",d,c)};a.prototype.kick=function(c,e,b,d){var f;f={ns_id:c,user_id:e};if(b){f.keep_files=true}return this._make_request("/share_ajax/kick_user",f,d)};a.prototype.kick_group=function(b,d,c){return Notify.error("This feature has been removed.")};a.prototype.reinvite_user=function(b,e,c){var d;d={ns_id:b,invite_id:e};return this._make_request("/share_ajax/reinvite_user",d,c)};a.prototype.update_sf_permissions=function(b,e,c,d){var f;f={ns_id:b,new_permissions:e};return this._make_request("/share_ajax/change_sf_perm",f,c,d)};a.prototype.update_sf_team_permissions=function(b,e,f,d,h,c){var g;g={ns_id:b,audience:e,inviter:f,shared_link_policy:d};if(!(h===void 0)){g.activity_feed_enabled=h}return this._make_request("/share_ajax/save_folder_settings",g,c)};a.prototype.validate_new_sf_path=function(e,b,c){var d;d={share_type:"new",folder_name:e};return this._make_request("/share_ajax/validate_folder",d,b,c,true)};a.prototype.validate_existing_sf_path=function(e,b,c){var d;d={share_type:"existing",path:e};return this._make_request("/share_ajax/validate_folder",d,b,c,true)};a.prototype._make_request=function(c,g,b,d,f){var e;if(f==null){f=false}g[Constants.UID_PARAM_NAME]=this.user.id;if((e=this.loading_elem)!=null){e.addClass("ajax-loading")}return new Ajax.DBRequest(c,{parameters:g,onSuccess:b,onFailure:d,onComplete:(function(h){return function(){var i;return(i=h.loading_elem)!=null?i.removeClass("ajax-loading"):void 0}})(this),noAutonotify:f})};return a})();UserlessSharingApi=(function(){function a(){}a.prototype.get_inbox_counts=function(b){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(c){return function(e){var d;d=JSON.parse(e.responseText);assert(typeof d==="object","bad inbox_count");return b(d)}})(this)})};a.prototype.get_folder_info=function(b,c){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:b,onFailure:c})};return a})();var SharingForms;SharingForms=(function(){function a(){}a.submit_share_new=function(c){var b;b=$$(".invite-more-form")[0];assert(b,"Couldn't find the invite more form.");Forms.ui_form_submit(b,"/share_ajax/new");return Forms.add_loading(c)};a.submit_share_existing=function(c){var b;b=$$(".invite-more-form")[0];assert(b,"Couldn't find the invite more form.");Forms.ui_form_submit(b,"/share_ajax/existing?long_running");return Forms.add_loading(c)};a.submit_invite_more=function(c){var b;b=$$(".invite-more-form")[0];assert(b.down("input[name=ns_id]"),"Submit invite more wizard is missing ns_id");Forms.ui_form_submit(b,"/share_ajax/invite_more");return Forms.add_loading(c)};return a})();var SharingModals;SharingModals=(function(){function a(){}a.show_shared_folder_options_modal=function(c,b){return DBModalStack.push(new ExistingSharedFolderOptionsModal(b,c))};a.show_shared_folder_wizard=function(b){return new ShareAFolderWizardModal(b,{element_id:"share-a-folder-wizard-modal"}).show()};a.get_select_role_modal=function(){return new SharedFolderSelectRoleModal({element_id:"select-role-modal"})};a.start_wizard_without_user=function(){if(Viewer.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=a.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(Viewer.get_viewer().get_users()[0])}};a.start_wizard_for_user=function(b){if(EmailVerification.get_for_user(b).verified()){return a.show_shared_folder_wizard(b)}};a.show_share_existing_modal=function(d,b){var c;if(EmailVerification.get_for_user(b).verified()){c=new InviteToNewSharedFolderWizardModal(b,{folder_name:d,element_id:"invite-to-new-sf-wizard-modal-"+b.id});return c.show()}};a.show_shmodel_or_invite_modal=function(c,e,b,d){if(EmailVerification.get_for_user(b).verified()){return new CreateLinkOrInviteToFolderWizardModal(b,{path:c,existing_sf:e,element_id:"create-link-or-invite-wizard-modal",target_item:d}).show()}};a.show_unshare_team_sf_modal=function(c,b,e){var d;d=new UnshareFolderModal(c,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:b,folder_path:e});return d.show()};a.show_ignore_modal=function(c,f,b){var e,d,g;assert(b,"Share ignore did not get an ns_id");g=_("Permanently remove '%(folder_name)s'").format({folder_name:Emstring.em_snippet(FilePath.filename(f),15)});e={path:f,ns_id:b};d=new DBUserModal(c,{element_id:"ignore-confirm",title:g});d.on_confirm_button_click=function(j){var i,h,k;j.preventDefault();i=$j(j.target);h=i.closest("form");k=function(l){Notify.success(_("Removed shared folder successfully."));document.fire(FileEvents.SF_IGNORE,{target_ns_id:b,user_id:c.id});return d.hide()};return Forms.ajax_submit(h[0],false,k,void 0,i[0],e)};return d.show()};a.show_rejoin_modal=function(c,f,b){var e,d,g;assert(b,"Rejoin didn't get an ns_id");g=_("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:Emstring.em_snippet(FilePath.filename(f),13)});e={path:f,ns_id:b};d=new DBUserModal(c,{element_id:"rejoin-confirm",title:g});d.on_confirm_button_click=function(j){var i,h,k;j.preventDefault();i=$j(j.target);h=i.closest("form");k=function(n){var l,m;m=n.responseText;l=FilePath.filename(m);Notify.success(_("Rejoined shared folder successfully."));document.fire(FileEvents.SF_REJOIN,{target_ns_id:b,user_id:c.id,filename:l,mount_point:m});return d.hide()};return Forms.ajax_submit(h[0],false,k,void 0,i[0],e)};return d.show()};a.show_invites=function(){return DBModalStack.push(new DBModalLoading({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};a.show_shared_subfolder_modal=function(c,e){var h,f,g,b,d;g=Emstring.em_snippet(FilePath.filename(c),14);f=_("Can't share folder");b="'%(parent_shared_folder)s' ".format({parent_shared_folder:g});DomUtil.fillVal(b.escapeHTML(),"parent_shared_folder_name");h=_("Share '%(parent_shared_folder)s' folder");d=h.format({parent_shared_folder:g});($("share_parent_folder_button")).value=d;Modal.show(_("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'>\n<img src='/static/images/icons/ajax-loading-small.gif' alt=''/></p>");$j("#share_parent_folder_button").on("click",(function(i){return function(j){Modal.hide();return i.show_shared_folder_options_modal(c,e)}})(this));return Modal.show(f,$("share_subfolder"))};return a})();var InviteFormController;InviteFormController=(function(){function a(d,c,b,i,h,g){var f,e;this.user=d;this.$form=c;this.members=b;this.invitees=i;this.new_style_groups=h;this.team_only=this.$form.data("team-only");e={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){f=Autocompleter.TeamTokenizer;e.team_only=this.team_only}else{f=Autocompleter.ContactsTokenizer;e.include_team=true}if(this.user.role==="work"&&(typeof GroupsApi!=="undefined"&&GroupsApi!==null)){e.include_new_style_groups=true}this.sharing_options_auto_completer=new f(this.user,g+"-new-collab-input",g+"-new-whobulk",g+"-hidden-input",e);SickInput._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new TeamSharedFolderInviteController(this.$form)}}a.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};a.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};a.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};a.prototype.reset_options=function(){return $j(this.sharing_options_auto_completer.get_entry_container()).hide()};a.prototype.set_team_only=function(b){this.team_only=b;return this.sharing_options_auto_completer.setTeamOnly(b)};a.prototype.extract_invitees=function(){var e,d,c,h,g,b,f;h={};f=["emails","fb_ids","group_ids","new_style_group_ids"];for(g=0,b=f.length;g<b;g++){d=f[g];c=this.$form.find("input[name="+d+"]");h[d]=[(function(){var k,j,i;i=[];for(k=0,j=c.length;k<j;k++){e=c[k];i.push($j(e).val())}return i})()]}return h};a.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};a.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return a})();var ExistingSharedFolderOptionsContent,ExistingSharedFolderOptionsModal,ExistingSharedFolderPermissionsContent,ExistingSharedFolderPermissionsModal,KickGroupModal,KickUserModal,LeaveFolderModal,MakeOwnerModal,SharedFolderBaseModal,TransferOwnershipModal,UninviteModal,UnshareFolderModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};SharedFolderBaseModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;a.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new SharingApi(this.user)}a.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return a})(DBModal);ExistingSharedFolderOptionsModal=(function(b){__extends(a,b);function a(c,d){var f,e;this.user=c;this.__show_modal=__bind(this.__show_modal,this);this.__x_click_handler=__bind(this.__x_click_handler,this);assert(d!=null,"Missing folder path");this.path=FilePath.normalize(d);e=_("Shared folder options for '%(folder)s'");e=e.format({folder:Emstring.em_snippet(FilePath.filename(d),13)});f={};f[Constants.UID_PARAM_NAME]=this.user.id;a.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:e,endpoint_url:URI({path:"/share_options"+this.path}).toString(),parameters:f})}a.prototype.__x_click_handler=function(d){var c;a.__super__.__x_click_handler.apply(this,arguments);c={path:this.path};return analytics.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,c)};a.prototype.__show_modal=function(d){var c;a.__super__.__show_modal.apply(this,arguments);c={path:this.path};return analytics.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,c)};return a})(DBModalLoading);ExistingSharedFolderOptionsContent=(function(){function a(e,c,d,b){this.$root=e;this.options=b;this.show_email_verification=__bind(this.show_email_verification,this);this.show_folder_settings=__bind(this.show_folder_settings,this);this.toggle_from_invite_mode=__bind(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=__bind(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=__bind(this.show_leave_folder_modal,this);this.show_unshare_folder_modal=__bind(this.show_unshare_folder_modal,this);this.show_uninvite_modal=__bind(this.show_uninvite_modal,this);this.show_transfer_user_modal=__bind(this.show_transfer_user_modal,this);this.show_kick_group_modal=__bind(this.show_kick_group_modal,this);this.show_kick_user_modal=__bind(this.show_kick_user_modal,this);this.update_tf_access=__bind(this.update_tf_access,this);this.update_sf_perms=__bind(this.update_sf_perms,this);this.reinvite_user=__bind(this.reinvite_user,this);this.submit_invitations=__bind(this.submit_invitations,this);this.extract_user_data_and_call=__bind(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=__bind(this.extract_invitee_data_and_call,this);this.user=Viewer.get_viewer().get_user_by_id(c);this.path=FilePath.normalize(d);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups}this.$root.find(".bubble-dropdown").click(function(f){dom.controller($j(f.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.sharing_api=new SharingApi(this.user);this.sharing_api.loading_elem=this.$root;BrowseStyleRows.register_all();SuggestionInput.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen()}a.prototype.listen=function(){var e,d,c,g,b,f;this.$root.find(".confirm-button").click((function(h){return function(i){i.preventDefault();return h.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(h){return function(i){i.preventDefault();return h.toggle_from_invite_mode()}})(this));e=this.$root.find("#sharing-options-new-collab-input");f=["focus","keypress","contextmenu"];for(g=0,b=f.length;g<b;g++){c=f[g];e.off(c);e.on(c,this.toggle_to_invite_mode)}d=this.$root.find("#custom-message-wizard");d.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new InviteFormController(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}this.$root.on("click","a.kick-user",(function(h){return function(i){return h.extract_user_data_and_call(i,h.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(h){return function(k){var i,j,l;k.preventDefault();i=$j(k.currentTarget);l=i.data("group-name");j=i.data("group-gid");return h.show_kick_group_modal(l,j)}})(this));this.$root.on("click","a.make-owner",(function(h){return function(i){return h.extract_user_data_and_call(i,h.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(h){return function(j){var i,k;j.preventDefault();i=$j(j.currentTarget);k=i.data("email");return window.location=URI({scheme:"mailto",path:k}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(h){return function(i){return h.extract_invitee_data_and_call(i,h.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(h){return function(i){return h.extract_invitee_data_and_call(i,h.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(h){return function(i){i.preventDefault();analytics.SharedFolderActivityLogger.log("web","invite_modal_leave_button",h.user,h.log_extras);return h.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(h){return function(i){i.preventDefault();analytics.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",h.user,h.log_extras);return h.show_unshare_folder_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(h){return function(i){i.preventDefault();analytics.SharedFolderActivityLogger.log("web","invite_modal_done_button",h.user,h.log_extras);return DBModalStack.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(h){return function(j){var i;i=$j(j.currentTarget);return h.update_sf_perms(i.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(h){return function(j){var i;i=$j(j.currentTarget);return h.update_tf_access(!i.prop("checked"))}})(this))};a.prototype.extract_invitee_data_and_call=function(f,d){var b,g,c;f.preventDefault();b=$j(f.currentTarget);c=b.data("email-or-fbname");g=b.data("invite-id");return d(c,this.ns_id,g)};a.prototype.extract_user_data_and_call=function(h,g){var c,f,d,b;h.preventDefault();c=$j(h.currentTarget);d=c.data("display-name");f=c.data("email");b=c.data("user-id");return g(d,f,b)};a.prototype.submit_invitations=function(){var e,d,g,c,f,b;this.invite_form_controller.tokenize();g=this.invite_form_controller.extract_invitees();f=this.invite_form_controller.get_custom_message();e=this.invite_form_controller.get_access_type();c=$u.clone(this.log_extras);c.access_type=e;analytics.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,c);b=(function(h){return function(j){var i;i=DBModal.get_containing_modal(h.$root);if(i&&i instanceof DBModalLoading){i.fetch()}else{DBModalStack.pop()}Notify.success(j.responseText);return document.fire(FileEvents.SF_INVITE,{target_ns_id:h.ns_id,user_id:h.user.id})}})(this);d=(function(h){return function(i){return InlineModalValidationError.show_validation_error(i,h.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,g,f,e,b,d)};a.prototype.reinvite_user=function(d,b,c){return this.sharing_api.reinvite_user(b,c,(function(e){return function(l){var i,j,k,h,f,g;h=JSON.parse(l.responseText);f=h.status;if(f==="OK"){g=_("%(email_or_fbname)s was reinvited successfully");g=g.format({email_or_fbname:d});return Notify.success(g)}else{k=h.reason;if(k==="ACCEPTED"){i=_("That invitation has already been accepted.")}else{if(k==="DECLINED"){i=_("That invitation has already been declined.")}else{i=_("You no longer have permission to perform this action.")}}Notify.error(i);if(h.reload){j=DBModal.get_containing_modal(e.$root);if(j&&j instanceof DBModalLoading){return j.fetch()}}}}})(this))};a.prototype.update_sf_perms=function(c){var d,e,b;this.$root.find("#change-sf-perm-saving").show();d=(c?1:0);b=(function(f){return function(g){if(c){Notify.success(_("Editors can now manage membership of this folder."))}else{Notify.success(_("Editors can no longer manage membership of this folder."))}return f.$root.find("#change-sf-perm-saving").hide()}})(this);e=(function(f){return function(g){if(g.responseText.indexOf("err:")===0){Notify.error(g.responseText.substr(4))}else{Notify.error(_("Error updating your preference! Please try again."))}return f.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,d,b,e)};a.prototype.update_tf_access=function(c){var d,b;b=(function(e){return function(f){if(c){return Notify.success(_("Team members can now change folder contents."))}else{return Notify.success(_("Team members can no longer change folder contents."))}}})(this);d=(function(e){return function(f){return Notify.error(_("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_group_access_type(this.ns_id,this.$root.data("group-gid"),c,b,d)};a.prototype.show_kick_user_modal=function(d,c,b){return DBModalStack.push(new KickUserModal(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:d,folder_path:this.path,user_id:b}))};a.prototype.show_kick_group_modal=function(b,c){return DBModalStack.push(new KickGroupModal(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:b,folder_path:this.path,group_id:c}))};a.prototype.show_transfer_user_modal=function(d,c,b){return DBModalStack.push(new TransferOwnershipModal(this.user,{element_id:"transfer-confirm-modal",user_id:b,user_name:d,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.show_uninvite_modal=function(d,b,c){return DBModalStack.push(new UninviteModal(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:d,ns_id:b,invite_id:c,folder_path:this.path}))};a.prototype.show_unshare_folder_modal=function(){return DBModalStack.push(new UnshareFolderModal(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.show_leave_folder_modal=function(){return DBModalStack.push(new LeaveFolderModal(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.toggle_to_invite_mode=function(){var b;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");return(b=this.sf_access_type)!=null?b.show():void 0};a.prototype.toggle_from_invite_mode=function(){var c,b;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((c=this.sf_access_type)!=null){c.hide()}return(b=this.invite_form_controller)!=null?b.reset_autocompleter():void 0};a.prototype.show_folder_settings=function(b){analytics.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);b.preventDefault();DBModalStack.register(ExistingSharedFolderPermissionsModal.SAVED_PERMISSIONS,(function(c){return function(f,d){if(d!=null){return c.set_team_only(d)}}})(this));return DBModalStack.push(new ExistingSharedFolderPermissionsModal(this.user,this.path,this.ns_id))};a.prototype.show_email_verification=function(b){DBModalStack.pop();return EmailVerification.get_for_user(this.user).show()};a.prototype.set_team_only=function(b){var c;this.invite_form_controller.set_team_only(b);c=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(b){return c.addClass("team-only")}else{return c.removeClass("team-only")}};return a})();LeaveFolderModal=(function(a){__extends(b,a);function b(){this.before_show=__bind(this.before_show,this);this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(d){var c;d.preventDefault();c=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,c,(function(e){return function(){var f;f=_("You removed yourself from '%(msg)s'.").format({msg:Emstring.em_snippet(FilePath.filename(e.path),25)});Notify.success(f);document.fire(FileEvents.SF_LEAVE,{target_ns_id:e.ns_id,folder_deleted:!c,user_id:e.user.id});return DBModalStack.clear()}})(this))};b.prototype.on_show=function(){b.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};b.prototype.before_show=function(){var c;c=_("Leave the shared folder '%(folder_name)s'");c=c.format({folder_name:Emstring.em_snippet(FilePath.filename(this.path),14)});return this.format({".db-modal-title-text":c})};return b})(SharedFolderBaseModal);UnshareFolderModal=(function(b){__extends(a,b);function a(){this.before_show=__bind(this.before_show,this);this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(d){var c;d.preventDefault();c=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,c,(function(e){return function(){var f;f=_("Unshared folder '%(folder_name)s'");f=f.format({folder_name:Emstring.em_snippet(FilePath.filename(e.path),25)});Notify.success(f);document.fire(FileEvents.SF_UNSHARE,{target_ns_id:e.ns_id,user_id:e.user.id});return DBModalStack.clear()}})(this))};a.prototype.on_show=function(){a.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};a.prototype.before_show=function(){var c;c=_("Unshare '%(folder_name)s'");c=c.format({folder_name:Emstring.em_snippet(FilePath.filename(this.path),21)});return this.format({".db-modal-title-text":c})};return a})(SharedFolderBaseModal);UninviteModal=(function(b){__extends(a,b);function a(c,d){this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.email_or_fbname=d.email_or_fbname;this.ns_id=d.ns_id;this.invite_id=d.invite_id;a.__super__.constructor.call(this,c,d)}a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(d){return function(j){var h,i,g,e,f;g=JSON.parse(j.responseText);e=g.status;if(e==="OK"){f=_("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:d.email_or_fbname});Notify.success(f)}else{i=g.reason;if(i==="ACCEPTED"){h=_("That invitation has already been accepted.")}else{if(i==="DECLINED"){h=_("That invitation has already been declined.")}}Notify.error(h)}return DBModalStack.pop()}})(this))};a.prototype.before_show=function(c){var d;d=_("Uninvite %(email_or_fbname)s?").format({email_or_fbname:Emstring.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":FilePath.filename(this.path),".db-modal-title-text":d})};return a})(SharedFolderBaseModal);KickUserModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.user_id=d.user_id;this.user_name=d.user_name;b.__super__.constructor.call(this,c,d)}b.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();c=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,c,(function(e){return function(){Notify.success(_("User removed successfully."));Sharing.reload_folder_info_if_two_account();return DBModalStack.pop()}})(this));d={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:c};return analytics.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,d)};b.prototype.before_show=function(c){var d;d=_("Remove %(person_name)s from this folder?");d=d.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":d})};return b})(SharedFolderBaseModal);KickGroupModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.group_id=d.group_id;this.group_name=d.group_name;b.__super__.constructor.call(this,c,d)}b.prototype.on_confirm_button_click=function(c){c.preventDefault();return GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(d){return function(){Notify.success(_("Group removed successfully."));Sharing.reload_folder_info_if_two_account();return DBModalStack.pop()}})(this))};b.prototype.before_show=function(){var c;c=_("Remove %(group_name)s from this folder?");c=c.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":c})};return b})(SharedFolderBaseModal);MakeOwnerModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.member_uid=d.member_uid;this.member_name=d.member_name;this.ns_id=d.ns_id;this.access_type=d.access_type;a.__super__.constructor.call(this,c,d)}a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(d){return function(){Notify.success(_("%(name)s now is the owner.").format({name:d.member_name}));return DBModalStack.pop()}})(this))};a.prototype.before_show=function(){var c;c=_("Make %(name)s the owner of this folder?");c=c.format({name:Emstring.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":c})};return a})(SharedFolderBaseModal);TransferOwnershipModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.user_id=d.user_id;this.user_name=d.user_name;a.__super__.constructor.call(this,c,d)}a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(d){return function(f){Notify.success(_("Ownership changed successfully"));return DBModalStack.pop()}})(this))};a.prototype.before_show=function(){var c;c=_("Make %(person_name)s the owner of this folder?");c=c.format({person_name:Emstring.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":c})};return a})(SharedFolderBaseModal);ExistingSharedFolderPermissionsModal=(function(b){__extends(a,b);a.SAVED_PERMISSIONS="existing_sf_permissions:saved";function a(d,e,c){var g,f;this.user=d;this.path=e;this.ns_id=c;g={ns_id:this.ns_id,folder_name:this.path};g[Constants.UID_PARAM_NAME]=this.user.id;f=_("'%(folder_name)s' settings");f=f.format({folder_name:Emstring.em_snippet(FilePath.filename(this.path),13)});a.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:f,endpoint_url:"/share_ajax/folder_settings",parameters:g})}return a})(DBModalLoading);ExistingSharedFolderPermissionsContent=(function(){function a(c,d,b){this.$form=c;this.ns_id=b;this._submit=__bind(this._submit,this);this.user=Viewer.get_viewer().get_user_by_id(d);this.sharing_api=new SharingApi(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}a.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};a.prototype._cancel=function(){return DBModalStack.pop()};a.prototype._submit=function(h){var i,b,f,d,c,g;h.preventDefault();b=this.$form.find("input[name=audience]:checked").val();f=this.$form.find("input[name=inviter]:checked").val();c=this.$form.find("input[name=shared_link_policy]:checked").val();i=(g=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?g.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,b,f,c,i,(function(e){return function(k){var j,l;j=JSON.parse(k.responseText);l=j.team_only_invite;Notify.success(j.message);DBModalStack.trigger(ExistingSharedFolderPermissionsModal.SAVED_PERMISSIONS,l);return DBModalStack.pop()}})(this));false;d={ns_id:this.ns_id,audience:b,inviter:f};return analytics.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,d)};return a})();var BaseShareAFolderWizardModal,CreateLinkOrInviteToFolderWizardModal,InlineModalValidationError,InviteToNewSharedFolderWizardModal,NewSharedFolderPermissionsContent,ShareAFolderWizardModal,ShareExistingFolderWizardModal,ShareNewFolderWizardModal,TeamSharedFolderWizardModalPage1,TeamSharedFolderWizardModalPage2,TeamSharedFolderWizardModalPage3,TeamSharedFolderWizardModalPage4,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};BaseShareAFolderWizardModal=(function(a){__extends(b,a);b.prototype.base_title=null;b.prototype.personal_title=null;b.prototype.work_title=null;function b(c,d){this.user=c;this.option=d;b.__super__.constructor.call(this,this.options);this.sharing_api=new SharingApi(this.user)}b.prototype.before_show=function(){var c;this.sharing_api.loading_elem=this.$modal_window;c=this.base_title;if(Viewer.get_viewer().is_paired){if(this.user.role==="personal"){c=this.personal_title}else{c=this.work_title.format({team_name:Viewer.get_viewer().team_name})}}return this.format({".db-modal-title-text":c})};return b})(DBModal);ShareAFolderWizardModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;b.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Share a folder");this.personal_title=_("Share a folder from your personal Dropbox");this.work_title=_("Share a folder from your %(team_name)s Dropbox")}b.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(c){return function(d){d.preventDefault();SharingModals.start_wizard_without_user();return c.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(c){return function(d){$j(d.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(c.$modal_window.find("input#create-new-sf").is(":checked")){return analytics.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",c.user)}else{return analytics.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",c.user)}}})(this))};b.prototype.on_confirm_button_click=function(h){var f,g,c,d;h.preventDefault();g=this.$modal_window.find("input#create-new-sf").is(":checked");if(g){d=new ShareNewFolderWizardModal(this.user,{element_id:"share-new-folder-wizard-modal"});this.hide();c={selection:"new_folder"};analytics.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,c);return d.show()}f=this.$modal_window.find(".ajax-loading-indicator").show();return $j.ajax({url:"/share_ajax/account_has_existing_folders",method:"post",subject_user:this.user,success:(function(e){return function(i){var j;i=JSON.parse(i);if(i===true){d=new ShareExistingFolderWizardModal(e.user,{element_id:"share-existing-folder-wizard-modal"});c.has_existing_folder=true}else{j=_("You don't have any existing folders. Please create and share a new folder.");d=new ShareNewFolderWizardModal(e.user,{element_id:"share-new-folder-wizard-modal",error_msg:j});c.has_existing_folder=false}e.hide();return d.show()}})(this),error:(function(e){return function(){return Notify.error()}})(this),complete:(function(e){return function(){return f.hide()}})(this)},c={selection:"existing_folder"},analytics.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,c))};return b})(BaseShareAFolderWizardModal);InlineModalValidationError=(function(){function a(){}a.show_validation_error=function(i,e){var f,g,d,c,h,b;if(i.responseText.indexOf("err:{")===0){b=i.responseText.substr(4);h=JSON.parse(b);for(g in h){f=h[g];if("message_text" in f){c=e.find("span.error-message");if(c.length===0){c=$j("<span/>").addClass("error-message");e.prepend(c)}c.text(f.message_text);return}}e.find("span.error-message").remove();return Notify.error()}else{e.find("span.error-message").remove();if(i.responseText.indexOf("err:")===0){d=i.responseText.substr(4);return Notify.error(d)}else{return Notify.error()}}};return a})();TeamSharedFolderWizardModalPage1=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.__fix_position=__bind(this.__fix_position,this);b.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=_("Now, let's set up your team");this.options.vertical_offset=5}b.prototype.on_show=function(){var d,f,c,e;e=this.$modal_window.find(".suggestion-input");for(f=0,c=e.length;f<c;f++){d=e[f];SuggestionInput.register($(d))}this.$modal_window.find("#validate-team-name").submit((function(g){return function(h){h.preventDefault();return g.on_confirm_button_click(h)}})(this));if(this.options.error_msg){Notify.error(this.options.error_msg)}return analytics.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};b.prototype.on_confirm_button_click=function(g){var d,c,f;g.preventDefault();f=this.$modal_window.find("#new-team-shared-folder-name-input").val();c=(function(e){return function(){var h;h=new TeamSharedFolderWizardModalPage2(e.user,{team_name:f,element_id:"team-shared-folder-wizard-modal-page2"});e.hide();return h.show()}})(this);d=(function(e){return function(h){analytics.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",e.user);return InlineModalValidationError.show_validation_error(h,e.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(f,c,d)};b.prototype.__fix_position=function(d){var c;c=this.$modal_window.find(".db-modal");return c.css({margin:"0",position:"fixed"})};return b})(BaseShareAFolderWizardModal);TeamSharedFolderWizardModalPage2=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.__fix_position=__bind(this.__fix_position,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);b.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=_("Invite teammates");this.folder_name=this.options.team_name}b.prototype.before_show=function(){var c;c=_("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":c})};b.prototype.on_show=function(){analytics.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(c){return function(d){d.preventDefault();return c.on_confirm_button_click(d)}})(this))};b.prototype.on_confirm_button_click=function(h){var f,d,j,c,i,g;h.preventDefault();j={emails:[]};analytics.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(c=g=1;g<=10;c=++g){f=this.$modal_window.find("#new-team-shared-folder-email"+c).val();if(f){j.emails.push(f)}}d=EmailVerification.getForRole(Browse.active_user.role);if(!d.verified()){analytics.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return d.send_email("share_folder",(function(e){return function(){var k;k=new TeamSharedFolderWizardModalPage3(e.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:e.folder_name,invitees:j,from_email_verification:true});e.hide();return k.show()}})(this))}else{analytics.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);i=new TeamSharedFolderWizardModalPage3(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:j,from_email_verification:true});this.hide();return i.show()}};b.prototype.__fix_position=function(d){var c;c=this.$modal_window.find(".db-modal");c.css;return{margin:"0",position:"fixed"}};return b})(BaseShareAFolderWizardModal);TeamSharedFolderWizardModalPage3=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.__fix_position=__bind(this.__fix_position,this);a.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=_("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}a.prototype.on_show=function(){var h,f,e,d,j,i,g,c;analytics.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(k){return function(l){l.preventDefault();return k.on_close_button_click(l)}})(this));j="";i=true;f=false;d="all";g=false;h=null;c=(function(k){return function(n){var l,m;l=JSON.parse(n.responseText);Notify.success(l.success_msg);m=new TeamSharedFolderWizardModalPage4(k.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:k.options.folder_name,invitees:k.options.invitees,from_email_verification:true});k.hide();return m.show()}})(this);e=(function(k){return function(l){return k.hide()}})(this);return this.sharing_api.share_folder(i,this.options.folder_name,this.options.invitees,j,f,d,g,h,c,e)};a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.hide()};a.prototype.__fix_position=function(d){var c;c=this.$modal_window.find(".db-modal");return c.css({margin:"0",position:"fixed"})};return a})(BaseShareAFolderWizardModal);TeamSharedFolderWizardModalPage4=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.__fix_position=__bind(this.__fix_position,this);a.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=_("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}a.prototype.before_show=function(){var c;c=this.$modal_window.find("#back_to_home");c.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};a.prototype.on_show=function(){return analytics.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};a.prototype.__fix_position=function(d){var c;c=this.$modal_window.find(".db-modal");return c.css({margin:"0",position:"fixed"})};return a})(BaseShareAFolderWizardModal);ShareNewFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.options.focus="#new-shared-folder-wizard input[type=text]";a.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Create a new shared folder");this.personal_title=_("Create a shared folder in your personal Dropbox");this.work_title=_("Create a shared folder in your %(team_name)s Dropbox")}a.prototype.on_show=function(){var d,f,c,e;e=this.$modal_window.find(".suggestion-input");for(f=0,c=e.length;f<c;f++){d=e[f];SuggestionInput.register($(d))}this.$modal_window.find("#validate-folder-name").submit((function(g){return function(h){h.preventDefault();return g.on_confirm_button_click(h)}})(this));if(this.options.error_msg){Notify.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(g){return function(h){h.preventDefault();SharingModals.start_wizard_for_user(g.user);return g.hide()}})(this))};a.prototype.on_confirm_button_click=function(g){var f,h,d,c;g.preventDefault();h=this.$modal_window.find("#new-shared-folder-name-input").val();d={folder_name:h};analytics.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,d);$j(document).trigger("db:share_new_folder:next");c=(function(e){return function(){var i;i=new InviteToNewSharedFolderWizardModal(e.user,{folder_name:h,element_id:"invite-to-new-sf-wizard-modal-"+e.user.id});e.hide();i.new_folder=true;i.show();return analytics.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",e.user,d)}})(this);f=(function(e){return function(i){var j;j=AjaxForm.extract_errors(i.responseText);analytics.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",e.user,d);if(j===false){}else{if(typeof j==="string"){return Notify.error(j)}else{$j("#new-shared-folder-name-input .error-message").remove();return AjaxForm.fill_errors($j("#validate-folder-name"),j)}}}})(this);return this.sharing_api.validate_new_sf_path(h,c,f)};return a})(BaseShareAFolderWizardModal);ShareExistingFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this._hide=__bind(this._hide,this);this.on_show=__bind(this.on_show,this);a.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Choose folder to share");this.personal_title=_("Choose a folder from your personal Dropbox");this.work_title=_("Choose a folder from your %(team_name)s Dropbox")}a.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=$j("#"+this.treeview_id).parent().attr("id");TreeView.schedule_reset();TreeView.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(c){return function(){var d;$j(document).on("db:treeview_selected",function(g,f){return c.folder_name=f});d=$j(".first-treeview-link");if(!Util.ie){return d.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(c){return function(d){d.preventDefault();c.hide();return SharingModals.start_wizard_for_user(c.user)}})(this))};a.prototype._hide=function(){TreeView.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return a.__super__._hide.apply(this,arguments)};a.prototype.on_hide=function(){return $j(document).off("db:treeview_selected")};a.prototype.on_confirm_button_click=function(g){var f,d,c;d={folder_name:this.folder_name};g.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();analytics.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,d);return SharingModals.show_shared_folder_options_modal(this.folder_name,this.user)}else{c=(function(e){return function(){var h;h=new InviteToNewSharedFolderWizardModal(e.user,{folder_name:e.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+e.user.id});e.hide();analytics.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",e.user,d);h.new_folder=false;return h.show()}})(this);f=(function(e){return function(h){return InlineModalValidationError.show_validation_error(h,e.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,c,f)}};return a})(BaseShareAFolderWizardModal);CreateLinkOrInviteToFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;a.__super__.constructor.call(this,this.options);this.sharing_api=new SharingApi(this.user)}a.prototype.before_show=function(){var c;this.sharing_api.loading_elem=this.$modal_window;c=_("Share '%(folder_name)s' with others");c=c.format({folder_name:Emstring.em_snippet(FilePath.filename(this.options.path),16)});return this.format({".db-modal-title-text":c})};a.prototype.on_show=function(){var c,e,d;c="edu_modal";e=(d=this.options.target_item)!=null?d:null;ShmodelUILogger.log("view",c,e);this.$modal_window.find(".option-to-share-folder").on("click",(function(f){return function(h){var g;if(f.options.existing_sf){ShmodelUILogger.log("sf_options",c,e);g=new ExistingSharedFolderOptionsModal(Browse.active_user,f.options.path)}else{ShmodelUILogger.log("sf_invite",c,e);g=new InviteToNewSharedFolderWizardModal(f.user,{folder_name:f.options.path,element_id:"invite-to-new-sf-wizard-modal-"+f.user.id})}f.hide();return g.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(f){return function(g){ShmodelUILogger.log("token_share",c,e);SharingShmodel.shmodel(f.options.path,"create_link_or_invite_to_folder_modal");return f.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(f){return function(g){g.preventDefault();ShmodelUILogger.log("clicked_learn_more",c,e);return window.open("/help/274","_blank")}})(this))};return a})(DBModal);InviteToNewSharedFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.insert_folder_settings=__bind(this.insert_folder_settings,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.show_settings_modal=__bind(this.show_settings_modal,this);this.options.focus=".new-collab-input";a.__super__.constructor.call(this,this.options);this.sharing_api=new SharingApi(this.user);this.folder_name=this.options.folder_name}a.prototype.before_show=function(){var c;this.sharing_api.loading_elem=this.$modal_window;c=_("Share '%(folder_name)s' with others");c=c.format({folder_name:Emstring.em_snippet(FilePath.filename(this.folder_name),16)});return this.format({".db-modal-title-text":c})};a.prototype.on_show=function(){var l,h,d,j,i,f,e,k,c,g;if(Constants.sharing_upsell_type){analytics.UserActivityLogger.log("web","over-quota-shared-folder-modal-"+Constants.sharing_upsell_type,null,Viewer.get_viewer().personal_user.id)}g=this.$modal_window.find(".suggestion-input");for(f=0,k=g.length;f<k;f++){d=g[f];SuggestionInput.register($(d))}h=this.$modal_window.find(".sf-invite-can-edit .can-edit-dropdown input");for(e=0,c=h.length;e<c;e++){d=h[e];SharedFolderAccessType.register(d)}l=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){i="invite-wizard-"+this.user.id;this.invite_form_controller=new InviteFormController(this.user,l,[],[],[],i);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();this.$modal_window.find(".change-new-folder-settings").on("click",(function(m){return function(n){n.preventDefault();return m.show_settings_modal()}})(this));j={path:this.folder_name};return analytics.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,j)};a.prototype.show_settings_modal=function(){var d,c;c=_("'%(folder_name)s' settings");c=c.format({folder_name:Emstring.em_snippet(FilePath.filename(this.folder_name),13)});d={folder_name:this.folder_name};if(this.audience_restriction){d.audience=this.audience_restriction}if(this.inviter_restriction){d.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){d.shared_link_policy=this.shared_link_policy_restriction}d[Constants.UID_PARAM_NAME]=this.user.id;DBModalStack.register(NewSharedFolderPermissionsContent.SAVED_PERMISSIONS,(function(e){return function(g,f){e.insert_folder_settings(f.audience,f.inviter,f.shared_link_policy);return e.invite_form_controller.reset_options()}})(this));return DBModalStack.push(new DBModalLoading({element_id:"folder-permissions-modal",title:c,endpoint_url:"/share_ajax/default_folder_settings",parameters:d}))};a.prototype.on_confirm_button_click=function(i){var h,g,k,d,f,j,c;i.preventDefault();this.invite_form_controller.tokenize();k=this.invite_form_controller.extract_invitees();j=this.invite_form_controller.get_custom_message();h=this.invite_form_controller.get_access_type();d=this.$modal_window.find("input#allow_other_members_to_share");if(d.length>0){this.inviter_restriction=d.is(":checked")?"all":"me"}g=(function(e){return function(l){return InlineModalValidationError.show_validation_error(l,e.$modal_window.find(".tokenized_autocompleter_container"))}})(this);c=(function(e){return function(m){var l;l=JSON.parse(m.responseText);Notify.success(l.success_msg);document.fire(FileEvents.SF_NEW,{sf_info:Sharing.decode_sort_key(l.sf_info)});return e.hide()}})(this);this.sharing_api.share_folder(this.new_folder,this.folder_name,k,j,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,h,c,g);f={path:this.folder_name,access_type:h};analytics.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,f);return $j(document).trigger("db:invite_to_new_folder:share")};a.prototype.insert_folder_settings=function(d,c,f){var e;this.audience_restriction=d;this.inviter_restriction=c;this.shared_link_policy_restriction=f;e=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return e.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return e.removeClass("team-only")}};return a})(DBModal);NewSharedFolderPermissionsContent=(function(){a.SAVED_PERMISSIONS="new_sf_permissions:saved";function a(b){this.$form=b;this._submit=__bind(this._submit,this);this._listen()}a.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};a.prototype._cancel=function(){return DBModalStack.pop()};a.prototype._submit=function(f){var c,d,b;f.preventDefault();c=this.$form.find("input[name=audience]:checked").val();d=this.$form.find("input[name=inviter]:checked").val();b=this.$form.find("input[name=shared_link_policy]:checked").val();DBModalStack.trigger(a.SAVED_PERMISSIONS,{audience:c,inviter:d,shared_link_policy:b});return DBModalStack.pop()};return a})();var SharingShmodel;SharingShmodel=(function(){function a(){}a.shmodel=function(c,b){return new ShareLinkModal(Browse.active_user.id,c,b).show()};a.shmodel_disabled=function(b){SharingModel.init_disable(b);return SharingModel.show_shmodal("","","contact",b.user_id)};return a})();var Sharing;Sharing={init:function(f,e,b,d,c,a){this.is_merged=e;[f.current,f.past].each((function(g){return function(h){return h.each(function(i){return g.decode_sort_key(i)})}})(this));this._state={sf_info:f,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{}};if(e){this.role_picker=$j("#role-selector").controller();this.role_picker.on_state_change=this._render.bind(this);MultiaccountLogin.set_during_login_callback((function(g){return function(i,h){SharingState.set_not_logged_in_role_and_email(null,null);return g._reload_folder_info(function(){return h()},function(j){h(_("Error displaying shared folders"));return window.location.reload()})}})(this))}SharingState.set_is_merged(e);SharingState.set_not_logged_in_role_and_email(b,d);SharingState.set_team_name(c);SharingState.set_show_inbox(a);this._listen();this._tmpl=HTML.tmpl("sf_list_item_tmpl");this._render();this.refresh_inbox_counts(true);return $j("#sf-view").show()},is_share_page:function(){return this._state!=null},decode_sort_key:function(a){assert((a.encoded_sort_key!=null)&&(a.sort_key==null),"expected encoded sort keys on each elm");a.sort_key=Util.decode_sort_key(a.encoded_sort_key);delete a.encoded_sort_key;return a},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(c,a){var b;if(!this.is_share_page()){return}b=(function(d){return function(e){var f;f=JSON.parse(e.responseText);d._state.sf_info=f;d._render();return typeof c==="function"?c():void 0}})(this);return new UserlessSharingApi().get_folder_info(b,a)},refresh_inbox_counts:function(a){return new UserlessSharingApi().get_inbox_counts((function(b){return function(c){return b._update_inbox_counts(c,a)}})(this))},_update_inbox_counts:function(b,f){var i,d,a,h,g,e;e=0;for(h in b){i=b[h];e+=i}$j("#inbox-count").text(e);$j("#inbox-count").toggleClass("show",e>0);if(!this.is_share_page()){return}d=function(j,c){var k;for(h in j){k=j[h];if(c[h]!==j[h]){return false}}return true};if((!f)&&this._state&&d(this._state.inbox_counts,b)){return}this._state.inbox_counts=b;if(e){a=new Element("a",{id:"new-invites-link",href:"#"});a.__sert(Sprite.make("web","email_32",{"class":"link-img"}));g=ungettext("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",e);g+=" \n";g=g.format({total_count:e});a.__sert(g);a.observe("click",(function(c){return function(j){Event.stop(j);return c.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(a)}else{$("invites-box").hide()}if(e>0&&SharingState.show_inbox){SharingState.set_show_inbox(false);return this.show_invites()}},register_accept:function(a){$j(a).closest(".sf-invite-action").addClass("loading");new UIRequest($j(a),a.action,{data:Forms.collect_form_vars(a),complete:(function(b){return function(d,c){$j(a).closest(".sf-invite-action").removeClass("loading");b.refresh_inbox_counts();return b._reload_folder_info()}})(this),success:(function(b){return function(g,c,i){var d,f,h,e;g=(e=JSON.parse(i.responseText))!=null?e.data:void 0;d=$j(a).closest(".sf-invite-action");d.addClass("sf-accepted");if(g!=null?g.redirect:void 0){f=d.find(".view-folder-button");return f.click(function(){return window.location.href=g!=null?g.redirect:void 0})}else{h=$j(a).closest(".invitation-row").attr("data-invite-id");return b._remove_invite_row(h)}}})(this)});return false},register_decline:function(b,d){var a,c;a=$j(b).closest("form");if((c=a.closest(".sf-invite-action"))!=null){c.addClass("loading")}if(a.length){new UIRequest(a,a[0].action,{data:Forms.collect_form_vars(a[0]),complete:(function(e){return function(h,g){var f;if((f=a.closest(".sf-invite-action"))!=null){f.removeClass("loading")}e._remove_invite_row(d);e.refresh_inbox_counts();return e._reload_folder_info()}})(this)})}return false},_remove_invite_row:function(e){var a,d,c,b;a=$j("#invites-container");d=a.find('[data-invite-id="'+e+'"]');if(d){b=d.parent("tbody");d.remove();if(b.children().length===0){a.find(".invitation-table-container").hide();a.find(".message-bottom").removeClass("message-bottom");a.find(".message-top").removeClass("message-top");if(a.find(".invites-message").length===0){c=DBModal.get_containing_modal(a);return c!=null?c.hide():void 0}}}},_listen:function(){var c,b,a;this.listen_modals();c=(function(d){return function(f,o,j){var k,e,n,m,l,q,g,p,h;h=d._get_current_sf_list_info(j),m=h[0],n=h[1];assert(o,"SF _transfer w/o target_ns_id");for(k=g=0,p=m.length;g<p;k=++g){e=m[k];if(e.target_ns_id===o&&e.user_id===f){l=e;q=k;break}}assert(q!=null,"SF _transfer w/o js obj");return[l,q]}})(this);a=(function(d){return function(k,p,m){var n,l,q,o,j,g,i,h,f;i=d._get_current_sf_list_info(p),n=i[0],g=i[1];h=d._get_current_sf_list_info(m),o=h[0],j=h[1];f=c(k.memo.user_id,k.memo.target_ns_id,p),l=f[0],q=f[1];n.splice(q,1);d._empty_check(p);if(k.memo.filename!=null){l.filename=k.memo.filename}if(k.memo.mount_point!=null){l.mount_point=k.memo.mount_point}o.push(l);return d._render()}})(this);b=(function(d){return function(k,h){var m,j,l,g,i,f;i=d._get_current_sf_list_info(h),m=i[0],g=i[1];f=c(k.memo.user_id,k.memo.target_ns_id,h),j=f[0],l=f[1];m.splice(l,1);return d._render()}})(this);document.observe(FileEvents.SF_UNSHARE,(function(d){return function(f){return b(f,"#sf-current")}})(this));document.observe(FileEvents.SF_LEAVE,(function(d){return function(f){return a(f,"#sf-current","#sf-past")}})(this));document.observe(FileEvents.SF_REJOIN,(function(d){return function(f){return a(f,"#sf-past","#sf-current")}})(this));document.observe(FileEvents.SF_IGNORE,(function(d){return function(f){return b(f,"#sf-past")}})(this));document.observe(FileEvents.SF_NEW,(function(d){return function(g){var f;f=g.memo.sf_info;assert(f,"SF_NEW without info");d._state.sf_info.current.push(f);return d._render()}})(this));$("create-share").observe("click",(function(d){return function(f){analytics.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(f);return SharingModals.start_wizard_without_user()}}})(this));$j("#learn-more-link").click((function(d){return function(f){return analytics.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(d){return function(f){Event.stop(f);return d.show_invites()}})(this))}return $j("#sf-current, #sf-past").each((function(d){return function(e,f){var g;g=["#sf-current","#sf-past"][e];$j(".sf-list",f).on("click","a.options-link",function(o){var m,k,l,h,i,n,j;o.preventDefault();m=$j(o.target).closest("a.options-link");h=m.attr("data-type");l=m.attr("data-mount");n=parseInt(m.attr("data-nsid"),10);j=Viewer.get_viewer().get_user_by_id(m.attr("data-user_id"));i=$j(o.target).closest("li.sf-folder").data("role");if(i!=null){SharingState.set_role(i)}if(h==="normal"){SharingModals.show_shared_folder_options_modal(l,j)}else{if(h==="remove"){SharingModals.show_ignore_modal(j,l,n)}else{if(h==="rejoin"){SharingModals.show_rejoin_modal(j,l,n)}}}k={option_type:h};if(n){k.ns_id=n}if(l){k.path=l}return analytics.SharedFolderActivityLogger.log("web","sharing_view_share_existing",j.id,k,true)});$j(".sf-sort",f).on("click","a.sort-option",function(j){var i,h,k;j.preventDefault();i=$j(j.target).closest("a.sort-option");k={SF_BY_NAME:d._name_cmp,SF_BY_MODIFIED:d._modified_cmp};h=k[i.attr("data-sort")];if(d._state.cmp[g]===h){d._state.is_ascending[g]=!d._state.is_ascending[g]}else{d._state.cmp[g]=h;d._state.is_ascending[g]=true}Util.add_sort_arrow_mouseover_j(i,d._state.is_ascending[g],g+" .sf-sort a.sort-option",true);return d._render_list_id(g)});return Util.add_sort_arrow_mouseover_j($j(".modified-sorter",f),d._state.is_ascending[g],g+" .sf-sort a.sort-option",false)}})(this))},listen_modals:function(){return $j("#new-or-existing-sf li").click((function(a){return function(c){var b;$j("#new-or-existing-sf li").removeClass("active");b=$j(c.target).closest("li");b.find("input").prop("checked",true);return b.addClass("active")}})(this))},_showing_two_accounts:function(){var a;return this.is_merged&&((a=this.role_picker)!=null?a.get_state():void 0)===RolePickerState.ALL},_render:function(){this._render_list_id("#sf-current");this._render_list_id("#sf-past");if($j("#sf-current").hasClass("empty-list")&&$j("#sf-past").hasClass("empty-list")){$j("#page-content").addClass("no-shares");return $j("#empty-content").show()}else{$j("#page-content").removeClass("no-shares");return $j("#empty-content").hide()}},_render_list_id:function(c){var j,g,h,e,f,d,i,a,k,b;b=this._get_current_sf_list_info(c),e=b[0],h=b[1];i=this._showing_two_accounts();j=(function(l){return function(m,o){var n;n=l._state.is_ascending[c]?1:-1;return n*l._state.cmp[c](m,o,i)}})(this);e.sort(j);f=$j(".sf-list",c);f.empty();for(a=0,k=e.length;a<k;a++){d=e[a];if(this._should_render(d)){g=this._tmpl({options_str:_("Options"),remove_str:_("Remove"),rejoin_str:_("Rejoin"),is_past:h,sf:d});f.append(g.toHTML())}}return this._empty_check(c)},_should_render:function(a){if(this.role_picker!=null){return this.role_picker.is_role_visible(a.role)}else{return true}},_empty_check:function(d){var c,a,b;b=this._get_current_sf_list_info(d),c=b[0],a=b[1];if($j(".sf-list",d).children().length){return $j(d).removeClass("empty-list")}else{return $j(d).addClass("empty-list")}},_get_current_sf_list_info:function(a){switch(a){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return assert(false,"invalid sf list id")}},_name_cmp:function(b,c,a){if(a){return Util.sort_by_key(b,c)}else{return Util.sort_by_rank_or_key(b,c)}},_modified_cmp:function(b,c,a){return b.modified_ts-c.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){return SharingModals.show_invites()}};var autoCompleteDiv;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(e,f,d,k){var j,c,h,i,a,b,g;this.user=e;this.baseInitialize(f,d,k);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;c=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}g=this.options.include_team===true;h=this.options.include_groups===true;a=this.options.include_new_style_groups===true;i=this.options.include_me===true;b=this.options.include_rooms===true;this.contacts_importer=ContactsImporter.get_contacts_importer({user:this.user,on_update_services:this.update_import_contacts_link.bind(this),hide_containing_modal:this.hide_containing_modal.bind(this),show_containing_modal:this.show_containing_modal.bind(this)});this.update_import_contacts_link();this.contacts_importer.on_open_auth_popup=this.contact_importer_unshow.bind(this);this._autocompleter_contact_import_item_tmpl=HTML.tmpl("autocompleter_item_tmpl");this.listen();j=(function(l){return function(m){m=m.includeForUser(l.user.id);if(l.options.contact_filter){m=l.options.contact_filter(m)}else{if(!c){m=m.excludeFacebook()}if(!h){m=m.excludeGroups()}if(!a){m=m.excludeNewStyleGroups()}if(!g){m=m.excludeTeamMembers()}if(!i){m=m.excludeMe()}if(!b){m=m.excludeRooms()}}return l.setContacts(m)}})(this);((function(l){return function(){var m;return DefaultContactsCache.load_contacts(m=false,b=b,(function(n){j(n);return DefaultContactsCache.register_for_updates("autocompleter_contacts",j)}))}})(this)).defer();return this.options.onShow=function(l,m){if(!m.style.position||m.style.position==="absolute"){m.style.position="absolute";$j(m).clonePosition($j(l),{setHeight:false,setTop:false,setLeft:false})}return $j(m).fadeTo(150,1)}},getToken:function(){var a;a=this.getTokenBounds();return this.element.value.substring(a[0],a[1])},listen:function(){return this.install_contact_importer_listener()},install_contact_importer_listener:function(){var a;Event.stopObserving(this.element,"blur");a=(function(b){return function(c){var d;if(!$j(c.target).closest("li").hasClass("contacts-importer")){if(b.contact_importer_currently_showing()){return b.contact_importer_unshow()}else{return(d=b.get_entry_container())!=null?d.hide():void 0}}}})(this);$j(this.element).closest(".db-modal-box").click(a);return $j(this.element).closest("#modal-box").click(a)},get_entry_container:function(){var a;return(a=this.element.up(".tokenized_autocompleter_container"))!=null?a.down(".autocomplete"):void 0},contact_importer_currently_showing:function(){var b,a;b=this.get_entry_container();if((b!=null)&&b.style.display!=="none"){if(((a=b.firstChild.firstChild)!=null?a.value:void 0)===0){if(b.firstChild.children.length>1){return true}}}return false},contact_importer_show:function(){var c,b,a,d;c=this.get_entry_container();if(((b=c.firstChild)!=null?(a=b.firstChild)!=null?a.value:void 0:void 0)>0){this.old_display=c.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.contact_importer_render_buttons();if((d=$("flash_copy_container"))!=null){d.hide()}return this.element.focus()},contact_importer_unshow:function(){var a;this.hasFocus=true;this.changed=false;this.updateChoices(this.old_contents);this.get_entry_container().style.display=this.old_display;return(a=$("flash_copy_container"))!=null?a.show():void 0},contact_importer_render_buttons:function(){var e,b,d,a,c;b=[];c=ThirdParty.contact_services();for(d=0,a=c.length;d<a;d++){e=c[d];assert(this.contacts_importer.connected_services!=null,"connected_services has not been set");b.push(this._autocompleter_contact_import_item_tmpl({email_provider_num:e,email_provider_img:ThirdParty.to_img(e),email_provider_name:ThirdParty.to_name(e),bottom_text:this.contacts_importer.connected_services[e]?_("Connected"):"",is_suggestion:0}).toHTML())}this.hasFocus=true;return this.updateChoices("<ul>"+(b.join(""))+"</ul>")},update_import_contacts_link:function(){if(this.contacts_importer.has_unconnected_services()){return $j(this.element).closest("form").find(".import-contacts-link").show()}else{return $j(this.element).closest("form").find(".import-contacts-link").hide()}},hide_containing_modal:function(){this.$hidden_modals=$j(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=$j("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(a){this.options.array=a.contacts;this.options.larray=a.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){this.updateChoices(this.options.selector());$j(".autocomplete-item-cancel-button").off();return $j(".autocomplete-item-cancel-button").on("click",((function(a){return function(b){b.stopPropagation();a.contacts_importer.suggestions_enabled=false;a.getUpdatedChoices();return new Ajax.DBRequest("/contacts/turn_off_importer_suggestions",{subject_user:a.user})}})(this)))},selectEntry:function(){var c,b,a;b=this.getCurrentEntry();c=this.options.array[b.value];if(c.type===ContactTypes.FB||c.type===ContactTypes.NEW_STYLE_GROUP){b.innerHTML=c.name}else{b.innerHTML=c.email}if(this.options.tokens.length>1){a=this.options.tokens[0]+" "}else{a=""}b.innerHTML+=a;this.active=false;this.updateElement(b);return $j(this.element).trigger("db:autocompleted")}},autoCompleteDiv=function(a,b){var c;c=$j("<div>");c.addClass(a);if(typeof b==="string"||b instanceof String){c.text(b)}else{c.append(b)}return c},{setOptions:function(b){var a;if(b==null){b={}}a={choices:5,selector:(function(c){return function(){var f,x,w,U,q,s,i,k,E,R,z,u,r,F,o,N,g,D,V,B,H,C,G,M,d,L,S,n,e,J,A,K,h,v,y,Q,P,O,t,m,j,I;A=$j("<ul>");E=c.getToken().toLowerCase();N=c.options.array.length;U=c.options.choices;s=c.options.array;H=c.options.larray;J=[];if(E.indexOf(" ")===-1){J.push("\\s+")}if(E.indexOf("+")===-1){J.push("\\+")}if(E.indexOf("@")===-1){J.push("@")}if(E.indexOf(".")===-1){J.push("\\.")}if(E.indexOf("&lt;")===-1){J.push("&lt;")}e=RegExp("("+J.join("|")+")");F=0;while(F<N&&A.children().length<U){q=s[F];B=H[F];R=-1;k=[];G=[];r="";switch(q.type){case ContactTypes.EMAIL:k.push(q.name,q.email_snippet);G.push(B.name,B.email);r="/static/images/icons/mail28.png";break;case ContactTypes.FB:k.push(q.name);G.push(B.name);if(Sharing.use_fb_profile_pics){r="https://graph.facebook.com/"+B.fb_id+"/picture"}else{r="/static/images/icons/fb24.png"}break;case ContactTypes.USER_GROUP:k.push(q.name,q.members);G.push(B.name,"");r="";z=q.group_avatar;break;case ContactTypes.NEW_STYLE_GROUP:k.push(q.name,q.members);G.push(B.name,"");r="";if(typeof GroupsListController!=="undefined"&&GroupsListController!==null){x=GroupsListController.string_to_hsl(q.name);w=GroupsListController.get_initials(q.name);z=$j("<span class='group-icon'>").css("background-color",x).text(w)}break;case ContactTypes.CAROUSEL_ROOM:k.push("",q.name);v=B.name;I=q.members;for(Q=0,t=I.length;Q<t;Q++){M=I[Q];v+="."+M.contact_vector_data.toLowerCase();v+="."+M.display_name.toLowerCase()}G.push("",v);r=q.avatar_url||"/static/images/carousel/icon-57px.png";break;default:assert(false,"should never get here due to type: "+(""+q.type+", "+q.name+", "+q.email+", "+q))}for(o=P=0,m=G.length;P<m;o=++P){C=G[o];S=J.length?C.split(e):[C];i=0;for(O=0,j=S.length;O<j;O++){L=S[O];if(!L){continue}if(L.indexOf(E)===0){R=i;break}i+=L.length}if(R!==-1){g=document.createTextNode(k[o].substr(0,R));d=$j("<strong>").text(k[o].substr(R,E.length));K=document.createTextNode(k[o].substr(R+E.length));k[o]=[g,d,K];break}}if(q.type===ContactTypes.FB){k.push(_("Facebook message"))}if(R!==-1){if(r){u=$j('<img width="28px" height="28px">').attr("src",r)}else{if(z){u=z}}n=autoCompleteDiv("autocomplete-line",k[0]);y=autoCompleteDiv("autocomplete-line autocomplete-secondary",k[1]);D=autoCompleteDiv("autocomplete-left",u);h=autoCompleteDiv(null,[n,y]);V=$j("<li>").attr("value",F).append(D,h);A.append(V)}F++}if(!$j(c.element).hasClass("no-contacts-importer")){if(c.contacts_importer.has_unconnected_services()){u=Sprite.make("web","user_add");n=autoCompleteDiv("autocomplete-line autocomplete-line-center",_("Import contacts"));D=autoCompleteDiv("autocomplete-left",u);h=autoCompleteDiv(null,[n]);V=$j("<li>").addClass("contacts-importer").append(D,h);A.append(V)}}f=A.wrap("<span>").parent().html();c.old_contents=f;return f}})(this)};return this.options=Object.extend(a,b)}});var Token;Token=Class.create({initialize:function(b,a,c,d){this.element=$(b);this.token_manager=c;this.hidden_input=a;this.element.token=this;this.selected=false;this.info=d;return $j(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var a;this.token_manager.token=this;if((a=this.hidden_input)!=null){a.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(a){if(a&&a.preventDefault){a.preventDefault()}if(this.detect(a)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(a){return this.token_manager.remove(this)},detect:function(d){var b,c,a;c=d.target?d.target:d.srcElement;a=c.token;b=c;while((a==null)&&b.parentNode){b=b.parentNode;a=b.token}return(a!=null)&&a.element===this.element}});var TokenManager;TokenManager=Class.create({initialize:function(b,c,a){this.shift_boundary_right_func=c;this.shift_boundary_left_func=a;this.element=b;this.tokens=[];return this.token=null},add:function(a){this.tokens.push(a);return this.element.fire("token:add",a.info)},populate:function(){var g,c,e,d,f,b,a;d=this.element.select(".token");a=[];for(f=0,b=d.length;f<b;f++){e=d[f];g=e.hasClassName("token-warn");c=new Token(e,null,this,{external:g});a.push(this.add(c))}return a},remove:function(b){var a;if(b==null){b=this.token}if(b!=null){a=this.tokens.indexOf(b);this.tokens.splice(a,1);b.element.remove();if(this.token===b&&a<this.tokens.length){this.tokens[a].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",b.info)}},removeAll:function(){var b,d,a,c;c=this.tokens;for(d=0,a=c.length;d<a;d++){b=c[d];b.element.remove();this.element.fire("token:remove",b.info)}return this.tokens.clear()},shift_left:function(){var a;a=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(a>0){if(this.token){this.token.deselect()}return this.tokens[a-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var a;a=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(a+1<this.tokens.length){return this.tokens[a+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var HiddenInput;HiddenInput=Class.create({initialize:function(a,c,b){this.element=$(a);this.auto_complete_element=c;this.token_manager=b;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(a){switch(a.keyCode){case Event.KEY_LEFT:a.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var __indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,a,d,f,c,b){var e;this.user=a;$super(a,d,f,b);this.token_manager=new TokenManager(this.element,this.generate_shift_boundary_right_func());this.hidden_input=new HiddenInput(c,this.element,this.token_manager);if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){$j(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(g,h){$j(h).clonePosition($j(g.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return h.show()};this.options.onHide=function(g,h){return h.hide()};this.members=[];if(b.members!=null){this.members=b.members}this.invitees=[];if(b.invitees!=null){this.invitees=b.invitees}this.new_style_groups=[];if(b.new_style_groups!=null){this.new_style_groups=b.new_style_groups}this.contacts_only=false;if(b.contacts_only!=null){this.contacts_only=b.contacts_only}if(DBHistory.get_url().indexOf("/referrals")!==-1){e=$j("#retrieve-contacts-button")}else{e=$j(this.element).closest("form").find(".tokenizer-submit-button")[0]}$j(e).on("mousedown",this.beforeSubmit.bindAsEventListener(this));$j(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!b.hide_import_contacts){this.import_links=$j(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(b){var a,c;a=b.findElement("li");this.index=a.autocompleteIndex;c=this.selectEntry();if(!c){return this.hide()}},onBlur:function($super,a){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(a)},onFocus:function(a){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(a){return this.tokenize_emails_input(true)},clearTokens:function(a){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getEmails:function(){var b,a;b=$j(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push($j(a).val())}return c})()).join(", ")},check_populated:function(){var b,a;b=$(this.element.parentNode);a=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(b.hasClassName("populated")&&a){return b.removeClassName("populated")}else{if(!b.hasClassName("populated")&&!a){return b.addClassName("populated")}}},clean_email_addr:function(e,c){var b,d,a;for(d=0,a=e.length;d<a;d++){b=e[d];c=c.sub(b,"")}return c.strip()},get_regexp_from_delimiters:function(e){var b,d,c,a;d="";for(c=0,a=e.length;c<a;c++){b=e[c];d+=b+"|"}return new RegExp("["+d+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(d,c,a){var e,b;b=true;e=c;if(a===ContactTypes.FB){e=d}if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}else{if(__indexOf.call(this.members,c)>=0){b=false;e="Already member"}else{if(__indexOf.call(this.invitees,c)>=0){b=false;e="Already invited"}else{if(a===ContactTypes.NEW_STYLE_GROUP){if(__indexOf.call(this.new_style_groups,c)>=0){b=false;e="Already member group"}else{b=true;e="Group"}}}}}if(c===this.user.email||c===this.user.id){e="You";b=!this.contacts_only}if(!d&&c){d=c.toString()}return{display:d,value:c,type:a,valid:b,bubble_title:e}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(b){var a,c;a=b.match(this.COMPOUND_EMAIL_REGEX);if(a){c=this.createTokenInfo(a[0],a[2],ContactTypes.EMAIL);return c}return null},tokenize_emails_input:function(j,e){var o,i,f,n,c,p,m,l,g,t,h,d,b,a,q,s,r,k;i=this.options.tokens;l=this.get_regexp_from_delimiters(i);if(this.options.single_token){n=[this.element.value]}else{n=this.element.value.split(l)}t="";if(!j){t=n[n.length-1];m=this.clean_email_addr(i,t);n=n.slice(0,n.length-1);if((k=t[t.length-1])===" "||k===">"){if(m.match(this.COMPOUND_EMAIL_REGEX)||Util.validate_email(m)){n.push(m);t=""}}}o=false;h=[];if(n.length>0){for(d=0,q=n.length;d<q;d++){f=n[d];g=this.parse_compound_email(f);if(g!=null?g.valid:void 0){o=true;this.set_input_size(1);this.addContact(g)}else{h.push(f)}}}n=h;if(!this.options.single_token){p=[];for(b=0,s=n.length;b<s;b++){f=n[b];p.push.apply(p,f.split(" "))}n=p}if(n.length>0){for(a=0,r=n.length;a<r;a++){f=n[a];f=this.clean_email_addr(i,f);if(f){g=this.createTokenInfo(f,f,ContactTypes.EMAIL);if(g.valid){o=true}else{if(e){continue}}this.set_input_size(1);this.addContact(g)}}}if(this.element.value!==t){this.element.value=t}c=this.element.up("form");if(o){Forms.clear_errors(c)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var b,a;b=this.element;a=function(){return b.focus()};return a},set_input_size:function(a){if((a==null)||a<0){a=20}return this.element.setStyle({width:""+a+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var l,p,f,d,s,g,m,o,k,i,e,j,n,c,a,q,r,h,b;k=$(this.element.parentNode.parentNode);i=parseInt(k.getStyle("width"),10)-15;s=i;l=$j(".tokenizer-link",k.parentNode);if(l.length>0){s-=l.width()}j=this.token_manager.tokens;g=false;n=0;for(c=0,q=j.length;c<q;c++){e=j[c];d=e.element;f=parseInt(d.getStyle("width"),10)+parseInt(d.getStyle("margin-right"),10);o=n+f;if(o>i){n=f;g=true}else{if(f>i){n=0;g=true}else{n=o}}}m=s-n;p=this.element.value.length*7;if(p>m){m=i}this.set_input_size(m);if(this.import_links.length&&this.import_links_visible){if(g||i-n-p<1.25*this.import_links_width){this.import_links_visible=false;h=this.import_links;b=[];for(a=0,r=h.length;a<r;a++){d=h[a];b.push($j(d).fadeOut(100))}return b}}},onKeyPress:function(b){var c,a;this.dynamically_resize_input();if(this.active){switch(b.keyCode){case 44:case 188:case 59:case 186:this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true);this.hide();Event.stop(b);return}this.selectEntry();this.hide();this.active=false;Event.stop(b);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(b);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(b);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(b);return}}else{this.tokenize_emails_input(false);if(b.keyCode===Event.KEY_TAB||b.keyCode===Event.KEY_RETURN){if(this.element.value&&b.preventDefault){b.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((c=b.keyCode)===Event.KEY_LEFT||c===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((a=b.keyCode)===Event.KEY_LEFT||a===Event.KEY_RIGHT||a===Event.KEY_UP||a===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var b,c,f,e,a,d;if(this.active){f=this.element.value;d=this.options.tokens;for(e=0,a=d.length;e<a;e++){b=d[e];c=f.indexOf(b);if(c!==-1){if(this.has_selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=f.substr(0,c);this.selectEntry();this.hide();this.active=false;this.element.value=f.substr(c+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_contact_importer:function(a){if(a==null){a=this.getCurrentEntry()}return $j(a).hasClass("contacts-importer")},has_selected_contact_importer_entry:function(a){var b;if(a==null){a=this.getCurrentEntry()}return a.value===0&&((b=a.id)!=null?b.length:void 0)!==0},selectEntry:function(){var c,b,f,a,d,e;b=this.getCurrentEntry();if(this.has_selected_contact_importer(b)){analytics.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.contact_importer_show();return true}else{if(this.has_selected_contact_importer_entry(b)){f=b.id.split("_")[0];assert(parseInt(f,10)<0,"The 'id-value' of an autocompleter-entry being <0 signifies that it's a contact-importer button");d=ThirdParty.to_name(f);if(this.contacts_importer.connected_services[f]){Notify.success(_("You're already connected to %(service_name)s").format({service_name:d}));return}if(__indexOf.call(ThirdParty.contact_services(),f)>=0){if($j(b).attr("suggestion")==="1"){return this.contacts_importer.auth_import(f,"suggestion")}else{return this.contacts_importer.auth_import(f)}}else{return assert(false,"Should never get here. entry_value: "+f)}}else{c=this.options.array[b.value];a=c.type===ContactTypes.FB?c.fb_id:c.type===ContactTypes.USER_GROUP?c.group_id:c.type===ContactTypes.NEW_STYLE_GROUP?c.group_id:c.type===ContactTypes.CAROUSEL_ROOM?c.members:c.email;this.set_input_size(1);e=this.createTokenInfo(c.name.strip(),a,c.type);this.addContact(e);Forms.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(k){var u,p,v,l,x,h,s,b,m,q,w,A,c,i,o,r,j,t,e,d,a,y,B,z,n,g,f;if(k.type===ContactTypes.CAROUSEL_ROOM&&!k.processed){n=k.value;for(e=0,y=n.length;e<y;e++){u=n[e];b=this.createTokenInfo(v=u.display_name,t=JSON.stringify([u.contact_vector_type,u.contact_vector_data]),j=ContactTypes.CAROUSEL_ROOM);b.processed=true;b.bubble_title=u.contact_vector_data;this.addContact(b)}return}r=this.token_manager.tokens;for(d=0,B=r.length;d<B;d++){m=r[d];if(k.value===m.info.value){return}}this.element.value="";switch(k.type){case ContactTypes.FB:s="fb_ids";x=new Element("img",{src:"/static/images/icons/fb_16.png"});break;case ContactTypes.EMAIL:s="emails";x=new Element("img",{src:"/static/images/icons/email_16.png"});break;case ContactTypes.USER_GROUP:s="group_ids";x=new Element("img",{src:"/static/images/icons/icon_spacer.gif","class":"sprite sprite_groups s_groups_group"});break;case ContactTypes.NEW_STYLE_GROUP:s="new_style_group_ids";x=new Element("img",{src:"/static/images/icons/icon_spacer.gif","class":"sprite sprite_groups s_groups_group"});break;case ContactTypes.CAROUSEL_ROOM:s="carousel_rooms";x=new Element("img",{src:"/static/images/carousel/icon-57px.png"});break;case ContactTypes.INVALID:s="invalids";x=new Element("span",{"class":"hidden"});break;default:assert(false,"should never get here due to type: "+k.type)}q=this.getTokenClass(k);o=$j("<span class='x'>").addClass(q);o.on("click",function(C){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(C);return false});A=new Element("input",{type:"hidden",name:s,value:k.value.toString()});m=new Element("a",{"class":"title_bubble token "+q,href:"#",tabindex:"-1",title:k.bubble_title});h=new Element("span");if(this.options.wrap_name){c=new Element("div",{"class":"token-display-text"});c.__sert(k.display);w=c;p=1}else{w=k.display;p=0}g=[A,x,w];for(a=0,z=g.length;a<z;a++){l=g[a];h.__sert(l)}$j(h).append(o);m.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(h))));if((f=$(m).down(5).next(p))!=null){f.innerHTML="&nbsp;"}i=new Token(m,this.hidden_input,this.token_manager,k);this.token_manager.add(i);return this.element.up().__sert({before:m})},getTokenClass:function(a){if(!a.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var __indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,a,d,e,c,b){$super(a,d,e,c,b);this.warn_only=!b.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));return this.team_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(a){this.warn_only=!a;return this.reloadContacts()},reloadContacts:function(){var a;return DefaultContactsCache.load_contacts(a=false,(function(b){return function(c){return b.setContacts(c)}})(this))},setContacts:function($super,e){var a,d,b,c;this.team_contacts={};this.team_contacts[Viewer.get_viewer().work_email]=1;e=e.sortByTeamFirst();c=e.contacts;for(d=0,b=c.length;d<b;d++){a=c[d];if(a.team){this.team_contacts[a.email]=1}}return $super(e)},createTokenInfo:function(e,c,a){var g,f,d,b;b=true;f=false;g=c;if(a===ContactTypes.FB){g=e}if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}else{if(__indexOf.call(this.members,c)>=0){b=false;g="Already member"}else{if(__indexOf.call(this.invitees,c)>=0){b=false;g="Already invited"}else{if(a===ContactTypes.EMAIL&&!this.team_contacts[c]){b=this.warn_only;f=true}else{if(a===ContactTypes.FB){b=this.warn_only;f=true}else{if(a===ContactTypes.NEW_STYLE_GROUP){if(__indexOf.call(this.new_style_groups,c)>=0){b=false;g="Already member group"}else{b=true;g="Group"}}}}}}}if(c===this.user.email||c===this.user.id){g="You";b=!this.contacts_only}if(!e&&c){e=c.toString()}return d={display:e,value:c,type:a,valid:b,external:f,bubble_title:g}},getTokenClass:function(a){if(!a.valid){return"token-error"}if(a.external){return"token-warn"}return"token-valid"},notifyExternal:function(b){var a,c,d;d=b.memo;if(d.external){c=this.token_manager.tokens.filter(function(e){return e.info.external});a=c?c.length:0;return this.element.fire("sf:token:external",{count:a})}}});var TeamSharedFolderInviteController;TeamSharedFolderInviteController=(function(){function a(b){var c;this.element=$(b[0]);c=this.element.down(".new-collab-input");c.observe("sf:token:external",this.handle_external.bind(this))}a.prototype.handle_external=function(c){var b,d;b=c.memo.count;d=this.element.down(".external-invite-message");if(b>1){DomUtil.fillVal(b,"external-invite-num");if(d!=null){d.removeClassName("single")}return d!=null?d.show():void 0}else{if(b===1){if(d!=null){d.addClassName("single")}return d!=null?d.show():void 0}else{return d!=null?d.hide():void 0}}};return a})();var TeamExternalShareConfirm;TeamExternalShareConfirm=(function(){function a(c){var b;this.root=$(c[0]);b=this.root.down(".token-container");this.token_manager=new TokenManager(b);this.token_manager.populate();b.observe("token:remove",this.remove.bind(this))}a.prototype.remove=function(d){var c,e,b;if(!this.token_manager.tokens.length){return this.root.addClassName("no-recipients")}else{if(d.memo.external){e=this.token_manager.tokens.filter(function(f){return f.info.external});c=e?e.length:0;b=this.root.down(".external_prompt");if(c===0){return b.hide()}else{if(c===1){return b.addClassName("single")}else{return DomUtil.fillVal(c,"external_member_count")}}}}};return a})();var SharingModel;SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(b,a,c){this.filename=b;this.c2d_vars=a;this.c2d_url=c!=null?c:"/sm/c2d";this.init_logger();return on_script_loaded((function(d){return function(){var k,j,g,f,e,i,h;j=$("login-create-an-account");if(j){j.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);if((f=$j("#c2d-register-form"))!=null){f.on("submit",d.c2d_register.bind(d))}if((e=$j("#c2d-login-form"))!=null){e.on("submit",d.c2d_login.bind(d))}if((i=$j("#c2d-twofactor-login-form"))!=null){i.on("submit",d.c2d_twofactor_login.bind(d))}if((h=$j("#download_button_link[data-dl-link]"))!=null){h.on("click",d.download_zip)}d.set_viewport_size();k=function(m,l){return d.do_c2d(l.id)};$j("#c2d-modal .login-form").on(typeof LoginForm!=="undefined"&&LoginForm!==null?LoginForm.LOGIN_SUCCESS:void 0,k);$j("#c2d-modal .register-form").on(typeof RegisterForm!=="undefined"&&RegisterForm!==null?RegisterForm.REGISTER_SUCCESS:void 0,k);g=URI.parse(window.location.href);if(g.getQuery()["force_dl"]){g.updateQuery({force_dl:0,dl:1});return window.location=g.toString()}}})(this))},init_folder:function(a,c,b){this.gallery_enabled=a;this.gallery_showing=c;this.is_folder=true;this.init_lightbox(b);return on_script_loaded((function(d){return function(){return d.load_thumbs()}})(this))},init_album:function(){this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(b){var c,a;a=b.icon.split("_");a.pop();c=a.join("_");return"/static/images/icons128/"+c+".png"},init_disable:function(a){this.init(a.filename,{});this.disabled=true;return $j(".shmodal-image img").attr("src",this.get_thumbnail_for_file(a))},init_logger:function(){on_script_loaded((function(a){return function(){var c,b;c=$("login-hover-link");if(c){c.observe("click",function(){return ShmodelLogger.log(ShmodelLogger.CLICK_SIGN_IN)});c.observe("click",function(){return RegistrationLogger.log("click_sign_in")})}if($("download_button_link")){ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_DOWNLOAD,$("download_button_link"))}c=$("add_to_my_dropbox_link");if(c){ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_ADD_TO_MY_DROPBOX,c);RegistrationLogger.attachLogListener("click_add_to_my_dropbox",c)}if($$(".remove-link").length){ShmodelLogger.attachLogListener(ShmodelLogger.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_FILENAME,$$(".shmodel-filename")[0])}c=$("default_content_download_button");if(c){ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_DOWNLOAD,c)}c=$("default_content_a2md");if(c){ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_ADD_TO_MY_DROPBOX,c)}c=$j("#login-create-an-account")[0];ShmodelLogger.attachLogListener(ShmodelLogger.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,c);c=$j("#login-hover-cont .login-form")[0];ShmodelLogger.attachLogListener(ShmodelLogger.LOGIN_THRU_DEFAULT_DROPDOWN,c);return(b=$j("#share-button"))!=null?b.click(function(d){return ShmodelLogger.log(ShmodelLogger.CLICK_SHARE)}):void 0}})(this));return document.observe(Lightbox.ACTIONS_ADDED,(function(a){return function(){var e,d,b,c;c=$("view_original");if(c){ShmodelLogger.attachLogListener("shmodel_lightbox_click_vieworiginal",c)}d=$("lightbox_share_link");if(d){ShmodelLogger.attachLogListener("shmodel_lightbox_click_getlink",d)}b=$j("lightbox-share-link");if(b[0]){ShmodelLogger.attachLogListener("shmodel_lightbox_click_getlink",b[0])}e=$("lightbox_download_link");if(e){return ShmodelLogger.attachLogListener("shmodel_lightbox_click_download",e)}}})(this))},set_team_only_shmodel:function(b,a){this.team_only_shmodel=b;return this.owner_name=a},_resize_album_view:function(){var a;a=Math.floor((dom.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+a+"px"})},init_lightbox:function(a){return Lightbox.init_from_preview_objs(a,"#gallery-view-media li")},load_thumbs:function(){var b,a;a=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");b=function(c){if(!c.src.endsWith(Sprite.SPACER)){return c.addClassName("thumbnail")}};return LegacyBatchThumbLoader.batch_load_thumbs(a,this.THUMBS_BATCH_SIZE,b)},switch_mode:function(g){var c,h,f,a,e,b,d;d=$A(["gallery","list"]);for(e=0,b=d.length;e<b;e++){a=d[e];h=$(a+"-view-container");c=$(a+"-toggle");if(g===a){h.show();c.addClassName("selected")}else{h.hide();c.removeClassName("selected")}}if(history.replaceState){f=window.location.pathname;if(g==="list"){f+="?lst"}history.replaceState({},"",f)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var a;if($(document.body).hasClassName("mobile")){a=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(a)}},toggle_dropdown:function(d,f,c){var a,b;if(d){Event.extend(d).preventDefault()}if(!f.visible()){if(this.is_album){return FreshDropdown.show(f,c,null,true)}else{b=$$(".nav-header").first().getHeight();a=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(a<0&&Util.ie8){a=4}return FreshDropdown.show(f,c,b-a,true)}}},prepare_confirm_remove_modal:function(b,d,a,f,k,g,j,h){var c,e,i;if(a){i=f?_("Unshare?"):_("Unshare album?");c=$j("#album-disable-token-modal")[0];DomUtil.fillVal(b.escapeHTML(),"album_unshare_name")}else{if(g){i=_("Remove link created by %(name)s").format({name:j});if(d){e=_('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{e=_('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}e=e.format({fname:Emstring.em_snippet(b,17),owner:j,owner_email:h})}else{i=_("Remove link to '%(name)s'").format({name:Emstring.em_snippet(b,17)});if(d){e=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{e=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}c=$j("#disable-token-modal")[0];DomUtil.fillVal(e,"disable-token-desc")}return{title:i,contents:c}},confirm_remove:function(b,f,c,a,d,j,g,i,h){var e;if(c==null){c=false}if(a==null){a=false}if(d==null){d=false}if(j==null){j=null}if(g==null){g=false}if(i==null){i=null}if(h==null){h=null}"Shows a confirm link remove modal where the remove will be driven from a share token.\nIf the user is not logged into her work account, this function will trigger the\nappropriate auth flow.\n\nname:                   file's display name (i.e. not including the path)\nuser_id:                user id for the account that will do the remove, if confirmed.\n                        For admins disabling team members' links, this is the id of the admin's\n                        work account.  For team members disabling links for their own work\n                        accounts, this is the id of that account.\nis_admin_remove:        true for admins disabling team members' links, false otherwise\nlink_owner_name:        the name of the user whose link is being removed; set only when\n                        'is_admin_remove' is true\nlink_owner_email:       the email of the user whose link is being removed; set only when\n                        'is_admin_remove' is true";assert(f,"confirm_remove missing tkey");assert(b,"confirm_remove missing name");assert(j,"confirm_remove missing user_id");assert(!g||!a,"admin removal of collections not supported");assert(!g||i,"missing link owner name for admin removal");assert(!g||h,"missing link owner email for admin removal");if(!Viewer.get_viewer().is_uid_signed_in(j)){MultiaccountLogin.show_modal({user_id:j,on_success:(function(k){return function(){return k.confirm_remove(b,f,c,a,d,j,g,i,h)}})(this)});return}e=SharingModel.prepare_confirm_remove_modal(b,c,a,d,j,g,i,h);return Modal.show(e.title,e.contents,{token:f,name:b,is_album:a,user_id:j})},confirm_remove_from_event_gid:function(a,i,c,h,e,g,f,b){var d;if(e==null){e=false}if(g==null){g=null}if(f==null){f=null}if(b==null){b=null}"Shows a confirm link remove modal where the remove will be driven from an activity log event\ngid.  The user must be a team admin and already logged in to her work account.\n\nname:                   file's display name (i.e. not including the path)\nactivity_log_event_gid_dbase64: non-null when we are deleting from the activity log, in which\n                        case we don't send the tokens to the UI.  The server can fetch the token\n                        from the gid_dbase64.\nis_folder:              true for folders, false for files\nuser_id:                user id for the user's work account.  The user must be already logged\n                        in.\nis_admin_remove:        true for admins disabling team members' links, false\n                        for admins removing their own links\nlink_owner_name:        the name of the user whose link is being removed; set only when\n                        'is_admin_remove' is true\nlink_owner_email:       the email of the user whose link is being removed; set only when\n                        'is_admin_remove' is true\nredirect_to_member_id:  user id that we feed into the remove token endpoint to effect a redirect\n                        to the activity log for this particular user (in order to avoid a URL\n                        change after the removal); null to redirect to the global view";assert(i,"confirm_remove missing event gid");assert(a,"confirm_remove missing name");assert(h,"confirm_remove missing user_id");assert(Viewer.get_viewer().is_uid_signed_in(h),"user not logged in");assert(!e||g,"missing link owner name for admin removal");assert(!e||f,"missing link owner email for admin removal");d=SharingModel.prepare_confirm_remove_modal(a,c,false,false,h,e,g,f);return Modal.show(d.title,d.contents,{name:a,user_id:h,activity_log_event_gid_dbase64:i,redirect_to_member_id:b})},do_remove:function(d){var a,c,b;assert(d.token||d.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");a=$j("#modal-content input").first();a.attr("disabled",true);$j("#modal-content").addClass("ajax-loading");b=window.location.pathname;if((b==="/links"||b==="/links/your_links")||b.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+d.token,{subject_user:d.user_id,onSuccess:(function(e){return function(){var f;Modal.hide();if(d.is_album){f=_("Unshared '%(name)s'")}else{f=_("Removed link for '%(name)s'")}f=f.format({name:d.name});Notify.success(f);return document.fire(FileEvents.LINKS_REMOVE,{token:d.token})}})(this),onComplete:(function(e){return function(){a.attr("disabled",false);return $j("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(d.token){c=URI({path:"/sm/disable/"+d.token})}else{c=URI({path:"/sm/disable_by_event_gid/"+d.activity_log_event_gid_dbase64});c.updateQuery("redirect_to_member_id",d.redirect_to_member_id).toString()}return Forms.postRequest(c.updateQuery(Constants.UID_PARAM_NAME,d.user_id).toString())}},show_shmodal_onload:function(c,d,b,a){if(a==null){a=null}return $j((function(e){return function(){DBHistory.remove_query_param("m");if(!Viewer.get_viewer().is_uid_signed_in(a)){MultiaccountLogin.show_modal({user_id:a,on_success:function(){return e.show_shmodal_onload(c,d,b,a)}});return}if((a!=null)&&EmailVerification.get_for_user(Viewer.get_viewer().get_user_by_id(a)).verified()){return e.show_shmodal(c,d,b,a)}else{if(a==null){assert(Viewer.get_viewer().is_paired,"Expected viewer to be paired.");return e.show_share_shmodel_role_chooser(c,d,b)}}}})(this))},show_shmodal:function(b,h,a,n){var m,j,l,i,f,g,d,c,k,e;this.url=b;this.short_url=h;if(!Viewer.get_viewer().is_uid_signed_in(n)){MultiaccountLogin.show_modal({user_id:n,on_success:(function(o){return function(){return o.show_shmodal(b,h,a,n)}})(this)});return}d=Viewer.get_viewer().get_user_by_id(n);if(EmailVerification.get_for_user(d).verified()){g="shmodal-user-"+n;Modal.show(this._get_shmodal_title(d.is_team),DomUtil.fromElm($(g)).stripScripts());f={};f[Constants.UID_PARAM_NAME]=n;Forms.add_vars("shmodal-send-form",f);if(this._get_thumbnail_type()){e=$$(".shmodal-image");for(c=0,k=e.length;c<k;c++){i=e[c];i.addClassName("thumbnail")}}if(a==="contacts"){l=Autocompleter.ContactsTokenizer}else{l=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new l(d,g+"-new-collab-input",g+"-new-whobulk",g+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:a==="team_only",user_id:n});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){m=clipboard.clipboard_overlay(b,$j("#"+g+"-copy-link"),SharingModel.copied_to_clipboard);m.css({position:"fixed",zIndex:1001});m.children().height(m.height());clearInterval(this.follow_freshbutton);j=(function(o){return function(){return m.clonePosition($j("#"+g+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(j,500)}else{$(g+"-copy-link").hide()}}SickInput._create($("modal").down(".custom-message-container"));SickInput._create($("modal").down(".fb-post-sickinput"));SickInput._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(h,n);$(g+"-new-collab-input").focus();return ShmodelLogger.log("shmodal_show")}},configure_dropdown:function(){var e,b,d,a,c;c=$$(".dropdown-menu-container");for(d=0,a=c.length;d<a;d++){e=c[d];b=e.down(".dropdown-menu-trigger");if(b!=null){b.observe("click",(function(f){return function(h){var g;g=h.target.up(".dropdown-menu-container");return g.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(f){return function(l){var j,k,i,g,h;if(l.target.hasClassName("dropdown-menu-trigger")||l.target.up(".dropdown-menu-trigger")){return}g=$$(".dropdown-shown");h=[];for(k=0,i=g.length;k<i;k++){j=g[k];h.push(j.removeClassName("dropdown-shown"))}return h}})(this))},copied_to_clipboard:function(){Notify.success(_("Link copied to clipboard"));Modal.hide();ShmodelLogger.log("shmodal_copy_link");return analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[FilePath.file_extension(SharingModel.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(c){var d,l,i,m,n,g,j,a,f,e,k,b,h;assert(c,"Must pass the shmodal send form into get_shmodel_send_recipients");d=c.select('input[name="emails"]');l=c.select('input[name="fb_ids"]');i=c.select('input[name="group_ids"]');g=c.select('input[name="new_style_group_ids"]');a=[];h=[d,l,i,g];for(f=0,k=h.length;f<k;f++){n=h[f];for(e=0,b=n.length;e<b;e++){m=n[e];j=m.up().innerHTML.stripTags().escapeHTML();a.push(j.substring(0,j.indexOf("&")))}}return a},send_shmodel_link:function(d){var c,b,f,a;c=$("shmodal-send-form");assert(c,"Couldn't find the shmodal send form.");a=this.get_shmodel_send_recipients(c);f=(function(e){return function(g){var h;h=SharingUtil.success_string_for_recipients(a);Notify.success(h);Modal.hide();return ShmodelLogger.log("shmodal_send")}})(this);b=(function(e){return function(g){return Forms.remove_loading()}})(this);return Forms.ajax_submit(c,"/sm/share",f,b,c.down(".tokenizer-submit-button"))},show_content:function(b){var e,d,a,c;$("shmodal-title-text").__date(ShmodalPanes.to_title_str(b));c=ShmodalPanes.list;for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){$(ShmodalPanes.to_toggle_str(e)).removeClassName("toggled");$(ShmodalPanes.to_content_str(e)).hide()}}$(ShmodalPanes.to_content_str(b)).show();$(ShmodalPanes.to_toggle_str(b)).addClassName("toggled");return $j("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(ShmodalPanes.SEND)},show_fb_content:function(){return this.show_content(ShmodalPanes.FB)},show_twitter_content:function(){return this.show_content(ShmodalPanes.TWITTER)},start_fb_post:function(e,b){var f,c,a,d;c=(function(g){return function(){return FacebookOAuth.do_auth(g.do_fb_post.curry(e,b),b)}})(this);f=$j("#modal:visible, #modal-overlay:visible");a=function(){return f.show()};if(FacebookOAuth.authed_user_id===b){return this.do_fb_post(e,b)}else{if(Viewer.get_viewer().is_uid_associated(FacebookOAuth.authed_user_id)){f.hide();d=new FacebookConfirmModal(Viewer.get_viewer().get_user_by_id(b),a,c.bind(this));return d.show()}else{return c()}}},start_twitter_post:function(a){if(Twitter.is_authed(a)){return this.do_twitter_post(a)}else{return Twitter.do_auth(this.do_twitter_post,a)}},do_fb_post:function(b,a){FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.success(_("Successfully posted to Facebook"));ShmodelLogger.log("shmodal_fb_post");return analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[FilePath.file_extension(SharingModel.filename).toLowerCase()]||"file"})};return FacebookOAuth.post($F("shmodal-fb-post-input"),b,null,null,null,function(){return Modal.hide()},a)},do_twitter_post:function(a){var b;b=$F("shmodal-twitter-post-input");if(!b){Notify.error(_("Please enter a Twitter post"));return}else{if(b.length>140){Notify.error(_("Your post must be 140 characters or less"));return}}Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};return Twitter.custom_post(b,(function(c){return function(){Modal.hide();Notify.success(_("Successfully posted to Twitter"));ShmodelLogger.log("shmodal_tweet");return analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[FilePath.file_extension(SharingModel.filename).toLowerCase()]||"file"})}})(this),a)},_get_shmodal_title:function(a){if(a==null){a=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(b){return function(){return b.show_send_content()}})(this)),((function(b){return function(){return b.show_fb_content()}})(this)),((function(b){return function(){return b.show_twitter_content()}})(this)),a)},generate_title_content:function(b,i,f,k,d){var e,g,a,j,c,h;if(d==null){d=false}j=$j("<div/>",{id:"shmodal-title"});c=$j("<div/>",{id:"shmodal-title-text",text:b});j.append(c);if(!d){a=$j("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});a.html(Sprite.make("web","email_20"));a.on("click",i);g=$j("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});g.html(Sprite.make("web","fb_20"));g.on("click",f);h=$j("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});h.html(Sprite.make("web","twitter_20"));h.on("click",k);j.append([a,g,h])}e=$j("<div/>",{"class":"clear"});j.append(e);return j[0]},_get_shmodal_title_text:function(){var b,a;if(this.is_folder){b=_("Share link to '%(folder_name)s'");return b=b.format({folder_name:Emstring.em_snippet(this.filename,15)})}else{a=this._get_thumbnail_type();if(a===BrowseFile.CATEGORY_TO_TRANSLATION.IMAGE){return _("Share this image")}else{if(a===BrowseFile.CATEGORY_TO_TRANSLATION.VIDEO){return _("Share this video")}else{return _("Share '%(filename)s'").format({filename:Emstring.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var b,a;if(this.filename.indexOf(".")===-1){return false}a=FilePath.file_extension(this.filename).toLowerCase();b=BrowseFile.EXTENSION_TO_CATEGORY[a];if(b&&(b==="IMAGE"||b==="VIDEO")){return BrowseFile.CATEGORY_TO_TRANSLATION[b]}return false},_populate_twitter_info:function(c,a){var d,b;d=this.is_folder?_("Just shared some files using @Dropbox"):(b=this._get_thumbnail_type(),b&&b===BrowseFile.CATEGORY_TO_TRANSLATION.IMAGE?_("Just shared an image using @Dropbox"):_("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(d+" "+c);Util._track_twitter_chars_left("shmodal-twitter-post-input",140);if(Twitter.is_authed(a)){return Twitter.get_user_info(function(e){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:e.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(e.name);$("shmodal-twitter-profile").down(".username").__date("@"+e.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},a)}},download_zip:function(d){var b,c,e,a,f;b=$j("#download_button_link").attr("data-dl-link");f=$j("#download_button_link").attr("data-test-link");a=$j("#download_button_link").attr("data-owner")==="true";e=(function(g){return function(h){var i;if(h==="OK"){window.location=b}else{if(h.indexOf("err:")===0){if(a){i=_("The zip file is too large.")}else{i=_("The zip file is too large. Please add it to your Dropbox.")}Notify.error(i)}else{Notify.error(_("Failed to download zip file."))}}return false}})(this);c=(function(g){return function(h){Notify.error(_("Failed to download zip file."));return false}})(this);if(f&&$j.support.cors===true){$j.ajax({url:f,type:"POST",success:e,error:c})}else{window.location=b}return false},show_share_shmodel_role_chooser:function(b,c,a){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new ShareShmodelSelectRoleModal({element_id:"share-shmodel-select-role-modal",link_url:b,short_url:c,tokenizer_type:a})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(b,c,a,e){var d;d=(function(f){return function(){var g;Modal.hide();$j("#role-selector option").removeClass("disabled");g=Viewer.get_viewer().get_uid_by_role(e);Viewer.get_viewer().sign_in_user_by_id(g);ShmodelUILogger.log("via-shmodel-viewer");return SharingModel.show_shmodal(b,c,a,g)}})(this);if(!Viewer.get_viewer().is_role_signed_in(e)){SharingState.not_logged_in_role=e;return MultiaccountLogin.show_modal({role:e,on_success:d})}else{return d()}},show_c2d_modal:function(h,b){var g,a,f,d,e,c;if(h==null){h=""}if(b==null){b=false}"If a role is passed in:\n  If the role is not logged in, that role will be prompted to login.\n  If the role is logged in, we'll show the c2d for that role.\nIf no role is passed in:\n  If the viewer is paired: (and thus logged in)\n    We'll present a role chooser.\n  If the viewer is logged in: (and not paired)\n    We'll present the c2d modal for the logged in unpaired user.\n  If the viewer isn't logged in:\n    We'll present the c2d modal that lets them login or register.";if(h){if(h===Constants.ROLE_PERSONAL){assert(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!Viewer.get_viewer().is_role_signed_in(h)){MultiaccountLogin.show_modal({role:h,on_success:(function(i){return function(){return i.show_c2d_modal(h)}})(this)});return}}else{if(Viewer.get_viewer().is_paired){new ShmodelC2DSelectRoleModal({element_id:"select-role-modal"}).show();return}}if(h){d="#c2d-modal-"+h}else{d="#c2d-modal"}e=this._c2d_modal_msg(h,Viewer.get_viewer().team_name);g=this._c2d_modal_button_msg(h,Viewer.get_viewer().team_name);a=this._c2d_modal_desc(h,Viewer.get_viewer().team_name);if(b){a=this._c2d_modal_team_only_desc(Viewer.get_viewer().team_name)+"<br/><br/>"+a}f=this._c2d_modal_login_desc(h,Viewer.get_viewer().team_name);DomUtil.fillVal(a,"c2d-desc");DomUtil.fillVal(f,"c2d-login-desc");if((c=$j(".c2d-submit-button"))!=null){c.val(g)}$j(".c2d-login-register-desc").hide();if(this.is_album){$j(".c2d-login-register-album-desc").show()}else{if(this.is_folder){$j(".c2d-login-register-folder-desc").show()}else{$j(".c2d-login-register-file-desc").show()}}return Modal.show(e,$j(d)[0],false,false,false,false)},_c2d_modal_msg:function(d,b){var a,c;if(d==null){d=""}if(b==null){b=""}if(this.c2d_vars.title){return c=this.c2d_vars.title}else{if(d===Constants.ROLE_PERSONAL){c=_("Save '%(filename)s' to my personal Dropbox");return c.format({filename:Emstring.em_snippet(this.filename,10)})}else{if(d===Constants.ROLE_WORK){c=_("Save '%(filename)s' to my %(team_name)s Dropbox");a=Math.max(10,15-new Emstring(b).length);return c.format({filename:Emstring.em_snippet(this.filename,a),team_name:b})}else{c=_("Save '%(filename)s' to my Dropbox");return c.format({filename:Emstring.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){return b=_("Save to my personal Dropbox")}else{if(c===Constants.ROLE_WORK){b=_("Save to my %(team_name)s Dropbox");return b.format({team_name:a})}else{return _("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(a){var b;if(this.is_album){b=_("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){b=_("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{b=_("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return b.format({owner_name:this.owner_name,team_name:a})},_c2d_modal_desc:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){b=_("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){b=_("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){b=_("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(c===Constants.ROLE_WORK){if(this.is_album){b=_("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){b=_("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{b=_("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return b.format({team_name:a})}else{if(this.is_album){return _("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return _("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return _("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){if(this.is_album){return b=_("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return b=_("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return b=_("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(c===Constants.ROLE_WORK){if(this.is_album){b=_("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){b=_("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{b=_("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return b.format({team_name:a})}}},c2d_register:function(b){var a,c;b.preventDefault();a=$("c2d-register-form");c=(function(d){return function(f){var e;e=JSON.parse(f.responseText);Constants.TOKEN=e.csrf_token;return d.do_c2d(e.id)}})(this);return Forms.ajax_submit(a,"/ajax_register",c,false,$(a).down("input[type=submit]"))},c2d_login:function(d,a){var c,b,f;if(a==null){a="c2d-login-form"}d.preventDefault();c=$(a);f=(function(e){return function(h){var g;g=JSON.parse(h.responseText);switch(g.status){case"OK":Constants.TOKEN=g.csrf_token;return e.do_c2d(g.id);case"TWOFACTOR":return e.show_c2d_twofactor(g.last_four_digits);case"SSO":return window.location=g.sso_url}}})(this);b=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(c,"/ajax_login",f,b,$(c).down("input[type=submit]"))},show_c2d_twofactor:function(a){$("c2d-login").hide();if(a){$("c2d-twofactor-login").addClassName("sms");DomUtil.fillVal(a,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(a){return function(b){switch(b.responseText.strip()){case"OK":return Notify.success(_("We sent you another code. It may take a few minutes to arrive."));case"UNREACHABLE":return a.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return a.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return a.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return a.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":a.hide_c2d_twofactor();return Notify.error(_("Sorry, your phone code has expired. Please log in again."))}}})(this),onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(c){var b,a,d;c.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}b=$("c2d-twofactor-login-form");d=(function(e){return function(g){var f;f=JSON.parse(g.responseText);switch(f.status){case"OK":Constants.TOKEN=f.csrf_token;return e.do_c2d(f.id);case"INVALID":return e.c2d_show_twofactor_error_invalid();case"EXPIRED":e.hide_c2d_twofactor();return Notify.error(_("Sorry, your phone code has expired. Please log in again."))}}})(this);a=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(b,"/ajax_verify_code",d,a)},do_c2d:function(a){var b;assert(a,"Must specify a user_id for saving to Dropbox.");b=_("Saving to your Dropbox...");if(Viewer.get_viewer().is_paired){if(Viewer.get_viewer().get_user_by_id(a).is_team){b=_("Saving to your %(team_name)s Dropbox...");b=b.format({team_name:Viewer.get_viewer().team_name})}else{b=_("Saving to your personal Dropbox...")}}Notify.success(b);Modal.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:b,subject_user:a,onSuccess:(function(c){return function(d){if(d.responseText&&d.responseText[0]==="/"){return window.location.href=d.responseText}else{if(d.responseText==="snapshot_ok"){return Notify.success(_("Successfully saved to your Dropbox."))}}}})(this)})},c2d_show_twofactor_error:function(b){var a;a=$("c2d-twofactor-error");a.__date(b);return a.show()},c2d_hide_twofactor_error:function(a){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(_("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(_("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(_("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(_("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(_("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(_("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var ShmodalPanes;ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",_("Share on Facebook"),_("Share on Twitter")],to_content_str:function(a){return this._content_str[a]},to_toggle_str:function(a){return this._toggle_str[a]},to_title_str:function(a){if(a===0){return SharingModel._get_shmodal_title_text()}return this._title_str[a]},to_focus_str:function(a){return this._focus_str[a]}};var ShareLinkModal,ShareLinkModalContent,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ShareLinkModal=(function(a){__extends(b,a);function b(c,e,d){var f;this.user_id=c;this.before_show=__bind(this.before_show,this);this.show=__bind(this.show,this);this.prompt_login_then_show=__bind(this.prompt_login_then_show,this);f={origin:d};f[Constants.UID_PARAM_NAME]=this.user_id;b.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:URI({path:"/sm/share_link"+e}).toString(),parameters:f})}b.prototype.prompt_login_then_show=function(){var c;c=(function(d){return function(){Modal.hide();$j("#role-selector option").removeClass("disabled");Viewer.get_viewer().sign_in_user_by_id(d.user_id);ShmodelUILogger.log("via-shmodel-viewer");return d.show()}})(this);if(!Viewer.get_viewer().is_uid_signed_in(this.user_id)){return MultiaccountLogin.show_modal({user_id:this.user_id,on_success:c})}else{return c()}};b.prototype.show=function(){var c;c=Viewer.get_viewer().get_user_by_id(this.user_id);if(EmailVerification.get_for_user(c).verified()){return b.__super__.show.call(this)}};b.prototype.before_show=function(){var f,e,c,d;d=this.$modal_window.find(".share-link-modal-content").length;if(d){f={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small.gif"};c=$j("<img />",f);e=$j("<div />",{"class":"loading-spinner"}).append(c);return this.$modal_window.find(".dynamic-content").html(e)}};return b})(DBModalLoading);ShareLinkModalContent=(function(){function a(f,g,h,i,b,c,l,e,j){var k,d;this.owner_id=f;this.tkey=g;this.fq_path=h;this.link=i;this.filename=b;this.tokenizer_type=c;this.tokenizer_ctx_str=l;this.fq_path_of_restricting_sf=j;this._send_link=__bind(this._send_link,this);this._show_shared_link_settings_modal=__bind(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=__bind(this._show_shared_folder_settings_modal,this);this._select_all_text=__bind(this._select_all_text,this);this._toggle_send_link_button=__bind(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=__bind(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=__bind(this._toggle_close_button_text,this);this._listen=__bind(this._listen,this);this._init_autocompleter=__bind(this._init_autocompleter,this);this.$content=$j(".share-link-modal-content");this.modal=DBModal.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=ContactsList.create_contacts_list(e)}k={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(FileEvents.LINKS_ADD,k);this.modal.set_title(_("Share link to '%(filename)s'").format({filename:Emstring.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((d=this.$share_link_url_input[0])!=null){d.select()}}a.prototype._init_autocompleter=function(){var b;b={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(Viewer.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",b,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(Viewer.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",b)}else{this.autocompleter=new Autocompleter.TeamTokenizer(Viewer.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",b)}}SickInput.init();return this.$collab_input.focus()};a.prototype._listen=function(){var c,b,f,e,d;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(g){return function(h){return DBModalStack.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((c=this.$collab_input)!=null){c.keyup(this._toggle_send_link_button)}if((b=this.$collab_input[0])!=null){b.observe("token:remove",this._toggle_send_link_button)}if((f=this.$collab_input[0])!=null){f.observe("token:add",this._toggle_close_button_text)}if((e=this.$collab_input[0])!=null){e.observe("token:remove",this._toggle_close_button_text)}return(d=this.$collab_input[0])!=null?d.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};a.prototype._toggle_close_button_text=function(d){var b,c;b=((c=this.autocompleter)!=null?c.token_manager.tokens.length:void 0)===0;if(b){return this.$cancel_button.text(_("Close"))}else{return this.$cancel_button.text(_("Cancel"))}};a.prototype._toggle_recipients_outside_team_warning=function(d){var b,c;b=$j(".external-recipient-warning-message");if(b.length){c=d.memo.count;if(d.memo.shared_folder_warning){if(c>0){return b.show()}else{return b.hide()}}else{if(c>1){b.find(".external-recpient-num").text(c);return b.removeClass("single").show()}else{if(c===1){return b.addClass("single").show()}else{return b.hide()}}}}};a.prototype._toggle_send_link_button=function(d){var b,c;b=((c=this.autocompleter)!=null?c.token_manager.tokens.length:void 0)===0;b=b&&$j.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",b)};a.prototype._select_all_text=function(b){return $j(b.currentTarget)[0].select()};a.prototype._show_shared_folder_settings_modal=function(c){var b;c.preventDefault();b=Viewer.get_viewer().get_user_by_id(this.owner_id);return SharingModals.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,b)};a.prototype._show_shared_link_settings_modal=function(c){var b;c.preventDefault();b=new SharedLinkSettingsModal(this.owner_id,this.tkey);return DBModalStack.push(b)};a.prototype._send_link=function(g){var d,c,f,b,h;f=this.$content.find(".share-link-modal-send-form")[0];b=this.get_shmodel_send_recipients(f);h=(function(e){return function(i){var j;j=SharingUtil.success_string_for_recipients(b);Notify.success(j);DBModalStack.pop();return ShmodelLogger.log("shmodal_send")}})(this);c=(function(e){return function(i){return Forms.remove_loading()}})(this);d=this.$content.find(".tokenizer-submit-button")[0];return Forms.ajax_submit(f,"/sm/share",h,c,d)};a.prototype.get_shmodel_send_recipients=function(d){var e,m,j,n,o,h,k,b,g,f,l,c,i;assert(d,"Must pass the shmodal send form into get_shmodel_send_recipients");e=d.select('input[name="emails"]');m=d.select('input[name="fb_ids"]');j=d.select('input[name="group_ids"]');h=d.select('input[name="new_style_group_ids"]');b=[];i=[e,m,j,h];for(g=0,l=i.length;g<l;g++){o=i[g];for(f=0,c=o.length;f<c;f++){n=o[f];k=n.up().innerHTML.stripTags().escapeHTML();b.push(k.substring(0,k.indexOf("&")))}}return b};return a})();var SharedLinkSettingsModal,SharedLinkSettingsModalContent,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};SharedLinkSettingsModal=(function(b){__extends(a,b);function a(c,d){var e;this.owner_id=c;this.tkey=d;e={tkey:this.tkey};e[Constants.UID_PARAM_NAME]=this.owner_id;a.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:e})}return a})(DBModalLoading);SharedLinkSettingsModalContent=(function(){function a(c,d,b,f){var g,e;this.owner_id=c;this.tkey=d;this.filename=b;this.saved_password_placeholder_value=f;this._save_settings=__bind(this._save_settings,this);this._toggle_password_input=__bind(this._toggle_password_input,this);this._enable_password_input_for_editing=__bind(this._enable_password_input_for_editing,this);this._date_change_callback=__bind(this._date_change_callback,this);this._show_calendar=__bind(this._show_calendar,this);this._hide_calendar=__bind(this._hide_calendar,this);this._future_date=__bind(this._future_date,this);this._enable_save_button=__bind(this._enable_save_button,this);this._custom_expiry_click_handler=__bind(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=__bind(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=__bind(this._show_custom_expiry_label,this);this._toggle_expiration=__bind(this._toggle_expiration,this);this._expiry_picker_callback=__bind(this._expiry_picker_callback,this);this._listen=__bind(this._listen,this);this._detect_and_handle_blur_when_password_empty=__bind(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=__bind(this._is_clicked,this);this._change_password_click=__bind(this._change_password_click,this);this._init_expiration_section=__bind(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=$j(".sharing-settings-modal-content");this.modal=DBModal.get_containing_modal(this.$content);if(!this.modal){return}e=_("'%(filename)s' permission settings").format({filename:Emstring.em_snippet(this.filename,18)});this.modal.set_title(e);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(g=true)}this._init_expiration_section();this._listen()}a.prototype._init_expiration_section=function(){var b;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){$j("#expiration-yes").prop("checked",true);b=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(b);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};a.prototype._change_password_click=function(b){b.preventDefault();return this._enable_password_input_for_editing()};a.prototype._is_clicked=function(b,c){return b.is(c.target)||b.has(c.target).length};a.prototype._detect_and_handle_blur_when_password_empty=function(b){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,b)){return}return this._show_password_input(true)};a.prototype._listen=function(){if(this.loaded_with_saved_password){$j(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(b){return function(c){return DBModalStack.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return $j(window).on(BubblePicker.CHANGED,this._expiry_picker_callback)};a.prototype._expiry_picker_callback=function(f,d){var b,c;b=d.clicked_val;if(b!=="custom"){c=this._future_date(parseInt(b));return this._set_expiration(c)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};a.prototype._toggle_expiration=function(d){var c,b;if($j(d.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();$j(".expiration-picker").controller().set_value(30);b=30;c=this._future_date(b);this._set_expiration(c);return this._set_selected_date_text(c)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};a.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return $j(window).on("click",this._custom_expiry_click_handler)};a.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return $j(window).off("click",this._custom_expiry_click_handler)};a.prototype._custom_expiry_click_handler=function(b){if(this._is_clicked(this.$calendar,b)){return}if(this.$selected_date_box.is(b.target)||this.$selected_date_box.has(b.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};a.prototype._enable_save_button=function(b){return this.$save_button.removeAttr("disabled")};a.prototype._future_date=function(b){var c;c=Util.start_of_day(new Date());c.setDate(c.getDate()+b);return c};a.prototype._hide_calendar=function(){return this.$calendar.hide()};a.prototype._show_calendar=function(){var d,c,b;$j(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){b=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{b=this._future_date(30)}c={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:b,onDateChange:$j.proxy(this._date_change_callback,this)};this.calendar=new DBCalendar("expiration-calendar-container",c)}else{this.$calendar.show()}d=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:d})};a.prototype._posix_time_to_date=function(b){return new Date(b*1000)};a.prototype._set_selected_date_text=function(b){return this.$selected_date.text(DateUtil.localize(b))};a.prototype._set_expiration=function(c){var b,d;assert(c.getMilliseconds()===0);assert(c.getSeconds()===0);assert(c.getMinutes()===0);assert(c.getHours()===0);d=(c.getTime()+this.MS_PER_DAY)/1000;b=d-1;return this.$expiry_posix.val(b)};a.prototype._date_change_callback=function(b){this._set_selected_date_text(b);this._set_expiration(b);this._enable_save_button();return this._hide_calendar()};a.prototype._show_password_input=function(g){var f,d,c,e,b;if(g==null){g=false}f=this.$content.find("label[for=audience-password]").position().left;e=this.$content.find("#audience-password").position().left;d=f-e+10;this.$password.show().css({left:d});this.$password_input.val("");if(g){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");b="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(b).show();c=this.$password.position();return this.$change_password.css({left:c.left,top:c.top}).show()}else{return this._enable_password_input_for_editing()}};a.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(_("Set password")).show();this.$password_input.focus();return this._enable_save_button()};a.prototype._toggle_password_input=function(b){var c;if($j(b.currentTarget).attr("id")==="audience-password"){return this._show_password_input(c=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};a.prototype._save_settings=function(f){var c,b,d,g;if(this.$password_input.data("is-saved-password")==="yes"){d={type:"hidden",name:"password",value:this.saved_password_placeholder_value};c=$j("<input />",d);this.$form.append(c);this.$password_input.attr("name","inoperative_password")}g=(function(e){return function(h){DBModalStack.pop();return Notify.success(_("Permission settings saved."))}})(this);b=(function(e){return function(h){if(e.$password.length&&e.$password.is(":visible")){e.$password_input.focus()}return Forms.remove_loading()}})(this);return Forms.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",g,b,this.$save_button[0])};return a})();var Foshmodal,FoshmodalPanes;FoshmodalPanes=Object.clone(ShmodalPanes);FoshmodalPanes.to_title_str=function(){var a,b,f,d,e,c;if(Foshmodal.sharing_collection){d=Emstring.em_snippet(Foshmodal.collection_to_share.name,18,1);return _("Share '%(snippeted_name)s'").format({snippeted_name:d})}else{a=Foshmodal._selection;c=PhotosUtil.categorize_files(a),b=c[0],f=c[1];if(b&&f){e=ungettext("Share %(file_count)s item","Share %(file_count)s items",a.length)}else{if(b){e=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",a.length)}else{e=ungettext("Share %(file_count)s video","Share %(file_count)s videos",a.length)}}e=e.format({file_count:a.length});return e}};Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:FoshmodalPanes.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=FoshmodalPanes.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;PhotosSelection.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();$j(".link-image").attr("src","static/images/empty_album_big.png");Forms.remove_loading($j("#modal").find(".tokenizer-submit-button")[0]);Forms.remove_loading($j("#modal").find(".foshmodal-copy-link")[0]);Forms.remove_loading($j("#shmodal-twitter-post-submit")[0]);return Forms.remove_loading($j("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(a){var b;assert(this._selection.length,"This should never be called with an empty selection");assert(this.current_tkey!=null,"Missing tkey");assert(this.current_shmodel_url!=null,"Missing shmodel url");assert(this.current_short_url!=null,"Missing short url");assert(a!=null,"Missing collection info");a.is_anonymous=this.creating_anonymous_collection();a.share_tkey=this.current_tkey;a.shmodel_url=this.current_shmodel_url;a.short_url=this.current_short_url;return b=new PhotoCollection(a)},set_shmodel_url:function(b,a){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof b==="function"?b():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(c){return function(e){var d;d=JSON.parse(e.responseText);c.current_shmodel_url=d.token_link;c.current_short_url=d.short_link;c.current_tkey=d.tkey;if(typeof b==="function"){b()}return typeof c.callback_for_when_we_have_shmodel_url==="function"?c.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof a==="function"?a():void 0}})}},attach_collection_to_token:function(b,a){assert(this.collection_to_share!=null,"Should get called only when there is an existing collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof b==="function"){b(this.collection_to_share.gid)}return}assert(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,b,a)},create_collection_and_attach_to_token:function(f,a){var c,e,d,b;assert(this.sharing_collection===false,"Should not get called when we already have a collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");e=(function(g){return function(h){var i;i=JSON.parse(h.responseText);g.create_album_from_selected_photos(i);return typeof f==="function"?f(i.gid):void 0}})(this);c=function(g){return typeof a==="function"?a(g):void 0};d={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var j,h,i,g;i=this._selection;g=[];for(j=0,h=i.length;j<h;j++){b=i[j];g.push(b.item_counter)}return g}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:e,onFailure:c,parameters:d})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){Notify.error(_("Please enter a name for this album"));this.unlock();return true}if(PhotosCollections.collection_name_in_use(this.current_album_name)){Notify.error(_("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(c){var b,a;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}b=$("shmodal-send-form");assert(b,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}a=(function(d){return function(e){d.unlock();if(!e.responseText.startsWith("err:")){Notify.error(_("We couldn't send this album. Please try again."));Modal.hide();return d.refresh()}}})(this);if(this.sharing_collection){this.send_collection(b,a)}else{this.send_selection(b,a)}return PhotosLogger.log_interaction(PhotosEvents.SEND,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var d,b,c,a,e;d=this.get_current_display_name();a=SharingModel.get_shmodel_send_recipients($("shmodal-send-form"));b=a[0].split(" ")[0];if(a.length===1){e=_("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:d,first_name_of_recipient:b})}else{if(a.length===2){c=a[1].split(" ")[0];e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:d,first_name_of_recipient:b,first_name_of_second_recipient:c})}else{e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:d,first_name_of_recipient:b,num_other_recipients:a.length-1})}}return e},send_selection:function(c,b){var e,d,a;e=(function(f){return function(g){var h;h=JSON.parse(g.responseText);f.create_album_from_selected_photos(h);Notify.success(f.get_send_success_text());f.refresh();return Modal.hide()}})(this);d={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var i,g,h,f;h=this._selection;f=[];for(i=0,g=h.length;i<g;i++){a=h[i];f.push(a.item_counter)}return f}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}if(this.creating_anonymous_collection()){d.collection_name=""}else{if(this.current_album_name.trim().length===0){d.collection_name=PhotosCollections.get_default_album_name()}}return Forms.ajax_submit(c,"/collection_create_and_send_link",e,b,c.down(".tokenizer-submit-button"),d)},send_collection:function(b,a){var c;assert(this.current_tkey!=null,"tkey should be set");assert(this.current_shmodel_url!=null,"shmodel url should be set");c=(function(d){return function(){Notify.success(d.get_send_success_text());Modal.hide();return d.refresh()}})(this);return this.collection_to_share.send_link(b,this.current_tkey,this.current_shmodel_url,this.current_short_url,c,a)},get_link_button_onclick:function(){var a,c,b;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}b=$("modal").down(".tokenizer-submit-button");c=(function(d){return function(f){var e;e=d.get_current_display_name();if(FlashDetect.installed){Notify.success(_("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:e}))}d.show_get_link_modal(d.current_shmodel_url,e,f);analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(d.collection_to_share!=null){AlbumsLogger.log_share("share_link",f,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)}return d.refresh()}})(this);a=(function(d){return function(e){d.unlock();Forms.remove_loading(b);if(!e.responseText.startsWith("err")){Notify.error(_("We couldn't create a link to this album. Please try again."));Modal.hide();return d.refresh()}}})(this);if(this.sharing_collection){Forms.add_loading(b);this.attach_collection_to_token(c,a)}else{if(this.alert_if_album_name_invalid()){return}Forms.add_loading(b);this.create_collection_and_attach_to_token(c,a)}return PhotosLogger.log_interaction(PhotosEvents.GET_LINK,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var a,b;if(FlashDetect.installed){a=clipboard.clipboard_overlay(this.current_shmodel_url,$j("#foshmodal-copy-link"),Foshmodal.get_link_button_onclick.bind(this));a.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);b=(function(c){return function(){return a.clonePosition($j("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(b,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(g,b){var f,c,a,d;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(g,b);return}f=$j("#modal:visible, #modal-overlay:visible");a=function(){return f.show()};c=(function(e){return function(){e.lock();setTimeout(e.unlock.bind(e),750);return FacebookOAuth.do_auth((function(){return e.do_fb_post(b)}),b)}})(this);if(FacebookOAuth.authed_user_id===b){this.do_fb_post(b)}else{if(Viewer.get_viewer().is_uid_associated(FacebookOAuth.authed_user_id)){this.unlock();f.hide();d=new FacebookConfirmModal(Viewer.get_viewer().get_user_by_id(b),a,c.bind(this));d.show()}else{c()}}return PhotosLogger.log_interaction(PhotosEvents.FB_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(b,a){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(b,a);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(Twitter.is_authed(a)){this.do_twitter_post(a)}else{setTimeout(this.unlock.bind(this),750);Twitter.do_auth(((function(c){return function(){return c.do_twitter_post(a)}})(this)),a)}return PhotosLogger.log_interaction(PhotosEvents.TWITTER_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(a){var b,c;b=(function(d){return function(){Notify.error(_("We couldn't share this album on Facebook. Please try again."));Modal.hide();return d.refresh()}})(this);c=(function(d){return function(f){var e;FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.progress_container=$("modal").down(".modal-buttons");e=d.get_current_display_name();FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.success(_("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:e}));return d.refresh()};FacebookOAuth.post($F("shmodal-fb-post-input"),d.current_shmodel_url,null,null,null,b,a);analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return AlbumsLogger.log_share("share_facebook",f,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(c,b)}else{return this.create_collection_and_attach_to_token(c,b)}},do_twitter_post:function(a){var d,b,c;d=$F("shmodal-twitter-post-input");if(!d){Notify.error(_("Please enter a tweet"));this.unlock();return}if(d.length>140){Notify.error(_("Your tweet must be 140 characters or less"));this.unlock();return}c=(function(e){return function(f){Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};Twitter.custom_post(d,function(){Modal.hide();Notify.success(_("Your tweet has been posted!"));return e.refresh()},a);analytics.ViralLogger.log(Viewer.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return AlbumsLogger.log_share("share_twitter",f,e.num_photos_to_share,e.creating_anonymous_collection(),!e.sharing_collection)}})(this);b=(function(e){return function(){Notify.error(_("We couldn't share this album on Twitter. Please try again."));Modal.hide();return e.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(c,b)}else{return this.create_collection_and_attach_to_token(c,b)}},show_get_link_modal:function(b,a,c){var d;Modal.show(_("Link to %(album_name)s").format({album_name:a.escapeHTML()}),$("get-link-modal"));d=$("get-link-modal").down(".link-input");d.setValue(b);d.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(b,"_blank");return Modal.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(c!=null){PhotosCollections.flash_sidebar_album(c)}return Modal.hide()}},update_current_album_name_text:function(a){this.current_album_name=$(FoshmodalPanes.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===FoshmodalPanes.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(e){var b,d,c,a;a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(e){if(this.num_photos_to_share===1){b=e}else{b=_("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:e,album_desc:PhotosUtil.file_desc(a)})}}else{if(a.length===1){c=a[0];if(c.preview_type==="photo"){d=_("Photo from %(date_taken)s")}else{d=_("Video from %(date_taken)s")}b=d.format({date_taken:datetime.nice_date_with_month_name(new Date(c.time_taken),true,true,true)})}else{b=PhotosUtil.file_desc(a)}}return $(FoshmodalPanes.to_content_str(FoshmodalPanes.FB)).down(".link-name").__date(b)},set_current_album_name_text:function(b,a){$(FoshmodalPanes.to_content_str(b)).down(".album-name-input").value=a;if(b===FoshmodalPanes.FB){return this.set_fb_post_title(a)}},show_content:function(e){var b,d,a,c;if(this.working){return}$("shmodal-title-text").__date(FoshmodalPanes.to_title_str());c=FoshmodalPanes.list;for(d=0,a=c.length;d<a;d++){b=c[d];if(b!==e){$(FoshmodalPanes.to_toggle_str(b)).removeClassName("toggled");$(FoshmodalPanes.to_content_str(b)).hide()}}$(FoshmodalPanes.to_content_str(e)).show();$(FoshmodalPanes.to_toggle_str(e)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(e,this.current_album_name)}switch(e){case FoshmodalPanes.FB:$("shmodal-fb-post-input").focus();break;case FoshmodalPanes.TWITTER:$("shmodal-twitter-post-input").focus();break;case FoshmodalPanes.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=e},_get_foshmodal_title:function(){return SharingModel.generate_title_content(FoshmodalPanes.to_title_str(),((function(a){return function(){return a.show_content(FoshmodalPanes.SEND)}})(this)),((function(a){return function(){return a.show_content(FoshmodalPanes.FB)}})(this)),((function(a){return function(){return a.show_content(FoshmodalPanes.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return PhotosUtil.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var a,c,b,e,d;a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(a.length===1){d=PhotosUtil.categorize_files(a),b=d[0],e=d[1];if(b){c=_("Just shared a photo using @Dropbox")}else{if(e){c=_("Just shared a video using @Dropbox")}else{assert(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{c=_("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+c+" "+this.current_short_url)},update_shmodal_image_text:function(){var h,k,j,f,e,i,a,g,d,c,b;if(this.sharing_collection){k=this.collection_to_share.num_items;j=PhotosUtil.album_desc(this.collection_to_share,false,true)}else{k=this._selection.length;j=PhotosUtil.file_desc(this._selection,false,true)}if(k>1){g=$$(".shmodal-image");c=[];for(f=0,i=g.length;f<i;f++){h=g[f];h.down("span").__date(j);c.push(h.down(".share-file-count").show())}return c}else{d=$$(".shmodal-image");b=[];for(e=0,a=d.length;e<a;e++){h=d[e];b.push(h.down(".share-file-count").hide())}return b}},show:function(i,p){var j,m,n,k,o,g,f,d,l,b,a,h,e,c;this.unlock();Modal.onHide=(function(q){return function(){var s,r;if((s=$("flash_copy_container"))!=null){s.remove()}if((r=q.send_link_autocompleter)!=null){r.hide()}$j("#modal").find(".new-collab-input").val("");clearInterval(q.follow_freshbutton);Photos.disable_selection();delete Modal.onHide;return Modal.hide()}})(this);this.sharing_collection=p;o=this.sharing_collection?i.thumbnail_url_256:i[0].thumbnail_url;h=$$(".link_image");for(g=0,l=h.length;g<l;g++){m=h[g];if(o!=null){m.src=o}else{m.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=FoshmodalPanes.SEND;this.have_real_tkey=this.sharing_collection&&(i.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=i;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=i.sort(function(r,q){return r.time_taken-q.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");e=$$(".save-as-album-checkbox");for(f=0,b=e.length;f<b;f++){j=e[f];j.checked=false;k=(function(q){return function(z){var A,w,u,s,r,v,t,y,x;if(z.target.checked){$("shmodal").addClassName("saving-as-album");q.current_album_name=q.previous_album_name||PhotosCollections.get_default_album_name();q.set_current_album_name_text(q.current_foshmodal_pane,q.current_album_name);A=$(FoshmodalPanes.to_content_str(q.current_foshmodal_pane)).down(".album-name-input");A.focus();A.select();v=$$(".save-as-album-checkbox");y=[];for(w=0,s=v.length;w<s;w++){j=v[w];y.push(j.checked=true)}return y}else{$("shmodal").removeClassName("saving-as-album");q.previous_album_name=q.current_album_name;q.current_album_name="";q.set_current_album_name_text(q.current_foshmodal_pane,q.current_album_name);t=$$(".save-as-album-checkbox");x=[];for(u=0,r=t.length;u<r;u++){j=t[u];x.push(j.checked=false)}return x}}})(this);j.observe("change",k);if(Browser.msie_version_at_most(8)){j.observe("click",k)}}c=$$(".album-name-input");for(d=0,a=c.length;d<a;d++){n=c[d];n.observe("keyup",this.update_current_album_name_text.bind(this))}}Photos.enable_selection();Modal.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(q){return function(){q.initialize_get_link_button();return q.set_twitter_message()}})(this)),(function(){Notify.error(_("This request could not be completed.  Please try again."));return Modal.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(Viewer.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();ActAsBlock.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return Util._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(b,g){var d={};function c(m,n){var l,j=[];for(var k=0;k<m.length;++k){l=d[m[k]]||e(m[k]);if(!l){throw"module definition dependecy not found: "+m[k]}j.push(l)}n.apply(null,j)}function h(k,j,i){if(typeof k!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(j===g){throw"invalid module definition, dependencies must be specified"}if(i===g){throw"invalid module definition, definition function must be specified"}c(j,function(){d[k]=i.apply(null,arguments)})}function f(i){return !!d[i]}function e(l){var j=b;var i=l.split(/[.\/]/);for(var k=0;k<i.length;++k){if(!j[i[k]]){return}j=j[i[k]]}return j}function a(l){for(var k=0;k<l.length;k++){var m=b;var o=l[k];var j=o.split(/[.\/]/);for(var n=0;n<j.length-1;++n){if(m[j[n]]===g){m[j[n]]={}}m=m[j[n]]}m[j[j.length-1]]=d[o]}}h("moxie/core/utils/Basic",[],function(){var q=function(v){var u;if(v===u){return"undefined"}else{if(v===null){return"null"}else{if(v.nodeType){return"node"}}}return({}).toString.call(v).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var m=function(v){var u;o(arguments,function(w,x){if(x>0){o(w,function(z,y){if(z!==u){if(q(v[y])===q(z)&&!!~s(q(z),["array","object"])){m(v[y],z)}else{v[y]=z}}})}});return v};var o=function(z,A){var y,w,v,x;if(z){try{y=z.length}catch(u){y=x}if(y===x){for(w in z){if(z.hasOwnProperty(w)){if(A(z[w],w)===false){return}}}}else{for(v=0;v<y;v++){if(A(z[v],v)===false){return}}}}};var r=function(u){var v;if(!u||q(u)!=="object"){return true}for(v in u){return false}return true};var k=function(v,u){var w=0,x=v.length;if(q(u)!=="function"){u=function(){}}if(!v||!v.length){u()}function y(z){if(q(v[z])==="function"){v[z](function(A){++z<x&&!A?y(z):u(A)})}}y(w)};var s=function(w,x){if(x){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(x,w)}for(var u=0,v=x.length;u<v;u++){if(x[u]===w){return u}}}return -1};var p=function(v,x){var w=[];if(q(v)!=="array"){v=[v]}if(q(x)!=="array"){x=[x]}for(var u in v){if(s(v[u],x)===-1){w.push(v[u])}}return w.length?w:false};var t=function(w,v){var u=[];o(w,function(x){if(s(x,v)!==-1){u.push(x)}});return u.length?u:null};var l=function(w){var v,u=[];for(v=0;v<w.length;v++){u[v]=w[v]}return u};var n=(function(){var u=0;return function(x){var v=new Date().getTime().toString(32),w;for(w=0;w<5;w++){v+=Math.floor(Math.random()*65535).toString(32)}return(x||"o_")+v+(u++).toString(32)}}());var i=function(u){if(!u){return u}return String.prototype.trim?String.prototype.trim.call(u):u.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var j=function(u){if(typeof(u)!=="string"){return u}var w={t:1099511627776,g:1073741824,m:1048576,k:1024},v;u=/^([0-9]+)([mgk]?)$/.exec(u.toLowerCase().replace(/[^0-9mkg]/g,""));v=u[2];u=+u[1];if(w.hasOwnProperty(v)){u*=w[v]}return u};return{guid:n,typeOf:q,extend:m,each:o,isEmptyObj:r,inSeries:k,inArray:s,arrayDiff:p,arrayIntersect:t,toArray:l,trim:i,parseSizeStr:j}});h("moxie/core/I18n",["moxie/core/utils/Basic"],function(j){var i={};return{addI18n:function(k){return j.extend(i,k)},translate:function(k){return i[k]||k},_:function(k){return this.translate(k)},sprintf:function(m){var l=[].slice.call(arguments,1),k="";j.each(m.split(/%[a-z]/),function(n){k+=n;if(l.length){k+=l.shift()}});return k}}});h("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(l,k){var i="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var j={mimes:{},extensions:{},addMimeType:function(m){var n=m.split(/,/),o,q,p;for(o=0;o<n.length;o+=2){p=n[o+1].split(/ /);for(q=0;q<p.length;q++){this.mimes[p[q]]=n[o]}this.extensions[n[o]]=p}},extList2mimes:function(s,t){var n=this,r,o,q,p,m=[];for(o=0;o<s.length;o++){r=s[o].extensions.split(/\s*,\s*/);for(q=0;q<r.length;q++){if(r[q]==="*"){return[]}p=n.mimes[r[q]];if(!p){if(t&&/^\w+$/.test(r[q])){m.push("."+r[q])}else{return[]}}else{if(l.inArray(p,m)===-1){m.push(p)}}}}return m},mimes2exts:function(m){var n=this,o=[];l.each(m,function(q){if(q==="*"){o=[];return false}var p=q.match(/^(\w+)\/(\*|\w+)$/);if(p){if(p[2]==="*"){l.each(n.extensions,function(r,s){if((new RegExp("^"+p[1]+"/")).test(s)){[].push.apply(o,n.extensions[s])}})}else{if(n.extensions[q]){[].push.apply(o,n.extensions[q])}}}});return o},mimes2extList:function(m){var o=[],n=[];if(l.typeOf(m)==="string"){m=l.trim(m).split(/\s*,\s*/)}n=this.mimes2exts(m);o.push({title:k.translate("Files"),extensions:n.length?n.join(","):"*"});o.mimes=m;return o},getFileExtension:function(n){var m=n&&n.match(/\.([^.]+)$/);if(m){return m[1].toLowerCase()}return""},getFileMime:function(m){return this.mimes[this.getFileExtension(m)]||""}};j.addMimeType(i);return j});h("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(o){var k=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],m=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],j;function n(r){var s,t;for(var q=0;q<r.length;q++){s=r[q].s1;t=r[q].prop;j=r[q].sv||r[q].id;if(s){if(s.indexOf(r[q].s2)!=-1){return r[q].id}}else{if(t){return r[q].id}}}}function p(r){var q=r.indexOf(j);if(q==-1){return}return parseFloat(r.substring(q+j.length+1))}var l=(function(){var q={define_property:(function(){return false}()),create_canvas:(function(){var r=document.createElement("canvas");return !!(r.getContext&&r.getContext("2d"))}()),return_response_type:function(r){try{if(o.inArray(r,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var t=new XMLHttpRequest();t.open("get","/");if("responseType" in t){t.responseType=r;if(t.responseType!==r){return false}return true}}}}catch(s){}return false},use_data_uri:(function(){var r=new Image();r.onload=function(){q.use_data_uri=(r.width===1&&r.height===1)};setTimeout(function(){r.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return q.use_data_uri&&(i.browser!=="IE"||i.version>=9)},use_data_uri_of:function(r){return(q.use_data_uri&&r<33000||q.use_data_uri_over32kb())},use_fileinput:function(){var r=document.createElement("input");r.setAttribute("type","file");return !r.disabled}};return function(s){var r=[].slice.call(arguments);r.shift();return o.typeOf(q[s])==="function"?q[s].apply(this,r):!!q[s]}}());var i={can:l,browser:n(k),version:p(navigator.userAgent)||p(navigator.appVersion),OS:n(m),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return i});h("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(j){var k=function(q){if(typeof q!=="string"){return q}return document.getElementById(q)};var l=function(s,r){var q;if(s.className===""){return false}q=new RegExp("(^|\\s+)"+r+"(\\s+|$)");return q.test(s.className)};var m=function(r,q){if(!l(r,q)){r.className=r.className===""?q:r.className.replace(/\s+$/,"")+" "+q}};var p=function(s,r){var q=new RegExp("(^|\\s+)"+r+"(\\s+|$)");s.className=s.className.replace(q,function(u,t,v){return t===" "&&v===" "?" ":""})};var i=function(r,q){if(r.currentStyle){return r.currentStyle[q]}else{if(window.getComputedStyle){return window.getComputedStyle(r,null)[q]}}};var o=function(r,v){var w=0,u=0,A,z=document,s,t;r=r;v=v||z.body;function q(E){var C,D,B=0,F=0;if(E){D=E.getBoundingClientRect();C=z.compatMode==="CSS1Compat"?z.documentElement:z.body;B=D.left+C.scrollLeft;F=D.top+C.scrollTop}return{x:B,y:F}}if(r&&r.getBoundingClientRect&&j.browser==="IE"&&(!z.documentMode||z.documentMode<8)){s=q(r);t=q(v);return{x:s.x-t.x,y:s.y-t.y}}A=r;while(A&&A!=v&&A.nodeType){w+=A.offsetLeft||0;u+=A.offsetTop||0;A=A.offsetParent}A=r.parentNode;while(A&&A!=v&&A.nodeType){w-=A.scrollLeft||0;u-=A.scrollTop||0;A=A.parentNode}return{x:w,y:u}};var n=function(q){return{w:q.offsetWidth||q.clientWidth,h:q.offsetHeight||q.clientHeight}};return{get:k,hasClass:l,addClass:m,removeClass:p,getStyle:i,getPos:o,getSize:n}});h("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(j){function i(m,l){var k;for(k in m){if(m[k]===l){return k}}return null}return{RuntimeError:(function(){var k={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": RuntimeError "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),OperationNotAllowedException:(function(){function k(l){this.code=l;this.name="OperationNotAllowedException"}j.extend(k,{NOT_ALLOWED_ERR:1});k.prototype=Error.prototype;return k}()),ImageError:(function(){var k={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": ImageError "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),FileException:(function(){var k={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": FileException "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),DOMException:(function(){var k={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": DOMException "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),EventException:(function(){function k(l){this.code=l;this.name="EventException"}j.extend(k,{UNSPECIFIED_EVENT_TYPE_ERR:0});k.prototype=Error.prototype;return k}())}});h("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(i,j){function k(){var l={};j.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=j.guid("uid_")}},addEventListener:function(q,p,n,o){var m=this,r;q=j.trim(q);if(/\s/.test(q)){j.each(q.split(/\s+/),function(s){m.addEventListener(s,p,n,o)});return}q=q.toLowerCase();n=parseInt(n,10)||0;r=l[this.uid]&&l[this.uid][q]||[];r.push({fn:p,priority:n,scope:o||this});if(!l[this.uid]){l[this.uid]={}}l[this.uid][q]=r},hasEventListener:function(m){return m?!!(l[this.uid]&&l[this.uid][m]):!!l[this.uid]},removeEventListener:function(o,n){o=o.toLowerCase();var p=l[this.uid]&&l[this.uid][o],m;if(p){if(n){for(m=p.length-1;m>=0;m--){if(p[m].fn===n){p.splice(m,1);break}}}else{p=[]}if(!p.length){delete l[this.uid][o];if(j.isEmptyObj(l[this.uid])){delete l[this.uid]}}}},removeAllEventListeners:function(){if(l[this.uid]){delete l[this.uid]}},dispatchEvent:function(s){var r,t,q,p,o={},n=true;if(j.typeOf(s)!=="string"){p=s;if(j.typeOf(p.type)==="string"){s=p.type;if(p.total&&p.loaded){o.total=p.total;o.loaded=p.loaded}o.async=p.async||false}else{throw new i.EventException(i.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(s.indexOf("::")!==-1){(function(u){r=u[0];s=u[1]}(s.split("::")))}else{r=this.uid}s=s.toLowerCase();t=l[r]&&l[r][s];if(t){t.sort(function(v,u){return u.priority-v.priority});q=[].slice.call(arguments);q.shift();o.type=s;q.unshift(o);var m=[];j.each(t,function(u){q[0].target=u.scope;if(o.async){m.push(function(v){setTimeout(function(){v(u.fn.apply(u.scope,q)===false)},1)})}else{m.push(function(v){v(u.fn.apply(u.scope,q)===false)})}});if(m.length){j.inSeries(m,function(u){n=!u})}}return n},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(m){var o;if(j.typeOf(m)!=="array"){m=[m]}for(var n=0;n<m.length;n++){o="on"+m[n];if(j.typeOf(this[o])==="function"){this.addEventListener(m[n],this[o])}else{if(j.typeOf(this[o])==="undefined"){this[o]=null}}}}})}k.instance=new k();return k});h("moxie/core/utils/Encode",[],function(){var k=function(m){return unescape(encodeURIComponent(m))};var l=function(m){return decodeURIComponent(escape(m))};var j=function(t,y){if(typeof(window.atob)==="function"){return y?l(window.atob(t)):window.atob(t)}var p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o,n,m,x,w,v,u,z,s=0,A=0,q="",r=[];if(!t){return t}t+="";do{x=p.indexOf(t.charAt(s++));w=p.indexOf(t.charAt(s++));v=p.indexOf(t.charAt(s++));u=p.indexOf(t.charAt(s++));z=x<<18|w<<12|v<<6|u;o=z>>16&255;n=z>>8&255;m=z&255;if(v==64){r[A++]=String.fromCharCode(o)}else{if(u==64){r[A++]=String.fromCharCode(o,n)}else{r[A++]=String.fromCharCode(o,n,m)}}}while(s<t.length);q=r.join("");return y?l(q):q};var i=function(v,A){if(A){k(v)}if(typeof(window.btoa)==="function"){return window.btoa(v)}var q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var p,o,n,z,y,x,w,B,u=0,C=0,t="",s=[];if(!v){return v}do{p=v.charCodeAt(u++);o=v.charCodeAt(u++);n=v.charCodeAt(u++);B=p<<16|o<<8|n;z=B>>18&63;y=B>>12&63;x=B>>6&63;w=B&63;s[C++]=q.charAt(z)+q.charAt(y)+q.charAt(x)+q.charAt(w)}while(u<v.length);t=s.join("");var m=v.length%3;return(m?t.slice(0,m-3):t)+"===".slice(m||3)};return{utf8_encode:k,utf8_decode:l,atob:j,btoa:i}});h("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(m,l,n){var i={},j={};function k(w,t,r,p,s){var v=this,o,u=m.guid(t+"_");function q(x,y){var A=null,z=w&&w.required_caps;y=y||"browser";if(this.mode!==null){return this.mode}if(z&&!m.isEmptyObj(x)){m.each(z,function(D,B){if(x.hasOwnProperty(B)){var C=x[B](D);if(typeof(C)==="string"){C=[C]}if(!A){A=C}else{if(!(A=m.arrayIntersect(A,C))){return(A=false)}}}});if(A){this.mode=m.inArray(y,A)!==-1?y:A[0]}else{if(A===false){this.mode=false}}}if(this.mode===null){this.mode=y}if(this.mode&&z&&!this.can(z)){this.mode=false}}j[u]=this;r=m.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},r);o=(function(){var x={};return{exec:function(A,y,B,z){if(o[y]){if(!x[A]){x[A]={context:this,instance:new o[y]()}}if(x[A].instance[B]){return x[A].instance[B].apply(this,z)}}},removeInstance:function(y){delete x[y]},removeAllInstances:function(){var y=this;m.each(x,function(A,z){if(m.typeOf(A.instance.destroy)==="function"){A.instance.destroy.call(A.context)}y.removeInstance(z)})}}}());m.extend(this,{initialized:false,uid:u,type:t,mode:null,shimid:u+"_container",clients:0,options:w,can:function(z,A){var x=arguments[2]||r;if(m.typeOf(z)==="string"&&m.typeOf(A)==="undefined"){z=k.parseCaps(z)}if(m.typeOf(z)==="object"){for(var y in z){if(!this.can(y,z[y],x)){return false}}return true}if(m.typeOf(x[z])==="function"){return x[z].call(this,A)}else{return(A===x[z])}},getShimContainer:function(){var x,y=l.get(this.shimid);if(!y){x=this.options.container?l.get(this.options.container):document.body;y=document.createElement("div");y.id=this.shimid;y.className="moxie-shim moxie-shim-"+this.type;m.extend(y.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});x.appendChild(y);x=null}return y},getShim:function(){return o},shimExec:function(y,z){var x=[].slice.call(arguments,2);return v.getShim().exec.call(this,this.uid,y,z,x)},exec:function(y,z){var x=[].slice.call(arguments,2);if(v[y]&&v[y][z]){return v[y][z].apply(this,x)}return v.shimExec.apply(this,arguments)},destroy:function(){if(!v){return}var x=l.get(this.shimid);if(x){x.parentNode.removeChild(x)}if(o){o.removeAllInstances()}this.unbindAll();delete j[this.uid];this.uid=null;u=v=o=x=null}});q.call(this,p,s)}k.order="html5,flash,silverlight,html4";k.getRuntime=function(o){return j[o]?j[o]:false};k.addConstructor=function(p,o){o.prototype=n.instance;i[p]=o};k.getConstructor=function(o){return i[o]||null};k.getInfo=function(o){var p=k.getRuntime(o);if(p){return{uid:p.uid,type:p.type,can:function(){return p.can.apply(p,arguments)}}}return null};k.parseCaps=function(o){var p={};if(m.typeOf(o)!=="string"){return o||{}}m.each(o.split(","),function(q){p[q]=true});return p};k.can=function(p,r){var q,o=k.getConstructor(p),s;if(o){q=new o({required_caps:r});s=q.mode;q.destroy();return !!s}return false};k.thatCan=function(q,r){var p=(r||k.order).split(/\s*,\s*/);for(var o in p){if(k.can(p[o],q)){return p[o]}}return null};k.capTrue=function(){return true};k.capFalse=function(){return false};k.capTest=function(o){return function(){return !!o}};return k});h("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(i,l,k){return function j(){var m;l.extend(this,{connectRuntime:function(q){var o=this,p;function n(r){var t,s;if(!r.length){o.trigger("RuntimeError",new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR));m=null;return}t=r.shift();s=k.getConstructor(t);if(!s){n(r);return}m=new s(q);m.bind("Init",function(){m.initialized=true;setTimeout(function(){m.clients++;o.trigger("RuntimeInit",m)},1)});m.bind("Error",function(){m.destroy();n(r)});if(!m.mode){m.trigger("Error");return}m.init()}if(l.typeOf(q)==="string"){p=q}else{if(l.typeOf(q.ruid)==="string"){p=q.ruid}}if(p){m=k.getRuntime(p);if(m){m.clients++;return m}else{throw new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR)}}n((q.runtime_order||k.order).split(/\s*,\s*/))},getRuntime:function(){if(m&&m.uid){return m}m=null;return null},disconnectRuntime:function(){if(m&&--m.clients<=0){m.destroy();m=null}}})}});h("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(l,j,k){var i={};function m(p,o){function n(u,q,s){var r,t=i[this.uid];if(l.typeOf(t)!=="string"||!t.length){return null}r=new m(null,{type:s,size:q-u});r.detach(t.substr(u,r.size));return r}k.call(this);if(p){this.connectRuntime(p)}if(!o){o={}}else{if(l.typeOf(o)==="string"){o={data:o}}}l.extend(this,{uid:o.uid||l.guid("uid_"),ruid:p,size:o.size||0,type:o.type||"",slice:function(s,q,r){if(this.isDetached()){return n.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),s,q,r)},getSource:function(){if(!i[this.uid]){return null}return i[this.uid]},detach:function(r){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",i[this.uid]);this.disconnectRuntime();this.ruid=null}r=r||"";var q=r.match(/^data:([^;]*);base64,/);if(q){this.type=q[1];r=j.atob(r.substring(r.indexOf("base64,")+7))}this.size=r.length;i[this.uid]=r},isDetached:function(){return !this.ruid&&l.typeOf(i[this.uid])==="string"},destroy:function(){this.detach();delete i[this.uid]}});if(o.data){this.detach(o.data)}else{i[this.uid]=o}}return m});h("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(k,j,l){function i(n,o){var m,p;if(!o){o={}}if(o.type&&o.type!==""){p=o.type}else{p=j.getFileMime(o.name)}if(o.name){m=o.name.replace(/\\/g,"/");m=m.substr(m.lastIndexOf("/")+1)}else{var q=p.split("/")[0];m=k.guid((q!==""?q:"file")+"_");if(j.extensions[p]){m+="."+j.extensions[p][0]}}l.apply(this,arguments);k.extend(this,{type:p||"",name:m||k.guid("file_"),lastModifiedDate:o.lastModifiedDate||(new Date()).toLocaleString()})}i.prototype=l.prototype;return i});h("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(j,m,l,q,s,k,o,i,p){var r=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function n(w){var u=this,t,v,x;if(j.inArray(j.typeOf(w),["string","node"])!==-1){w={browse_button:w}}v=l.get(w.browse_button);if(!v){throw new q.DOMException(q.DOMException.NOT_FOUND_ERR)}x={accept:[{title:k.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:v.parentNode||document.body};w=j.extend({},x,w);if(typeof(w.required_caps)==="string"){w.required_caps=i.parseCaps(w.required_caps)}if(typeof(w.accept)==="string"){w.accept=m.mimes2extList(w.accept)}t=l.get(w.container);if(!t){t=document.body}if(l.getStyle(t,"position")==="static"){t.style.position="relative"}t=v=null;p.call(u);j.extend(u,{uid:j.guid("uid_"),ruid:null,files:null,init:function(){u.convertEventPropsToHandlers(r);u.bind("RuntimeInit",function(z,y){u.ruid=y.uid;u.bind("Ready",function(){u.trigger("Refresh")},999);u.bind("Change",function(){var A=y.exec.call(u,"FileInput","getFiles");u.files=[];j.each(A,function(B){if(B.size===0){return true}u.files.push(new o(u.ruid,B))})},999);u.bind("Refresh",function(){var D,C,B,A;B=l.get(w.browse_button);A=l.get(y.shimid);if(B){D=l.getPos(B,l.get(w.container));C=l.getSize(B);if(A){j.extend(A.style,{top:D.y+"px",left:D.x+"px",width:C.w+"px",height:C.h+"px"})}}A=B=null});y.exec.call(u,"FileInput","init",w)});u.connectRuntime(j.extend({},w,{required_caps:{select_file:true}}))},disable:function(z){var y=this.getRuntime();if(y){y.exec.call(this,"FileInput","disable",j.typeOf(z)==="undefined"?true:z)}},refresh:function(){u.trigger("Refresh")},destroy:function(){var y=this.getRuntime();if(y){y.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(j.typeOf(this.files)==="array"){j.each(this.files,function(z){z.destroy()})}this.files=null}})}n.prototype=s.instance;return n});h("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(k,l,p,i,n,o,r,m){var q=["ready","dragenter","dragleave","drop","error"];function j(t){var s=this,u;if(typeof(t)==="string"){t={drop_zone:t}}u={accept:[{title:k.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};t=typeof(t)==="object"?i.extend({},u,t):u;t.container=l.get(t.drop_zone)||document.body;if(l.getStyle(t.container,"position")==="static"){t.container.style.position="relative"}if(typeof(t.accept)==="string"){t.accept=m.mimes2extList(t.accept)}o.call(s);i.extend(s,{uid:i.guid("uid_"),ruid:null,files:null,init:function(){s.convertEventPropsToHandlers(q);s.bind("RuntimeInit",function(w,v){s.ruid=v.uid;s.bind("Drop",function(){var x=v.exec.call(s,"FileDrop","getFiles");s.files=[];i.each(x,function(y){s.files.push(new n(s.ruid,y))})},999);v.exec.call(s,"FileDrop","init",t);s.dispatchEvent("ready")});s.connectRuntime(t)},destroy:function(){var v=this.getRuntime();if(v){v.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}j.prototype=r.instance;return j});h("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(k,j,l){function i(){this.uid=k.guid("uid_");j.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}i.prototype=l.instance;return i});h("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(i,m,o,q,l,n,k){var p=["loadstart","progress","load","abort","error","loadend"];function j(){var r=this,t;i.extend(this,{uid:i.guid("uid_"),readyState:j.EMPTY,result:null,error:null,readAsBinaryString:function(u){s.call(this,"readAsBinaryString",u)},readAsDataURL:function(u){s.call(this,"readAsDataURL",u)},readAsText:function(u){s.call(this,"readAsText",u)},abort:function(){this.result=null;if(i.inArray(this.readyState,[j.EMPTY,j.DONE])!==-1){return}else{if(this.readyState===j.LOADING){this.readyState=j.DONE}}if(t){t.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(t){t.getRuntime().exec.call(this,"FileReader","destroy");t.disconnectRuntime()}r=t=null}});function s(z,v){t=new k();function x(A){r.readyState=j.DONE;r.error=A;r.trigger("error");w()}function w(){t.destroy();t=null;r.trigger("loadend")}function u(A){t.bind("Error",function(C,B){x(B)});t.bind("Progress",function(B){r.result=A.exec.call(t,"FileReader","getResult");r.trigger(B)});t.bind("Load",function(B){r.readyState=j.DONE;r.result=A.exec.call(t,"FileReader","getResult");r.trigger(B);w()});A.exec.call(t,"FileReader","read",z,v)}this.convertEventPropsToHandlers(p);if(this.readyState===j.LOADING){return x(new o.DOMException(o.DOMException.INVALID_STATE_ERR))}this.readyState=j.LOADING;this.trigger("loadstart");if(v instanceof l){if(v.isDetached()){var y=v.getSource();switch(z){case"readAsText":case"readAsBinaryString":this.result=y;break;case"readAsDataURL":this.result="data:"+v.type+";base64,"+m.btoa(y);break}this.readyState=j.DONE;this.trigger("load");w()}else{u(t.connectRuntime(v.ruid))}}else{x(new o.DOMException(o.DOMException.NOT_FOUND_ERR))}}}j.EMPTY=0;j.LOADING=1;j.DONE=2;j.prototype=q.instance;return j});h("moxie/core/utils/Url",[],function(){var i=function(s){var o=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],n=o.length,t={http:80,https:443},q={},p=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,l=p.exec(s||"");while(n--){if(l[n]){q[o[n]]=l[n]}}if(/^[^\/]/.test(q.path)&&!q.scheme){var r=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(r)){r=r.replace(/[^\/]+$/,"")}q.host=document.location.hostname;q.path=r+(q.path||"")}if(!q.scheme){q.scheme=document.location.protocol.replace(/:$/,"")}if(!q.host){q.host=document.location.hostname}if(!q.port){q.port=document.location.port||t[q.scheme]||80}q.port=parseInt(q.port,10);if(!q.path){q.path="/"}delete q.source;return q};var k=function(m){var n={http:80,https:443},l=i(m);return l.scheme+"://"+l.host+(l.port!==n[l.scheme]?":"+l.port:"")+l.path+(l.query?l.query:"")};var j=function(m){function l(n){return[n.scheme,n.host,n.port].join("/")}if(typeof m==="string"){m=i(m)}return l(i())===l(m)};return{parseUrl:i,resolveUrl:k,hasSameOrigin:j}});h("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(k,j,i){return function(){j.call(this);k.extend(this,{uid:k.guid("uid_"),readAsBinaryString:function(m){return l.call(this,"readAsBinaryString",m)},readAsDataURL:function(m){return l.call(this,"readAsDataURL",m)},readAsText:function(m){return l.call(this,"readAsText",m)}});function l(s,o){if(o.isDetached()){var r=o.getSource();switch(s){case"readAsBinaryString":return r;case"readAsDataURL":return"data:"+o.type+";base64,"+i.btoa(r);case"readAsText":var n="";for(var p=0,q=r.length;p<q;p++){n+=String.fromCharCode(r[p])}return n}}else{var m=this.connectRuntime(o.ruid).exec.call(this,"FileReaderSync","read",s,o);this.disconnectRuntime();return m}}}});h("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(i,j,l){function k(){var n,o={},m="";j.extend(this,{append:function(q,r){var p=this,s=j.typeOf(r);if(r instanceof l){if(n){delete o[n]}n=q;o[q]=[r]}else{if("array"===s){q+="[]";j.each(r,function(t){p.append.call(p,q,t)})}else{if("object"===s){j.each(r,function(u,t){p.append.call(p,q+"["+t+"]",u)})}else{r=r.toString();if(!o[q]){o[q]=[]}o[q].push(r)}}}},hasBlob:function(){return !!n},getBlob:function(){return o[n]&&o[n][0]||null},getBlobName:function(){return n||null},each:function(p){j.each(o,function(r,q){j.each(r,function(s){p(s,q)})})},destroy:function(){n=null;m="";o={}}})}return k});h("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(q,r,p,y,u,o,s,n,w,z,i,t){var j={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function m(){this.uid=q.guid("uid_")}m.prototype=p.instance;var l=["loadstart","progress","abort","error","load","timeout","loadend"];var k=1,A=2;function v(){var R=this,E={timeout:0,readyState:v.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},Y=true,J,P,Q={},S,G,I=null,K=null,ab=false,B=false,x=false,L=false,D=false,H=false,N,X,W=null,Z=null,U={},O,V="",C;q.extend(this,E,{uid:q.guid("uid_"),upload:new m(),open:function(ah,af,ag,ad,ae){var ac;if(!ah||!af){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(ah)||y.utf8_encode(ah)!==ah){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}if(!!~q.inArray(ah.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){P=ah.toUpperCase()}if(!!~q.inArray(P,["CONNECT","TRACE","TRACK"])){throw new r.DOMException(r.DOMException.SECURITY_ERR)}af=y.utf8_encode(af);ac=u.parseUrl(af);H=u.hasSameOrigin(ac);J=u.resolveUrl(af);if((ad||ae)&&!H){throw new r.DOMException(r.DOMException.INVALID_ACCESS_ERR)}S=ad||ac.user;G=ae||ac.pass;Y=ag||true;if(Y===false&&(aa("timeout")||aa("withCredentials")||aa("responseType")!=="")){throw new r.DOMException(r.DOMException.INVALID_ACCESS_ERR)}ab=!Y;B=false;Q={};M.call(this);aa("readyState",v.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(ae,ad){var ac=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(aa("readyState")!==v.OPENED||B){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(ae)||y.utf8_encode(ae)!==ae){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}ae=q.trim(ae).toLowerCase();if(!!~q.inArray(ae,ac)||/^(proxy\-|sec\-)/.test(ae)){return false}if(!Q[ae]){Q[ae]=ad}else{Q[ae]+=", "+ad}return true},getAllResponseHeaders:function(){return V||""},getResponseHeader:function(ac){ac=ac.toLowerCase();if(D||!!~q.inArray(ac,["set-cookie","set-cookie2"])){return null}if(V&&V!==""){if(!C){C={};q.each(V.split(/\r\n/),function(ad){var ae=ad.split(/:\s+/);if(ae.length===2){ae[0]=q.trim(ae[0]);C[ae[0].toLowerCase()]={header:ae[0],value:q.trim(ae[1])}}})}if(C.hasOwnProperty(ac)){return C[ac].header+": "+C[ac].value}}return null},overrideMimeType:function(ad){var ac,ae;if(!!~q.inArray(aa("readyState"),[v.LOADING,v.DONE])){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}ad=q.trim(ad.toLowerCase());if(/;/.test(ad)&&(ac=ad.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){ad=ac[1];if(ac[2]){ae=ac[2]}}if(!t.mimes[ad]){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}W=ad;Z=ae},send:function(ae,ad){if(q.typeOf(ad)==="string"){U={ruid:ad}}else{if(!ad){U={}}else{U=ad}}this.convertEventPropsToHandlers(l);this.upload.convertEventPropsToHandlers(l);if(this.readyState!==v.OPENED||B){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}if(ae instanceof n){U.ruid=ae.ruid;K=ae.type||"application/octet-stream"}else{if(ae instanceof z){if(ae.hasBlob()){var ac=ae.getBlob();U.ruid=ac.ruid;K=ac.type||"application/octet-stream"}}else{if(typeof ae==="string"){I="UTF-8";K="text/plain;charset=UTF-8";ae=y.utf8_encode(ae)}}}if(!this.withCredentials){this.withCredentials=(U.required_caps&&U.required_caps.send_browser_cookies)&&!H}x=(!ab&&this.upload.hasEventListener());D=false;L=!ae;if(!ab){B=true;if(!L){}}F.call(this,ae)},abort:function(){D=true;ab=false;if(!~q.inArray(aa("readyState"),[v.UNSENT,v.OPENED,v.DONE])){aa("readyState",v.DONE);B=false;if(O){O.getRuntime().exec.call(O,"XMLHttpRequest","abort",L)}else{throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}L=true}else{aa("readyState",v.UNSENT)}},destroy:function(){if(O){if(q.typeOf(O.destroy)==="function"){O.destroy()}O=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function aa(ad,ac){if(!E.hasOwnProperty(ad)){return}if(arguments.length===1){return i.can("define_property")?E[ad]:R[ad]}else{if(i.can("define_property")){E[ad]=ac}else{R[ad]=ac}}}function F(af){var ad=this;N=new Date().getTime();O=new s();function ae(){O.destroy();O=null;ad.dispatchEvent("loadend");ad=null}function ac(ag){O.bind("LoadStart",function(ah){aa("readyState",v.LOADING);ad.dispatchEvent("readystatechange");ad.dispatchEvent(ah);if(x){ad.upload.dispatchEvent(ah)}});O.bind("Progress",function(ah){if(aa("readyState")!==v.LOADING){aa("readyState",v.LOADING);ad.dispatchEvent("readystatechange")}ad.dispatchEvent(ah)});O.bind("UploadProgress",function(ah){if(x){ad.upload.dispatchEvent({type:"progress",lengthComputable:false,total:ah.total,loaded:ah.loaded})}});O.bind("Load",function(ah){aa("readyState",v.DONE);aa("status",Number(ag.exec.call(O,"XMLHttpRequest","getStatus")||0));aa("statusText",j[aa("status")]||"");aa("response",ag.exec.call(O,"XMLHttpRequest","getResponse",aa("responseType")));if(!!~q.inArray(aa("responseType"),["text",""])){aa("responseText",aa("response"))}else{if(aa("responseType")==="document"){aa("responseXML",aa("response"))}}V=ag.exec.call(O,"XMLHttpRequest","getAllResponseHeaders");ad.dispatchEvent("readystatechange");if(aa("status")>0){if(x){ad.upload.dispatchEvent(ah)}ad.dispatchEvent(ah)}else{D=true;ad.dispatchEvent("error")}ae()});O.bind("Abort",function(ah){ad.dispatchEvent(ah);ae()});O.bind("Error",function(ah){D=true;aa("readyState",v.DONE);ad.dispatchEvent("readystatechange");L=true;ad.dispatchEvent(ah);ae()});ag.exec.call(O,"XMLHttpRequest","send",{url:J,method:P,async:Y,user:S,password:G,headers:Q,mimeType:K,encoding:I,responseType:ad.responseType,withCredentials:ad.withCredentials,options:U},af)}if(typeof(U.required_caps)==="string"){U.required_caps=o.parseCaps(U.required_caps)}U.required_caps=q.extend({},U.required_caps,{return_response_type:ad.responseType});if(af instanceof z){U.required_caps.send_multipart=true}if(!H){U.required_caps.do_cors=true}if(U.ruid){ac(O.connectRuntime(U))}else{O.bind("RuntimeInit",function(ah,ag){ac(ag)});O.bind("RuntimeError",function(ah,ag){ad.dispatchEvent("RuntimeError",ag)});O.connectRuntime(U)}}function M(){aa("responseText","");aa("responseXML",null);aa("response",null);aa("status",0);aa("statusText","");N=X=null}}v.UNSENT=0;v.OPENED=1;v.HEADERS_RECEIVED=2;v.LOADING=3;v.DONE=4;v.prototype=p.instance;return v});h("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(l,i,j,m){function k(){var r,p,n,s,v,u;j.call(this);l.extend(this,{uid:l.guid("uid_"),state:k.IDLE,result:null,transport:function(A,z,y){var x=this;y=l.extend({chunk_size:204798},y);if((r=y.chunk_size%3)){y.chunk_size+=3-r}u=y.chunk_size;t.call(this);n=A;s=A.length;if(l.typeOf(y)==="string"||y.ruid){q.call(x,z,this.connectRuntime(y))}else{var w=function(C,B){x.unbind("RuntimeInit",w);q.call(x,z,B)};this.bind("RuntimeInit",w);this.connectRuntime(y)}},abort:function(){var w=this;w.state=k.IDLE;if(p){p.exec.call(w,"Transporter","clear");w.trigger("TransportingAborted")}t.call(w)},destroy:function(){this.unbindAll();p=null;this.disconnectRuntime();t.call(this)}});function t(){s=v=0;n=this.result=null}function q(x,y){var w=this;p=y;w.bind("TransportingProgress",function(z){v=z.loaded;if(v<s&&l.inArray(w.state,[k.IDLE,k.DONE])===-1){o.call(w)}},999);w.bind("TransportingComplete",function(){v=s;w.state=k.DONE;n=null;w.result=p.exec.call(w,"Transporter","getAsBlob",x||"")},999);w.state=k.BUSY;w.trigger("TransportingStarted");o.call(w)}function o(){var w=this,x,y=s-v;if(u>y){u=y}x=i.btoa(n.substr(v,u));p.exec.call(w,"Transporter","receive",x,s)}}k.IDLE=0;k.BUSY=1;k.DONE=2;k.prototype=m.instance;return k});h("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var l,j,i={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},u,s=function(v){throw {name:"SyntaxError",message:v,at:l,text:u}},o=function(v){if(v&&v!==j){s("Expected '"+v+"' instead of '"+j+"'")}j=u.charAt(l);l+=1;return j},n=function(){var w,v="";if(j==="-"){v="-";o("-")}while(j>="0"&&j<="9"){v+=j;o()}if(j==="."){v+=".";while(o()&&j>="0"&&j<="9"){v+=j}}if(j==="e"||j==="E"){v+=j;o();if(j==="-"||j==="+"){v+=j;o()}while(j>="0"&&j<="9"){v+=j;o()}}w=+v;if(!isFinite(w)){s("Bad number")}else{return w}},p=function(){var y,x,w="",v;if(j==='"'){while(o()){if(j==='"'){o();return w}else{if(j==="\\"){o();if(j==="u"){v=0;for(x=0;x<4;x+=1){y=parseInt(o(),16);if(!isFinite(y)){break}v=v*16+y}w+=String.fromCharCode(v)}else{if(typeof i[j]==="string"){w+=i[j]}else{break}}}else{w+=j}}}}s("Bad string")},r=function(){while(j&&j<=" "){o()}},k=function(){switch(j){case"t":o("t");o("r");o("u");o("e");return true;case"f":o("f");o("a");o("l");o("s");o("e");return false;case"n":o("n");o("u");o("l");o("l");return null}s("Unexpected '"+j+"'")},t,q=function(){var v=[];if(j==="["){o("[");r();if(j==="]"){o("]");return v}while(j){v.push(t());r();if(j==="]"){o("]");return v}o(",");r()}}s("Bad array")},m=function(){var w,v={};if(j==="{"){o("{");r();if(j==="}"){o("}");return v}while(j){w=p();r();o(":");if(Object.hasOwnProperty.call(v,w)){s('Duplicate key "'+w+'"')}v[w]=t();r();if(j==="}"){o("}");return v}o(",");r()}}s("Bad object")};t=function(){r();switch(j){case"{":return m();case"[":return q();case'"':return p();case"-":return n();default:return j>="0"&&j<="9"?n():k()}};return function(y,w){var v;u=y;l=0;j=" ";v=t();r();if(j){s("Syntax error")}return typeof w==="function"?(function x(C,B){var A,z,D=C[B];if(D&&typeof D==="object"){for(A in D){if(Object.prototype.hasOwnProperty.call(D,A)){z=x(D,A);if(z!==g){D[A]=z}else{delete D[A]}}}}return w.call(C,B,D)}({"":v},"")):v}}())});h("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(k,o,u,s,v,j,t,n,r,y,m,q,p,l){var w=["progress","load","error","resize","embedded"];function i(){t.call(this);k.extend(this,{uid:k.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){z.call(this)},999);this.convertEventPropsToHandlers(w);A.apply(this,arguments)},downsize:function(H,D,G,E){try{if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(this.width>i.MAX_RESIZE_WIDTH||this.height>i.MAX_RESIZE_HEIGHT){throw new u.ImageError(u.ImageError.MAX_RESOLUTION_ERR)}if(!H&&!D||k.typeOf(G)==="undefined"){G=false}H=H||this.width;D=D||this.height;E=(k.typeOf(E)==="undefined"?true:!!E);this.getRuntime().exec.call(this,"Image","downsize",H,D,G,E)}catch(F){this.trigger("error",F)}},crop:function(F,D,E){this.downsize(F,D,true,E)},getAsCanvas:function(){if(!r.can("create_canvas")){throw new u.RuntimeError(u.RuntimeError.NOT_SUPPORTED_ERR)}var D=this.connectRuntime(this.ruid);return D.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(D,E){if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(!D){D="image/jpeg"}if(D==="image/jpeg"&&!E){E=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",D,E)},getAsDataURL:function(D,E){if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",D,E)},getAsBinaryString:function(D,F){var E=this.getAsDataURL(D,F);return p.atob(E.substring(E.indexOf("base64,")+7))},embed:function(G){var O=this,L,K,M,I,P=arguments[1]||{},F=this.width,N=this.height,H;function E(){if(r.can("create_canvas")){var Q=L.getAsCanvas();if(Q){G.appendChild(Q);Q=null;L.destroy();O.trigger("embedded");return}}var S=L.getAsDataURL(K,M);if(!S){throw new u.ImageError(u.ImageError.WRONG_FORMAT)}if(r.can("use_data_uri_of",S.length)){G.innerHTML='<img src="'+S+'" width="'+L.width+'" height="'+L.height+'" />';L.destroy();O.trigger("embedded")}else{var R=new n();R.bind("TransportingComplete",function(){H=O.connectRuntime(this.result.ruid);O.bind("Embedded",function(){k.extend(H.getShimContainer().style,{top:"0px",left:"0px",width:L.width+"px",height:L.height+"px"});H=null},999);H.exec.call(O,"ImageView","display",this.result.uid,F,N);L.destroy()});R.transport(p.atob(S.substring(S.indexOf("base64,")+7)),K,k.extend({},P,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:G}))}}try{if(!(G=o.get(G))){throw new u.DOMException(u.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(this.width>i.MAX_RESIZE_WIDTH||this.height>i.MAX_RESIZE_HEIGHT){throw new u.ImageError(u.ImageError.MAX_RESOLUTION_ERR)}K=P.type||this.type||"image/jpeg";M=P.quality||90;I=k.typeOf(P.crop)!=="undefined"?P.crop:false;if(P.width){F=P.width;N=P.height||F}else{var D=o.getSize(G);if(D.w&&D.h){F=D.w;N=D.h}}L=new i();L.bind("Resize",function(){E.call(O)});L.bind("Load",function(){L.downsize(F,N,I,false)});L.clone(this,false);return L}catch(J){this.trigger("error",J)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function z(E){if(!E){E=this.getRuntime().exec.call(this,"Image","getInfo")}if(E){if(k.typeOf(E.meta)==="string"){try{this.meta=l(E.meta)}catch(D){}}else{this.meta=E.meta}}k.extend(this,{size:parseInt(E.size,10),width:parseInt(E.width,10),height:parseInt(E.height,10),type:E.type});if(this.name===""){this.name=E.name}}function A(F){var E=k.typeOf(F);try{if(F instanceof i){if(!F.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}x.apply(this,arguments)}else{if(F instanceof m){if(!~k.inArray(F.type,["image/jpeg","image/png"])){throw new u.ImageError(u.ImageError.WRONG_FORMAT)}B.apply(this,arguments)}else{if(k.inArray(E,["blob","file"])!==-1){A.call(this,new q(null,F),arguments[1])}else{if(E==="string"){if(/^data:[^;]*;base64,/.test(F)){A.call(this,new m(null,{data:F}),arguments[1])}else{C.apply(this,arguments)}}else{if(E==="node"&&F.nodeName.toLowerCase()==="img"){A.call(this,F.src,arguments[1])}else{throw new u.DOMException(u.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(D){this.trigger("error",D)}}function x(D,E){var F=this.connectRuntime(D.ruid);this.ruid=F.uid;F.exec.call(this,"Image","loadFromImage",D,(k.typeOf(E)==="undefined"?true:E))}function B(F,G){var E=this;E.name=F.name||"";function D(H){E.ruid=H.uid;H.exec.call(E,"Image","loadFromBlob",F)}if(F.isDetached()){this.bind("RuntimeInit",function(I,H){D(H)});if(G&&typeof(G.required_caps)==="string"){G.required_caps=j.parseCaps(G.required_caps)}this.connectRuntime(k.extend({required_caps:{access_image_binary:true,resize_image:true}},G))}else{D(this.connectRuntime(F.ruid))}}function C(F,E){var D=this,G;G=new v();G.open("get",F);G.responseType="blob";G.onprogress=function(H){D.trigger(H)};G.onload=function(){B.call(D,G.response,true)};G.onerror=function(H){D.trigger(H)};G.onloadend=function(){G.destroy()};G.bind("RuntimeError",function(I,H){D.trigger("RuntimeError",H)});G.send(null,E)}}i.MAX_RESIZE_WIDTH=6500;i.MAX_RESIZE_HEIGHT=6500;i.prototype=y.instance;return i});h("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(n,i,k,j){var m="html5",l={};function o(q){var p=this,t=k.capTest,s=k.capTrue;var r=n.extend({access_binary:t(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return p.can("access_binary")&&!!l.Image},display_media:t(j.can("create_canvas")||j.can("use_data_uri_over32kb")),do_cors:t(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:t(function(){var u=document.createElement("div");return(("draggable" in u)||("ondragstart" in u&&"ondrop" in u))&&(j.browser!=="IE"||j.version>9)}()),filter_by_extension:t(function(){return(j.browser==="Chrome"&&j.version>=28)||(j.browser==="IE"&&j.version>=10)}()),return_response_headers:s,return_response_type:function(u){if(u==="json"){return true}else{return j.can("return_response_type",u)}},return_status_code:s,report_upload_progress:t(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return p.can("access_binary")&&j.can("create_canvas")},select_file:function(){return j.can("use_fileinput")&&window.File},select_folder:function(){return p.can("select_file")&&j.browser==="Chrome"&&j.version>=21},select_multiple:function(){return p.can("select_file")&&!(j.browser==="Safari"&&j.OS==="Windows")},send_binary_string:t(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:t(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||p.can("send_binary_string")},slice_blob:t(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return p.can("slice_blob")&&p.can("send_multipart")},summon_file_dialog:t(function(){return(j.browser==="Firefox"&&j.version>=4)||(j.browser==="Opera"&&j.version>=12)||(j.browser==="IE"&&j.version>=10)||!!~n.inArray(j.browser,["Chrome","Safari"])}()),upload_filesize:s},arguments[2]);k.call(this,q,(arguments[1]||m),r);n.extend(this,{init:function(){this.trigger("Init")},destroy:(function(u){return function(){u.call(p);u=p=null}}(this.destroy))});n.extend(this.getShim(),l)}k.addConstructor(m,o);return l});h("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(j,k){function i(){function l(n,q,m){var o;if(window.File.prototype.slice){try{n.slice();return n.slice(q,m)}catch(p){return n.slice(q,m-q)}}else{if((o=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return o.call(n,q,m)}else{return null}}}this.slice=function(){return new k(this.getRuntime().uid,l.apply(this,arguments))}}return(j.Blob=i)});h("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(o){var p={},l="moxie_"+o.guid();function k(){this.returnValue=false}function j(){this.cancelBubble=true}var m=function(u,q,v,s){var t,r;q=q.toLowerCase();if(u.addEventListener){t=v;u.addEventListener(q,t,false)}else{if(u.attachEvent){t=function(){var w=window.event;if(!w.target){w.target=w.srcElement}w.preventDefault=k;w.stopPropagation=j;v(w)};u.attachEvent("on"+q,t)}}if(!u[l]){u[l]=o.guid()}if(!p.hasOwnProperty(u[l])){p[u[l]]={}}r=p[u[l]];if(!r.hasOwnProperty(q)){r[q]=[]}r[q].push({func:t,orig:v,key:s})};var n=function(v,q,w){var t,s;q=q.toLowerCase();if(v[l]&&p[v[l]]&&p[v[l]][q]){t=p[v[l]][q]}else{return}for(var r=t.length-1;r>=0;r--){if(t[r].orig===w||t[r].key===w){if(v.removeEventListener){v.removeEventListener(q,t[r].func,false)}else{if(v.detachEvent){v.detachEvent("on"+q,t[r].func)}}t[r].orig=null;t[r].func=null;t.splice(r,1);if(w!==s){break}}}if(!t.length){delete p[v[l]][q]}if(o.isEmptyObj(p[v[l]])){delete p[v[l]];try{delete v[l]}catch(u){v[l]=s}}};var i=function(r,q){if(!r||!r[l]){return}o.each(p[r[l]],function(t,s){n(r,s,q)})};return{addEvent:m,removeEvent:n,removeAllEvents:i}});h("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(m,o,l,j,k,i){function n(){var q=[],p;o.extend(this,{init:function(A){var r=this,y=r.getRuntime(),x,t,u,z,w,v;p=A;q=[];u=p.accept.mimes||k.extList2mimes(p.accept,y.can("filter_by_extension"));t=y.getShimContainer();t.innerHTML='<input id="'+y.uid+'" type="file" style="font-size:999px;opacity:0;"'+(p.multiple&&y.can("select_multiple")?"multiple":"")+(p.directory&&y.can("select_folder")?"webkitdirectory directory":"")+(u?' accept="'+u.join(",")+'"':"")+" />";x=l.get(y.uid);o.extend(x.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});z=l.get(p.browse_button);if(y.can("summon_file_dialog")){if(l.getStyle(z,"position")==="static"){z.style.position="relative"}w=parseInt(l.getStyle(z,"z-index"),10)||1;z.style.zIndex=w;t.style.zIndex=w-1;j.addEvent(z,"click",function(C){var B=l.get(y.uid);if(B&&!B.disabled){B.click()}C.preventDefault()},r.uid)}v=y.can("summon_file_dialog")?z:t;j.addEvent(v,"mouseover",function(){r.trigger("mouseenter")},r.uid);j.addEvent(v,"mouseout",function(){r.trigger("mouseleave")},r.uid);j.addEvent(v,"mousedown",function(){r.trigger("mousedown")},r.uid);j.addEvent(l.get(p.container),"mouseup",function(){r.trigger("mouseup")},r.uid);x.onchange=function s(){q=[];if(p.directory){o.each(this.files,function(C){if(C.name!=="."){q.push(C)}})}else{q=[].slice.call(this.files)}if(i.browser!=="IE"){this.value=""}else{var B=this.cloneNode(true);this.parentNode.replaceChild(B,this);B.onchange=s}r.trigger("change")};r.trigger({type:"ready",async:true});t=null},getFiles:function(){return q},disable:function(t){var s=this.getRuntime(),r;if((r=l.get(s.uid))){r.disabled=!!t}},destroy:function(){var s=this.getRuntime(),r=s.getShimContainer();j.removeAllEvents(r,this.uid);j.removeAllEvents(p&&l.get(p.container),this.uid);j.removeAllEvents(p&&l.get(p.browse_button),this.uid);if(r){r.innerHTML=""}q=p=null}})}return(m.FileInput=n)});h("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(l,m,k,i,j){function n(){var q=[],t=[],p;m.extend(this,{init:function(x){var w=this,y;p=x;t=r(p.accept);y=p.container;i.addEvent(y,"dragover",function(z){z.preventDefault();z.stopPropagation();z.dataTransfer.dropEffect="copy"},w.uid);i.addEvent(y,"drop",function(A){A.preventDefault();A.stopPropagation();q=[];if(A.dataTransfer.items&&A.dataTransfer.items[0].webkitGetAsEntry){var z=[];m.each(A.dataTransfer.items,function(B){z.push(B.webkitGetAsEntry())});u(z,function(){w.trigger("drop")})}else{m.each(A.dataTransfer.files,function(B){if(o(B)){q.push(B)}});w.trigger("drop")}},w.uid);i.addEvent(y,"dragenter",function(z){z.preventDefault();z.stopPropagation();w.trigger("dragenter")},w.uid);i.addEvent(y,"dragleave",function(z){z.preventDefault();z.stopPropagation();w.trigger("dragleave")},w.uid)},getFiles:function(){return q},destroy:function(){i.removeAllEvents(p&&k.get(p.container),this.uid);q=t=p=null}});function r(y){var x=[];for(var w=0;w<y.length;w++){[].push.apply(x,y[w].extensions.split(/\s*,\s*/))}return m.inArray("*",x)===-1?x:[]}function o(w){var x=j.getFileExtension(w.name);return !x||!t.length||m.inArray(x,t)!==-1}function u(y,x){var w=[];m.each(y,function(z){w.push(function(A){s(z,A)})});m.inSeries(w,function(){x()})}function s(x,w){if(x.isFile){x.file(function(y){if(o(y)){q.push(y)}w()},function(){w()})}else{if(x.isDirectory){v(x,w)}else{w()}}}function v(A,x){var w=[],z=A.createReader();function y(B){z.readEntries(function(C){if(C.length){[].push.apply(w,C);y(B)}else{B()}},B)}y(function(){u(w,x)})}}return(l.FileDrop=n)});h("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(j,i,l){function k(){var n,o=false;l.extend(this,{read:function(r,p){var q=this;n=new window.FileReader();n.addEventListener("progress",function(s){q.trigger(s)});n.addEventListener("load",function(s){q.trigger(s)});n.addEventListener("error",function(s){q.trigger(s,n.error)});n.addEventListener("loadend",function(){n=null});if(l.typeOf(n[r])==="function"){o=false;n[r](p.getSource())}else{if(r==="readAsBinaryString"){o=true;n.readAsDataURL(p.getSource())}}},getResult:function(){return n&&n.result?(o?m(n.result):n.result):null},abort:function(){if(n){n.abort()}},destroy:function(){n=null}});function m(p){return i.atob(p.substring(p.indexOf("base64,")+7))}}return(j.FileReader=k)});h("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(p,j,m,i,o,l,s,q,n,k){function r(){var y,w;j.extend(this,{send:function(G,D){var F=this,C=(n.browser==="Mozilla"&&n.version>=4&&n.version<7),z=n.browser==="Android Browser",E=false;w=G.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();y=x();y.open(G.method,G.url,G.async,G.user,G.password);if(D instanceof l){if(D.isDetached()){E=true}D=D.getSource()}else{if(D instanceof s){if(D.hasBlob()){if(D.getBlob().isDetached()){D=v.call(F,D);E=true}else{if((C||z)&&j.typeOf(D.getBlob().getSource())==="blob"&&window.FileReader){t.call(F,G,D);return}}}if(D instanceof s){var B=new window.FormData();D.each(function(I,H){if(I instanceof l){B.append(H,I.getSource())}else{B.append(H,I)}});D=B}}}if(y.upload){if(G.withCredentials){y.withCredentials=true}y.addEventListener("load",function(H){F.trigger(H)});y.addEventListener("error",function(H){F.trigger(H)});y.addEventListener("progress",function(H){F.trigger(H)});y.upload.addEventListener("progress",function(H){F.trigger({type:"UploadProgress",loaded:H.loaded,total:H.total})})}else{y.onreadystatechange=function A(){switch(y.readyState){case 1:break;case 2:break;case 3:var J,H;try{if(i.hasSameOrigin(G.url)){J=y.getResponseHeader("Content-Length")||0}if(y.responseText){H=y.responseText.length}}catch(I){J=H=0}F.trigger({type:"progress",lengthComputable:!!J,total:parseInt(J,10),loaded:H});break;case 4:y.onreadystatechange=function(){};if(y.status===0){F.trigger("error")}else{F.trigger("load")}break}}}if(!j.isEmptyObj(G.headers)){j.each(G.headers,function(H,I){y.setRequestHeader(I,H)})}if(""!==G.responseType&&"responseType" in y){if("json"===G.responseType&&!n.can("return_response_type","json")){y.responseType="text"}else{y.responseType=G.responseType}}if(!E){y.send(D)}else{if(y.sendAsBinary){y.sendAsBinary(D)}else{(function(){var H=new Uint8Array(D.length);for(var I=0;I<D.length;I++){H[I]=(D.charCodeAt(I)&255)}y.send(H.buffer)}())}}F.trigger("loadstart")},getStatus:function(){try{if(y){return y.status}}catch(z){}return 0},getResponse:function(B){var A=this.getRuntime();try{switch(B){case"blob":var D=new o(A.uid,y.response);var E=y.getResponseHeader("Content-Disposition");if(E){var z=E.match(/filename=([\'\"'])([^\1]+)\1/);if(z){w=z[2]}}D.name=w;if(!D.type){D.type=m.getFileMime(w)}return D;case"json":if(!n.can("return_response_type","json")){return y.status===200?k(y.responseText):null}return y.response;case"document":return u(y);default:return y.responseText!==""?y.responseText:null}}catch(C){return null}},getAllResponseHeaders:function(){try{return y.getAllResponseHeaders()}catch(z){}return""},abort:function(){if(y){y.abort()}},destroy:function(){self=w=null}});function t(D,B){var C=this,A,z;A=B.getBlob().getSource();z=new window.FileReader();z.onload=function(){B.append(B.getBlobName(),new l(null,{type:A.type,data:z.result}));self.send.call(C,D,B)};z.readAsBinaryString(A)}function x(){if(window.XMLHttpRequest&&!(n.browser==="IE"&&n.version<8)){return new window.XMLHttpRequest()}else{return(function(){var z=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var B=0;B<z.length;B++){try{return new ActiveXObject(z[B])}catch(A){}}})()}}function u(A){var B=A.responseXML;var z=A.responseText;if(n.browser==="IE"&&z&&B&&!B.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(A.getResponseHeader("Content-Type"))){B=new window.ActiveXObject("Microsoft.XMLDOM");B.async=false;B.validateOnParse=false;B.loadXML(z)}if(B){if((n.browser==="IE"&&B.parseError!==0)||!B.documentElement||B.documentElement.tagName==="parsererror"){return null}}return B}function v(B){var E="----moxieboundary"+new Date().getTime(),C="--",D="\r\n",z="",A=this.getRuntime();if(!A.can("send_binary_string")){throw new q.RuntimeError(q.RuntimeError.NOT_SUPPORTED_ERR)}y.setRequestHeader("Content-Type","multipart/form-data; boundary="+E);B.each(function(G,F){if(G instanceof l){z+=C+E+D+'Content-Disposition: form-data; name="'+F+'"; filename="'+unescape(encodeURIComponent(G.name||"blob"))+'"'+D+"Content-Type: "+G.type+D+D+G.getSource()+D}else{z+=C+E+D+'Content-Disposition: form-data; name="'+F+'"'+D+D+unescape(encodeURIComponent(G))+D}});z+=C+E+C+D;return z}}return(p.XMLHttpRequest=r)});h("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var l=false,j;function m(o,q){var n=l?0:-8*(q-1),r=0,p;for(p=0;p<q;p++){r|=(j.charCodeAt(o+p)<<Math.abs(n+p*8))}return r}function i(p,n,o){o=arguments.length===3?o:j.length-n-1;j=j.substr(0,n)+p+j.substr(o+n)}function k(o,p,r){var s="",n=l?0:-8*(r-1),q;for(q=0;q<r;q++){s+=String.fromCharCode((p>>Math.abs(n+q*8))&255)}i(s,o,r)}return{II:function(n){if(n===g){return l}else{l=n}},init:function(n){l=false;j=n},SEGMENT:function(n,p,o){switch(arguments.length){case 1:return j.substr(n,j.length-n-1);case 2:return j.substr(n,p);case 3:i(o,n,p);break;default:return j}},BYTE:function(n){return m(n,1)},SHORT:function(n){return m(n,2)},LONG:function(n,o){if(o===g){return m(n,4)}else{k(n,o,4)}},SLONG:function(n){var o=m(n,4);return(o>2147483647?o-4294967296:o)},STRING:function(n,o){var p="";for(o+=n;n<o;n++){p+=String.fromCharCode(m(n,1))}return p}}}});h("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(j){return function i(o){var p=[],n,k,l,m=0;n=new j();n.init(o);if(n.SHORT(0)!==65496){return}k=2;while(k<=o.length){l=n.SHORT(k);if(l>=65488&&l<=65495){k+=2;continue}if(l===65498||l===65497){break}m=n.SHORT(k+2)+2;if(l>=65505&&l<=65519){p.push({hex:l,name:"APP"+(l&15),start:k,length:m,segment:n.SEGMENT(k,m)})}k+=m}n.init(null);return{headers:p,restore:function(s){var q,r;n.init(s);k=n.SHORT(2)==65504?4+n.SHORT(4):2;for(r=0,q=p.length;r<q;r++){n.SEGMENT(k,0,p[r].segment);k+=p[r].length}s=n.SEGMENT();n.init(null);return s},strip:function(s){var t,q,r;q=new i(s);t=q.headers;q.purge();n.init(s);r=t.length;while(r--){n.SEGMENT(t[r].start,t[r].length,"")}s=n.SEGMENT();n.init(null);return s},get:function(r){var t=[];for(var s=0,q=p.length;s<q;s++){if(p[s].name===r.toUpperCase()){t.push(p[s].segment)}}return t},set:function(r,u){var v=[],s,t,q;if(typeof(u)==="string"){v.push(u)}else{v=u}for(s=t=0,q=p.length;s<q;s++){if(p[s].name===r.toUpperCase()){p[s].segment=v[t];p[s].length=v[t].length;t++}if(t>=v.length){break}}},purge:function(){p=[];n.init(null);n=null}}}});h("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(k,j){return function i(){var p,m,l,n={},s;p=new j();m={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};s={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function o(t,B){var v=p.SHORT(t),y,E,F,A,z,u,w,C,D=[],x={};for(y=0;y<v;y++){w=u=t+12*y+2;F=B[p.SHORT(w)];if(F===g){continue}A=p.SHORT(w+=2);z=p.LONG(w+=2);w+=4;D=[];switch(A){case 1:case 7:if(z>4){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.BYTE(w+E)}break;case 2:if(z>4){w=p.LONG(w)+n.tiffHeader}x[F]=p.STRING(w,z-1);continue;case 3:if(z>2){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.SHORT(w+E*2)}break;case 4:if(z>1){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.LONG(w+E*4)}break;case 5:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.LONG(w+E*4)/p.LONG(w+E*4+4)}break;case 9:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.SLONG(w+E*4)}break;case 10:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.SLONG(w+E*4)/p.SLONG(w+E*4+4)}break;default:continue}C=(z==1?D[0]:D);if(s.hasOwnProperty(F)&&typeof C!="object"){x[F]=s[F][C]}else{x[F]=C}}return x}function r(){var t=n.tiffHeader;p.II(p.SHORT(t)==18761);if(p.SHORT(t+=2)!==42){return false}n.IFD0=n.tiffHeader+p.LONG(t+=2);l=o(n.IFD0,m.tiff);if("ExifIFDPointer" in l){n.exifIFD=n.tiffHeader+l.ExifIFDPointer;delete l.ExifIFDPointer}if("GPSInfoIFDPointer" in l){n.gpsIFD=n.tiffHeader+l.GPSInfoIFDPointer;delete l.GPSInfoIFDPointer}return true}function q(A,C,z){var x,v,u,t=0;if(typeof(C)==="string"){var B=m[A.toLowerCase()];for(var w in B){if(B[w]===C){C=w;break}}}x=n[A.toLowerCase()+"IFD"];v=p.SHORT(x);for(var y=0;y<v;y++){u=x+12*y+2;if(p.SHORT(u)==C){t=u+8;break}}if(!t){return false}p.LONG(t,z);return true}return{init:function(t){n={tiffHeader:10};if(t===g||!t.length){return false}p.init(t);if(p.SHORT(0)===65505&&p.STRING(4,5).toUpperCase()==="EXIF\0"){return r()}return false},TIFF:function(){return l},EXIF:function(){var u;u=o(n.exifIFD,m.exif);if(u.ExifVersion&&k.typeOf(u.ExifVersion)==="array"){for(var v=0,t="";v<u.ExifVersion.length;v++){t+=String.fromCharCode(u.ExifVersion[v])}u.ExifVersion=t}return u},GPS:function(){var t;t=o(n.gpsIFD,m.gps);if(t.GPSVersionID&&k.typeOf(t.GPSVersionID)==="array"){t.GPSVersionID=t.GPSVersionID.join(".")}return t},setExif:function(t,u){if(t!=="PixelXDimension"&&t!=="PixelYDimension"){return false}return q("exif",t,u)},getBinary:function(){return p.SEGMENT()},purge:function(){p.init(null);p=l=null;n={}}}}});h("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(n,i,k,m,j){function l(w){var p,r,t,s,v,o;function u(){var x=0,y,z;while(x<=p.length){y=r.SHORT(x+=2);if(y>=65472&&y<=65475){x+=5;return{height:r.SHORT(x),width:r.SHORT(x+=2)}}z=r.SHORT(x+=2);x+=z-2}return null}p=w;r=new m();r.init(p);if(r.SHORT(0)!==65496){throw new i.ImageError(i.ImageError.WRONG_FORMAT)}t=new k(w);s=new j();o=!!s.init(t.get("app1")[0]);v=u.call(this);n.extend(this,{type:"image/jpeg",size:p.length,width:v&&v.width||0,height:v&&v.height||0,setExif:function(x,y){if(!o){return false}if(n.typeOf(x)==="object"){n.each(x,function(A,z){s.setExif(z,A)})}else{s.setExif(x,y)}t.set("app1",s.getBinary())},writeHeaders:function(){if(!arguments.length){return(p=t.restore(p))}return t.restore(arguments[0])},stripHeaders:function(x){return t.strip(x)},purge:function(){q.call(this)}});if(o){this.meta={tiff:s.TIFF(),exif:s.EXIF(),gps:s.GPS()}}function q(){if(!s||!t||!r){return}s.purge();t.purge();r.init(null);p=v=t=s=r=null}}return l});h("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(i,l,k){function j(u){var n,p,r,q,t;n=u;p=new k();p.init(n);(function(){var v=0,x=0,w=[35152,20039,3338,6666];for(x=0;x<w.length;x++,v+=2){if(w[x]!=p.SHORT(v)){throw new i.ImageError(i.ImageError.WRONG_FORMAT)}}}());function s(){var w,v;w=m.call(this,8);if(w.type=="IHDR"){v=w.start;return{width:p.LONG(v),height:p.LONG(v+=4)}}return null}function o(){if(!p){return}p.init(null);n=t=r=q=p=null}t=s.call(this);l.extend(this,{type:"image/png",size:n.length,width:t.width,height:t.height,purge:function(){o.call(this)}});o.call(this);function m(v){var y,x,z,w;y=p.LONG(v);x=p.STRING(v+=4,4);z=v+=4;w=p.LONG(v+y);return{length:y,type:x,start:z,CRC:w}}}return j});h("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(l,i,k,j){return function(n){var o=[k,j],m;m=(function(){for(var q=0;q<o.length;q++){try{return new o[q](n)}catch(p){}}throw new i.ImageError(i.ImageError.WRONG_FORMAT)}());l.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(p){return p},stripHeaders:function(p){return p},purge:function(){}});l.extend(this,m);this.purge=function(){m.purge();m=null}}});h("moxie/runtime/html5/image/MegaPixel",[],function(){function i(I,m,n){var p=I.naturalWidth,v=I.naturalHeight;var C=n.width,z=n.height;var r=n.x||0,q=n.y||0;var D=m.getContext("2d");if(j(I)){p/=2;v/=2}var G=1024;var l=document.createElement("canvas");l.width=l.height=G;var o=l.getContext("2d");var E=k(I,p,v);var w=0;while(w<v){var H=w+G>v?v-w:G;var A=0;while(A<p){var B=A+G>p?p-A:G;o.clearRect(0,0,G,G);o.drawImage(I,-A,-w);var t=(A*C/p+r)<<0;var u=Math.ceil(B*C/p);var s=(w*z/v/E+q)<<0;var F=Math.ceil(H*z/v/E);D.drawImage(l,0,0,B,H,t,s,u,F);A+=G}w+=G}l=o=null}function j(n){var m=n.naturalWidth,p=n.naturalHeight;if(m*p>1024*1024){var o=document.createElement("canvas");o.width=o.height=1;var l=o.getContext("2d");l.drawImage(n,-m+1,0);return l.getImageData(0,0,1,1).data[3]===0}else{return false}}function k(p,m,u){var l=document.createElement("canvas");l.width=1;l.height=u;var v=l.getContext("2d");v.drawImage(p,0,0);var o=v.getImageData(0,0,1,u).data;var s=0;var q=u;var t=u;while(t>s){var n=o[(t-1)*4+3];if(n===0){q=t}else{s=t}t=(q+s)>>1}l=null;var r=(t/u);return(r===0)?1:r}return{isSubsampled:j,renderTo:i}});h("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(o,i,p,l,j,r,q,k,m){function n(){var C=this,B,G,A,w,E,I=false,t=true;i.extend(this,{loadFromBlob:function(L){var K=this,M=K.getRuntime(),J=arguments.length>1?arguments[1]:true;if(!M.can("access_binary")){throw new p.RuntimeError(p.RuntimeError.NOT_SUPPORTED_ERR)}E=L;if(L.isDetached()){w=L.getSource();z.call(this,w);return}else{F.call(this,L.getSource(),function(N){if(J){w=H(N)}z.call(K,N)})}},loadFromImage:function(J,K){this.meta=J.meta;E=new j(null,{name:J.name,size:J.size,type:J.type});z.call(this,K?(w=J.getAsBinaryString()):J.getAsDataURL())},getInfo:function(){var J=this.getRuntime(),K;if(!G&&w&&J.can("access_image_binary")){G=new r(w)}K={width:x().width||0,height:x().height||0,type:E.type||k.getFileMime(E.name),size:w&&w.length||E.size||0,name:E.name||"",meta:G&&G.meta||this.meta||{}};return K},downsize:function(){s.apply(this,arguments)},getAsCanvas:function(){if(A){A.id=this.uid+"_canvas"}return A},getAsBlob:function(J,K){if(J!==this.type){s.call(this,this.width,this.height,false)}return new j(null,{type:J,data:C.getAsBinaryString.call(this,J,K)})},getAsDataURL:function(K){var L=arguments[1]||90;if(!I){return B.src}if("image/jpeg"!==K){return A.toDataURL("image/png")}else{try{return A.toDataURL("image/jpeg",L/100)}catch(J){return A.toDataURL("image/jpeg")}}},getAsBinaryString:function(K,M){if(!I){if(!w){w=H(C.getAsDataURL(K,M))}return w}if("image/jpeg"!==K){w=H(C.getAsDataURL(K,M))}else{var L;if(!M){M=90}try{L=A.toDataURL("image/jpeg",M/100)}catch(J){L=A.toDataURL("image/jpeg")}w=H(L);if(G){w=G.stripHeaders(w);if(t){if(G.meta&&G.meta.exif){G.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}w=G.writeHeaders(w)}G.purge();G=null}}I=false;return w},destroy:function(){C=null;u.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function x(){if(!A&&!B){throw new p.ImageError(p.DOMException.INVALID_STATE_ERR)}return A||B}function H(J){return l.atob(J.substring(J.indexOf("base64,")+7))}function D(K,J){return"data:"+(J||"")+";base64,"+l.btoa(K)}function z(K){var J=this;B=new Image();B.onerror=function(){u.call(this);J.trigger("error",new p.ImageError(p.ImageError.WRONG_FORMAT))};B.onload=function(){J.trigger("load")};B.src=/^data:[^;]*;base64,/.test(K)?K:D(K,E.type)}function F(L,M){var K=this,J;if(window.FileReader){J=new FileReader();J.onload=function(){M(this.result)};J.onerror=function(){K.trigger("error",new p.FileException(p.FileException.NOT_READABLE_ERR))};J.readAsDataURL(L)}else{return M(L.getAsDataURL())}}function s(K,W,O,U){var X=this,Y,M,L,S,R,N,Q,P,J;t=U;J=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(i.inArray(J,[5,6,7,8])!==-1){var V=K;K=W;W=V}N=x();L=!O?Math.min:Math.max;M=L(K/N.width,W/N.height);if(M>1&&(!O||U)){this.trigger("Resize");return}Q=Math.round(N.width*M);P=Math.round(N.height*M);if(!A){A=document.createElement("canvas")}Y=A.getContext("2d");if(O){A.width=K;A.height=W}else{A.width=Q;A.height=P}S=Q>A.width?Math.round((Q-A.width)/2):0;R=P>A.height?Math.round((P-A.height)/2):0;if(!t){y(A.width,A.height,J)}v.call(this,N,A,-S,-R,Q,P);this.width=A.width;this.height=A.height;I=true;X.trigger("Resize")}function v(M,N,J,P,L,O){if(m.OS==="iOS"){q.renderTo(M,N,{width:L,height:O,x:J,y:P})}else{var K=N.getContext("2d");K.drawImage(M,J,P,L,O)}}function y(M,J,L){switch(L){case 5:case 6:case 7:case 8:A.width=J;A.height=M;break;default:A.width=M;A.height=J}var K=A.getContext("2d");switch(L){case 2:K.translate(M,0);K.scale(-1,1);break;case 3:K.translate(M,J);K.rotate(Math.PI);break;case 4:K.translate(0,J);K.scale(1,-1);break;case 5:K.rotate(0.5*Math.PI);K.scale(1,-1);break;case 6:K.rotate(0.5*Math.PI);K.translate(0,-J);break;case 7:K.rotate(0.5*Math.PI);K.translate(M,-J);K.scale(-1,1);break;case 8:K.rotate(-0.5*Math.PI);K.translate(-M,0);break}}function u(){if(G){G.purge();G=null}w=B=A=E=null;I=false}}return(o.Image=n)});h("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(j,m,k,p,i){var n="flash",o={};function l(){var r;try{r=navigator.plugins["Shockwave Flash"];r=r.description}catch(t){try{r=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(s){r="0.0"}}r=r.match(/\d+/g);return parseFloat(r[0]+"."+r[1])}function q(s){var r=this,t;s=j.extend({swf_url:m.swf_url},s);i.call(this,s,n,{access_binary:function(u){return u&&r.mode==="browser"},access_image_binary:function(u){return u&&r.mode==="browser"},display_media:i.capTrue,do_cors:i.capTrue,drag_and_drop:false,report_upload_progress:function(){return r.mode==="client"},resize_image:i.capTrue,return_response_headers:false,return_response_type:function(u){return !j.arrayDiff(u,["","text","json","document"])||r.mode==="browser"},return_status_code:function(u){return r.mode==="browser"||!j.arrayDiff(u,[200,404])},select_file:i.capTrue,select_multiple:i.capTrue,send_binary_string:function(u){return u&&r.mode==="browser"},send_browser_cookies:function(u){return u&&r.mode==="browser"},send_custom_headers:function(u){return u&&r.mode==="browser"},send_multipart:i.capTrue,slice_blob:i.capTrue,stream_upload:function(u){return u&&r.mode==="browser"},summon_file_dialog:false,upload_filesize:function(u){return j.parseSizeStr(u)<=2097152||r.mode==="client"},use_http_method:function(u){return !j.arrayDiff(u,["GET","POST"])}},{access_binary:function(u){return u?"browser":"client"},access_image_binary:function(u){return u?"browser":"client"},report_upload_progress:function(u){return u?"browser":"client"},return_response_type:function(u){return j.arrayDiff(u,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(u){return j.arrayDiff(u,[200,404])?"browser":["client","browser"]},send_binary_string:function(u){return u?"browser":"client"},send_browser_cookies:function(u){return u?"browser":"client"},send_custom_headers:function(u){return u?"browser":"client"},stream_upload:function(u){return u?"client":"browser"},upload_filesize:function(u){return j.parseSizeStr(u)>=2097152?"client":"browser"}},"client");if(l()<10){this.mode=false}j.extend(this,{getShim:function(){return k.get(this.uid)},shimExec:function(v,w){var u=[].slice.call(arguments,2);return r.getShim().exec(this.uid,v,w,u)},init:function(){var v,w,u;u=this.getShimContainer();j.extend(u.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});v='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+s.swf_url+'" ';if(m.browser==="IE"){v+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}v+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+s.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+m.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(m.browser==="IE"){w=document.createElement("div");u.appendChild(w);w.outerHTML=v;w=u=null}else{u.innerHTML=v}t=setTimeout(function(){if(r&&!r.initialized){r.trigger("Error",new p.RuntimeError(p.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(u){return function(){u.call(r);clearTimeout(t);s=t=u=r=null}}(this.destroy))},o)}i.addConstructor(n,q);return o});h("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(j,k){var i={slice:function(n,p,l,o){var m=this.getRuntime();if(p<0){p=Math.max(n.size+p,0)}else{if(p>0){p=Math.min(p,n.size)}}if(l<0){l=Math.max(n.size+l,0)}else{if(l>0){l=Math.min(l,n.size)}}n=m.shimExec.call(this,"Blob","slice",p,l,o||"");if(n){n=new k(m.uid,n)}return n}};return(j.Blob=i)});h("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(i){var j={init:function(k){this.getRuntime().shimExec.call(this,"FileInput","init",{name:k.name,accept:k.accept,multiple:k.multiple});this.trigger("ready")}};return(i.FileInput=j)});h("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(l,i){var j="";function k(n,o){switch(o){case"readAsText":return i.atob(n,"utf8");case"readAsBinaryString":return i.atob(n);case"readAsDataURL":return n}return null}var m={read:function(q,o){var p=this,n=p.getRuntime();if(q==="readAsDataURL"){j="data:"+(o.type||"")+";base64,"}p.bind("Progress",function(s,r){if(r){j+=k(r,q)}});return n.shimExec.call(this,"FileReader","readAsBase64",o.uid)},getResult:function(){return j},destroy:function(){j=null}};return(l.FileReader=m)});h("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(k,i){function j(m,n){switch(n){case"readAsText":return i.atob(m,"utf8");case"readAsBinaryString":return i.atob(m);case"readAsDataURL":return m}return null}var l={read:function(p,o){var m,n=this.getRuntime();m=n.shimExec.call(this,"FileReaderSync","readAsBase64",o.uid);if(!m){return null}if(p==="readAsDataURL"){m="data:"+(o.type||"")+";base64,"+m}return j(m,p,o.type)}};return(k.FileReaderSync=l)});h("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(o,i,k,n,m,q,l,j){var p={send:function(y,t){var v=this,z=v.getRuntime();function s(){y.transport=z.mode;z.shimExec.call(v,"XMLHttpRequest","send",y,t)}function u(B,A){z.shimExec.call(v,"XMLHttpRequest","appendBlob",B,A.uid);t=null;s()}function w(B,A){var C=new l();C.bind("TransportingComplete",function(){A(this.result)});C.transport(B.getSource(),B.type,{ruid:z.uid})}if(!i.isEmptyObj(y.headers)){i.each(y.headers,function(A,B){z.shimExec.call(v,"XMLHttpRequest","setRequestHeader",B,A.toString())})}if(t instanceof q){var x;t.each(function(B,A){if(B instanceof k){x=A}else{z.shimExec.call(v,"XMLHttpRequest","append",A,B)}});if(!t.hasBlob()){t=null;s()}else{var r=t.getBlob();if(r.isDetached()){w(r,function(A){r.destroy();u(x,A)})}else{u(x,r)}}}else{if(t instanceof k){if(t.isDetached()){w(t,function(A){t.destroy();t=A.uid;s()})}else{t=t.uid;s()}}else{s()}}},getResponse:function(u){var r,t,s=this.getRuntime();t=s.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(t){t=new n(s.uid,t);if("blob"===u){return t}else{if(!!~i.inArray(u,["","text"])){r=new m();return r.readAsText(t)}else{if("arraybuffer"===u){}else{if("json"===u){r=new m();try{return j(r.readAsText(t))}catch(v){return null}}}}}}return null},abort:function(s){var r=this.getRuntime();r.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!s){}}};return(o.XMLHttpRequest=p)});h("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(i,k){var j={getAsBlob:function(n){var m=this.getRuntime(),l=m.shimExec.call(this,"Transporter","getAsBlob",n);if(l){return new k(m.uid,l)}return null}};return(i.Transporter=j)});h("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(j,l,k,n,m){var i={loadFromBlob:function(r){var q=this,p=q.getRuntime();function o(t){p.shimExec.call(q,"Image","loadFromBlob",t.uid);q=p=null}if(r.isDetached()){var s=new k();s.bind("TransportingComplete",function(){o(s.result.getSource())});s.transport(r.getSource(),r.type,{ruid:p.uid})}else{o(r.getSource())}},loadFromImage:function(p){var o=this.getRuntime();return o.shimExec.call(this,"Image","loadFromImage",p.uid)},getAsBlob:function(q,r){var p=this.getRuntime(),o=p.shimExec.call(this,"Image","getAsBlob",q,r);if(o){return new n(p.uid,o)}return null},getAsDataURL:function(){var q=this.getRuntime(),p=q.Image.getAsBlob.apply(this,arguments),o;if(!p){return null}o=new m();return o.readAsDataURL(p)}};return(j.Image=i)});h("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(j,m,l,p,i){var n="silverlight",o={};function q(z){var C=false,v=null,r,s,t,B,u,x=0;try{try{v=new ActiveXObject("AgControl.AgControl");if(v.IsVersionSupported(z)){C=true}v=null}catch(y){var w=navigator.plugins["Silverlight Plug-In"];if(w){r=w.description;if(r==="1.0.30226.2"){r="2.0.30226.2"}s=r.split(".");while(s.length>3){s.pop()}while(s.length<4){s.push(0)}t=z.split(".");while(t.length>4){t.pop()}do{B=parseInt(t[x],10);u=parseInt(s[x],10);x++}while(x<t.length&&B===u);if(B<=u&&!isNaN(B)){C=true}}}}catch(A){C=false}return C}function k(s){var r=this,t;s=j.extend({xap_url:m.xap_url},s);i.call(this,s,n,{access_binary:i.capTrue,access_image_binary:i.capTrue,display_media:i.capTrue,do_cors:i.capTrue,drag_and_drop:false,report_upload_progress:i.capTrue,resize_image:i.capTrue,return_response_headers:function(u){return u&&r.mode==="client"},return_response_type:i.capTrue,return_status_code:function(u){return r.mode==="client"||!j.arrayDiff(u,[200,404])},select_file:i.capTrue,select_multiple:i.capTrue,send_binary_string:i.capTrue,send_browser_cookies:function(u){return u&&r.mode==="browser"},send_custom_headers:function(u){return u&&r.mode==="client"},send_multipart:i.capTrue,slice_blob:i.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:i.capTrue,use_http_method:function(u){return r.mode==="client"||!j.arrayDiff(u,["GET","POST"])}},{return_response_headers:function(u){return u?"client":"browser"},return_status_code:function(u){return j.arrayDiff(u,[200,404])?"client":["client","browser"]},send_browser_cookies:function(u){return u?"browser":"client"},send_custom_headers:function(u){return u?"client":"browser"},use_http_method:function(u){return j.arrayDiff(u,["GET","POST"])?"client":["client","browser"]}});if(!q("2.0.31005.0")||m.browser==="Opera"){this.mode=false}j.extend(this,{getShim:function(){return l.get(this.uid).content.Moxie},shimExec:function(v,w){var u=[].slice.call(arguments,2);return r.getShim().exec(this.uid,v,w,u)},init:function(){var u;u=this.getShimContainer();u.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+s.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+m.global_event_dispatcher+'"/></object>';t=setTimeout(function(){if(r&&!r.initialized){r.trigger("Error",new p.RuntimeError(p.RuntimeError.NOT_INIT_ERR))}},m.OS!=="Windows"?10000:5000)},destroy:(function(u){return function(){u.call(r);clearTimeout(t);s=t=u=r=null}}(this.destroy))},o)}i.addConstructor(n,k);return o});h("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(i,j,k){return(i.Blob=j.extend({},k))});h("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(i){var j={init:function(l){function k(n){var o="";for(var m=0;m<n.length;m++){o+=(o!==""?"|":"")+n[m].title+" | *."+n[m].extensions.replace(/,/g,";*.")}return o}this.getRuntime().shimExec.call(this,"FileInput","init",k(l.accept),l.name,l.multiple);this.trigger("ready")}};return(i.FileInput=j)});h("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(k,j,i){var l={init:function(){var n=this,m=n.getRuntime(),o;o=m.getShimContainer();i.addEvent(o,"dragover",function(p){p.preventDefault();p.stopPropagation();p.dataTransfer.dropEffect="copy"},n.uid);i.addEvent(o,"dragenter",function(q){q.preventDefault();var p=j.get(m.uid).dragEnter(q);if(p){q.stopPropagation()}},n.uid);i.addEvent(o,"drop",function(q){q.preventDefault();var p=j.get(m.uid).dragDrop(q);if(p){q.stopPropagation()}},n.uid);return m.shimExec.call(this,"FileDrop","init")}};return(k.FileDrop=l)});h("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(i,k,j){return(i.FileReader=k.extend({},j))});h("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(i,j,k){return(i.FileReaderSync=j.extend({},k))});h("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(i,k,j){return(i.XMLHttpRequest=k.extend({},j))});h("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(i,k,j){return(i.Transporter=k.extend({},j))});h("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(j,k,i){return(j.Image=k.extend({},i))});h("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(o,i,l,k){var n="html4",m={};function j(q){var p=this,s=l.capTest,r=l.capTrue;l.call(this,q,n,{access_binary:s(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:s(m.Image&&(k.can("create_canvas")||k.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:s(function(){return(k.browser==="Chrome"&&k.version>=28)||(k.browser==="IE"&&k.version>=10)}()),resize_image:function(){return m.Image&&p.can("access_binary")&&k.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(t){return !!~o.inArray(t,["json","text","document",""])},return_status_code:function(t){return !o.arrayDiff(t,[200,404])},select_file:function(){return k.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return p.can("select_file")},summon_file_dialog:s(function(){return(k.browser==="Firefox"&&k.version>=4)||(k.browser==="Opera"&&k.version>=12)||(k.browser==="IE"&&k.version>=10)||!!~o.inArray(k.browser,["Chrome","Safari"])}()),upload_filesize:r,use_http_method:function(t){return !o.arrayDiff(t,["GET","POST"])}});o.extend(this,{init:function(){this.trigger("Init")},destroy:(function(t){return function(){t.call(p);t=p=null}}(this.destroy))});o.extend(this.getShim(),m)}l.addConstructor(n,j);return m});h("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(m,o,l,j,k,i){function n(){var s,q=[],t=[],p;function r(){var w=this,z=w.getRuntime(),y,x,u,B,v,A;A=o.guid("uid_");y=z.getShimContainer();if(s){u=l.get(s+"_form");if(u){o.extend(u.style,{top:"100%"})}}B=document.createElement("form");B.setAttribute("id",A+"_form");B.setAttribute("method","post");B.setAttribute("enctype","multipart/form-data");B.setAttribute("encoding","multipart/form-data");o.extend(B.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});v=document.createElement("input");v.setAttribute("id",A);v.setAttribute("type","file");v.setAttribute("name","Filedata");v.setAttribute("accept",t.join(","));o.extend(v.style,{fontSize:"999px",opacity:0});B.appendChild(v);y.appendChild(B);o.extend(v.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(i.browser==="IE"&&i.version<10){o.extend(v.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}v.onchange=function(){var C;if(!this.value){return}if(this.files){C=this.files[0]}else{C={name:this.value}}q=[C];this.onchange=function(){};r.call(w);w.bind("change",function(){var D=l.get(A),F=l.get(A+"_form"),E;if(w.files.length&&D&&F){E=w.files[0];D.setAttribute("id",E.uid);F.setAttribute("id",E.uid+"_form");F.setAttribute("target",E.uid+"_iframe")}D=F=null},998);v=B=null;w.trigger("change")};if(z.can("summon_file_dialog")){x=l.get(p.browse_button);j.removeEvent(x,"click",w.uid);j.addEvent(x,"click",function(C){if(v&&!v.disabled){v.click()}C.preventDefault()},w.uid)}s=A;y=u=x=null;w.trigger({type:"ready",async:true})}o.extend(this,{init:function(x){var u=this,w=u.getRuntime(),v;p=x;t=x.accept.mimes||k.extList2mimes(x.accept,w.can("filter_by_extension"));v=w.getShimContainer();(function(){var y,A,z;y=l.get(x.browse_button);if(w.can("summon_file_dialog")){if(l.getStyle(y,"position")==="static"){y.style.position="relative"}A=parseInt(l.getStyle(y,"z-index"),10)||1;y.style.zIndex=A;v.style.zIndex=A-1}z=w.can("summon_file_dialog")?y:v;j.addEvent(z,"mouseover",function(){u.trigger("mouseenter")},u.uid);j.addEvent(z,"mouseout",function(){u.trigger("mouseleave")},u.uid);j.addEvent(z,"mousedown",function(){u.trigger("mousedown")},u.uid);j.addEvent(l.get(x.container),"mouseup",function(){u.trigger("mouseup")},u.uid);y=null}());r.call(this);v=null},getFiles:function(){return q},disable:function(v){var u;if((u=l.get(s))){u.disabled=!!v}},destroy:function(){var v=this.getRuntime(),u=v.getShimContainer();j.removeAllEvents(u,this.uid);j.removeAllEvents(p&&l.get(p.container),this.uid);j.removeAllEvents(p&&l.get(p.browse_button),this.uid);if(u){u.innerHTML=""}s=q=t=p=null}})}return(m.FileInput=n)});h("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(i,j){return(i.FileReader=j)});h("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(n,j,m,i,o,q,l,r,k){function p(){var u,s,v;function t(w){var B=this,z,A,x,y,C=false;if(!v){return}z=v.id.replace(/_iframe$/,"");A=m.get(z+"_form");if(A){x=A.getElementsByTagName("input");y=x.length;while(y--){switch(x[y].getAttribute("type")){case"hidden":x[y].parentNode.removeChild(x[y]);break;case"file":C=true;break}}x=[];if(!C){A.parentNode.removeChild(A)}A=null}setTimeout(function(){q.removeEvent(v,"load",B.uid);if(v.parentNode){v.parentNode.removeChild(v)}var D=B.getRuntime().getShimContainer();if(!D.children.length){D.parentNode.removeChild(D)}D=v=null;w()},1)}j.extend(this,{send:function(E,y){var A=this,D=A.getRuntime(),z,x,C,w;u=s=null;function B(){var F=D.getShimContainer()||document.body,G=document.createElement("div");G.innerHTML='<iframe id="'+z+'_iframe" name="'+z+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';v=G.firstChild;F.appendChild(v);q.addEvent(v,"load",function(){var I;try{I=v.contentWindow.document||v.contentDocument||window.frames[v.id].document;if(/^4\d{2}\s/.test(I.title)&&I.getElementsByTagName("address").length){u=I.title.replace(/^(\d+).*$/,"$1")}else{u=200;s=j.trim(I.body.innerHTML);A.trigger({type:"progress",loaded:s.length,total:s.length});if(w){A.trigger({type:"uploadprogress",loaded:w.size||1025,total:w.size||1025})}}}catch(H){if(i.hasSameOrigin(E.url)){u=404}else{t.call(A,function(){A.trigger("error")});return}}t.call(A,function(){A.trigger("load")})},A.uid)}if(y instanceof r&&y.hasBlob()){w=y.getBlob();z=w.uid;C=m.get(z);x=m.get(z+"_form");if(!x){throw new o.DOMException(o.DOMException.NOT_FOUND_ERR)}}else{z=j.guid("uid_");x=document.createElement("form");x.setAttribute("id",z+"_form");x.setAttribute("method",E.method);x.setAttribute("enctype","multipart/form-data");x.setAttribute("encoding","multipart/form-data");x.setAttribute("target",z+"_iframe");D.getShimContainer().appendChild(x)}if(y instanceof r){y.each(function(H,F){if(H instanceof l){if(C){C.setAttribute("name",F)}}else{var G=document.createElement("input");j.extend(G,{type:"hidden",name:F,value:H});x.appendChild(G)}})}x.setAttribute("action",E.url);B();x.submit();A.trigger("loadstart")},getStatus:function(){return u},getResponse:function(w){if("json"===w){if(j.typeOf(s)==="string"){try{return k(s.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(x){return null}}}else{if("document"===w){}}return s},abort:function(){var w=this;if(v&&v.contentWindow){if(v.contentWindow.stop){v.contentWindow.stop()}else{if(v.contentWindow.document.execCommand){v.contentWindow.document.execCommand("Stop")}else{v.src="about:blank"}}}t.call(this,function(){w.dispatchEvent("abort")})}})}return(n.XMLHttpRequest=p)});h("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(j,i){return(j.Image=i)});a(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var c={},b=moxie.core.utils.Basic.inArray;(function a(e){var d,f;for(d in e){f=typeof(e[d]);if(f==="object"&&!~b(d,["Exceptions","Env","Mime"])){a(e[d])}else{if(f==="function"){c[d]=e[d]}}}})(window.moxie);c.Env=window.moxie.core.utils.Env;c.Mime=window.moxie.core.utils.Mime;c.Exceptions=window.moxie.core.Exceptions;window.mOxie=c;if(!window.o){window.o=c}return c})();(function(e,g,d){var c=e.setTimeout,f={};function a(i){var h=i.required_features,j={};function k(m,n,l){var o={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(o[m]){j[o[m]]=n}else{if(!l){j[m]=n}}}if(typeof(h)==="string"){b.each(h.split(/\s*,\s*/),function(l){k(l,true)})}else{if(typeof(h)==="object"){b.each(h,function(m,l){k(l,m)})}else{if(h===true){if(!i.multipart){j.send_binary_string=true}if(i.chunk_size>0){j.slice_blob=true}b.each(i,function(m,l){k(l,!!m,true)})}}}return j}var b={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:g.mimes,ua:g.ua,typeOf:g.typeOf,extend:g.extend,guid:g.guid,each:g.each,getPos:g.getPos,getSize:g.getSize,xmlEncode:function(i){var j={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},h=/[<>&\"\']/g;return i?(""+i).replace(h,function(k){return j[k]?"&"+j[k]+";":k}):i},toArray:g.toArray,inArray:g.inArray,addI18n:g.addI18n,translate:g.translate,isEmptyObj:g.isEmptyObj,hasClass:g.hasClass,addClass:g.addClass,removeClass:g.removeClass,getStyle:g.getStyle,addEvent:g.addEvent,removeEvent:g.removeEvent,removeAllEvents:g.removeAllEvents,cleanName:function(h){var j,k;k=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(j=0;j<k.length;j+=2){h=h.replace(k[j],k[j+1])}h=h.replace(/\s+/g,"_");h=h.replace(/[^a-z0-9_\-\.]+/gi,"");return h},buildUrl:function(i,h){var j="";b.each(h,function(l,k){j+=(j?"&":"")+encodeURIComponent(k)+"="+encodeURIComponent(l)});if(j){i+=(i.indexOf("?")>0?"&":"?")+j}return i},formatSize:function(h){if(h===d||/\D/.test(h)){return b.translate("N/A")}if(h>1099511627776){return Math.round(h/1099511627776,1)+" "+b.translate("tb")}if(h>1073741824){return Math.round(h/1073741824,1)+" "+b.translate("gb")}if(h>1048576){return Math.round(h/1048576,1)+" "+b.translate("mb")}if(h>1024){return Math.round(h/1024,1)+" "+b.translate("kb")}return h+" "+b.translate("b")},parseSize:g.parseSizeStr,predictRuntime:function(j,i){var h,k;if(i){j.runtimes=i}h=new b.Uploader(j);k=h.runtime;h.destroy();return k},addFileFilter:function(i,h){f[i]=h}};b.addFileFilter("mime_types",(function(){var i,j;function h(k){var l=[];b.each(k,function(m){b.each(m.extensions.split(/,/),function(n){if(/^\s*\*\s*$/.test(n)){l.push("\\.*")}else{l.push("\\."+n.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+l.join("|")+")$","i")}return function(m,l,k){if(!j||m!=i){j=h(m);i=[].slice.call(m)}if(!j.test(l.name)){this.trigger("Error",{code:b.FILE_EXTENSION_ERROR,message:b.translate("File extension error."),file:l});k(false)}else{k(true)}}}()));b.addFileFilter("max_file_size",function(k,i,h){var j;if(i.size!==j&&k&&i.size>k){this.trigger("Error",{code:b.FILE_SIZE_ERROR,message:b.translate("File size error."),file:i});h(false)}else{h(true)}});b.addFileFilter("prevent_duplicates",function(k,i,h){if(k){var j=this.files.length;while(j--){if(i.name===this.files[j].name&&i.size===this.files[j].size){this.trigger("Error",{code:b.FILE_DUPLICATE_ERROR,message:b.translate("Duplicate file error."),file:i});h(false);return}}}h(true)});b.Uploader=function(l){var i=[],v={},s={},k,q,n=false,o,p,u;function j(){var y,z=0,x;if(this.state==b.STARTED){for(x=0;x<i.length;x++){if(!y&&i[x].status==b.QUEUED){y=i[x];if(this.trigger("BeforeUpload",y)){y.status=b.UPLOADING;this.trigger("UploadFile",y)}}else{z++}}if(z==i.length){if(this.state!==b.STOPPED){this.state=b.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",i)}}}function t(x){x.percent=x.size>0?Math.ceil(x.loaded/x.size*100):100;m()}function m(){var y,x;q.reset();for(y=0;y<i.length;y++){x=i[y];if(x.size!==d){q.size+=x.origSize;q.loaded+=x.loaded*x.origSize/x.size}else{q.size=d}if(x.status==b.DONE){q.uploaded++}else{if(x.status==b.FAILED){q.failed++}else{q.queued++}}}if(q.size===d){q.percent=i.length>0?Math.ceil(q.uploaded/i.length*100):0}else{q.bytesPerSec=Math.ceil(q.loaded/((+new Date()-k||1)/1000));q.percent=q.size>0?Math.ceil(q.loaded/q.size*100):0}}function h(){var x=this,z=0;var y={accept:l.filters.mime_types,runtime_order:l.runtimes,required_caps:s,swf_url:l.flash_swf_url,xap_url:l.silverlight_xap_url};b.each(l.runtimes.split(/\s*,\s*/),function(A){if(l[A]){y[A]=l[A]}});g.inSeries([function(A){if(l.browse_button){o=new g.FileInput(b.extend({},y,{name:l.file_data_name,multiple:l.multi_selection,container:l.container,browse_button:l.browse_button}));o.onready=function(){var B=g.Runtime.getInfo(this.ruid);g.extend(x.features,{chunks:B.can("slice_blob"),multipart:B.can("send_multipart"),multi_selection:B.can("select_multiple")});z++;A()};o.onchange=function(){x.addFile(this.files)};o.bind("mouseenter mouseleave mousedown mouseup",function(C){if(!n){var B=g.get(l.browse_button);if(B){if(l.browse_button_hover){if("mouseenter"===C.type){g.addClass(B,l.browse_button_hover)}else{if("mouseleave"===C.type){g.removeClass(B,l.browse_button_hover)}}}if(l.browse_button_active){if("mousedown"===C.type){g.addClass(B,l.browse_button_active)}else{if("mouseup"===C.type){g.removeClass(B,l.browse_button_active)}}}B=null}}});o.bind("error runtimeerror",function(){o=null;A()});o.init()}else{A()}},function(A){if(l.drop_element){p=new g.FileDrop(b.extend({},y,{drop_zone:l.drop_element}));p.onready=function(){var B=g.Runtime.getInfo(this.ruid);x.features.dragdrop=B.can("drag_and_drop");z++;A()};p.ondrop=function(){x.addFile(this.files)};p.bind("error runtimeerror",function(){p=null;A()});p.init()}else{A()}}],function(){if(typeof(l.init)=="function"){l.init(x)}else{b.each(l.init,function(B,A){x.bind(A,B)})}if(z){x.trigger("PostInit")}else{x.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")})}})}function w(y,x){if(y.ruid){var z=g.Runtime.getInfo(y.ruid);if(z){return z.can(x)}}return false}function r(z,B,x){var y=new g.Image();try{y.onload=function(){y.downsize(B.width,B.height,B.crop,B.preserve_headers)};y.onresize=function(){x(this.getAsBlob(z.type,B.quality));this.destroy()};y.onerror=function(){x(z)};y.load(z)}catch(A){x(z)}}q=new b.QueueProgress();l=b.extend({runtimes:g.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},l);if(l.resize){l.resize=b.extend({preserve_headers:true,crop:false},l.resize)}if(b.typeOf(l.filters)==="array"){l.filters={mime_types:l.filters}}l.filters=b.extend({mime_types:[],prevent_duplicates:!!l.prevent_duplicates,max_file_size:l.max_file_size},l.filters);l.filters.max_file_size=b.parseSize(l.filters.max_file_size)||0;l.chunk_size=b.parseSize(l.chunk_size)||0;l.required_features=s=a(b.extend({},l));b.extend(this,{id:b.guid(),state:b.STOPPED,features:{},runtime:g.Runtime.thatCan(s,l.runtimes),files:i,settings:l,total:q,init:function(){var x=this;l.browse_button=g.get(l.browse_button);l.drop_element=g.get(l.drop_element);if(typeof(l.preinit)=="function"){l.preinit(x)}else{b.each(l.preinit,function(z,y){x.bind(y,z)})}if(!l.browse_button||!l.url){this.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")});return}x.bind("FilesAdded",function(z,y){[].push.apply(i,y);c(function(){x.trigger("QueueChanged");x.refresh()},1)});x.bind("CancelUpload",function(){if(u){u.abort()}});if(l.unique_names){x.bind("BeforeUpload",function(y,z){var B=z.name.match(/\.([^.]+)$/),A="part";if(B){A=B[1]}z.target_name=z.id+"."+A})}x.bind("UploadFile",function(G,D){var A=G.settings.url,B=G.features,E=l.chunk_size,H=l.max_retries,y,F=0;if(D.loaded){F=D.loaded=E*Math.floor(D.loaded/E)}function C(){if(H-->0){c(z,1)}else{D.loaded=F;G.trigger("Error",{code:b.HTTP_ERROR,message:b.translate("HTTP Error."),file:D,response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()})}}function z(){var K,J,I,L;if(D.status==b.DONE||D.status==b.FAILED||G.state==b.STOPPED){return}I={name:D.target_name||D.name};if(E&&B.chunks&&y.size>E){L=Math.min(E,y.size-F);K=y.slice(F,F+L)}else{L=y.size;K=y}if(E&&B.chunks){if(l.send_chunk_number){I.chunk=Math.ceil(F/E);I.chunks=Math.ceil(y.size/E)}else{I.offset=F;I.total=y.size}}else{I.chunk=0;I.chunks=1}u=new g.XMLHttpRequest();u.withCredentials=true;if(u.upload){u.upload.onprogress=function(M){D.loaded=Math.min(D.size,F+M.loaded);G.trigger("UploadProgress",D)}}u.onload=function(){if(u.status>=400){C();return}if(L<y.size){K.destroy();F+=L;D.loaded=Math.min(F,y.size);G.trigger("ChunkUploaded",D,{offset:D.loaded,total:y.size,response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()});if(g.Env.browser==="Android Browser"){G.trigger("UploadProgress",D)}}else{D.loaded=D.size}K=J=null;if(!F||F>=y.size){if(D.size!=D.origSize){y.destroy();y=null}G.trigger("UploadProgress",D);D.status=b.DONE;G.trigger("FileUploaded",D,{response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()})}else{H=l.max_retries;c(z,1)}};u.onerror=function(){C()};u.onloadend=function(){this.destroy();u=null};if(G.settings.multipart&&B.multipart){I.name=D.target_name||D.name;u.open("post",A,true);b.each(G.settings.headers,function(N,M){u.setRequestHeader(M,N)});J=new g.FormData();b.each(b.extend(I,G.settings.multipart_params),function(N,M){J.append(M,N)});J.append(G.settings.file_data_name,K);u.send(J,{runtime_order:G.settings.runtimes,required_caps:s,swf_url:G.settings.flash_swf_url,xap_url:G.settings.silverlight_xap_url})}else{A=b.buildUrl(G.settings.url,b.extend(I,G.settings.multipart_params));u.open("post",A,true);u.setRequestHeader("Content-Type","application/octet-stream");b.each(G.settings.headers,function(N,M){u.setRequestHeader(M,N)});u.send(K,{runtime_order:G.settings.runtimes,required_caps:s,swf_url:G.settings.flash_swf_url,xap_url:G.settings.silverlight_xap_url})}}y=D.getSource();if(!g.isEmptyObj(G.settings.resize)&&w(y,"send_binary_string")&&!!~g.inArray(y.type,["image/jpeg","image/png"])){r.call(this,y,G.settings.resize,function(I){y=I;D.size=I.size;z()})}else{z()}});x.bind("UploadProgress",function(y,z){t(z)});x.bind("StateChanged",function(y){if(y.state==b.STARTED){k=(+new Date())}else{if(y.state==b.STOPPED){for(var z=y.files.length-1;z>=0;z--){if(y.files[z].status==b.UPLOADING){y.files[z].status=b.QUEUED;m()}}}}});x.bind("QueueChanged",m);x.bind("Error",function(y,z){if(z.file){z.file.status=b.FAILED;t(z.file);if(y.state==b.STARTED){c(function(){j.call(x)},1)}}});x.bind("FileUploaded",function(){m();c(function(){j.call(x)},1)});x.trigger("Init",{runtime:this.runtime});h.call(this)},refresh:function(){if(o){o.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=b.STARTED){this.state=b.STARTED;this.trigger("StateChanged");j.call(this)}},stop:function(){if(this.state!=b.STOPPED){this.state=b.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){n=arguments[0]!==d?arguments[0]:true;if(o){o.disable(n)}this.trigger("DisableBrowse",n)},getFile:function(y){var x;for(x=i.length-1;x>=0;x--){if(i[x].id===y){return i[x]}}},addFile:function(y,z){var E=this,B=[],x=[],D;function A(){var G=p||o;if(G){return G.getRuntime().uid}return false}function C(I,H){var G=[];g.each(E.settings.filters,function(K,J){if(f[J]){G.push(function(L){f[J].call(E,K,I,function(M){L(!M)})})}});g.inSeries(G,H)}function F(G){var H=g.typeOf(G);if(G instanceof g.File){if(!G.ruid&&!G.isDetached()){if(!D){return false}G.ruid=D;G.connectRuntime(D)}F(new b.File(G))}else{if(G instanceof g.Blob){F(G.getSource());G.destroy()}else{if(G instanceof b.File){if(z){G.name=z}B.push(function(I){C(G,function(J){if(!J){x.push(G)}I()})})}else{if(g.inArray(H,["file","blob"])!==-1){F(new g.File(null,G))}else{if(H==="node"&&g.typeOf(G.files)==="filelist"){g.each(G.files,F)}else{if(H==="array"){z=null;g.each(G,F)}}}}}}}D=A();F(y);if(B.length){g.inSeries(B,function(){if(x.length){E.trigger("FilesAdded",x)}})}},removeFile:function(y){var z=typeof(y)==="string"?y:y.id;for(var x=i.length-1;x>=0;x--){if(i[x].id===z){return this.splice(x,1)[0]}}},splice:function(z,x){var y=i.splice(z===d?0:z,x===d?i.length:x);this.trigger("FilesRemoved",y);this.trigger("QueueChanged");b.each(y,function(A){A.destroy()});return y},trigger:function(y){var A=v[y.toLowerCase()],z,x;if(A){x=Array.prototype.slice.call(arguments);x[0]=this;for(z=0;z<A.length;z++){if(A[z].func.apply(A[z].scope,x)===false){return false}}}return true},hasEventListener:function(x){return !!v[x.toLowerCase()]},bind:function(x,z,y){var A;x=x.toLowerCase();A=v[x]||[];A.push({func:z,scope:y||this});v[x]=A},unbind:function(x){x=x.toLowerCase();var A=v[x],y,z=arguments[1];if(A){if(z!==d){for(y=A.length-1;y>=0;y--){if(A[y].func===z){A.splice(y,1);break}}}else{A=[]}if(!A.length){delete v[x]}}},unbindAll:function(){var x=this;b.each(v,function(z,y){x.unbind(y)})},destroy:function(){this.stop();b.each(i,function(x){x.destroy()});i=[];if(o){o.destroy();o=null}if(p){p.destroy();p=null}s={};k=q=n=u=null;this.trigger("Destroy");this.unbindAll();v={}}})};b.File=(function(){var i={};function h(j){b.extend(this,{id:b.guid(),name:j.name||j.fileName,type:j.type||"",size:j.size||j.fileSize,origSize:j.size||j.fileSize,loaded:0,percent:0,status:b.QUEUED,lastModifiedDate:j.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var k=this.getSource().getSource();return g.inArray(g.typeOf(k),["blob","file"])!==-1?k:null},getSource:function(){if(!i[this.id]){return null}return i[this.id]},destroy:function(){var k=this.getSource();if(k){k.destroy();delete i[this.id]}}});i[this.id]=j}return h}());b.QueueProgress=function(){var h=this;h.size=0;h.loaded=0;h.uploaded=0;h.failed=0;h.queued=0;h.percent=0;h.bytesPerSec=0;h.reset=function(){h.size=h.loaded=h.uploaded=h.failed=h.queued=h.percent=h.bytesPerSec=0}};e.plupload=b}(window,mOxie));var BulkUpload,FileQueue,InlineUploadStatus,OverQuotaUploads,Upload,UploadFile,UploadPrep,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var c,b,d,a;d={"MSIE 8.0":"flash","MSIE 9.0":"flash"};b="html5";for(c in d){a=d[c];if(navigator.userAgent.indexOf(c)!==-1){b=a}}return b})(),set_dest:function(a){DomUtil.fillVal(a,"dest-folder");return this.current_dest=a},init:function(c,d,e,b){var a;this.set_dest(c);a=this.initPLU(e,b);if(!d){event_load.window_load(a)}else{a()}$j("#flash-upload-container > .moxie-shim").each(function(f){if(f.observe){Util.freshbutton_overlay(f,$("choose-button"));return Util.freshbutton_overlay(f,$("add-button"))}});return FileQueue.clear()},init_basic:function(){Util.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(a){return document.fire(Upload.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(c){var b,a,d;b=$("modal").cumulativeOffset();d=c.clientY-b.top-3;a=c.clientX-b.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:d+"px",left:a+"px"})});return $("file-box").observe("change",function(){var e,c,f,d,a,b;Modal.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();c=$("file-box").getValue().split("\\").pop();d=Sprite.make("web",FilePath.file_icon(c));$("basic-upload-status").down(".icon").__date(d);e=_("Uploading %(filename)s").format({filename:Emstring.em_snippet(c,25)});$("basic-upload-status").down(".file-desc").__date(e);$("basic-upload-status").show();$("basic-uploading-message").show();f=$("file-box").files;b=0;if(f){a=f[0].lastModifiedDate;if(a){b=Math.round(Date.parse(a)/1000)||0}}if(!b){b=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=b;return $("basic-upload-form").submit()})},initPLU:function(b,a){return(function(c){return function(){var e,d;e={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:c.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:"choose-button",container:"flash-upload-container",preinit:{PostInit:function(){if(b){b()}return c.uploaderLoaded()},Error:c.uploadError.bind(c)},init:{FilesAdded:c.fileQueued.bind(c),UploadProgress:c.uploadProgress.bind(c),FileUploaded:c.uploadSuccess.bind(c),BeforeUpload:c.prepareFileForUploading.bind(c),ChunkUploaded:c.chunkUploaded.bind(c),UploadComplete:FileQueue.finished.bind(FileQueue),Refresh:function(){if(c.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){$j("#flash-upload-container").clonePosition($j("#add-button"));$j("#flash-upload-container > .moxie-shim")[0].style.width="100%";return $j("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:Constants.static_url_moxie_swf};if(a!=null){$j.extend(e,a)}d=new plupload.Uploader(e);c.PLU=d;return c.PLU.init()}})(this)},reset:function(){if(FileQueue.uploading&&FileQueue.current_file){this.PLU.removeFile(FileQueue.current_file)}return InlineUploadStatus.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return InlineUploadStatus.show()}},updatePostParams:function(c){var b,a;a=this.PLU.settings.multipart_params;for(b in c){if(c.hasOwnProperty(b)){a[b]=c[b]}}return this.PLU.settings.multipart_params=a},fileQueued:function(b,g){var e,d,a,c;for(d=0,a=g.length;d<a;d++){e=g[d];if((typeof e.getNative==="function"?(c=e.getNative())!=null?c.dest:void 0:void 0)===void 0){e.dest=Upload.current_dest}else{e.dest=e.getNative().dest}}document.fire(this.QUEUE_EVT,{files:g});$j(document).trigger(this.QUEUE_EVT,{files:g});return this.show_upload()},uploadNext:function(){var c,a,b,d;b=FileQueue.next();a=($u.contains(Upload.APPLE_PACKAGE_EXTENSIONS,FilePath.file_extension_for_logging(b.name))&&b.size%34===0)||(FilePath.file_extension_for_logging(b.name)===""&&b.size%34===0&&b.size<=3400);if(a){b.status=plupload.FAILED;c={file:b,code:Upload.APPLE_PACKAGE_ERROR,message:_("Can\u2019t Upload"),tooltip_text:_('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,c);return false}d={dest:FileQueue.next().dest,t:Constants.TOKEN};d[Constants.UID_PARAM_NAME]=Browse.active_user;Upload.updatePostParams(d);this.PLU.start();FileQueue.last_update_time=0;FileQueue.last_update_size=0;return true},pause:function(){return Upload.PLU.stop()},uploadProgress:function(b,a){if(!FileQueue.cancelled_files[a.id]){document.fire(this.UPDATE_EVT,{file:a,percent_complete:a.loaded/a.size});return $j(document).trigger(this.UPDATE_EVT,{file:a,percent_complete:a.loaded/a.size})}},generateUploadId:function(){var a,b,d,c;a="";for(b=c=0;c<=15;b=++c){a+=String.fromCharCode(Math.floor(Math.random()*256))}d=base64.encode(a);d=d.replace(/\+/g,"-");d=d.replace(/\//g,"_");d=d.replace(/\=*$/,"");return d},chunkUploaded:function(b,c,d){var a;a=JSON.parse(d.response||"");return this.updatePostParams({offset:a.offset})},prepareFileForUploading:function(){var a;a=FileQueue.next();return this.updatePostParams({reported_total_size:a.size,dest:a.dest,t:Constants.TOKEN,upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(e,d,c){var b,a;try{a=JSON.parse(c.response)}catch(f){b=f;a=null}if(c.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:d,message:_("Quota exceeded"),tooltip_text:_("Your upload failed because you are over quota.")});return $j(document).trigger(this.ERROR_EVT,{file:d,message:_("Quota exceeded"),tooltip_text:_("Your upload failed because you are over quota.")})}else{if(c.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:d,message:_("Empty File")});return $j(document).trigger(this.CANCEL_EVT,{file:d,message:_("Empty File")})}else{if(c.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:d,message:_("File Ignored")});return $j(document).trigger(this.CANCEL_EVT,{file:d,message:_("File Ignored")})}else{if((a!=null?a.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:d});return $j(document).trigger(this.COMPLETE_EVT,{file:d})}else{document.fire(this.ERROR_EVT,{file:d});return $j(document).trigger(this.ERROR_EVT,{file:d})}}}}},uploadComplete:function(b,a){document.fire(this.COMPLETE_EVT,{file:a});return $j(document).trigger(this.COMPLETE_EVT,{file:a})},uploadError:function(f,a){var d,b,c;if((c=a.file.id,__indexOf.call(FileQueue.file_ids(),c)<0)&&a.code!==Upload.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[a.file]});$j(document).trigger(this.QUEUE_EVT,{files:[a.file]})}window.errorObj=a;b=(function(){switch(a.code){case plupload.FILE_SIZE_ERROR:return _("File too large");default:return _("Upload Error")}})();this.show_upload();d={file:a.file,error_code:a.code,message:b};if(a!=null?a.tooltip_text:void 0){d.tooltip_text=a.tooltip_text}document.fire(this.ERROR_EVT,d);return $j(document).trigger(this.ERROR_EVT,d)},grabURL:function(){var a;a=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(a)){$("url").value=a}return true},treeview_handler:function(b,a){var c;DomUtil.fillVal(b,"dest-folder");c=$("basic-uploader-url");if(c){c.href=c.href.replace(/(\/upload)(.*)(\?basic=1)/,function(g,e,h,d){return e+Util.urlquote(b)+d})}return FileQueue.clear()},new_folder:function(){TreeView.hide();Modal.show(_("Create new folder..."),DomUtil.fromElm("create-folder"),{action:this.do_new_folder.bind(this,Browse.active_user),wit_group:"new-folder-confirm"});if(!Util.ie){return $j("#first-treeview-link").trigger("click")}},do_new_folder:function(a){var c,b;if(!Modal.vars.selected_path){Notify.error(_("Please select a parent folder."));return}b=$F("entered-name");c=Modal.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+Util.urlquote(c)+"?to_path="+Util.urlquote(b),{subject_user:a,onSuccess:(function(d){return function(e){d.treeview_handler(FilePath.normalize(c)+"/"+b);return TreeView.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(Upload.PLU.runtime==="flash"){$j("#flash-upload-container").clonePosition($j("#choose-button"));$j("#flash-upload-container > .moxie-shim")[0].style.top="0px";$j("#flash-upload-container > .moxie-shim")[0].style.left="0px";$j("#flash-upload-container > .moxie-shim")[0].style.width="100%";return $j("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{$j("#choose-button").click((function(a){return function(b){return $j("#"+a.PLU.id+"_html5").click()}})(this));return $j("#add-button").click((function(a){return function(b){return $j("#choose-button").click()}})(this))}}};FileQueue={init:function(){return FileQueue._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,FileQueue._file_queued.bind(this));document.observe(Upload.QUEUE_ERROR_EVT,FileQueue._file_queue_errored.bind(this));document.observe(Upload.UPDATE_EVT,FileQueue._file_updated.bind(this));document.observe(Upload.COMPLETE_EVT,FileQueue._file_completed.bind(this));document.observe(Upload.ERROR_EVT,FileQueue._file_errored.bind(this));return document.observe(Upload.CANCEL_EVT,FileQueue._file_cancelled.bind(this))},_file_queued:function(g){var c,f,b,d,a;d=g.memo.files;a=[];for(f=0,b=d.length;f<b;f++){c=d[f];this.files[c.id]=c;if(!FileQueue.uploading){this._start_uploading()}this.current_file=c;a.push(T("File queued:",c.name))}return a},_file_queue_errored:function(a){this._file_queued(a);return setTimeout(((function(b){return function(){return b._file_errored(a)}})(this)),250)},_file_updated:function(j){var d,a,b,c,h,g,f,i,k;c=j.memo.file;g=j.memo.percent_complete;h=g*c.size;k=h+this.completed_size();b=new Date().getTime();if(this.last_update_time){f=(b-this.last_update_time)/1000;if(Upload.PLU.total.bytesPerSec){this.average_bps=Upload.PLU.total.bytesPerSec}else{a=h-this.last_update_size;d=a/f;this.average_bps=((k-a)*this.average_bps+a*d)/k}i=(this.queue_size()-k)/this.average_bps;this.formatted_time=datetime.format_time(i+this.num_left())}this.current_file=c;this.last_update_time=new Date().getTime();return this.last_update_size=h},_file_completed:function(b){var a;a=b.memo.file;this.completed_files[a.id]=true;T("File completed:",a.name);return this._check_if_finished(a)},_file_errored:function(b){var a;a=b.memo.file;this.errored_files[a.id]=true;BulkUpload.update_errors();InlineUploadStatus.update_errors();T("File errored:",a.name);return this._check_if_finished(a)},_file_cancelled:function(b){var a;a=b.memo.file;this.cancelled_files[a.id]=true;if(a.status===plupload.UPLOADING){Upload.PLU.stop();Upload.PLU.removeFile(a);Upload.PLU.start()}else{Upload.PLU.removeFile(a)}T("File cancelled:",a.name);return this._check_if_finished(a)},_start_uploading:function(){var a;this.uploading=Upload.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=a=(function(b){return function(){return _("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(a){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return Upload.uploadNext()}},_finished_uploading:function(){var b,c,d,a;this.uploading=false;if(!this.num_files()){BulkUpload.cancelled()}else{if(this.errors()){BulkUpload.errored();InlineUploadStatus.errored()}else{BulkUpload.completed();InlineUploadStatus.completed()}}a=$("inline-upload-status").visible();Browse.select_fq_paths=[];if(Browse.inside_dir){for(d in this.completed_files){c=this.files[d];b=FilePath.normalize(c.dest);Browse.select_fq_paths.push(""+b+"/"+c.name)}Browse.force_reload()}else{if(Browse.in_search_mode()){FileSearch.force_reload()}}if(a){InlineUploadStatus.show()}Modal.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return $u(this.files).filter((function(a){return function(b){return !(a.cancelled_files[b.id]||a.errored_files[b.id]||a.completed_files[b.id])}})(this))[0]},cancels:function(){return $u(this.cancelled_files).keys().length},errors:function(){return $u(this.errored_files).keys().length},queue_size:function(){var b,f,c,e,a,d;c=0;d=this.file_ids();for(e=0,a=d.length;e<a;e++){f=d[e];b=this.files[f];if(!this.errored_files[f]&&!this.cancelled_files[f]&&typeof b.size!=="undefined"){c+=b.size}}return c},completed_size:function(){var e,b,d,a,c;b=0;c=$u(this.completed_files).keys();for(d=0,a=c.length;d<a;d++){e=c[d];if(typeof this.files[e].size!=="undefined"){b+=this.files[e].size}}return b},file_ids:function(){return $u(this.files).map((function(a){return function(b,c){return c}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return $u(this.file_ids()).filter((function(a){return function(b){return !(a.cancelled_files[b]||a.errored_files[b]||a.completed_files[b])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof Modal!=="undefined"&&Modal!==null){return Modal.onHide=null}}};FileQueue.clear();UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){UploadFile._tmpl=HTML.tmpl("upload_list_item_tmpl");return UploadFile._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,UploadFile._file_queued);document.observe(Upload.QUEUE_ERROR_EVT,UploadFile._file_queue_errored);document.observe(Upload.UPDATE_EVT,UploadFile._file_updated);document.observe(Upload.COMPLETE_EVT,UploadFile._file_completed);document.observe(Upload.ERROR_EVT,UploadFile._file_errored);return document.observe(Upload.CANCEL_EVT,UploadFile._file_cancelled)},_file_queued:function(g){var c,f,b,d,a;d=g.memo.files;a=[];for(f=0,b=d.length;f<b;f++){c=d[f];a.push((function(k){var j,n,m,i,h,e,l;j=k.dest;h=display_format.format_bytes(k.size||0);n=UploadFile._tmpl({file:k,icon:FilePath.file_icon(k.name),filename_snippet:Emstring.em_snippet(k.name,UploadFile.FILENAME_SNIPPET_LENGTH),size:h,dest:j,dest_snippet:Emstring.em_snippet(_("Dropbox")+j,UploadFile.DEST_SNIPPET_LENGTH,0)});$("upload-files-list").__sert(n);m=$(k.id);i=FileQueue.num_files();e=$("upload-files-list");if(i<=6){e.removeClassName("scroll")}else{e.addClassName("scroll")}e.scrollTop=e.scrollHeight;m.down(".dest").observe("click",function(){Browse.reload_fqpath(m.readAttribute("data-dest"),true);return Modal.hide()});l=m.down(".status-col").down("a.small-x-button");l.stopObserving("click");l.observe("click",function(o){document.fire(Upload.CANCEL_EVT,{file:k});return $j(document).trigger(Upload.CANCEL_EVT,{file:k})});return m.down(".upload-progress-bar").setStyle({width:"0"})})(c))}return a},_file_queue_errored:function(a){UploadFile._file_queued(a);return UploadFile._file_errored(a)},_file_updated:function(d){var c,f,b,a;c=d.memo.file;f=$(c.id);if(FileQueue.num_files()===1){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});f.down(".time-col").__date(a)}b=parseInt(c.percent,10)+"%";if(b==="100%"){f.down(".time-col").__date();f.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"}))}return f.down(".upload-progress-bar").setStyle({width:b})},_file_completed:function(b){var a,c;a=b.memo.file;a.completed=true;c=$(a.id);c.addClassName("complete");setTimeout(function(){return c.down(".status-col").__date(Sprite.make("web","s_check"))},0);return c.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(b){var a,c;a=b.memo.file;c=$(a.id);if(c){return UploadFile._actual_file_errored(b)}else{return setTimeout((function(d){return function(){return UploadFile._actual_file_errored(b)}})(this),0)}},_actual_file_errored:function(f){var a,c,b,g,d;b=f.memo.file;g=$(b.id);g.addClassName("error");g.down(".dest-col").hide();g.down(".time-col").__date();g.down(".status-col").__date(Sprite.make("web","nosync"));g.down(".upload-progress-bar").setStyle({width:"100%"});c=f.memo.message||_("Upload Error");a=void 0;if(f.memo.tooltip_text){a=f.memo.tooltip_text}else{a=_('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');$j(document).on("click","a#basic_link",function(){FileOps.show_basic_upload();return false})}g.down(".error-msg").__date(c);d=g.down(".error-details");d.observe("mouseover",function(){return Tooltip.show(d,a)});return g.down(".error-col").show()},_file_cancelled:function(b){var a,c;a=b.memo.file;c=$(a.id);c.addClassName("cancelled");c.down(".dest-col").__date(_(b.memo.message||"Canceled"));c.down(".time-col").__date();c.down(".status-col").__date(Sprite.make("web","cancelsync"));return c.down(".upload-progress-bar").setStyle({width:"100%"})}};BulkUpload={init:function(){this.elem=$("bulk-upload-status");return BulkUpload._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,BulkUpload._file_queued.bind(this));return document.observe(Upload.UPDATE_EVT,BulkUpload._file_updated.bind(this))},_file_queued:function(b){var a;a=new Element("a",{"class":"small-x-button"});a.observe("click",function(){var e,g,f,d,c;FileQueue.all_cancelled=true;e=FileQueue.file_ids().slice(0);c=[];for(f=0,d=e.length;f<d;f++){g=e[f];if(!FileQueue.completed_files[g]&&!FileQueue.errored_files[g]){document.fire(Upload.CANCEL_EVT,{file:FileQueue.files[g]});c.push($j(document).trigger(Upload.CANCEL_EVT,{file:FileQueue.files[g]}))}else{c.push(void 0)}}return c});return this.elem.down(".status").__date(a)},_file_updated:function(d){var c,b,a;if(FileQueue.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");c=ungettext("%d file","%d files",FileQueue.num_non_cancelled_files()).format(FileQueue.num_non_cancelled_files());this.elem.down(".num-files").__date(c);b=_("- %(size)s").format({size:display_format.format_bytes(Upload.PLU.total.size)});this.elem.down(".size").__date(b);if(FileQueue.formatted_time){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});this.elem.down(".time-left").__date(a)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(FileQueue.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(Upload.PLU.runtime==="flash"){return $j("#flash-upload-container").clonePosition($j("#add-button"))}}},update_errors:function(){var a;a=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return $("bulk-upload-status").down(".num-errors").__date(a)},completed:function(){var b,a;$("hide-button").hide();$("done-button").show();if(FileQueue.num_files()>1){this.elem.addClassName("complete");b=ungettext("Uploaded %d file","Uploaded %d files",FileQueue.num_non_cancelled_files()).format(FileQueue.num_non_cancelled_files());this.elem.down(".num-files").__date(b);a=_("- %(size)s").format({size:display_format.format_bytes(FileQueue.completed_size())});this.elem.down(".size").__date(a);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Sprite.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var a;$("hide-button").hide();$("done-button").show();this.completed();a=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return this.elem.down(".num-errors").__date(a)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(FileQueue.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(_("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Sprite.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,InlineUploadStatus._file_queued.bind(this));return document.observe(Upload.UPDATE_EVT,InlineUploadStatus._file_updated.bind(this))},_file_queued:function(c){var b,a;b=$("inline-upload-status");b.removeClassName("error");b.removeClassName("complete");b.down(".icon").__date(Sprite.make("web","s_sync"));b.down(".file-desc").__date(_("Starting upload..."));b.down(".num-errors").__date();a=ungettext("%d file","%d files",FileQueue.num_left()).format(FileQueue.num_left());b.down(".view-details").__date(a);b.down(".status").__date();return b.down(".inline-upload-progress").style.width="0%"},_file_updated:function(h){var g,c,d,f,b,a;g=$("inline-upload-status");c=h.memo.file;g.down(".icon").__date(Sprite.make("web","s_sync"));d=_("Uploading %(filename)s").format({filename:Emstring.em_snippet(c.name,this.FILENAME_SNIPPET_LENGTH)});g.down(".file-desc").__date(d);if(FileQueue.num_left()>1){a=ungettext("%d file left","%d files left",FileQueue.num_left()-1).format(FileQueue.num_left()-1);g.down(".view-details").__date(a)}else{g.down(".view-details").__date(_("View details"))}if(FileQueue.formatted_time){b=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});g.down(".status").__date(b)}f=c.percent+"%";return g.down(".inline-upload-progress").style.width=f},update_errors:function(){var a,b;a=$("inline-upload-status");b=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return a.down(".num-errors").__date(b)},add_x_button:function(){var a,b;b=new Element("a",{"class":"small-x-button"});b.observe("click",function(){InlineUploadStatus.hide();return Upload.reset()});a=$("inline-upload-status");return a.down(".status").__date(b)},completed:function(){var b,a;b=$("inline-upload-status");b.addClassName("complete");b.removeClassName("error");b.down(".icon").__date(Sprite.make("web","s_check"));if(FileQueue.num_files()>1){a=_("Uploaded %(num_files)d files").format({num_files:FileQueue.num_non_cancelled_files()})}else{a=_("Uploaded %(filename)s").format({filename:Emstring.em_snippet(FileQueue.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}b.down(".file-desc").__date(a);b.down(".num-errors").__date();b.down(".view-details").__date(_("View details"));this.add_x_button();return b.down(".inline-upload-progress").style.width="100%"},errored:function(){var c,b,a,d;c=$("inline-upload-status");c.addClassName("error");c.removeClassName("complete");c.down(".icon").__date(Sprite.make("web","nosync"));b=void 0;if(FileQueue.num_files()>1){b=_("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:FileQueue.num_non_cancelled_files()-FileQueue.errors(),num_files:FileQueue.num_non_cancelled_files()});c.down(".file-desc").__date(b);d=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());c.down(".num-errors").__date(d)}else{if(FileQueue.current_file!=null){a=Emstring.em_snippet(FileQueue.current_file.name,this.FILENAME_SNIPPET_LENGTH)}b=a?_("Unable to upload %(filename)s").format({filename:a}):_("Unable to upload file");c.down(".file-desc").__date(b);c.down(".num-errors").__date()}c.down(".view-details").__date(_("View details"));this.add_x_button();return c.down(".inline-upload-progress").style.width="100%"},show:function(a){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return UploadPrep.supported()&&Browse.inside_dir&&!(Browse.in_search_mode()&&FileSearch.fulltext_search_enabled)},browse_indicators_enabled:function(){var d,b,c,a;if(!UploadPrep.enabled()){return false}b=["file-preview-modal","modal-overlay"];for(c=0,a=b.length;c<a;c++){d=b[c];if($(d).visible()){return false}}return true},modal_indicators_enabled:function(){var b,a,c;return UploadPrep.enabled()&&$j("#modal #upload-modal-dropzone").length&&((b=$j("#modal"))!=null?b.visible():void 0)&&((a=$j("#modal"))!=null?(c=a.offset())!=null?c.left:void 0:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(a){return $j(a).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(b){var a;if(!UploadPrep._drop_indicators){if(UploadPrep.modal_indicators_enabled()){a=$("upload-modal-dropzone");$j(a).clonePosition($j("#modal"),{setLeft:false,setTop:false});$j(a).fadeIn(500);UploadPrep._show_border_drop_indicators()}else{if(UploadPrep.browse_indicators_enabled()){BrowseDrag._add_drop_indicators(b)}else{return}}$("drag-status").removeClassName("active");return UploadPrep._drop_indicators=true}},hide_drop_indicators:function(){if(UploadPrep._drop_indicators){UploadPrep._hide_border_drop_indicators();BrowseDrag._remove_drop_indicators();if(!UploadPrep._notifications_cleared){Notify.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){UploadPrep._drop_indicators=false;UploadPrep._drop_dest_folder=null;return UploadPrep._notifications_cleared=false}),500)}return UploadPrep._notifications_cleared=true},folder_dragover:function(a){var b;if(UploadPrep.browse_indicators_enabled()&&UploadPrep._drop_indicators){if(OverQuotaUploads.disabled){if(UploadPrep._drop_dest_folder==null){b=_("You can't upload files because you're out of space.");Notify.error(b,60);UploadPrep._notifications_cleared=false;UploadPrep._show_border_drop_indicators()}}else{if(a!==UploadPrep._drop_dest_folder){if(a===Browse.containing_fq_path()){if(Browse.inside_read_only_shared_folder){b=_("You don't have permission to add to this folder.");Notify.error(b,60)}else{b=_("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:FileOps.upload_plain_snippet()});Notify.success(new HTML(b),60);UploadPrep._show_border_drop_indicators()}UploadPrep._notifications_cleared=false}else{Notify.clear();UploadPrep._hide_border_drop_indicators()}}}return UploadPrep._drop_dest_folder=a}},supports_recursive_upload:function(a){var b;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(a!=null?(b=a[0])!=null?b.webkitGetAsEntry:void 0:void 0)},upload:function(c,e,b){var d,g,f,a;if(b==null){b=null}if(Browse.inside_read_only_shared_folder){return}if(OverQuotaUploads.disabled){g=_("You can't upload files because you're out of space.");return Notify.error(g)}else{if(UploadPrep.supports_recursive_upload(b)){return UploadPrep._recursive_upload(c,b)}else{for(f=0,a=e.length;f<a;f++){d=e[f];d.dest=c}return UploadPrep._upload(e,b)}}},_recursive_upload:function(l,i){var n,c,d,k,g,o,b,m,f,h,a,e,j;b=[];f=[];h=function(p,q){p.dest=l+FilePath.parent_dir(q.fullPath);return b.push(p)};for(e=0,j=i.length;e<j;e++){m=i[e];k=m.webkitGetAsEntry();if(k!==null){if(k.isDirectory){f.push(k)}else{h(m.getAsFile(),k)}}}d=0;o=0;a=function(p,r){var q;q=_('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:r.name});Notify.error(new HTML(q));return $j("#use-advanced-uploader").on("click",function(s){s.preventDefault();return FileOps.show_upload()})};n=3000;g=0;c=function(){var p;while(f.length){k=f.pop();if(k!==null){if(k.isDirectory){(function(r){var q;q=r.createReader();d+=1;return q.readEntries(function(s){var v,u,t;if(s.length!==0){for(u=0,t=s.length;u<t;u++){v=s[u];f.push(v)}return q.readEntries(arguments.callee)}else{return d-=1}},function(s){d-=1;return a(s,r)})})(k)}else{o+=1;p=function(q){return function(r){h(r,q);return o-=1}};k.file(p(k),function(q){o-=1;return a(q,k)})}}}if(b.length>n&&!g){g=1;Notify.error(_("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:n}));return}if(d||o){return c.defer()}else{if(b.length){return UploadPrep._upload(b)}}};return c()},_upload:function(d,b){var a,c;if(b==null){b=null}if(b){a=this._parse_upload_items(b)}c=function(){var g,h,f,e;e=[];for(h=0,f=d.length;h<f;h++){g=d[h];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(a!=null?a[g.name].isDirectory:void 0)){g.is_directory=true}g.id=plupload.guid();e.push(Upload.PLU.addFile(g))}return e};if($("modal").visible()){return c()}else{FileOps.show_upload(c);return Modal.hide(null,true)}},_parse_upload_items:function(b){var c,d,e,a;c={};for(e=0,a=b.length;e<a;e++){d=b[e];if(d.getAsEntry){d=d.getAsEntry()}else{if(d.webkitGetAsEntry){d=d.webkitGetAsEntry()}}c[d.name]=d}return c}};OverQuotaUploads={disabled:false,init:function(a){this.disabled=a;if(this.disabled){return $j("body").addClass("uploads-disabled")}}};var FileOps;FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(b){var e,d,a,c;c=Modal.vars.apps;for(d=0,a=c.length;d<a;d++){e=c[d];if(e.app_id!==b){continue}return e}return null},create_album_from_folder:function(b,a){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:b,album_name:a},job:true,job_user:Viewer.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:_("Creating album..."),onSuccess:function(c){var d;d=JSON.parse(c.responseText);return window.location.href=d.url}})},dir_handler:function(d,c){var b,a;if(typeof c==="string"){c=$(c)}b=$$(".treeview .highlight")[0];if(b){b.removeClassName("highlight")}a=c.up("div");a.addClassName("highlight");Modal.selected_div=a;if(Modal.shown()){c.blur()}document.fire("db:dir_click",{path:d});return Modal.vars.selected_path=d},show_folder_pick:function(f,d,c,e,a){var b;DomUtil.fillVal(FilePath.filename(d).escapeHTML(),"folder-pick-file");TreeView.move("copy-move-treeview","folder-pick-treeview",{user:Browse.active_user});b=(a?_("Move"):_("Copy"));DomUtil.fillVal(b,"folder-pick-action-text");Modal.show(f,$("folder-pick"),{fq_path:d,action:c,folder:e});return $j("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(g,f,d,e){var b,a,c;c=BrowseUtil.profile_files(d);a=BrowseUtil.profile_summary(c);DomUtil.fillVal(a,"bulk-folder-pick-file");TreeView.move("copy-move-treeview","bulk-folder-pick-treeview",{user:Browse.active_user});if(f==="move"){b=_("Move")}else{if(f==="copy"){b=_("Copy")}else{b=_("Restore")}}DomUtil.fillVal(b,"bulk-folder-pick-action-text");Modal.show(g,$("bulk-folder-pick"),{files:d,action:e});return $j("#first-treeview-link").trigger("click")},show_copy:function(a,b){var c;c=(b?_("Copy folder to..."):_("Copy file to..."));TreeView.set_params({disable_read_only:true});return FileOps.show_folder_pick(c,a,FileOps.do_copy,b,false)},show_copy_bulk:function(a){var b;b=ungettext("Copy %(item_count)s item to...","Copy %(item_count)s items to...",a.length).format({item_count:a.length});TreeView.set_params({disable_read_only:true});return FileOps.show_bulk_folder_pick(b,"copy",a,FileOps.do_bulk_copy)},show_move_bulk:function(a){var b;b=ungettext("Move %(item_count)s item to...","Move %(item_count)s items to...",a.length).format({item_count:a.length});TreeView.set_params({disable_read_only:true});return FileOps.show_bulk_folder_pick(b,"move",a,FileOps.do_bulk_move)},show_move:function(a,b){var c;c=(b?_("Move folder to..."):_("Move file to..."));TreeView.set_params({disable_read_only:true});return FileOps.show_folder_pick(c,a,FileOps.do_move,b,true)},show_delete:function(a,c,d,b){return SimpleModal.show({title_text:d?_("Delete folder?"):_("Delete file?"),body_html:_("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:FilePath.filename(c).escapeHTML()}),confirm_text:_("Delete"),cancel_text:_("Cancel"),confirm_callback:(function(e){return function(){if(b){return FileOps.do_nonbrowse_delete(a,[c])}else{return FileOps.do_delete(a,c)}}})(this)})},show_bulk_delete:function(a,b){return SimpleModal.show({title_text:ungettext("Delete %(item_count)s item?","Delete %(item_count)s items?",b.length).format({item_count:b.length}),body_html:ungettext("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",b.length).format({item_count:b.length}),confirm_text:_("Delete"),cancel_text:_("Cancel"),confirm_callback:(function(c){return function(){return FileOps.do_bulk_delete(a,b)}})(this)})},show_purge:function(a,b){return SimpleModal.show({title_text:b?_("Permanently delete folder?"):_("Permanently delete file?"),body_html:_("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:FilePath.filename(a).escapeHTML()}),confirm_text:_("Permanently delete"),cancel_text:_("Cancel"),confirm_callback:(function(c){return function(){return FileOps.do_purge(Browse.find_file(a))}})(this)})},show_bulk_purge:function(a){return SimpleModal.show({title_text:ungettext("Permanently delete %d item?","Permanently delete %d items?",a.length).format(a.length),body_html:ungettext("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",a.length).format({item_count:a.length}),confirm_text:_("Permanently delete"),cancel_text:_("Cancel"),confirm_callback:(function(b){return function(){return FileOps.do_bulk_purge(a)}})(this)})},show_bulk_restore:function(b,a){return SimpleModal.show({title_text:ungettext("Restore %d item...","Restore %d items...",b.length).format(b.length),body_html:ungettext("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",b.length).format({item_count:b.length}),confirm_text:_("Restore"),cancel_text:_("Cancel"),confirm_callback:(function(c){return function(){return FileOps.do_bulk_restore(b)}})(this)})},wrap_strong:function(a){if(Browse.containing_fq_path()===""){return a.escapeHTML()}else{return"<strong>"+a.escapeHTML()+"</strong>"}},upload_snippet:function(c){var a,b;if(c==null){c=1000}if(Viewer.get_viewer().is_paired&&Browse.active_user.is_team){b=Emstring.em_snippet(Viewer.get_viewer().team_name,c).escapeHTML()}if(Browse.containing_fq_path()===""){if(Viewer.get_viewer().is_paired){if(Browse.active_user.is_team){return _(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:b})}else{return _(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return _(" upload to your Dropbox")}}else{a=Emstring.em_snippet(FilePath.filename(Browse.containing_fq_path()),c).escapeHTML();if(Viewer.get_viewer().is_paired){if(Browse.active_user.is_team){return _(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:a,team_name:b})}else{return _(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:a})}}else{return _(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:a})}}},upload_short_snippet:function(c){var b,a;if(c==null){c=1000}a=Browse.containing_fq_path();if(!a){return _("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}b=Emstring.em_snippet(FilePath.filename(a),c);return _("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:b})},upload_plain_snippet:function(a){if(a==null){a=1000}return this.upload_snippet(a).replace("<strong>","'").replace("</strong>","'")},show_upload:function(i,a,f){var c,g,b,d,h,e;c=Browse.containing_fq_path();if(OverQuotaUploads.disabled){DomUtil.fillVal(this.wrap_strong(FilePath.filename(c)),"disabled-upload-foldername");b=this.upload_short_snippet(20);Modal.show(b,$("disabled-upload-modal"),{},false);return}$j(document).trigger(this.SHOW_UPLOAD_EVT,{source:a,has_callback:i!=null});if((!FlashDetect.versionAtLeast(9))&&Upload.runtimes==="flash"){FileOps.show_basic_upload();$("enhanced-upload-toggle").hide();return}DomUtil.fillVal(this.upload_snippet(20),"upload-foldername");DomUtil.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&UploadPrep.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}b=this.upload_short_snippet(20);Modal.show(b,DomUtil.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,FileQueue.num_files());e=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(d=0,h=e.length;d<h;d++){g=e[d];g.observe("click",function(){FileOps.show_basic_upload();return false})}if(!FileQueue.num_files()){Upload.init(FilePath.normalize(c),true,i,f)}else{Upload.set_dest(FilePath.normalize(c))}return InlineUploadStatus.hide()},show_basic_upload:function(){DomUtil.fillVal(this.upload_snippet(20),"basic-upload-foldername");Modal.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){FileOps.show_upload();return false});Upload.set_dest(FilePath.normalize(Browse.containing_fq_path()));return Upload.init_basic()},show_undelete:function(a){var b,c,d;DomUtil.fillVal(a.filename.escapeHTML(),"undelete_filename");b=Sprite.make("web",a.icon,{});b.addClassName("link-img");b.style.backgroundColor="transparent";c=FileOps.build_revisions_uri(a.fq_path,Browse.active_user,{undelete:1});$$(".undelete-icon").invoke("update",b);$$(".undelete-other-versions")[0].href=c;$$(".undelete-link")[0].href=c;d=_("Restore file?");return Modal.show(d,$("undelete-modal"),{file:a})},do_undelete:function(b){var a,c;a=Modal.vars.file;c=_("Restored '%(file_name)s'").format({file_name:a.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[a.fq_path]},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:function(d){Modal.hide();Notify.success(c);return document.fire(FileEvents.RESTORE,{files:[a]})}});return false},do_copy:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to copy a file we couldn't find.");return FileOps.do_bulk_copy([a],b)},do_bulk_copy:function(f,b){var d,e,c,g,a;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();f=f||Modal.vars.files;assert(f.length>0,"Tried to copy 0 files");if(typeof b==="undefined"){if(typeof Modal.vars.selected_path==="undefined"){Notify.error(_("You need to select a destination for the file."));return}else{b=Modal.vars.selected_path}}b=FilePath.normalize(b);c=0;for(g=0,a=f.length;g<a;g++){d=f[g];if(d.dir){if((b+"/").indexOf(d.fq_path+"/")===0){Notify.error(_("You cannot copy a folder into itself."));return}}}e=f.pluck("fq_path");Notify.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:e,to_path:b},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Copying..."),onSuccess:function(o){var k,n,h,p,j,l,i,m;k=o.responseText.evalJSON().changesets;n=e.length;p=Emstring.em_snippet(FilePath.filename(b),FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();j=ungettext("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",n);j=j.format({count:n,location:p});UndoAction.notifyWithUndo(new HTML(j),k,FileOps.do_rollback);h=[];m=o.responseText.evalJSON().new_browse_files;for(l=0,i=m.length;l<i;l++){d=m[l];h.push(d.fq_path)}Browse.select_fq_paths=h;$("reload-link").observe("click",function(){return BrowseURL.set_path_url(null,b)});TreeView.schedule_reset();return document.fire(FileEvents.COPY,{files:f,to_fq_path:b})}})},bulk_move_error:function(a,i){var g,d,j,e,k,f,b,c,h;j=Browse.find_file(i);e=BrowseUtil.profile_files(a);c=void 0;f=void 0;h=void 0;if(j){f=j.dir;c=j.fq_path;h=j.target_ns||j.ns_id}else{if(Browse.inside_dir&&Browse.can_get_details_from_fq_path(i)){d=Browse.details_from_fq_path(i);f=true;c=d.fq_path;h=d.ns_id}else{f=true;c=i;h=void 0}}k=a.pluck("fq_path").collect(FilePath.normalize);if(-1!==k.indexOf(FilePath.normalize(c))){return _("You cannot copy a folder into itself.")}g=b=function(l){var m;m=FilePath.parent_dir(l.fq_path);return m===(c||"/")};if(a.all(g)){return ungettext("That file already exists in that folder.","Those files already exist in that folder.",a.length)}if(!f){return _("You cannot put files inside one another.")}if(e.target_namespaces>0&&h&&h!==Constants.root_ns){if(e.sandboxes>0){if(j.is_sandbox()){return _("You're not allowed to put an application folder inside another application folder.")}else{if(j.is_shared_folder()){return _("You're not allowed to put an application folder inside a shared folder.")}}}else{if(e.shared_folders>0){if(j.is_sandbox()){return _("You're not allowed to put a shared folder inside an application folder.")}else{if(j.is_shared_folder()){return _("You're not allowed to put a shared folder inside another shared folder.")}}}}return _("You're not allowed to nest special folders.")}if(Browse.public_folder_enabled){if(c==="/Public"&&e.target_namespaces>0){return _("You're not allowed to move shared folders to your Public folder.")}}if(e.public_folder>0){return _("You're not allowed to move your Public folder.")}if(e.deleted>0){return _("Moving deleted folders or files is not allowed.")}},do_move:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to move a file we couldn't find.");return FileOps.do_bulk_move([a],b)},do_bulk_move:function(e,f){var c,d,a,b;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();e=e||Modal.vars.files;if(!e){return}assert(e.length>0,"Tried to move 0 files");a=f||Modal.vars.selected_path||"";a=FilePath.normalize(a);c=FileOps.bulk_move_error(e,a);if(c){Notify.error(c);return}d=e.pluck("fq_path");Notify.clear();b="/cmd/move";return new Ajax.DBRequest(b,{parameters:{files:d,to_path:a},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Moving..."),onSuccess:function(j){var i,h,g,k;i=j.responseText.evalJSON().changesets;h=d.length;g=Emstring.em_snippet(FilePath.filename(a),FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();k=ungettext("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",h);k=k.format({count:h,location:g});UndoAction.notifyWithUndo(new HTML(k),i,FileOps.do_rollback);$("reload-link").observe("click",function(){return BrowseURL.set_path_url(null,a)});TreeView.schedule_reset();return document.fire(FileEvents.MOVE,{files:e,to_fq_path:a})}})},do_rollback:function(a){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(a)},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(b){var c;c=_("Undo complete.");Notify.success(c);assert(Browse.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(Browse.in_search_mode()){FileSearch.select_fq_paths=Browse.pre_action_selection;FileSearch.force_reload()}else{if(Lightbox.shown){Browse.select_fq_paths=Browse.pre_action_selection}else{Browse.select_fq_paths=Browse.pre_action_selection;Browse.force_reload()}}return Browse.pre_action_selection=false}})},do_bulk_delete:function(a,d){var b,c;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();d=d||Modal.vars.files;assert(d.length>0,"Tried to delete 0 files");c=(function(){var g,f,e;e=[];for(g=0,f=d.length;g<f;g++){b=d[g];e.push(b.fq_path)}return e})();Notify.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:c},subject_user:a,job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(e){var g,f;f=e.responseText.evalJSON();g=ungettext("Deleted %d item.","Deleted %d items.",c.length).format(c.length);UndoAction.notifyWithUndo(g,f.changesets,FileOps.do_rollback);TreeView.schedule_reset();return document.fire(FileEvents.DELETE,{files:d})}})},do_delete:function(a,c){var b;b=Browse.find_file(c||Modal.vars.fq_path);assert(b,"Trying to delete a file we couldn't find.");return FileOps.do_bulk_delete(a,[b])},do_nonbrowse_delete:function(a,b){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:b},subject_user:a,html_in_error_msg:true,onSuccess:function(c){var d;d=ungettext("Deleted %(file_count)s item","Deleted %(file_count)s items",b.length);d=d.format({file_count:b.length});Notify.success(d);return document.fire(FileEvents.DELETE,{fq_paths:b})}})},do_purge:function(a){assert(a,"Trying to purge a file we couldn't find.");return FileOps.do_bulk_purge([a])},do_bulk_purge:function(b){var a,c;assert(b.length>0,"Tried to purge 0 files");a=b.collect(function(d){return d.fq_path});c=ungettext("Permanently deleted %d item","Permanently deleted %d items",a.length).format(a.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:a},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(d){Notify.success(c);TreeView.schedule_reset();return document.fire(FileEvents.PURGE,{files:b})}})},do_bulk_restore:function(c){var b,d,a;c=c||Modal.vars.files;a=Modal.vars.user;assert(c.length>0,"Tried to restore 0 files");b=c.collect(function(e){return e.fq_path});d=ungettext("Restored %d item","Restored %d items",b.length,{comment:"meaning, successfully restored x files and folders"}).format(b.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:b},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:function(e){Notify.success(d);TreeView.schedule_reset();return document.fire(FileEvents.RESTORE,{files:c})}})},do_folder_restore:function(b,a){var c;c=function(d){var f,e;f=_("Restoring '%(folder_name)s'").format({folder_name:FilePath.filename(b)});e=d.responseText;if(e.startsWith("err:")){e=e.substring(4);$j("#async-result").html(e);Notify.error(new HTML(e),60)}else{f=_("Restored '%(folder_name)s'").format({folder_name:FilePath.filename(b)});$j("#status-of-files").text(_("Restored files"));Notify.success(f,60)}$j("#restore-done-heading").text(f);$j(".pre-restore").hide();return $j(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[b]},job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:c,onFailure:c,subject_user:a})},do_bulk_download:function(c){var e,b,d,a;e=new Element("form",{action:URI({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user.id).toString(),method:"post"});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{files:b.fq_path})}Forms.add_vars(e,{parent_path:Browse.block_hash_param||"/",w:Browse.block_hash});$(document.body).__sert(e);return e.submit()},do_bulk_photo_view:function(c){var e,b,d,a;e=new Element("form",{action:"https://"+Constants.WEBSERVER+"/photos",method:"post"});Forms.add_vars(e,{t:Constants.TOKEN});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{selected_items:b.root_coll_item_counter})}$(document.body).__sert(e);return e.submit()},build_revisions_uri:function(c,a,b){if(b==null){b={}}b[Constants.UID_PARAM_NAME]=String(a);return URI({path:"/revisions"+c}).updateQuery(b)}};var Forms,__hasProp={}.hasOwnProperty;Forms={submitOnlyOnce:function(){var a;a=Forms.submitted!==true;Forms.submitted=true;return a},disable:function(a){if(a){return setTimeout((function(){return a.disabled=true}),0)}},enable:function(a){if(a){return setTimeout((function(){return a.disabled=false}),0)}},show_button_on_change:function(a,d){var c,e,f,b;c=$j(a);c.hide();if(d==null){d=c.closest("form")}e=d[0];if(this.next_id==null){this.next_id=0}f=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[f]=this.collect_form_vars(e);c.attr("data-id",f);d.data("button-id",f);b=(function(g){return function(){var j,i,h;c.hide();i=g.collect_form_vars(e);if(Object.keys(i).length!==Object.keys(g.initial_vars[f]).length){c.show()}h=[];for(j in i){if(i[j]!==g.initial_vars[f][j]){h.push(c.show())}else{h.push(void 0)}}return h}})(this);d.change(b);d.find("input").filter(":text").on("input",b);return d.find("textarea").on("input",b)},add_vars:function(c,d){var e,b,a;c=$(c);a=[];for(b in d){if(!__hasProp.call(d,b)){continue}e=new Element("input",{type:"hidden",name:b});e.setValue(d[b]);a.push(c.__sert(e))}return a},collect_form_vars:function(e,d){var h,c,b,g,f,a;if(d==null){d=false}e=e||$(document.body);c=e.select("input").concat(e.select("textarea")).concat(e.select("select"));b={};for(f=0,a=c.length;f<a;f++){h=c[f];if(h.name&&h.name!=="t"){g=h.getValue();if(g||d){if(typeof g!=="string"){g=g.join(",")}if(b[h.name]!=null){if(typeof b[h.name]==="string"){b[h.name]=[b[h.name],g]}else{b[h.name].push(g)}}else{b[h.name]=g}}}}return b},add_loading:function(c,a){var b;if(c){c=$(c);b=new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"});b.addClassName("text-img ajax_submit_loading");if(a==="after"){return $j(c).after(b)}else{return $j(c).before(b)}}},remove_loading:function(a){return $j(".ajax_submit_loading").remove()},ui_form_submit:function(b,a){a=a||b.action;if(b.ajax_submitted){return false}b.ajax_submitted=true;return new UIRequest($j(b),a,{data:Forms.collect_form_vars(b),success:(function(c){return function(g,d,h){var f,e;e=$j(b).data("button-id");if(e!=null){f=$j(b).find("*[type='submit'][data-id='"+e+"']");c.initial_vars[e]=c.collect_form_vars(b);return f.hide()}}})(this),complete:(function(c){return function(e,d){return b.ajax_submitted=false}})(this)})},ajax_submit_obj:function(f){var j,l,c,d,b,e,h,i,g,k,a;d=f.form,a=f.url,k=f.success_callback,c=f.fail_callback,j=f.button,h=f.more_vars,i=f.position,e=f.job,b=f.html_response,l=f.complete_callback,g=f.progress_text;return Forms.ajax_submit(d,a,k,c,j,h,i,e,b,l,g)},ajax_submit:function(d,b,m,c,k,h,l,e,a,p,f){var n,g,i,o,j;if(a==null){a=false}if(d.ajax_submitted){return false}d.ajax_submitted=true;j=$j(d).find(".suggestion-input");for(i=0,o=j.length;i<o;i++){n=j[i];SuggestionInput.blank(n.identify())()}if(k){Forms.add_loading(k,l)}g=Forms.collect_form_vars(d);if(h){Object.extend(g,h)}new Ajax.DBRequest(b||d.action,{noAutonotify:true,parameters:g,job:e,progress_text:f,evalJSON:false,onSuccess:function(q){Forms.remove_loading();if(m&&typeof m==="function"){return m(q)}},onFailure:function(s){var q,r;if(s){if(s.responseText.indexOf("err:")===0){q=s.responseText.substr(4);if(q.indexOf("{")===0){r=q.evalJSON(true);Forms.fill_errors(d,r)}else{if(a){q=new HTML(q)}Notify.error(q)}}else{Notify.error()}Forms.remove_loading();if(c&&typeof c==="function"){return c(s)}}},onComplete:function(t){var s,r,q;q=d.select(".suggestion-input");for(s=0,r=q.length;s<r;s++){n=q[s];SuggestionInput.blur_elm(n)}d.ajax_submitted=false;if(p&&typeof p==="function"){return p(t)}}});return false},clear_errors:function(a){a=a||$(document.body);this.hide_errors(a);return a.select(".error-removable").invoke("remove")},fill_errors:function(f,e){var c,h,b,d,g,a;e=e||{};f=f||$(document.body);Forms.clear_errors(f);for(g in e){if(!__hasProp.call(e,g)){continue}h=f.down("[data-error-field-name='"+g+"']")||f.down("[name='"+g+"']");if(h){c=new Element("br",{"class":"error-removable"});b=new Element("span",{"class":"error-message error-removable"});d=e[g];assert(d.message_html||d.message_text,"Error message must have a message_html or message_text property");if(d.message_html){b.update(d.message_html)}else{b.__date(d.message_text)}$j(h).before(b);$j(h).before(c);a=$j(f).find("input[name='"+g+"'], textarea[name='"+g+"']");if(a){a.addClass("input-error")}}}return this.show_errors(f)},value:function(d){var c,b,f,e,a;b=$$('input[name="'+d+'"]');f=null;for(e=0,a=b.length;e<a;e++){c=b[e];f=$(c).getValue()||f}return f},postRequest:function(c,d,a){var b;if(d==null){d={}}if(a==null){a={}}assert(c!=null,"postRequest missing action");d.t=Constants.TOKEN;b=new Element("form",{action:c,method:"POST"});if(a.target){b.target=a.target}document.body.appendChild(b);Forms.add_vars(b,d);return b.submit()},hide_errors:function(c){var f,e,d,b,a;f=this.get_errors(c);a=[];for(d=0,b=f.length;d<b;d++){e=f[d];if(e.down("span.error-message")){a.push(e.hide())}else{a.push(void 0)}}return a},show_errors:function(b){var e,d,c,a;e=this.get_errors(b);for(c=0,a=e.length;c<a;c++){d=e[c];if(d.down("span.error-message")){d.show()}}return $j(".sick-input").find("label").css("top","")},get_errors:function(b){var c,a;a=".error-bubble, .error-plain-text";c=b?b.select(a):$$(a);return c}};$j(function(){return Forms.show_errors()});var ActAsBlock;ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(f,g){var d,b,c,a;if(g==null){g=document.body}c=$(g).getElementsByClassName("act_as_block");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];a.push(this.resize(f))}return a},resize:function(e){var a,c,d,b;e=$(e);c=e.up();a=Util.sumStyles(e,this.elm_list);d=Util.sumStyles(c,this.parent_list);e.style.width="1px";b=c.getWidth()-a-d;if(b>0){return e.style.width=b+"px"}}};var BrowseStyleRows;BrowseStyleRows={register_all:function(){var d,c,a,b;b=$$(".bs-row");for(c=0,a=b.length;c<a;c++){d=b[c];this.register(d)}Event.observe(document,"click",this.kill_current.bind(this));return $j(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(b){var a;b=$(b);b.db_observe("mouseover",this.mouseover.bind(this));b.db_observe("mouseout",this.mouseout.bind(this));a=b.down(".action-button");if(a){return a.db_observe("click",this.click.bind(this))}},mouseover:function(b,a){if(!a.hasClassName("no-hover")){return a.addClassName("hover")}},mouseout:function(b,a){return a.removeClassName("hover")},click:function(d,b){var a,f,c;if(d.target.tagName==="A"){return}f=b.up(".bs-row");Event.stop(d);if(f.hasClassName("selected")){this.kill_current(false);return}$j(document).trigger("dropdown-opened");this.kill_current(false);c=$(d.target);if(!c.match(".bs-actions-list *")){f.addClassName("selected")}a=(c.hasClassName("bs-row")?c:c.up(".bs-row"));return a.style.zIndex=9},kill_current:function(f){var g,d,b,c,a;c=$$(".bs-row.selected");a=[];for(d=0,b=c.length;d<b;d++){g=c[d];g.removeClassName("selected");a.push(g.style.zIndex="")}return a}};var Bubble;Bubble={make:function(q,D,v,o,j){var g,s,A,f,e,C,x,p,n,h,m,u,z,k,a,i,d,B,y,w;if(D==null){D="left"}j=j!=null?j:{};if(["left","right"].contains(D)){v=v||"middle";assert(["top","middle","bottom"].contains(v),"expected tail position ['top', 'middle', 'bottom'], got "+v)}else{if(["bottom","top"].contains(D)){v=v||"center";assert(["left","center","right"].contains(v),"expected tail position ['left', 'center', 'right'], got "+v)}else{if(!["none"].contains(D)){assert(false,"unexpected tail side, got "+D)}}}u=new Element("table");if(j.style==="titled"){u.addClassName("bluebubble");z="bluebubble"}else{u.addClassName("bubble");z="bubble"}if(o){u.style.width=o+"px"}a=new Element("tbody");B=new Element("tr");i=new Element("td");i.addClassName("tl");m=new Element("td");m.addClassName("t");if(j.style==="titled"){if(o){m.style.width=(o-42)+"px"}}d=new Element("td");d.addClassName("tr");if(D==="top"){k=new Element("img",{src:"/static/images/"+z+"_arrow_top.png"});k.addClassName("tarrow");if(j.style==="titled"){k.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(k);m.__sert(s)}else{m.style.textAlign=v;m.__sert(k)}}B.__sert(i);B.__sert(m);B.__sert(d);a.__sert(B);y=new Element("tr");p=new Element("td");p.addClassName("l");if(D==="left"){if(j.style==="titled"){g=new Element("img",{src:"/static/images/bluebubble_arrow_left.png"})}else{g=new Element("img",{src:"/static/images/bubble_arrow.png"})}g.addClassName("arrow");p.__sert(g);p.vAlign=v}x=new Element("td");x.addClassName("c");x.update(q);n=new Element("td");n.addClassName("r");if(D==="right"){h=new Element("img",{src:"/static/images/bubble_arrow_right.png"});h.addClassName("rarrow");n.__sert(h);n.vAlign=v}y.__sert(p);y.__sert(x);y.__sert(n);a.__sert(y);w=new Element("tr");e=new Element("td");e.addClassName("bl");A=new Element("td");A.addClassName("b");if(D==="bottom"){f=new Element("img",{src:"/static/images/"+z+"_arrow_bottom.png"});f.addClassName("barrow");if(j.style==="titled"){f.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(f);A.__sert(s)}else{A.style.textAlign=v;A.__sert(f)}}C=new Element("td");C.addClassName("br");w.__sert(e);w.__sert(A);w.__sert(C);a.__sert(w);u.__sert(a);return u}};var DbBubble;DbBubble={position:function(f,e,i){var j,b,a,h,c,g,d;f=$j(f).css({top:"auto",right:"auto",bottom:"auto",left:"auto",position:"absolute"});assert(f.find(".db-arrow").length,"db-arrow not found");j=f.find(".db-arrow-border");assert(j.length,"db-arrow-border not found");h=null;d=["top","right","bottom","left"];for(c=0,g=d.length;c<g;c++){a=d[c];if(f.hasClass("db-"+a+"-arrow")){h=a;break}}assert(h,"No db-#{direction}-arrow class set");if(h==="left"){b="left+"+(j.outerWidth())+"px top-"+(j.position().top)+"px"}else{if(h==="right"){b="right-"+(j.outerWidth())+"px top-"+(j.position().top)+"px"}else{if(h==="top"){b="left-"+(j.position().left)+"px top+"+(j.outerHeight())+"px"}else{if(h==="bottom"){b="left-"+(j.position().left)+"px bottom-"+(j.outerHeight())+"px"}}}}if(!i){i={top:"bottom",left:"right",bottom:"top",right:"left"}[h]}return f.position({my:b,at:i,of:e,collision:"none"})}};var FreshDropdown;FreshDropdown={show:function(g,d,c,b){var f,e,h,a;if(b==null){b=false}$j(document).trigger("dropdownOpened",[1]);f=$j(d);if(!c){c=f[0].offsetHeight+10}this.hide_all();e=$j(g).show();a=e[0].offsetWidth;h=f[0].offsetWidth;e.clonePosition(f,{setHeight:false,setWidth:false,offsetLeft:-1*(a-h)+22,offsetTop:c});if(b){e.width(a)}f.addClass("pressed");return((function(i){return function(){return document.observe("click",i.hide_all)}})(this)).defer()},hide_all:function(c){var b,a;a=$j(".freshdropdown-menu");b=0;a.each(function(){if($j(this).is(":visible")){return b+=1}});a.hide();$j(document).trigger("dropdownClosed",[b]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",this.hide_all)}};var JumpWatcher;JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&JumpWatcher.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=URI.parse(window.location.href).fragment}},report:function(){clearInterval(JumpWatcher.interval);return assert(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var LocaleSelectorModal,TeamLocaleSelectorModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};LocaleSelectorModal=(function(b){__extends(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";a.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(c){return function(d){d.preventDefault();c.hide();return c.set_locale($j(d.target).attr("data-locale"))}})(this))};a.prototype.on_hide=function(){return this.$modal_window.off("click")};a.prototype.set_locale=function(c,e){var d;if(e==null){e=false}d=$j("<form />",{action:this.action,method:"post"});Forms.add_vars(d[0],{locale:c,locale_cont:e||window.location.href,t:Constants.TOKEN});$j(document.body).append(d);return d.submit()};return a})(DBModal);TeamLocaleSelectorModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return b})(LocaleSelectorModal);var LoginDropdown;LoginDropdown={init:function(){var a;a=$j("#login-hover-link");if(!(a.length>0)){return}this.login_link=a;return this.register()},register:function(a){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(a){return this.clicking=true},click:function(a){a.preventDefault();if(this.clicking&&a.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}$j(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return $j("input[name='login_email']").focus()},unclick:function(b){var a;if(b){a=$j(b.target);if(a[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){$j(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var Modal;Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(m,i,j,o,c,k,g,h,n){var b,e,l,a,d,f;if(j==null){j=false}if(o==null){o=false}if(c==null){c=false}if(k==null){k=false}if(g==null){g=""}if(h==null){h=true}if(n==null){n=false}if(Modal.shown()){Modal._cleanup()}c=c||this.width;e="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(e).invoke("hide");if(FileQueue.uploading&&!k){alertd(_("You can't do this while uploading."));return false}assert(i,"Missing modal content!");d=this.vars._prev_scope;this.vars=j||{};this.vars._prev_scope=d;$("modal").setStyle({width:""+c+"px",margin:"0 0 0 "+(Math.floor(-c/2).toString())+"px"});this.vars.extra_class="";if(g){$("modal").addClassName(g);this.vars.extra_class=g}if(!k){if(FileQueue.num_files()){Upload.reset();FileQueue.clear()}a=Util.childElement($("modal-content"),0);if(a&&a!==i){$("grave-yard").__sert(a)}b=new Element("div");b.update(i);$("modal-content").__sert(b);if(i.show){i.show()}Element.show("modal")}$j("#modal-overlay").off("click");if(h){$j("#modal-overlay").on("click",function(p){Modal.hide(null,false,true);p.preventDefault();return p.stopPropagation()})}else{$j("#modal-overlay").on("click",function(p){p.preventDefault();return p.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(c+20)+"px",margin:"0 0 0 "+(Math.floor(-c/2-10).toString())+"px"});$j("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(o){$("modal-content").select("#"+o.id).first().focus()}else{if(!Util.ie){l=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(l){l.focus()}}}if(!this.track_id){this.track_resizes()}if(m){if(Util.isElm(m)){$j("#modal-title").html(m)}else{$j("#modal-title").text(m)}$j("#modal-title").show();f=$j("#modal-title").text();T("Modal.show:",f)}else{$j("#modal-title").hide();T("Modal.show")}ActAsBlock.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";dom.scroll_lock_document();if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=n;$j("#modal").find("input").filter(":visible:first").focus();$j(document).trigger("modalOpened",[1]);return false},fix_position:function(c){var b,a;a=document.viewport.getScrollOffsets().top+this.vertical_offset;b=parseInt($("modal").getStyle("height"),10);if(b+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(b+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:a+"px"});return $("modal-behind").setStyle({position:"absolute",height:(b+20)+"px",top:(a-10)+"px"})}},keydown:function(d){var f,a,c,b;c=d.keyCode||d.which||d.charCode;if(c===27||(c===8&&!dom.focus_in_input())){d.preventDefault();this.hide(null,false,true)}if(c===9&&!dom.focus_in_input()){a=$("modal").down("input[type=text], input[type=email]");b=$("modal").down(".modal-tabs");f=b;while(f&&f.next()){f=f.next();if(f.visible()){a=f.down("input[type=text], input[type=email]");break}}if(a){d.preventDefault();return a.focus()}}},shown:function(){return $("modal").visible()},hide:function(c,a,b){if(c){Event.stop(c)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(b);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!a&&!FileQueue.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(FileQueue.uploading){InlineUploadStatus.show()}}Modal._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return T("Modal.hide")},_cleanup:function(){$j(document).trigger("modalClosed",[1]);return dom.scroll_unlock_document()},should_prevent_hide:function(){return this.prevent_hide_if_loading&&$u.some($j("#modal form"),function(a){return a.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var a;a=$("modal").getHeight();if(this.old_height!==a||$("modal-behind").getHeight()<a){this.old_height=a;return this.fix_position()}},vars:{}};var RolePicker,RolePickerState,RoleSelect,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};RolePicker=(function(){function a(c){var d,b;if(c==null){c={}}this._actually_set_state=__bind(this._actually_set_state,this);this._do_login=__bind(this._do_login,this);this.is_user_visible=__bind(this.is_user_visible,this);this.is_role_visible=__bind(this.is_role_visible,this);this.ensure_role_is_visible=__bind(this.ensure_role_is_visible,this);this.update_picker_ui=__bind(this.update_picker_ui,this);this.set_state=__bind(this.set_state,this);this.get_state=__bind(this.get_state,this);this._allow_merged_state=c.allow_merged_state!=null?c.allow_merged_state:true;this._limit_to_role=c.limit_to_role!=null?c.limit_to_role:null;if(Viewer.get_viewer().is_role_signed_in(RolePickerState.PERSONAL)&&Viewer.get_viewer().is_role_signed_in(RolePickerState.WORK)){this.set_state(RolePickerState.ALL)}else{d=Viewer.get_viewer().get_users();assert(d.length,"tried to use RolePicker on a page with no users");b=d[0];this.set_state(b.role)}return this}a.prototype.get_state=function(){return this._state};a.prototype.set_state=function(c){var f,e,b,d;assert(this._allow_merged_state||(c!==RolePickerState.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){assert((c===RolePickerState.ALL)||(c===this._limit_to_role))}if(c===RolePickerState.ALL){d=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(e=0,b=d.length;e<b;e++){f=d[e];if(!Viewer.get_viewer().is_role_signed_in(f)){this._do_login(f,c);return}}}else{f=c;if(!Viewer.get_viewer().is_role_signed_in(f)){this._do_login(f,c);return}}return this._actually_set_state(c)};a.prototype.update_picker_ui=function(){};a.prototype.ensure_role_is_visible=function(b){if(!this.is_role_visible(b)){if(this._allow_merged_state){return this.set_state(RolePickerState.ALL)}else{return this.set_state(b)}}};a.prototype.is_role_visible=function(b){return this._state===RolePickerState.ALL||this._state===b};a.prototype.is_user_visible=function(b){return this.is_role_visible(b.role)};a.prototype._do_login=function(b,c){return MultiaccountLogin.show_modal({role:b,on_success:(function(d){return function(){return d._actually_set_state(c)}})(this)})};a.prototype._actually_set_state=function(b){this._state=b;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(b):void 0};return a})();RoleSelect=(function(b){__extends(a,b);function a(d,c){if(c==null){c={}}this.limit_to_role=__bind(this.limit_to_role,this);this.update_picker_ui=__bind(this.update_picker_ui,this);this.on_ui_change=__bind(this.on_ui_change,this);this.$container=d;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(BubblePicker.CHANGED,this.on_ui_change);a.__super__.constructor.call(this,c);return this}a.prototype.on_ui_change=function(c,e){var d;d=e.clicked_val;if(d!==this._state){this.$bubble_picker.controller().set_value(this._state);return this.set_state(d)}};a.prototype.update_picker_ui=function(){this.$bubble_picker.controller().set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};a.prototype.limit_to_role=function(f,d){var c,e;if(f!=null){this.ensure_role_is_visible(f);for(c in RolePickerState){e=RolePickerState[c];if(e===f||e===RolePickerState.ALL){continue}this.$bubble_picker.controller().disable_option(e,d)}}else{for(c in RolePickerState){e=RolePickerState[c];this.$bubble_picker.controller().enable_option(e)}}return this._limit_to_role=f};return a})(RolePicker);var SickInput;SickInput={init:function(){var e,d,b,c,a;c=$$(".sick-input");a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(!e.hasClassName("sickified")){a.push(this._create(e))}}return a},_create:function(d){var c,a,b;if(d==null){return}c=d.identify();a=d.down("input")||d.down("textarea")||d.down("select");a.observe("focus",function(){return d.addClassName("focused")});a.observe("blur",function(){return d.removeClassName("focused")});b=function(){if(d.hasClassName("populated")&&a.getValue()===""){d.removeClassName("populated")}else{if(!d.hasClassName("populated")&&a.getValue()!==""){d.addClassName("populated")}}if(c in SickInput._handler_map){return SickInput._handler_map[c]()}};Forms.show_errors();b();return setInterval(b,100)},_handler_map:{},add_interval_handler:function(b,a){var c;c=b.identify();return this._handler_map[c]=a},remove_interval_handler:function(b,a){var c;c=b.identify();if(this._handler_map[c]===a){return delete this._handler_map[c]}}};var Spinner;Spinner={showLoading:function(h,a,g,d){var b,e,f,c;g=true;e=$("spinner-loading");a=$(a);if(!e){e=new Element("div",{id:"spinner-loading"});b=new HTML('<table style="height: 100%; width: 100%; background:#fff;">\n  <tr>\n  <td valign="top">\n    <div id="spinner-loading-text" style="padding-top: 16px;text-align:center;"></div>\n  </td>\n  </tr>\n</table>');e.__date(b);document.body.appendChild(e)}$j(e).clonePosition($j(a));if(e.getWidth()===0){return}if(Util.ie){e.style.left=a.getBoundingClientRect().left+"px"}e.setOpacity(0.9);f=$("spinner-loading-text");if(h){f.__date()}else{c=new Element("img",{src:"/static/images/icons/ajax-loading.gif",style:"vertical-align: bottom;"});f.__date(c);if(!g){f.__sert(_("Loading..."))}}$("spinner-loading").show();if(d){return e.style.zIndex="1001"}},hideLoading:function(){return $("spinner-loading").hide()}};var SuggestionInput;SuggestionInput={register:function(b){var a;b=$(b);a=b.up("form");if(SuggestionInput.defaulted(b)||b.getValue()===""){b.setValue(b.title)}else{b.addClassName("suggestion-input-unfaded")}b.observe("blur",this.blur.bind(this));b.observe("focus",this.focus.bind(this));b.observe("db:value_change",this.focus.bind(this));if(a){if(!b.id){b.id="r_elm_id_"+(Math.random().toString())}return a.observe("submit",SuggestionInput.blank(b.id).bind(this))}},register_all:function(){var c,e,b,d,a;d=$$(".suggestion-input");a=[];for(e=0,b=d.length;e<b;e++){c=d[e];a.push(this.register(c))}return a},blank:function(a){return(function(b){return function(){var c;c=$(a);if(!c){return}if(b.defaulted(c)){return c.setValue("")}}})(this)},defaulted:function(a){a=$(a);return a.getValue()===a.title},do_blank:function(a){return this.blank(a)()},clear:function(a){var b;b={target:a};return this.focus(b)},focus:function(a){var b;b=$(a.target);if(!b){return}if(this.defaulted(b)){b.addClassName("suggestion-input-unfaded");return b.setValue("")}},blur_elm:function(a){if(a.getValue()===""){a.removeClassName("suggestion-input-unfaded");a.setValue(a.title)}return a.blur()},blur:function(a){var b;b=$(a.target);if(!b){return}return this.blur_elm(b)},reset:function(b){var a;a=$(b);if(!a){return}a.removeClassName("suggestion-input-unfaded");a.setValue(a.title);a.defaulted=true;return a.blur()},setValue:function(a,b){var c;c=$(a);if(!c){return}c.addClassName("suggestion-input-unfaded");c.setValue(b);return c.defaulted=false}};var TitleBubble;TitleBubble=(function(){var c,b,g,d,e,a,f;f=0;c=0;a=function(h){return f=h};e=function(m){var r,p,k,o,j,h,n,i,l,q;o=$j(m.currentTarget);q=o.attr("title");if(q!=null?q.length:void 0){o.attr("data-title",q);o.removeAttr("title")}k=parseInt(o.data("title-delay"));p="title-bubble-"+(c++);o.data("bubble-id",p);r=$j("<div/>",{id:p,"class":"title_bubble_container"});if(!k){r.css({opacity:0});r.addClass("has-transition")}if(o.hasClass("white")){r.addClass("white")}if(o.hasClass("black")){r.addClass("black")}r.text(o.attr("data-title"));i=o.attr("data-title-hide-tail")!=="yes";if(i){l=$j("<div/>",{"class":"tail"});r.append(l)}$j(document.body).append(r);h=g(o[0],r[0]);j=b(h,r[0],o[0]);r.clonePosition(o,{setWidth:false,setHeight:false,offsetTop:j.top-f,offsetLeft:j.left});r.addClass("position-"+h);if(i){l.clonePosition(o,{setWidth:false,setHeight:false,offsetTop:j.top-f+j.tail_offset_top+$j(r).outerHeight(),offsetLeft:j.left+j.tail_offset_left+($j(r).outerWidth()/2)})}n=function(){var s;if(!((r.data("pending-delay"))&&(o.data("bubble-id")===p))){return}s=(parseInt(o.data("title-fade-time")))||400;return r.fadeIn(s)};if(k){r.hide();r.data("pending-delay",true);return setTimeout(n,k)}else{return r.css({opacity:""})}};g=function(l,h){var k,j,i;l=$(l);i=l.getAttribute("data-title-position");k=document.viewport.getDimensions();j=l.viewportOffset();if(!(i==="above"||i==="below"||i==="right"||i==="left")){i="above"}if(i==="left"){if(j.left<h.width){return"right"}}else{if(i==="right"){if(k.width-(j.left+l.getWidth())<h.width){return"left"}}else{if(i==="below"){if(k.height-(j.top+l.getHeight())<h.height){return"above"}}else{if(i==="above"){if(j.top<h.height){return"below"}}}}}return i};b=function(j,q,m){var o,k,r,n,p,l,h,t,s,i;q=$(q);m=$(m);r=document.viewport.getDimensions();o=q.getDimensions();n=m.viewportOffset();k=6;p=0;l=0;s=0;i=0;if(j==="below"||j==="above"){if(j==="below"){l=m.getHeight()+k}else{l=(-1*o.height)-k}h=m.getWidth()/2-o.width/2;if(n.left+h+o.width>r.width){p=r.width-n.left-o.width;s=h-p-5}else{p=h;s=-5}}if(j==="left"||j==="right"){if(j==="right"){p=m.getWidth()+k}else{p=(-1*o.width)-k}t=m.getHeight()/2-o.height/2;if(n.top+t+o.height>r.height){l=r.height-n.top-o.height;i=t-l-5}else{l=t;i=-5}}return{left:p,top:l,tail_offset_left:s,tail_offset_top:i}};d=function(i){var h,j,k;k=$j(i!=null?i.currentTarget:void 0);h=$j("#"+k.data("bubble-id"));if(h.data("pending-delay")){h.removeData("pending-delay");j=(parseInt(k.data("title-fade-time")))||400;return h.fadeOut(j,function(){return h.remove()})}else{return h.remove()}};return{init:function(){$j(document).on("mouseenter",".title_bubble",e);$j(document).on("mouseleave",".title_bubble",d).on("mouseup",".title_bubble",d);$j(document).on("mouseenter",".title_bubble_sticky",e);return $j(document).on("mouseleave",".title_bubble_sticky",d)},set_vertical_space:a,hide_all:function(){return $j(".title_bubble_container").remove()}}})();var Tooltip;Tooltip={attach:function(g,c,a,b){var f,e;if(b==null){b={}}g=$(g);a=(a?$(a):null);f=Bubble.make(c,g.tail_position,b.tail_position,b.width,b);f.setStyle({display:"none",position:"absolute"});$("floaters").__sert(f);if(g.match("#modal-content *")||g.match(".db-modal-content *")){f.style.zIndex="13001"}else{f.style.zIndex=""}if(g.tail_position==="right"){e=(Util.ie?32:12);f.style.marginLeft=-(f.getWidth()+g.getWidth()+e)+"px"}g.tooltip=f;g.out_target=(a?true:false);g.observe("mouseout",this.mouseout("target",g));g.observe("mouseover",this.mouseover("target",g));g.out_trigger=(a?false:true);if(a){a.observe("mouseout",this.mouseout("trigger",g));a.observe("mouseover",this.mouseover("trigger",g))}g.out_tooltip=true;f.observe("mouseout",this.mouseout("tooltip",g));return f.observe("mouseover",this.mouseover("tooltip",g))},update:function(b,a){if(b.tooltip){return $(b.tooltip).update(a)}},mouseover:function(a,b){return function(){return b["out_"+a]=false}},mouseout:function(a,b){return function(){b["out_"+a]=true;return Tooltip.hide_if_out.defer(b)}},show_by:function(b){var c,a;c=$j(b.tooltip);b=$j(b);c.show();a=Math.floor(c[0].offsetHeight/2);return c.clonePosition(b,{setWidth:false,setHeight:false,offsetTop:Math.floor(b[0].offsetHeight/2)-a,offsetLeft:b[0].offsetWidth+1})},hide_if_out:function(a){var b;if(!a.out_target||!a.out_trigger||!a.out_tooltip){return}b=$(a.tooltip);return b.hide()},show:function(e,d,b,a,c){if(a==null){a="left"}e=$(e);if(!e.tail_position){e.tail_position=a}b=(b?$(b):null);if(!e.tooltip){this.attach(e,d,b,c)}return this.show_by(e)}};var TreeView;TreeView={tv:{},loaded:false,set_params:function(a){return this.ajax_params=a},init:function(c,a,d){var b;if(d==null){d="treeview"}this.tv[d]={};b=this.tv[d];b.autohide=(a===null?true:a);b.handler=c;b.viewdiv=$(d);b.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(UpdateEvents.ADD,(function(e){return function(f){return e.schedule_reset()}})(this));document.observe(UpdateEvents.REMOVE,(function(e){return function(f){return e.schedule_reset()}})(this));return document.observe(UpdateEvents.MOVE,(function(e){return function(f){return e.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(d){var b,c,a;b={url:"/ajax_subtreeview",method:"post",data:$j.extend({},this.ajax_params),success:(function(e){return function(g){var h,f;f=[];for(h in e.tv){if(e.tv.hasOwnProperty(h)){e.tv[h].viewdiv.down(".treeview-folders").update(g);if(d&&d.onSuccess){f.push(d.onSuccess(g))}else{f.push(void 0)}}else{f.push(void 0)}}return f}})(this)};if(d!=null?d.user:void 0){b.subject_user=d.user;a=Viewer.get_role_title(d.user);if(Viewer.get_viewer().is_paired){if(d.user.is_team){c="s_briefcase"}else{c="s_house"}}else{c="dropbox"}if(!a){a=_("Dropbox")}$j("#first-treeview-link span").text(a);Sprite.replace($j("#root-img")[0],"web","dropbox",c)}else{$j("#first-treeview-link span").text(_("Dropbox"))}return $j.ajax(b)},toggle:function(c,b){var a;Event.stop(c);a=this.tv[b||"treeview"];if(a.shown){a.shown=false;this.hide(c,b)}else{a.shown=true;this.show(c.target,b)}return false},hide:function(c,b){var a;a=this.tv[b||"treeview"];if(!c||!$(c.target).descendantOf(a.viewdiv)){a.viewdiv.hide();Event.stopObserving(window,"click",a.hidefunc);return a.shown=false}},show:function(c,b){var d,a;a=this.tv[b||"treeview"];c=$(c);c.blur();d=c.cumulativeOffset();a.viewdiv.setStyle({top:(d.top+c.getHeight())+"px",left:(d.left-4)+"px"});a.viewdiv.show();return Event.observe(window,"click",a.hidefunc)},toggleNode:function(b){var a;b=$(b);a=b.down("img");if(a.className.match("bullet_plus")){Sprite.replace(a,"web","bullet_plus","bullet_minus")}else{Sprite.replace(a,"web","bullet_minus","bullet_plus")}b.up().next("div").toggle();b.blur();return false},toggleNodeAjax:function(d,a,b){var c,e;if(d.fetched_children){return this.toggleNode(d)}d=$(d);c=d.down("img");e=Sprite._get(c);c.src="/static/images/icons/ajax-loading-small.gif";$j.ajax({url:"/ajax_subtreeview"+a,method:"post",data:$j.extend({},this.ajax_params),subject_user:b,success:(function(f){return function(g){var h;h=new Element("div",{style:"display: none;"}).update(g);d.up().__sert({after:h});d.fetched_children=true;Sprite._set(c,e);return f.toggleNode(d)}})(this),complete:function(){if(/loading/.match(c.src)){return Sprite._set(c,e)}}});return false},handle:function(c,b){var d,a;d=$H(this.tv).keys();a=$(b).ancestors().find(function(e){return d.include(e.id)});if(!a){return}a=this.tv[a.id];$j(document).trigger("db:treeview_selected",[c]);if(a.handler){a.handler(c,b)}if(a.autohide){this.hide(a.id)}return false},move:function(c,d,b){var a;a=$(c);if(!this.loaded){this.reset({onSuccess:(function(e){return function(){e.loaded=1;return e.move(c,d,b)}})(this),user:b!=null?b.user:void 0})}else{if(b&&b.onSuccess){b.onSuccess()}}assert(a,"Couldn't find tree_id");assert($(d),"Couldn't find location_id");$(d).appendChild(a);return a.show()}};var ULSelectMenu;ULSelectMenu=(function(){var d,h,c,i,j,e,g,a,f,b,k;d=function(l){return l.removeClassName("shown")};k=function(l){return l.toggleClassName("shown")};g=function(){return this.removeClassName("hover")};e=function(){return this.addClassName("hover")};a=function(p,o){var l,q,n,m;m=[];for(q=0,n=o.length;q<n;q++){l=o[q];m.push(p.insert(l))}return m};i=function(n,l,m){a(n,m);if(n.firstChild!==l){return n.__sert({top:l})}};f=function(m,n){var l;l="selected";$j(m).find("."+l).removeClass(l);return $j(n).addClass(l)};b=function(n,q){var r,p,m,o,l;o=n.select("li");l=[];for(p=0,m=o.length;p<m;p++){r=o[p];if(r.getAttribute("data-value")===q){l.push(f(n,r))}else{l.push(void 0)}}return l};j=function(l,n,m){return function(o){if(!l.hasClassName("selected")){f(n,l);n.fire("db:change",l.getAttribute("data-value"));return d(n)}else{i(n,l,m);return k(n)}}};h=function(n){var q,t,p,m,s,l,o,r;t=n.select("li");assert(t.length,"Empty list of options "+n.identify());p=void 0;if(t.length===1){n.addClassName("one")}else{for(o=0,r=t.length;o<r;o++){q=t[o];s=q.getAttribute("data-value");assert(s,q.identify()+" missing data value");q.observe("click",j(q,n,t));q.observe("mouseenter",e);q.observe("mouseleave",g);if(q.hasClassName("selected")){p=q}}$(document.body).observe("click",function(u){if($(u.target).up(".ul_select_menu")===n){return}return d(n)})}if(!p){p=t[0]}p.addClassName("selected");l=new Element("span");m=p.getDimensions();l.setStyle({width:m.width+"px",height:m.height+"px",position:"relative",display:"inline-block"});return n.wrap(l)};c=function(){var p,o,m,n,l;n=$$(".ul_select_menu");l=[];for(o=0,m=n.length;o<m;o++){p=n[o];l.push(h(p))}return l};$j(c);return{init:function(l){return h(l)},set_selected_by_value:b}})();var DBCalendar;DBCalendar=Class.create({initialize:function(b,a){this.options=a||{};this.container=$(b);assert(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=Util.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=Util.start_of_day(this.options.first_day||this.today)}this.view_date=Util.start_of_day(this.options.selected_date||this.today);this.selected_date=Util.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(b,a){Event.stop(b);this.view_date.setMonth(a);return this.render()},is_valid_date:function(d,f,e,c,a){var b;d=parseInt(d,10);f=parseInt(f,10);e=parseInt(e,10);c=parseInt(c,10);a=parseInt(a,10);c=c||1970;a=a||(new Date()).getFullYear()+1;f+=1;if(e<c){return false}if(e>a){return false}if(f<1||f>12){return false}if(d<=0){return false}if(f===2){b=((e%4)===0)&&(((e%100)!==0)||((e%400)===0));if(b){return d<=29}else{return d<=28}}else{if(f===4||f===6||f===9||f===11){return d<=30}else{return d<=31}}},change_date:function(a,d,b){var c;if(!this.is_valid_date(a,d,b)){return}c=b!==this.view_date.getFullYear()||d!==this.view_date.getMonth();this.selected_date.setDate(a);this.selected_date.setMonth(d);this.selected_date.setFullYear(b);if(c){this.view_date.setMonth(d);this.view_date.setFullYear(b);this.render()}else{$j(this.container).find(".selected").removeClass("selected");$j(this.container).find("a#day"+a+"-"+d).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var d,j,h,f,e,b,g,c,i,a;j=this.render_days();f=$j(".current-month",j);g=f.first().data("date");b=f.last().data("date");a=g<=this.options.first_day;i=b>=this.options.last_day;d=new Element("div");d.addClassName("calendar clearfix");if(!i){this._next_month=(function(k){return this._change_month(k,this.view_date.getMonth()+1)}).bind(this);e=new Element("a");e.addClassName("changemonth next");e.update(Sprite.make("web","arrowright",{}));Event.observe(e,"click",this._next_month);d.__sert(e)}if(!a){this._prev_month=(function(k){return this._change_month(k,this.view_date.getMonth()-1)}).bind(this);c=new Element("a");c.addClassName("changemonth prev");c.update(Sprite.make("web","arrowleft",{}));Event.observe(c,"click",this._prev_month);d.__sert(c)}h=new Element("h5");h.update(_("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:datetime.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));d.__sert(h);d.__sert(j);return this.container.__date(d)},render_days:function(){var h,g,a,f,b,e,d,c;g=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);d=g.getDay();h=new Element("div");h.addClassName("days");for(a=c=d;d<=0?c<0:c>0;a=d<=0?++c:--c){e=new Date(g.getFullYear(),g.getMonth(),g.getDate());e.setDate(e.getDate()-a);h.__sert(this.render_day(e,true))}f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(f.getMonth()===this.view_date.getMonth()){h.__sert(this.render_day(f));f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),f.getDate()+1)}b=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(b.getDay()!==6){b=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);h.__sert(this.render_day(b,true))}return h},render_day:function(c,e){var b,d;d=!e;if(this.options.last_day){e=e||c>this.options.last_day}if(this.options.first_day){e=e||c<this.options.first_day}b=new Element(e?"span":"a");$j(b).data("date",c);if(d){b.addClassName("current-month")}b.update(c.getDate());b.addClassName("date");b.writeAttribute("id","day"+c.getDate()+"-"+c.getMonth());if(this.selected_date.getDate()===c.getDate()&&this.selected_date.getMonth()===c.getMonth()&&this.selected_date.getFullYear()===c.getFullYear()){b.addClassName("selected")}if(e){b.addClassName("inactive")}else{this._handler=(function(f){var a;a=f.target.identify().substr(3).split("-");return this.change_date(a[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(b,"click",this._handler)}return b}});var DatePickerInput;DatePickerInput=Class.create({initialize:function(a,c){var f,d,e,b;this.container=a;this.options={};Object.extend(this.options,c||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");b=(this.input.value?Util.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){e=Util.from_mysql_date(this.container.getAttribute("data-first"))}f=this.options.disable_future!=null?this.options.disable_future:true;d=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:e,disable_future:f,disable_past:d,selected_date:b});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(b)},show_cal:function(b){var a;if(b){Event.stop(b)}a=$(b.target);if(a.match(".cal-container")||a.up(".cal-container")){return}$j(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(a){this.input.value=Util.to_mysql_date(a,false);this.display.update(DateUtil.localize(a));return this.hide_cal()}});var TextInputDatePicker;TextInputDatePicker=Class.create({initialize:function(d,c){var f,e,b,a;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,c||{});this.input=$(d);assert(this.input,"Couldn't find the element "+d.toString());b=new Date();a=(this.input.value?Util.from_mysql_date(this.input.value):false);e=new Date(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate());this.cal_icon=Sprite.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+d,style:"display: none; position: absolute; z-index: 1"});this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:e,selected_date:a});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));f=$j(this.input);$j(this.cal_container).clonePosition(f,{setWidth:false,setHeight:false,offsetTop:f[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(a){if(a){Event.stop(a)}return this.cal_container.toggle()},hide_cal:function(a){if(a){Event.stop(a)}return this.cal_container.hide()},onDateChange:function(a){if(this.options.choose_eod){a.setTime(Util.start_of_day(a).getTime()+86399999)}this.input.value=Util.to_mysql_date(a,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});event_load.window_load(ActAsBlock.register.bind(ActAsBlock));$j(SickInput.init.bind(SickInput));$j(SuggestionInput.register_all.bind(SuggestionInput));Event.observe(window,"scroll",function(){return TitleBubble.hide_all()});$j(function(){JumpWatcher.interval=setInterval(JumpWatcher.check.bind(JumpWatcher),500);LoginDropdown.init();return TitleBubble.init()});var LocaleSelector;LocaleSelector={init:function(){$j(document).on("click",".modal-locale-link",(function(a){return function(b){b.preventDefault();return a.show()}})(this));$j(document).on("click",".modal-locale-link-index-page",(function(a){return function(b){b.preventDefault();a.logShow();return a.show()}})(this));return $j(document).on("click",".modal-team-locale-link",(function(a){return function(b){b.preventDefault();return a.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new LocaleSelectorModal({element_id:"locale-selector-modal"})}return this.modal.show()},logShow:function(){return $j.ajax({url:"https://"+Constants.WEBSERVER+"/log_user_opened_locale_selector",type:"POST"})},show_team_modal:function(){if(!this.team_modal){this.team_modal=new TeamLocaleSelectorModal({element_id:"locale-selector-modal"})}return this.team_modal.show()}};$j(function(){return LocaleSelector.init()});var ChangeNameModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ChangeNameModal=(function(a){__extends(b,a);function b(){b.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(c){return function(h){var g,d,f;h.preventDefault();g=$j(h.target);d=g.closest("form");f=function(){c.hide();return location.reload()};return Forms.ajax_submit(d[0],false,f,null,g[0])}})(this)}return b})(DBModal);var AccountExtras;AccountExtras={prices:{},prices_value:{},watch_id:0,watch:function(){if(!AccountExtras.watch_id){return AccountExtras.watch_id=setInterval(AccountExtras.update_prices,200)}},show_detail:function(a,d,b){var c;c=_("What is %(feature_name)s?").format({feature_name:a});Modal.show(c,$(d+"-modal"),{},false);return false},register_price:function(e,a,d,c,b){AccountExtras.prices[e]=[a,d];return AccountExtras.prices_value[e]=[c,b]},update_prices:function(){var f,d,a,b,c,e;e=$("yearly").checked;d=(e?1:0);a=(e?_("year"):_("month"));b=0;for(f in AccountExtras.prices){if(AccountExtras.prices.hasOwnProperty(f)){$(f+"-price").__date(AccountExtras.prices[f][d]);$(f+"-priceperiod").__date(a)}if(AccountExtras.prices_value.hasOwnProperty(f)){if($(f).checked){c=AccountExtras.prices_value[f][d];b+=parseFloat(c)}}}return $(document).fire("widget:update_price",{price:b,period:a})}};var AliasManager,ManageAliasModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ManageAliasModal=(function(b){__extends(a,b);function a(c){this.options=c;this._poll_until_verified=__bind(this._poll_until_verified,this);this._get_params_from_target=__bind(this._get_params_from_target,this);this._on_load=__bind(this._on_load,this);this._show_action_panel=__bind(this._show_action_panel,this);this._input_enter_handler=__bind(this._input_enter_handler,this);this.resend_verify=__bind(this.resend_verify,this);this.remove_alias=__bind(this.remove_alias,this);this.add_alias=__bind(this.add_alias,this);this.refresh_alias=__bind(this.refresh_alias,this);this.on_show=__bind(this.on_show,this);a.__super__.constructor.call(this,this.options)}a.prototype.before_show=function(c){a.__super__.before_show.call(this,c);this.polling=0;c.find(".alias-action").on("click",this._show_action_panel);c.find(".alias-action-submit").on("click",this.add_alias);c.find("form").submit(function(){return false});return c.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};a.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};a.prototype.refresh_alias=function(d,c){if(d==null){d=true}if(d){Forms.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(e){return function(f){e.$modal_window.find(".dynamic-content").html(f.responseText);e._on_load(f);if(typeof c==="function"){return c()}}})(this),onFailure:(function(e){return function(f){return e.hide()}})(this)})};a.prototype.add_alias=function(g){var f,c,d,h;g.preventDefault();c=$j(g.currentTarget).closest("form");f=c.find(".alias-action-submit");h={};h[Constants.UID_PARAM_NAME]=this.options.subject_user.id;d=(function(e){return function(){var i;e.$modal_window.find(".alias-action-inputs input").val("");e.polling=0;i=e.polling?null:e._poll_until_verified;return e.refresh_alias(true,i)}})(this);return Forms.ajax_submit(c[0],false,d,false,f[0],h,"before")};a.prototype.remove_alias=function(c){var d;c.preventDefault();d=this._get_params_from_target(c.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:d,onSuccess:(function(e){return function(f){return e.refresh_alias()}})(this)})};a.prototype.resend_verify=function(c){var d;c.preventDefault();d=this._get_params_from_target(c.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:d,onSuccess:(function(e){return function(f){return e.refresh_alias()}})(this)})};a.prototype._input_enter_handler=function(c){c.preventDefault();c.stopPropagation();if(c.which===13){return this.add_alias(c)}};a.prototype._show_action_panel=function(f){var d,c;f.preventDefault();c=$j(f.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();d=this.$modal_window.find("#"+c).show();return d.find("input:visible:enabled:first").focus()};a.prototype._on_load=function(c){BrowseStyleRows.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(d){return function(f){return d.remove_alias(f)}})(this));return this.$dynamic.on("click",".alias-verify",(function(d){return function(f){return d.resend_verify(f)}})(this))};a.prototype._get_params_from_target=function(e){var c,d,f;c=$j(e);f=c.data("alias-type");d=c.closest(".alias-row").find(".alias-text").text();return{alias:d,alias_type:f}};a.prototype._poll_until_verified=function(){var e,f,d,c;f=5;e=60;d=(function(g){return function(){return g.refresh_alias(false,g._poll_until_verified)}})(this);c=this.$dynamic.find(".alias-verify").length;if(c&&this.polling<e){this.polling++;return setTimeout(d,f*1000)}else{return this.polling=0}};return a})(DBModal);AliasManager={show:function(e){var c,d,b,a;a=Viewer.get_viewer().get_user_by_role(e);if(a==null){return}if(!a.is_email_verified){if(e===Constants.ROLE_PERSONAL){personal_email_verification.verified()}else{work_email_verification.verified()}return}b=Viewer.get_viewer().is_paired?e:"";d=_("Manage your %(role_show)s contact methods").format({role_show:b});c=new ManageAliasModal({element_id:"manage-alias",title:d,subject_user:a,role:a.role});c.show()}};var BonusTable;BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(a){this.user_id=a;if(BonusTable._inited){return}BonusTable._inited=true;$("bonus-loading").show();BonusTable._tmpl=HTML.tmpl("bonus_row_tmpl");BonusTable.listen();return BonusTable.get_next_page()},_render:function(d){var b,e,c,a;b=[];for(c=0,a=d.length;c<a;c++){e=d[c];b.push(BonusTable._tmpl({row:e}))}return $("bonus-table").__sert(b)},get_next_page:function(){if(BonusTable._fetching_page){return}BonusTable._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+BonusTable._next_page,{onSuccess:function(b){var d,a,c;d=b.responseText.evalJSON();c=d.rows;a=d.has_more;BonusTable._render(c);$("bonus-loading").hide();if(a){BonusTable._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return BonusTable._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(b){var a,d,c;d=$j(b.currentTarget);c=_("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");a=$j(Bubble.make(c,"right","middle"));Element.absolutize(a[0]);d.append(a);a.clonePosition(d,{setWidth:false,setHeight:false});return a.css({width:"200px",left:(parseInt(a.css("left"),10)-210)+"px",top:(parseInt(a.css("top"),10)-55)+"px"})},_max_referral_out:function(h){var a,g,d,f,c;f=$j(".reached-max-referral-bonus .bubble");c=[];for(g=0,d=f.length;g<d;g++){a=f[g];c.push(a.remove())}return c},listen:function(){$j("#load-more-bonus").on("click",BonusTable.get_next_page.bind(BonusTable));$j(document).on("mouseenter",".reached-max-referral-bonus",BonusTable._max_referral_over);return $j(document).on("mouseleave",".reached-max-referral-bonus",BonusTable._max_referral_out)},toggle:function(){if($j("#bonus-list").is(":visible")){this.hide();return $j("#space-earned-link").text(_("View all space earned"))}else{this.show();return $j("#space-earned-link").text(_("Hide space earned"))}},show:function(){return $j("#bonus-list").slideDown(150)},hide:function(){return $j("#bonus-list").slideUp(150)}};var DowngradeReasons,DowngradeReasons2,DowngradeSurvey;DowngradeReasons={reasons:{},addReason:function(a){return this.reasons[a]=true},addReasons:function(a){var d,e,c,b;b=[];for(e=0,c=a.length;e<c;e++){d=a[e];b.push(this.addReason(d))}return b},change:function(f,c,a){var g,i,h,d,b,e;f=parseInt(f,10);i=$(c);assert(i,"Couldn't find container for DowngradeReason");g=false;e=this.reasons;for(d in e){h=e[d];b=$(a+d);assert(b,"Couldn't find container for ",a+d);if(h&&parseInt(d,10)===f){b.show();g=true}else{b.hide()}}if(g){return i.show()}else{return i.hide()}}};DowngradeReasons2={init:function(){var b,d,a,c;c=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(d=0,a=c.length;d<a;d++){b=c[d];$j(b).change(function(f){var e;e=f.target.id.indexOf("other")>=0;return DowngradeReasons2.change(e,f.target.getValue())})}return $j(".shared-additional-info").attr("name","shared_additional_info")},change:function(c,a){var b;$j(".downgrade-other-reason .error-message").hide();if(c){return}b="#downgrade-info-"+a;$j(".downgrade-info").hide();$j(b).show();$j(".downgrade-info textarea").removeAttr("name");$j(b+" textarea").attr("name","additional_info");return $j("input[name=other_reason_id]").removeAttr("checked")}};DowngradeSurvey={init:function(){var a;a="#downgrade-survey-form";return $j(""+a).on("submit",(function(b){return function(f){var d,c;c=$j(""+a+" input[name=other_reason_id]:checked").length;d=$j(""+a+" input[id=downgrade-radio-8]");if(d.is(":checked")&&c===0){$j(".downgrade-other-reason .error-message").show();return f.preventDefault()}}})(this))}};var GetSpace;GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(c,b,d){var a;GetSpace._current_space=c;GetSpace._why_msg=b;GetSpace._twitter_url=d;if($("why_like")&&$("twitter_post")){$("twitter_post").hide()}$("space-actions").on("click",".space-action",GetSpace.perform_action);a=URI.parse(window.location.href).fragment;if(a){return GetSpace.highlight_offer(a)}},highlight_offer:function(b){var a,c;a=$j("#"+b);c=a.css("background-color");return a.css("background-color",GetSpace.offer_highlight_color).delay(2000).animate({"background-color":c}).queue(function(){return a.css("background-color","")})},perform_action:function(b){var c,a;a={contact_sales:GetSpace._contact_sales,contact_support:GetSpace._contact_support,teams:GetSpace._teams,upgrade:GetSpace._upgrade,plans:GetSpace._plans,refer:GetSpace._refer,get_started:GetSpace._get_started,fb_link:GetSpace._fb_link,twitter_link:GetSpace._twitter_link,twitter_follow:GetSpace._twitter_follow,why_like:GetSpace._why_like,twitter_post:GetSpace._twitter_post,mailbox_link:GetSpace._mailbox_link};c=$(b.target);if(!c.hasClassName("space-action")){c=c.up(".space-action")}return a[c.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return FacebookOAuth.do_auth(function(){GetSpace._refresh_link_bonuses();return GetSpace._completed($("fb_link"))},Viewer.get_viewer().personal_user.id)},_twitter_link:function(){return Twitter.do_auth(function(){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(Viewer.get_viewer().personal_user.id,true);return GetSpace._completed($("twitter_link"))},Viewer.get_viewer().personal_user.id)},_twitter_follow:function(){if(Twitter.is_authed(Viewer.get_viewer().personal_user.id)){return GetSpace.follow_dropbox()}else{return Twitter.do_auth(GetSpace.follow_dropbox,Viewer.get_viewer().personal_user.id)}},_why_like:function(){Modal.show(_("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return Util._track_twitter_chars_left("why-i-like-input",90)},_twitter_post:function(){if(Twitter.is_authed(Viewer.get_viewer().personal_user.id)){return GetSpace.start_twitter_post()}else{return Twitter.do_auth(GetSpace.start_twitter_post,Viewer.get_viewer().personal_user.id)}},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!Twitter.is_authed(Viewer.get_viewer().personal_user.id)){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(Viewer.get_viewer().personal_user.id,true)}return Twitter.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(_("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(_("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}return GetSpace._completed($("twitter_follow"))}},Viewer.get_viewer().personal_user.id)},submit_why:function(){GetSpace._why_msg=$F("why-i-like-input");return Forms.ajax_submit($("why-i-like-form"),false,(function(){Modal.hide();GetSpace._completed($("why_like"));if($("twitter_post")){return setTimeout((function(){return $j("#twitter_post").css("opacity",0).slideDown().animate({opacity:1},{queue:false,duration:2500})}),2500)}}),false,$("why-i-like-submit"))},start_twitter_post:function(){Modal.onHide=function(){if(!Twitter.is_authed(Viewer.get_viewer().personal_user.id)){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(Viewer.get_viewer().personal_user.id,true)}if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}delete Modal.onHide;return Modal.hide()};return Twitter.get_user_info(function(a){Modal.show(_("Tweet about your love of Dropbox"),$("twitter-post-modal"));$("twitter-post-header").down(".profile-pic").__date(new Element("img",{src:a.profile_image_url_https}));$("twitter-post-header").down(".name").__date(a.name);$("twitter-post-header").down(".username").__date("@"+a.screen_name);GetSpace._update_display_twitter_post();$("twitter-post-input").setValue(GetSpace._why_msg);return Util._track_twitter_chars_left("twitter-post-input",90)},Viewer.get_viewer().personal_user.id)},show_edit_twitter_post:function(){$("display-twitter-post").hide();$("display-twitter-post-buttons").hide();$("edit-twitter-post").show();$("edit-twitter-post-buttons").show();$("twitter-post-input").observe("keypress",function(a){if(a.keyCode===13){return GetSpace.hide_edit_twitter_post()}});return $("twitter-post-input").focus()},hide_edit_twitter_post:function(){var a;a=$F("twitter-post-input");if(!a){Notify.error(_("Please enter a message"));return}else{if(a.length>90){Notify.error(_("Your post must be 90 characters or less"));return}}GetSpace._why_msg=a;GetSpace._update_display_twitter_post();$("edit-twitter-post").hide();$("edit-twitter-post-buttons").hide();$("display-twitter-post").show();return $("display-twitter-post-buttons").show()},do_twitter_post:function(){var a;Twitter.from_getspace=1;a=_("I love Dropbox because %(why_msg)s %(referral_link)s",{comment:"why_msg will be filled in by Dropbox users"}).format({why_msg:GetSpace._why_msg,referral_link:GetSpace._twitter_url});if(a.length>140){GetSpace.show_edit_twitter_post();Notify.error(_("Your tweet must be 140 characters or less"));return}Twitter.custom_show_posting=function(){return Forms.add_loading($("twitter-post-submit"))};return Twitter.custom_post(a,function(){Modal.hide();return GetSpace._completed($("twitter_post"))},Viewer.get_viewer().personal_user.id)},_update_display_twitter_post:function(){var a;$("display-twitter-post").__date(_("I love Dropbox because %(why_msg)s ",{comment:"why_msg will be filled in by Dropbox users"}).format({why_msg:GetSpace._why_msg}));a=new Element("a",{href:GetSpace._twitter_url,target:"_blank"});a.__date(GetSpace._twitter_url);return $("display-twitter-post").__sert(a)},_completed:function(b){var a;b.addClassName("completed");b.down(".icon-col").__date(Sprite.make("web","check_36"));$j(b).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return $j(b).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);a=parseInt(b.down(".space").readAttribute("data-space"),10);GetSpace._current_space+=a;$("current-space").__date(display_format.format_bytes(GetSpace._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var Help;Help={toggle_more_help:false,show_os:function(b,c,a){c=$(c);$$(".os-filter").invoke("removeClassName","selected");c.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+a).invoke("show");return Event.stop(b)},vote:function(a,b){new Ajax.DBRequest("/help/"+a+"/vote/"+b);$j("#help-vote-cont").fadeOut();return Notify.success(_("Thanks for your feedback!"))}};var Home;Home={hide_promo:function(a){new Ajax.DBRequest(a);return $$(".house-ad").invoke("remove")}};var DeleteFailuresModal,Hosts,UnlinkHostModal,show_delete_failures_modal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Hosts={attach_host_listener:function(e,c){var b,d,f,a;b=$j("#"+e);f=b.data("host-ids");d=b.data("display-name");a=function(){return new UnlinkHostModal(f,d,c,null,null).show()};return $j(".unlink-host-link",b).on("click",a)},edit:function(f,c){var b,g,h,e,d,a;h=$j("#host-device-row-"+c+" .host-item .sprite-text");if(h.data("editing")==="true"){return false}h.data("editing","true");g=h.text();h.data("previous",g);f=$u.values(f);e=$j('<input type="text" class="name-input skinny-input" size="20"\n  maxlength="256" style="word-wrap: break-word;">').val(g);a=$j('<input type="button" class="button">').val(_("Save"));a.on("click",function(){return Hosts.doneEditing(f,c)});b=$j('<input type="button" class="button grayed">').val(_("Cancel"));b.on("click",function(){return Hosts.cancelEditing(c)});h.empty();h.append(e,"&nbsp;",a,"&nbsp;",b);d=$j("input",h);d.on("keydown",function(){return Hosts.checkKey(f,c)});return d.focus()},doneEditing:function(c,b){var d,a;d=$j("#host-device-row-"+b+" .host-item .sprite-text");a=$j("input",d).val();return $j.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(c),name:a},type:"POST"}).success(function(e){return Hosts.unedit(d,JSON.parse(e).display_name)})},cancelEditing:function(a){var b;b=$j("#host-device-row-"+a+" .host-item .sprite-text");return Hosts.unedit(b,b.data("previous"))},unedit:function(b,a){b.data("editing","false");return b.text(a)},dismiss:function(c,b,d,a,e){new $j.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:c,user_id:b,team_id:d},subject_user:e,success:function(f){return a.remove()}});return false},checkKey:function(b,a){return function(c){c=c||window.event;if(c.keyCode===Event.KEY_RETURN){Hosts.doneEditing(b,a)}if(c.keyCode===Event.KEY_ESC){return Hosts.cancelEditing(a)}}},show_device_unlink_modal:function(d,e,g,c,b,i,a){var h,f;h=$j("#unlink-device-modal-"+i);f={both:$u.values(b),personal:[b[Constants.ROLE_PERSONAL]],work:[b[Constants.ROLE_WORK]]};Modal.show(c,h[0]);if($u.values(b).length>1){h.addClass("show-selector")}return $j("form input[type=submit]",h).on("click",function(j){j.preventDefault();b=f[$j(".unlink-select select",h).val()];Forms.add_vars($j("form",h)[0],{user_ids:JSON.stringify(b),app_id:e,device_id:JSON.stringify(d),device_name:a});return $j("form",h).submit()})}};DeleteFailuresModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(c){c.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};b.prototype.on_show=function(d){var c;c=ungettext("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(c)};return b})(DBModal);show_delete_failures_modal=function(c,b,a){var d;d=new DeleteFailuresModal({element_id:"delete-failures-modal"});d.host_id=c;d.name=b;d.num_failures=a;d.show();return false};UnlinkHostModal=(function(b){__extends(a,b);function a(g,e,c,d,f){this.host_ids=g;this.name=e;this.delete_support_type=c;this.owner_id=d;this.team_id=f;this.on_show=__bind(this.on_show,this);this._set_delete_text=__bind(this._set_delete_text,this);this.fail_callback=__bind(this.fail_callback,this);this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);a.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=$u(this.host_ids).values().length>1}a.prototype.on_confirm_button_click=function(g){var d,f,c;g.preventDefault();f=this.$modal_window.find(".unlink_host_form")[0];d=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");c={host_ids:JSON.stringify(this.get_selected_hosts())};return Forms.ajax_submit(f,false,this.success_callback,this.fail_callback,d,c)};a.prototype.success_callback=function(){return window.location.reload()};a.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};a.prototype._set_delete_text=function(c){return this.$modal_window.find(".delete_data_label").text(c)};a.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};a.prototype.on_show=function(d){var c;this.$modal_window.find(".delete_data").attr("checked",false);if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(e){return function(f){if(e._get_unlink_select()===Constants.ROLE_PERSONAL){return e.$modal_window.find(".new_client").hide()}else{return e.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(_("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:Viewer.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(e){return function(f){if(e._get_unlink_select()===Constants.ROLE_WORK){return e.$modal_window.find(".new_client").hide()}else{return e.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(_("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(_("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(e){return function(f){if(e._get_unlink_select()===Constants.ROLE_PERSONAL){return e._set_delete_text(_("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(e._get_unlink_select()===Constants.ROLE_WORK){return e._set_delete_text(_("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:Viewer.get_viewer().team_name}))}else{return e._set_delete_text(_("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){c="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(_("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:c}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};a.prototype.get_selected_hosts=function(){var c;if($u.values(this.host_ids).length===1){return $u.values(this.host_ids)}c=$j(".unlink-choice").val();if(c==="both"){return $u.values(this.host_ids)}else{return[this.host_ids[c]]}};return a})(DBModal);var LoginAndRegister;LoginAndRegister={init:function(b,a){$j("#login-link").on("click",function(){$j("#login-and-register-container").removeClass("show-register");if(a){return $j("#login_password").focus()}else{return $j("#login_email").focus()}});$j("#register-link").on("click",function(){$j("#login-and-register-container").addClass("show-register");return $j("#register-partial input").filter(":visible").first().focus()});if(b){return $j("#register-partial input").filter(":visible").first().focus()}else{if(a){return $j("#password-field input").focus()}else{return $j("#login_email").focus()}}}};var News;News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(b,c){var a;if(c.hasAttribute("data-div")){b.preventDefault();a=c.readAttribute("data-div");return DBHistory.push_state("/news/"+a)}});return DBHistory.add_callback("/news",News.history_change)},change_tab:function(a){var b;b=$$("#nav a[data-div="+a+"]").first();if($(b)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(b).addClassName("selected");return $(a).addClassName("selected")}},history_change:function(a){a=a||News.DEFAULT_TAB;return News.change_tab(a)}};var Recover;Recover={init:function(){var a;a=$("recover-form");return a.observe("submit",this.form_submit.bind(this))},form_submit:function(a){this.clear_error();a.preventDefault();return Forms.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(b){var a;a=JSON.parse(b.responseText);if(a.status==="error"){this.show_error(a.msg)}if(a.status==="ok"){this.show_hosts(a)}if(a.status==="redirect"){return window.location.href=a.url}},show_hosts:function(h){var e,c,d,a,g,b,f;Forms.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(h.filename);c=$("trusted-hosts");c.update();f=h.hosts;for(g=0,b=f.length;g<b;g++){e=f[g];a=new Element("li");d="lnx";if(e.platform==="mac"){d="osx"}if(e.platform==="win"){d="win"}a.__sert(Sprite.make("web",d));a.__sert(new HTML(e.display_name.escapeHTML()));c.appendChild(a)}$("login-step").hide();return $("hosts-step").show()},show_error:function(a){$("error-messages").update(a);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var Restore;Restore={next:function(a,d){var c,b;b=$j("ul.selected");c=b.next("ul");c.addClass("selected");b.removeClass("selected");if(c.next("ul").length){$j("#next-page").show()}else{$j("#next-page").hide()}$j("#prev-page").show();return Restore.inc_page(1)},prev:function(a,d){var c,b;b=$j("ul.selected");c=b.prev("ul");c.addClass("selected");b.removeClass("selected");if(c.prev("ul").length){$j("#prev-page").show()}else{$j("#prev-page").hide()}$j("#next-page").show();return Restore.inc_page(-1)},inc_page:function(c){var b,a;b=parseInt($j("#page_num").text(),10);a=b+c;return $j("#page_num").text(a)},init:function(d,a,b){var c;c=Viewer.get_viewer().get_user_by_id(b);$j("#next-page").on("click",function(f){Restore.next(f);return false});$j("#prev-page").on("click",function(f){Restore.prev(f);return false});$j("#restore-submit-button").on("click",function(f){FileOps.do_folder_restore(d,c);return false});$j("#restore-cancel-button").on("click",function(f){return location.href=a});return $j("#restore-back-button").on("click",function(f){return location.href=a})}};var SelectRoleModal,ShareShmodelSelectRoleModal,SharedFolderSelectRoleModal,ShmodelC2DSelectRoleModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};SelectRoleModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=null;b.prototype.on_show=function(){return $j(".role-options li").click((function(c){return function(f){var d,g;d=$j(f.target).closest("li");g=d.data("role");assert(c.on_select_role,"missing on_select_role implementation");c.on_select_role(g);return c.hide()}})(this))};return b})(DBModal);SharedFolderSelectRoleModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(d){var c;c=function(){Sharing.role_picker.ensure_role_is_visible(d);SharingState.set_role(d);return SharingModals.start_wizard_for_user(Viewer.get_viewer().get_user_by_role(d))};if(d===Multiaccount.logged_out_role){return MultiaccountLogin.show_modal({role:d,on_success:c})}else{return c()}};return b})(SelectRoleModal);ShmodelC2DSelectRoleModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(d){var c;c=function(){return SharingModel.show_c2d_modal(d)};if(!Viewer.get_viewer().is_role_signed_in(d)){return MultiaccountLogin.show_modal({role:d,on_success:c})}else{return c()}};return b})(SelectRoleModal);"This is displayed when someone tries to share a shmodel but is paired and has\nmultiple accounts that they could share from. (This determines who the share\nemail sends from, who the contact gets added to, etc.)";ShareShmodelSelectRoleModal=(function(a){__extends(b,a);function b(){this.on_select_role=__bind(this.on_select_role,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(c){return SharingModel.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,c)};return b})(SelectRoleModal);var TabController;TabController=Class.create({initialize:function(c,b){var a;a=$(c);assert(a,c+" is missing.");this.container=a;this.options={killEvent:true};Object.extend(this.options,b);return this.listen()},listen:function(){var f,c,e,b,d,a;c=this;d=this.container.select("a");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];assert(f.id&&f.id.length>0,"Element is missing an id");a.push(f.observe("click",(function(g){return this.click(g)}).bindAsEventListener(c)))}return a},click:function(a){if(this.options.killEvent){Event.stop(a)}return this.toggle($(a.target))},toggle:function(b){var e,a,d,f,c;c=this.container.down("a.selected");if(c){f=$(c.id+"-content");if(f){f.hide()}}this.container.select(".selected").invoke("removeClassName","selected");a=false;if(!b){b=this.container.down("a");a=true}b.addClassName("selected");e=$(b.id+"-content");if(e){e.show()}if(this.options.onTabChange){this.options.onTabChange(b,c)}if(this.options.url_prefix){d=this.options.url_prefix;if(!a){d+="/"+b.id}return DBHistory.push_state(d)}}});var InviteForm;InviteForm={initialized:false,init:function(){$j((function(a){return function(){a.add_auto_completer=new Autocompleter.ContactsTokenizer(Viewer.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(b){return b.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});return a.add_auto_completer.clearTokens()}})(this));this.tokenAdd=$j.proxy(this._tokenAdd,this);this.tokenRemove=$j.proxy(this._tokenRemove,this);$j("#team-invite-new-collab-input")[0].on("token:add",this.tokenAdd);$j("#team-invite-new-collab-input")[0].on("token:remove",this.tokenRemove);this.reset_licenses();this.initialized=true;this.setup_tab_support($j);return SickInput.init()},set_emails:function(f){var a,d,e,c,b;if(f==null){return}b=[];for(e=0,c=f.length;e<c;e++){d=f[e];a={display:d,type:0,valid:true,value:d};b.push(this.add_auto_completer.addContact(a))}return b},rebind_modal_submit_autocompleter:function(){var a,b;a=this.invite_modal.$modal_window;b=a.find(".tokenizer-submit-button");b.on("mousedown",(function(c){return function(){return c.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(a)},setup_tab_support:function(a){return a.find("#team-invite-new-collab-input").first().on("keyup change",function(){var b;b=a.find(".new-collab-input").first();if(b.val()!==""){return b.attr("tabindex",-1)}else{return b.removeAttr("tabindex")}})},reset_modal_licenses:function(){var a;a=typeof Dashboard!=="undefined"&&Dashboard!==null?Dashboard.get_total_members():window.active_team_member_table.get_user_count();this.update_used_licenses(a);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(a){this.available_licenses--;$j(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(a){this.available_licenses++;$j(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(b){var c,a,d;if(window.active_team_member_table){d=window.active_team_member_table.data.users;for(a in d){c=d[a];if(c.email===b){return true}}}},update_license_count:function(){var a,b;a=$j("#license-count-message");if(this.available_licenses<0){b=_("You need more licenses for this invitation.");a.addClass("over")}else{if(this.available_licenses===0){b=_("You have no remaining licenses.");a.removeClass("over")}else{b=ungettext("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});a.removeClass("over")}}return a.text(b)},init_modal_licenses:function(c,b,a){if(!this.invite_modal){this.invite_modal=new InviteModal(a)}this.total_licenses=c;this.is_trial=b;return $j("body").trigger("invite-modal-initialized")},update_used_licenses:function(a){this.used_licenses=a;return this.reset_licenses()},init_form_licenses:function(c,a,b){this.total_licenses=c;this.used_licenses=a;this.is_trial=b;return InviteForm.reset_licenses()},add_total_licenses:function(a){a=a||0;if(a>0){this.total_licenses+=a;this.available_licenses+=a;this.update_license_count();if(typeof Dashboard!=="undefined"&&Dashboard!==null){return Dashboard.add_licenses(a)}}},on_add_licenses_exit:function(b,a){var c;if((c=this.invite_modal)!=null?c.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(a)},reset_modal:function(){var a;a=this.invite_modal.$modal_window;SuggestionInput.reset(a.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return a.find(".new-collab-input").val("")},on_add_licenses_click:function(b){var a;b.preventDefault();if(this.is_trial){if((a=this.invite_modal)!=null){a.hide()}return add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){DBModalStack.unregister(AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=$j.proxy(this.on_add_licenses_exit,this);DBModalStack.register(AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return DBModalStack.push(new AddLicensesModal())}}};var InviteModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};InviteModal=(function(b){__extends(a,b);function a(c){this.transition_view_model=c;this._reset=__bind(this._reset,this);this._update_form_pricing_information=__bind(this._update_form_pricing_information,this);this._update_remaining_licenses_message=__bind(this._update_remaining_licenses_message,this);this._make_transition_info_request=__bind(this._make_transition_info_request,this);this._handle_token_change=__bind(this._handle_token_change,this);this._licenses_total=__bind(this._licenses_total,this);this._licenses_to_add=__bind(this._licenses_to_add,this);this.on_hide=__bind(this.on_hide,this);this.on_show=__bind(this.on_show,this);a.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new DfBTransitionInfoFetcher(c);this.probability=Math.random()}this.skip_reset=false}a.prototype.on_confirm_button_click=function(c){return Team.add_users(c,this.add_qty)};a.prototype.on_show=function(){var c;this._reset();c=$j("#team-invite-wizard .team-invite-add-licenses");c.on("click",$j.proxy(InviteForm.on_add_licenses_click,InviteForm));$j(window).on("token:changed",this._handle_token_change);if(InviteForm.initialized){InviteForm.update_license_count()}return DBModalStack.register(DBModalStack.CLEAR,function(){return InviteForm.reset_modal()})};a.prototype.on_hide=function(){return $j(window).off("token:changed",this._handle_token_change)};a.prototype._licenses_to_add=function(){return -1*InviteForm.available_licenses};a.prototype._licenses_total=function(){return InviteForm.total_licenses+this._licenses_to_add()};a.prototype._handle_token_change=function(d,c){this._update_remaining_licenses_message(c.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(e){return function(){e._make_transition_info_request();return e.fetch_transition_timeout_id=null}})(this),100)}};a.prototype._make_transition_info_request=function(){var e,d,c,f;d=Math.floor(Math.random()*1000000);this.current_callback_token=d;e=this._licenses_to_add();c=this._licenses_total();f=(function(g){return function(h){return g._update_form_pricing_information(d,e,c,h)}})(this);if(e>0){return this.transition_info_fetcher.get(f,{total_users:this._licenses_total()})}else{return f(null)}};a.prototype._update_remaining_licenses_message=function(c){var d;this.remaining_licenses=c;d=this._get_remaining_licenses_message(c);return this.$modal_window.find("#license-count-message").text(d)};a.prototype._get_remaining_licenses_message=function(c){var d;if(c<0){d=_("You need more licenses for this invitation.")}else{if(c===0){d=_("After this invitation, you'll have no remaining licenses.")}else{d=ungettext("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",c).format({count:c})}}return d};a.prototype._update_form_pricing_information=function(f,g,c,j){var d,i,h,e;if(f!==this.current_callback_token){return}if(j&&g>0){this.add_qty=g;d=this.transition_view_model.state.currency;h=j.current_total.amount;i=CashUtil.formatCurrency(h,d);e=CashUtil.formatCurrency(j.recurring_total.amount,d);$j(".new-amount").text(i);$j(".add-qty").text(g);$j(".recurring-amount").text(e);$j(".total-qty").text(c);$j(".charges-section").show();$j(".team-invite-buttons .confirm-button").val(_("Invite and buy"));return $j("#expected_price").val(h)}else{return this._reset()}};a.prototype._reset=function(){this.add_qty=0;$j(".charges-section").hide();$j("#expected_price").val(0);return $j(".team-invite-buttons .confirm-button").val(_("Invite to team"))};return a})(DBModal);var AccountTransferBaseModal,BetaEnrollConfirmationModal,BetaFeedbackModal,DemoSignupModal,DfeRemoveUserModal,ManageFilesModal,Team,TwoFactorMessageModal,show_manage_files_modal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Team={setup_beta_modal_listeners:function(){var f,i,g,a,e,d,h,b,c;i=$j(".feature-list .enroll-button");a=$j(".feature-list .feedback-button");for(e=0,h=i.length;e<h;e++){f=i[e];g=$j(f).data("feature");$j(f).click((function(j){return function(){return new BetaEnrollConfirmationModal(j).show()}})(g))}c=[];for(d=0,b=a.length;d<b;d++){f=a[d];g=$j(f).data("feature");c.push($j(f).click((function(j){return function(){return new BetaFeedbackModal(j).show()}})(g)))}return c},invite_modal_show:function(a){if(!InviteForm.invite_modal){return $j("body").one("invite-modal-initialized",(function(b){return function(){return b.invite_modal_show(a)}})(this))}if(!this.invite_modal_already_initialized){InviteForm.invite_modal.show();InviteForm.init();this.invite_modal_already_initialized=true}else{InviteForm.invite_modal.show();InviteForm.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){InviteForm.update_used_licenses(window.active_team_member_table.get_user_count())}return InviteForm.set_emails(a)},init_admin:function(){TitleBubble.set_vertical_space(2);return $j("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return $j(".team_name_change_notice .hide_link").click((function(a){return function(b){return a.hide_team_name_change_banner()}})(this))},add_users:function(c,a){var f,b,d;Event.stop(c);b=$("team-invite-form");assert(b,"Couldn't find the team invite form.");f=$j(b).find("input[name='emails']");if(f.length===0){Notify.error(_("You haven't included anyone to invite! Please invite at least one person."));return}d=Forms.collect_form_vars(b);$j.extend(d,{team_id:Constants.team_id});Forms.add_loading(c.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:d,subject_user:Viewer.get_viewer().work_user,progress_text:_("Inviting members..."),noAutonotify:true,onSuccess:function(l){var i,h,g,j,e;Forms.remove_loading();InviteForm.reset_modal();InviteForm.add_total_licenses(a);InviteForm.invite_modal.hide();j=$j(".team_admin_members_table");g=JSON.parse(l.responseText);if(g){if(window.active_team_member_table){window.active_team_member_table.add_users(g!=null?g.users:void 0)}else{if(typeof Dashboard!=="undefined"&&Dashboard!==null){Dashboard.set_num_invited(g!=null?g.num_invited:void 0)}}i=(function(){var m,k;m=g!=null?g.users:void 0;k=[];for(h in m){e=m[h];k.push(e)}return k})();if(i.length===1){return Notify.success(_("Invited %(user_email)s.").format({user_email:i[0].email}))}else{if(i.length>1){return Notify.success(_("Invited %(user_count)d people.").format({user_count:i.length}))}else{return Notify.error(ungettext("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",f.length).format({num_skipped:f.length}))}}}else{return Notify.error()}},onFailure:function(h){var e,g;if(h){if(h.responseText.indexOf("err:")===0){e=h.responseText.substr(4);if(e.indexOf("{")===0){g=e.evalJSON(true);Forms.fill_errors(b,g)}else{e=new HTML(e);Notify.error(e)}}else{Notify.error()}}Forms.remove_loading();return $j("input[type='submit']").prop("disabled",false)},cleanUp:function(){Forms.remove_loading();InviteForm.reset_modal();return InviteForm.invite_modal.hide()}})},show_demo_signup_modal:function(c,d,e,b,f){var a,i,h,g;this.webinar_key=c;this.webinar_iso_datetime=d;this.webinar_date=e;this.webinar_title=b;this.tab_url=f;g=_("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});i=new DemoSignupModal({element_id:"demo-signup-modal",title:g});i.show();i.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);i.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);i.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);i.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);h=i.$modal_window.find("input[name=retURL]");h.attr("value",h.val()+"#"+this.tab_url);a=i.$modal_window.find("#demo-signup-form")[0];return a.on("submit",i.on_confirm_button_click)},show_remove_modal:function(d,f,a,b,h,c){var e,g;if($j(".dfe-remove-user-modal").length){e=new DfeRemoveUserModal({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});e.user_name=f||b;e.email=b;e.user_id=a;e.team_id=Constants.team_id;e.invited=h;e.show();return false}if(f){DomUtil.fillVal(f,"remove-user-name");g=_("Remove '%(user_name)s'").format({user_name:f})}else{DomUtil.fillVal(b,"remove-user-name");g=_("Remove '%(user_email)s'").format({user_email:b})}if(!h&&c){$("user-migrated-message").show();$("delete-account").checked=false;$("remove-from-team").checked=true}else{$("user-migrated-message").hide();$("remove-from-team").checked=false;$("delete-account").checked=true}if(!h){return Modal.show(g,$("remove-user-modal"),{user_id:a,button:d})}else{return Modal.show(g,$("remove-user-modal-simple"),{user_id:a,button:d,disable_if_joined:false})}},remove_user:function(d,f){var c,b,a;Event.stop(d);b=$j("input[type=submit]","#remove-user-modal");b.attr("disabled",1);a=Modal.vars.user_id;if(f){c=true}else{c=$j("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:Constants.team_id,user_id:a,disable_if_joined:c},onSuccess:(function(e){return function(i){var h,j,g;h=JSON.parse(i.responseText);if((j=window.active_team_member_table)!=null){j.remove_user(Modal.vars.user_id)}if((g=window.removed_team_member_table)!=null){g.add_users(h)}e.decrement_used_licenses();return Notify.success(_("User removed."))}})(this),cleanUp:function(){Modal.hide();return b.removeAttr("disabled")}})},show_reinvite_modal:function(c,d,a,b){var e;DomUtil.fillVal(b,"reinvite-user-email");DomUtil.fillVal(d,"reinvite-user-team");e=_("Resend invite to '%(email_address)s'").format({email_address:Emstring.em_snippet(b,18)});return Modal.show(e,$("reinvite-user-modal"),{user_id:a,button:c})},reinvite_user:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(f){var d,e,c,g;Notify.success(_("Invite sent."));if((g=$("team-member-info"))!=null){g.update(f.responseText)}d=window.active_team_member_table;c=d.data.users[a];c.invite_expired=false;e={};e[a]=c;return d.update_user_data(e)},cleanUp:function(){return Modal.hide()}})},show_user_activity_log_modal:function(a,c,d){var b;b=$j("#activity-log-modal");b.find(".activity-log-email").text(c);b.find(".activity-log-name").text(d);b.find("#activity-log-user-message").show();return Modal.show(_("Create activity report"),b[0],{user_id:a})},show_team_activity_log_modal:function(b,c){var a;a=$j("#activity-log-modal");a.find(".activity-log-email").text(b);a.find(".activity-log-name").text(c);a.find("#activity-log-team-message").show();return Modal.show(_("Create full activity report"),a[0])},generate_activity_log:function(h){var d,g,f,a,c,b;Event.stop(h);d=$j("#activity-log-modal");g=d.find("input[name='from_date']").val();a=d.find("input[name='to_date']").val();if(g>a){Notify.error(_("Your start date is after your end date."));return}f=Constants.team_id;b=Modal.vars.user_id;c=new Date().getTimezoneOffset().toString();return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:g,to_date:a,team_id:f,user_id:b,tzoffset:c},onSuccess:function(e){return Notify.success(_("Report started. We'll email you when it's ready."))},cleanUp:function(){return Modal.hide()}})},show_reset_password_modal:function(b,c,a){var d;$j("#reset-password-modal .member-name").text(c);d=_("Reset password for '%(user_name)s'").format({user_name:c});return Modal.show(d,$("reset-password-modal"),{user_id:a,button:b})},reset_password:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(c){return Notify.success(_("User's password reset."))},cleanUp:function(){return Modal.hide()}})},show_reset_all_passwords_modal:function(){return Modal.show(_("Reset all passwords"),$("reset-all-passwords-modal"))},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:Constants.team_id},job:Constants.use_async_reset,subject_user:Viewer.get_viewer().work_user,progress_text:_("Resetting all passwords..."),onSuccess:function(a){return Notify.success(_("All passwords reset."))},cleanUp:function(){return Modal.hide()}})},show_admin_status_modal:function(c,i,k,e,j,f){var b,g,a,d,h;a=j.strip()||e;d=void 0;b=void 0;h=void 0;g=void 0;if(f){h=_("Add admin permissions for '%(person_name)s'").format({person_name:a.escapeHTML()});d=_("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:a.escapeHTML()});b=_("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"});g="alert_32"}else{h=_("Remove admin privileges from '%(person_name)s'").format({person_name:a.escapeHTML()});d=_("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:a.escapeHTML()});b=_("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"});g="alert_32"}DomUtil.fillVal(e,"admin-status-email");DomUtil.fillVal(d,"admin-status-action");DomUtil.fillVal(b,"admin-status-button-action");return Modal.show(h,$("admin-status-modal"),{user_id:k,button:c,admin_on:f})},set_admin_status:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:Constants.team_id,user_id:a,on:(Modal.vars.admin_on?"yes":"no")},onSuccess:function(d){var e,c;e=(Modal.vars.admin_on?_("User's admin status granted."):_("User's admin status removed."));if(window.active_team_member_table){c=JSON.parse(d.responseText);window.active_team_member_table.update_user_data(c);return Notify.success(e)}else{if(Modal.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(Modal.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(Modal.vars.user_id)}}},cleanUp:function(){return Modal.hide()}})},show_disable_2fa_modal:function(c,a,b){$j("#disable-2fa-modal .member-name").text(b);return Modal.show(_("Disable two-step verification"),$("disable-2fa-modal"),{user_id:a,elm:c})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(b){var a;$j(".tfa_enabled").replaceWith(_("Disabled"));a=JSON.parse(b.responseText);if(window.active_team_member_table){window.active_team_member_table.update_user_data(a)}else{MemberActionsMenu.update_container_users(".buttons",a)}Notify.success(_("Two-step verification disabled."));return Modal.hide()}})},show_sso_preview_email:function(a){return Modal.show(_("Email preview"),$(a))},show_sso_sample_email:function(a){return Modal.show(_("Sample email"),$(a))},show_user_message_modal:function(c,b,a){var d;DomUtil.fillVal(a,"user-message-email");d=_("Send email to '%(user_name)s'").format({user_name:c});$("user-message").value="";Modal.show(d,$("user-message-modal"),{user_name:c,user_id:b});return Util.focus.defer("user-message")},send_user_message:function(){var b,a;a=Modal.vars.user_id;b=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:a,team_id:Constants.team_id,message:b},onSuccess:function(){var c;c=Modal.vars.user_name;Notify.success(_("Message successfully sent to %(user_name)s.").format({user_name:c}));return Modal.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:Constants.team_id}});$j(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return $j(".pin_notice").hide()},hide_pin_banner_with_user_id:function(a,b){return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:a},onSuccess:function(c){return $j(b).closest("span").removeClass("on").addClass("off")}})},get_pin_with_user_id:function(a,b){return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:a},onSuccess:function(d){var c;c=JSON.parse(d.responseText);$j(b).closest("span").find(".pin-value").text(c.pin+" -");return $j(b).closest("span").removeClass("off").addClass("on")}})},send_team_message:function(b){var a;Event.stop(b);a=$F("team-message").strip();if(a){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:Constants.team_id,message:a},onSuccess:function(c){Notify.success(_("Message successfully sent to team."));return Modal.hide()}})}},show_security_message_modal:function(){return new TwoFactorMessageModal().show()},send_team_security_message:function(c){var b,a;Event.stop(c);a=$F("team-security-message").strip();b=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:b.serialize(true),onSuccess:function(d){Notify.success(_("Message successfully sent."));return Modal.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(a,b){this.used_licenses=a;return this.total_licenses=b},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(a,b){$("migration-url").value=b;Modal.show(_("Migration link for '%(email)s'").format({email:Emstring.em_snippet(a,18)}),$("migrate-url-modal"));return $("migration-url").select()},toggle_account_view:function(a){switch(a){case"new":$("account_info_new").removeClassName("hidden_elem");$("account_info_existing").addClassName("hidden_elem");break;case"existing":$("account_info_new").addClassName("hidden_elem");$("account_info_existing").removeClassName("hidden_elem")}$("account_info_type").value=a;return false},show_end_session_modal:function(b,a,c){TitleBubble.hide_all();$j("#end-session-modal .member-name").text($j("#member-name").text());return Modal.show(_("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:b,user_id:a,elm:c})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:Modal.vars.login_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.success(_("Web session closed."))}})},unlink_device:function(a,d,h,b,i,c,e){var g,f;TitleBubble.hide_all();g=$("unlink-device-modal-"+c);f=_("Unlink %(device_name)s").format({device_name:h});return Modal.show(f,g,{app_id:d,user_id:i,elm:e,device_id:a,display_name:h})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:Modal.vars.app_id,team_id:Constants.team_id,user_id:Modal.vars.user_id,device_id:JSON.stringify(Modal.vars.device_id)},subject_user:Viewer.get_viewer().work_user,onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.success(_("%(device_name)s unlinked.").format({device_name:Modal.vars.display_name}))}})},disable_app:function(b,c,a,d){TitleBubble.hide_all();$j("#disable-app-modal .app-name").text(c);$j("#disable-app-modal .member-name").text($j("#member-name").text());return Modal.show(_("Disable '%(app_name)s'?").format({app_name:c}),$("disable-app-modal"),{app_id:b,user_id:a,elm:d})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:true,team_id:Constants.team_id,user_id:Modal.vars.user_id},subject_user:Viewer.get_viewer().work_user,onSuccess:function(a){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.success(a.responseText)}})},remove_closest_row:function(d){var c,b,a;c=$j(d).closest(".team_admin_table_row");b=$j(c).closest(".team_admin_table");if(b.find(".team_admin_table_row").length===1){a=b.prev(".team_admin_table_title");if(!a.length){a=$j(".team_apps_table_panel")}a.remove();return b.remove()}else{return c.remove()}},submit_report_form:function(a){$j(a.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};BetaEnrollConfirmationModal=(function(b){__extends(a,b);function a(c){this.feature_name=c;this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);a.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}a.prototype.on_confirm_button_click=function(c){$j("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return a})(DBModal);BetaFeedbackModal=(function(b){__extends(a,b);function a(c){this.feature_name=c;this.error=__bind(this.error,this);this.success=__bind(this.success,this);a.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(d){return function(i){var h,g,f;i.preventDefault();h=$j(i.target);g=h.closest("form");f={feature_name:d.feature_name};return Forms.ajax_submit(g[0],false,d.success,d.error,h[0],f)}})(this)}a.prototype.success=function(c){Notify.success(_("Thank you for your feedback."));return this.$modal_window.hide()};a.prototype.error=function(c){if(c.status!==200){return Notify.error(_("Failed to submit feedback. Please try again."))}};return a})(DBModal);DemoSignupModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(h){var p,m,i,c,k,f,o,n,d,l,j,g;h.preventDefault();j=$("demo-signup-form");n=$("1210");f=$j(j).find("input[name='first_name']").val();$j(n).find("input[name='FirstName']").attr("value",f);o=$j(j).find("input[name='last_name']").val();$j(n).find("input[name='LastName']").attr("value",o);k=$j(j).find("input[name='email']").val();$j(n).find("input[name='Email']").attr("value",k);l=$j(j).find("input[name='phone_number']").val();$j(n).find("input[name='Phone']").attr("value",l);p=$j(j).find("input[name='company_name']").val();$j(n).find("input[name='Company']").attr("value",p);i=$j(j).find("select[name='company_size']");m=i.find("option:selected").val();$j(n).find("input[name='Company_size__c']").attr("value",m);c=$(this.$modal_window.find(".confirm-button")[0]);g=(function(e){return function(q){e.$modal_window.hide();return n.submit()}})(this);d=Forms.collect_form_vars(j,true);return Forms.ajax_submit(j,false,g,false,c,d,true)};b.prototype.on_show=function(c){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return SickInput.init()};return b})(DBModal);AccountTransferBaseModal=(function(b){__extends(a,b);function a(c,e,d){this.file_action_selector=e;this.transfer_choice_selector=d;this._clearInput=__bind(this._clearInput,this);this._markInputInvalid=__bind(this._markInputInvalid,this);this._markInputValid=__bind(this._markInputValid,this);this._tokenRemove=__bind(this._tokenRemove,this);this._tokenAdd=__bind(this._tokenAdd,this);this._selectChange=__bind(this._selectChange,this);this._isTransferSelected=__bind(this._isTransferSelected,this);this.handleAjaxFailure=__bind(this.handleAjaxFailure,this);a.__super__.constructor.call(this,c,this.file_action_selector,this.transfer_choice_selector)}a.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(Viewer.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(c){return function(d){return d.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(c.email?[c.email.toLowerCase()]:[])}})(this)});this.tokenAdd=$j.proxy(this._tokenAdd,this);this.tokenRemove=$j.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=$j.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};a.prototype.handleAjaxFailure=function(c){if(c.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};a.prototype._isTransferSelected=function(){return $j(this.transfer_choice_selector).prop("checked")};a.prototype._selectChange=function(c){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};a.prototype._tokenAdd=function(c){this.$collab_input.hide();if(c.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};a.prototype._tokenRemove=function(c){this.$collab_input.show();return this._clearInput()};a.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};a.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};a.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return a})(DBModal);TwoFactorMessageModal=(function(b){__extends(a,b);function a(){a.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}a.prototype.on_confirm_button_click=function(c){Team.send_team_security_message(c);return this.hide()};return a})(DBModal);DfeRemoveUserModal=(function(a){__extends(b,a);function b(c){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.success_callback=__bind(this.success_callback,this);this.on_show=__bind(this.on_show,this);b.__super__.constructor.call(this,c,"input[name=transfer_files]","#transfer_files_on")}b.prototype.on_show=function(c){var d;b.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){d=_("Uninvite %(user_name)s").format({user_name:this.user_name})}else{d=_("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(d);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();return this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}};b.prototype.success_callback=function(e){var d,f,c;d=JSON.parse(e.responseText);if((f=window.active_team_member_table)!=null){f.remove_user(this.user_id)}if((c=window.removed_team_member_table)!=null){c.add_users(d)}if(this.invited){Notify.success(_("User uninvited."))}else{Notify.success(_("User removed."))}Team.decrement_used_licenses();return this.hide()};b.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();d=this.$modal_window.find(".dfe-remove-user-modal")[0];c=$(this.$modal_window.find(".confirm-button")[0]);return Forms.ajax_submit(d,false,this.success_callback,this.handleAjaxFailure,c)};return b})(AccountTransferBaseModal);ManageFilesModal=(function(b){__extends(a,b);function a(d,e,c){this.source_user_id=d;this.source_user_name=e;this.options=c;this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);a.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}a.prototype.get_form=function(){return this.$modal_window.find("form")[0]};a.prototype.on_show=function(){var c;a.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);c=_("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(c);return this.get_form().on("submit",this.on_confirm_button_click)};a.prototype.on_confirm_button_click=function(f){var c,d,g;f.preventDefault();d=this.get_form();c=$(this.$modal_window.find(".confirm-button")[0]);g=(function(e){return function(i){var h;h=JSON.parse(i.responseText);if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(h)}else{MemberActionsMenu.update_container_users(".buttons",h)}if($j("#move-files").prop("checked")){Notify.success(_("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{Notify.success(_("Permanently deleted files"))}return e.$modal_window.hide()}})(this);return Forms.ajax_submit(d,false,g,this.handleAjaxFailure,c)};return a})(AccountTransferBaseModal);show_manage_files_modal=function(a,b){var c;c=new ManageFilesModal(a,b,{element_id:"manage-files-modal",focus:".new-collab-input"});return c.show()};var NOTCLIENTS,NOTCLIENT_DEBUG,add_notclient,new_notclient,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1},__slice=[].slice;NOTCLIENTS={};NOTCLIENT_DEBUG=false;add_notclient=function(a,c,b){new_notclient(a);return setTimeout((function(){return NOTCLIENTS[a].init(c,b)}),2000)};new_notclient=function(s){var G,I,j,l,i,t,q,B,c,n,a,e,m,L,d,M,g,x,r,f,z,k,p,H,w,N,F,o,E,b,y,D,h,u,K,C,v,J,A;assert(__indexOf.call(NOTCLIENTS,s)<0,"cannot create more than one notclient per user");r=function(O){return $u.isNumber(O)&&O%1===0&&O>0};x=function(O){return $u.isNumber(O)&&O%1===0&&O>=0};assert(r(s),"user_id must be a positive integer");f=function(){var O;O=1<=arguments.length?__slice.call(arguments,0):[];if(NOTCLIENT_DEBUG){return console.log.apply(console,O)}};G=90000;l=8096;t="user";i="list";d=false;I=1000;j=5*60*1000;N=0;u=function(){var O;if(e===0){O=0}else{O=Math.min(I*Math.pow(2,e-1),j)}return Math.max(O,N)};H=null;F={};L={};p=1;M=false;g=false;J=null;B=false;C=[];h=null;a=null;z=null;k={};o=false;e=0;K=0;v=function(S,Q){var P,O,R;R=[];for(P in Q){O=Q[P];P=parseInt(P,10);assert(r(P),"ns_ids must be positive integers: "+P);assert(x(O),"sjids must be nonnegative integers: "+O);if(S[P]!=null){R.push(S[P]=Math.min(S[P],O))}else{R.push(S[P]=O)}}return R};c=function(){var Q,P,R,O;assert((H!=null)&&!$u.isEmpty(F),"expected nid and ns_map");R={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};Q=$u.pluck($u.values(L),"type");if(__indexOf.call(Q,t)>=0){R.user_id=s;R.nid=H!=null?H.replace(/^0+(.)/,"$1"):void 0}if(__indexOf.call(Q,i)>=0){R.ns_map=((function(){var S;S=[];for(P in F){O=F[P];S.push(""+P+"_"+O)}return S})()).join(",")}if(URI.parse(Constants.SUBSCRIBE_URL).updateQuery(R).toString().length>l){delete R.ns_map}return R};n=function(){var O;if(!d){return}O=u();if(O>0){return a=window.setTimeout(A,O)}else{return A()}};A=function(){var O;assert(!M&&!g,"connect: invalid state");assert(H>=0||!$u.isEmpty(F),"notclient: called connect with nothing to subscribe to");f("###########################");O=c();if((O.nid==null)&&!O.ns_map){f("nothing to subscribe to. skipping notserver connection.");return}f("connecting to notserver...");M=true;K+=1;return J=$j.ajax(Constants.SUBSCRIBE_URL,{data:O,dataType:"json",noDropboxDefaults:true,error:function(){if(B){B=false;return}e+=1;f("error connecting to notserver. bad rounds="+e+".");M=false;return n()},success:function(P){f("notserver connection closed. response:",P);M=false;if(P.chillout!=null){N=parseInt(P.chillout,10)*1000;f("notserver told us to chill for "+N+"ms")}else{if(N>0){f("setting notserver chillout back to 0ms");N=0}}if(P.ret==="punt"){return n()}else{assert(P.ret==="new","unknown notserver ret: "+P.ret);assert("refresh" in P,"expected notserver ret:new to have refresh keyword");return D(P.refresh)}}})};q=function(){if(J!=null){B=true;J.abort();return J=null}};E=function(){N=0;M=false;g=false;q();C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return n()};y=function(){var O;d=false;N=0;H=null;F={};L={};O=0;p=1;M=false;g=false;J=null;B=false;C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return K=0};D=function(U){var X,S,O,P,V,Q,W,R;assert(!g&&!M,"run_handlers: invalid state");assert(z===null,"run_handlers: new_nid must start at null");assert($u.isEqual(k,{}),"run_handlers: new_ns_map must start at {}");assert(!o,"expected one_or_more_handler_failures=false");g=true;f("running handlers...");P=$u.filter($u.values(L),function(Z){var Y;return Y=Z.type,__indexOf.call(U,Y)>=0});assert(!$u.isEmpty(P),"notserver sent a ping for unsubscribed activity");C=$u.pluck(P,"handler_id");for(Q=0,W=P.length;Q<W;Q++){R=P[Q],X=R.handler,S=R.handler_id,O=R.name,V=R.type;f("running id="+S+", name="+O+", type="+V);X()}if($u.isEmpty(C)){return f("all handlers already finished running. no need for a slacker timeout.")}else{f("all handlers running. slacker timeout set.");return h=window.setTimeout(b,G)}};b=function(){var Q,R,P,O;assert(g&&!M,"called report_slackers in an invalid state.");assert(!$u.isEmpty(C,"report_slackers called w/ nothing slackin'"));f("found some slackers");o=true;O=[];for(R=0,P=C.length;R<P;R++){Q=C[R];O.push(m(Q))}return O};m=function(O){if(__indexOf.call(C,O)<0){return}f("done handling: "+O);C=$u.without(C,O);if($u.isEmpty(C)){f("all handlers are done running.");g=false;window.clearTimeout(h);if(z!=null){f("new nid: "+z);H=z}if(!$u.isEmpty(k)){f("new ns_map:",k);F=k}if(o){e+=1;f("one or more handler errors. bad_rounds="+e)}else{e=0}z=null;k={};o=false;return n()}};w={get_user_id:function(){return s},get_nid:function(){return H},get_ns_map:function(){return $u.clone(F)},get_consecutive_bad_rounds:function(){return e},get_total_rounds:function(){return K},get_notserver_chillout_ms:function(){return N},get_sleep_ms:u,subscribe_user:function(W){var P,Q,V,U,S,O,R;assert(!g,"adding new handlers from inside handlers is not currently supported");R=["name","handler"];for(S=0,O=R.length;S<O;S++){U=R[S];assert(W[U],"subscribe_user requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding user handler "+W.name);Q=$u.pluck($u.values(L),"type");V=__indexOf.call(Q,t)<0;P=p++;L[P]={handler_id:P,handler:W.handler,name:W.name,type:t};if(V){f("first user handler added, reconnecting");E()}return P},subscribe_sfj:function(W){var P,Q,V,U,S,O,R;assert(!g,"adding new handlers from inside handlers is not currently supported");R=["name","handler"];for(S=0,O=R.length;S<O;S++){U=R[S];assert(W[U],"subscribe_sfj requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding sfj handler "+W.name);Q=$u.pluck($u.values(L),"type");V=__indexOf.call(Q,i)<0;P=p++;L[P]={handler_id:P,handler:W.handler,name:W.name,type:i};if(V){f("first sfj handler added, reconnecting");E()}return P},handler_success:function(O,Q){var P;if(__indexOf.call(C,O)<0){return}P=L[O].type;if(P===i){assert("ns_map" in Q,"ns_map required param is missing");assert(!("nid" in Q),"nid is disallowed from SFJ handlers");v(k,Q.ns_map)}else{assert(P===t,"unknown handler type: "+P);assert("nid" in Q,"nid required param is missing");assert(!("ns_map" in Q),"ns_map is disallowed from user handlers");if((z==null)||Q.nid<z){z=Q.nid}}return m(O)},handler_failure:function(O){f("handler failed. handler_id="+O);if(__indexOf.call(C,O)<0){return}o=true;return m(O)},handle_visibility_change:function(){if(window.document.hidden){return q()}else{return E()}},init:function(P,O){assert(!d,"error: init() has been called twice.");H=P;v(F,O);d=true;if(window.document.visibilityState!=null){window.document.on("visibilitychange",this.handle_visibility_change);if(!window.document.hidden){return n()}}else{return n()}},reset:y,abort:q,reconnect:E};NOTCLIENTS[s]=w;return w};var UpdateEvents;UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var FileTypes;FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5};var BrowseUtil;BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(b,c){var a;if(c==null){c=null}a=Object.clone(b);if(a.is_dir){a.ago="";a.ts=0}else{a.target_ns=false}a.sort_key=Util.decode_sort_key(a.sort_key);a.request_id=c!=null?c:null;return new BrowseFile(a)},filepreview_from_selected:function(c,b,r,p){var d,l,n,k,m,o,e,h,g,a,f,q,j;if(p==null){p=false}if(b&&(b.bytes<0||b.preview_type==="download")){window.open(b.href,"_blank");return}a=DBHistory.get_url();m=a.indexOf("/lightbox")===0;n=a.indexOf("/sh/")===0;l=a.indexOf("/s/")===0;if((c==="callback")&&m&&Lightbox.shown){return}else{if(c==="fileclick"&&b&&((j=b.preview_type)!=="photo"&&j!=="video")){FileViewer.show(b,Browse.active_user,true);return}}if(!b){h=BrowseSelection.get_selected_files();b=h&&h.first()}e=p?[b]:Browse.files;o=this.browsefile_to_filepreview(e);if(o.length){g=0;if(b){for(k=f=0,q=o.length;f<q;k=++f){d=o[k];if(d.fq_path===b.fq_path){g=k;break}}}if(n){BrowseSharedLink.close_shared_link_view()}return Lightbox.init(o,{start_index:g,include_delete:true,keep_url:l,is_loading:r,share_button_experiment_variant:Browse.lightbox_share_button_experiment_variant})}},browsefile_to_filepreview:function(g){var i,b,d,a,e,h,c;a=[];for(h=0,c=g.length;h<c;h++){i=g[h];if(i.bytes<0||i.dir){continue}if(i.preview_type==="photo"&&i.large_thumbnail_url_tmpl){b="null-"+i.filename;d=new PhotoPreview({filename:i.filename,fq_path:i.fq_path,thumbnail_url_tmpl:i.large_thumbnail_url_tmpl,dl_url:URI.parse(i.href).updateQuery({dl:1}).toString(),original_url:i.href,link_hash:b,ns_id:i.ns_id,ns_path:i.ns_path,activity_key:i.activity_key,owner_id:i.user_id});a.push(d)}else{if(i.preview_type==="video"&&i.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){e=new VideoPreview({filename:i.filename,fq_path:i.fq_path,thumbnail_url_tmpl:i.large_thumbnail_url_tmpl,preview_url:i.video_transcode_url(),dl_url:URI.parse(i.href).updateQuery({dl:1}).toString(),ns_id:i.ns_id,ns_path:i.ns_path,activity_key:i.activity_key,owner_id:i.user_id});a.push(e)}}}return a},profile_files:function(b){var c,d,e,a;d={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(e=0,a=b.length;e<a;e++){c=b[e];if(c.dir){d.folders+=1}else{d.files+=1}if(c.is_sandbox()){d.sandboxes+=1}if(c.is_shared_folder()){d.shared_folders+=1}if(c.bytes===-1){d.deleted+=1}if(c.target_ns){d.target_namespaces+=1}if(c.fq_path.toLowerCase()==="/public"&&Browse.public_folder_enabled){d.public_folder=1}if(c.root_coll_item_counter>=0){d.in_root_coll+=1}}return d},profile_summary:function(b){var c,a;c=ungettext("%d file","%d files",b.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(b.files);a=ungettext("%d folder","%d folders",b.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(b.folders);if(b.files&&b.folders){return _("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:c,y_folders:a})}else{if(b.files){return c}else{if(b.folders){return a}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var h,f,c,b,g,e,a,d;h=$j("#browse");c=h.find("#browse-root-actions");b=h.find("#browse-sort");f=h.find("#browse-header-status");d=this.SPECIAL_MODES;for(e=0,a=d.length;e<a;e++){g=d[e];h.removeClass(g);c.removeClass(g);b.removeClass(g);f.removeClass(g)}if(FileSearch.fulltext_search_enabled){FileSearch.reset_fulltext_search(true);h.removeClass("fulltext_search");c.removeClass("fulltext_search");b.removeClass("fulltext_search");f.removeClass("fulltext_search");$j("#fulltext-search-loading").hide();return $j("#fulltext-search-all-link").hide()}},set_special_mode:function(g){var b,c,i,a,f,d,h,e;b=$j("#browse");i=b.find("#browse-root-actions");a=b.find("#browse-sort");c=b.find("#browse-header-status");assert(this.SPECIAL_MODES.indexOf(g)!==-1,"unknown mode");if(b.hasClass(g)){assert(i.hasClass(g),"inconsistent modes");assert(a.hasClass(g),"inconsistent modes");return}e=this.SPECIAL_MODES;for(d=0,h=e.length;d<h;d++){f=e[d];if(f!==g){b.removeClass(f);i.removeClass(f);a.removeClass(f);c.removeClass(f)}}b.addClass(g);i.addClass(g);a.addClass(g);c.addClass(g);if(g===this.SEARCH_MODE){if(FileSearch.fulltext_search_enabled){b.addClass("fulltext_search");i.addClass("fulltext_search");a.addClass("fulltext_search");return c.addClass("fulltext_search")}}},get_mode:function(){var e,a,d,b,c;a=this.BROWSE_MODE;c=this.SPECIAL_MODES;for(d=0,b=c.length;d<b;d++){e=c[d];if($j("#browse").hasClass(e)){a=e}}return a},load_visible_thumbs:function(){var m,p,d,l,q,r,n,c,h,b,g,f,o,a,k,e;c=this.get_files_in_view();p=c[1]-c[0];n=[Math.max(c[0]-p,0),c[0]];r=[Math.min(c[1],Browse.files.length),Math.min(c[1]+p,Browse.files.length)];m=[];k=[c,r,n];for(g=0,o=k.length;g<o;g++){q=k[g];l=q[0],h=q[1];e=Browse.files.slice(l,+h+1||9000000000);for(f=0,a=e.length;f<a;f++){d=e[f];if(d.get_div()){m.push(d.get_div().down("img"))}}}b=function(i){if(!i.src.endsWith(Sprite.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return LegacyBatchThumbLoader.batch_load_thumbs(m,this.THUMBS_BATCH_SIZE,b)},get_files_in_view:function(){var c,d,b,a,f,e;f=dom.viewport_dimensions().height;e=dom.scroll_offsets().top;c=this._get_top_file_y_offset();d=this._get_elm_height();if(!c||!d){return[0,Browse.files.length]}b=Math.floor((e-c)/d);b=Math.max(b,0);a=b+Math.ceil(f/d);a=Math.min(a,Browse.files.length);return[b,a]},_get_top_file_y_offset:function(){if(Browse.files.length>0&&Browse.files[0].get_div()){return Browse.files[0].get_div().cumulativeOffset().top}else{return null}},_get_elm_height:function(){var a;if(Browse.files.length>=3&&Browse.files[1].get_div()){a=Browse.files[1].get_div();return a.getLayout().get("margin-box-height")}else{return null}},append_ellipsis:function(a){return _("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:a})},_show_blue_sharing_icons:function(){return Browse.sharing_icons_experiment_variant&&Browse.sharing_icons_experiment_variant==="BLUE_ICONS"},get_shared_folder_icon:function(){if(this._show_blue_sharing_icons()){return"s-folder-blue"}else{return"rainbow_16"}},get_shared_link_icon:function(){if(this._show_blue_sharing_icons()){return"s-link-blue"}else{return"s_link"}}};var Sort;Sort=(function(){var g,a,d,f,e,c,b;d=function(i){var h;h=i?1:-1;return function(j,k){return h*Util.sort_by_rank_or_key(j,k)}};f=function(i){var h;h=i?1:-1;return function(j,k){if(j.bytes>k.bytes){return h}else{if(j.bytes<k.bytes){return -h}else{return h*Sort.FILES_BY_NAME(j,k)}}}};g=function(i){var h;h=i?1:-1;return function(j,k){return h*(j.fq_path.toLowerCase()>k.fq_path.toLowerCase()?1:-1)}};a=function(i){var h;h=i?1:-1;return function(k,l){var j;j=k.ts===l.ts?0:k.ts>l.ts?1:-1;return h*j}};c=function(h){return function(k){var j,i;i=h(k);j=d(true);return function(l,m){if(l.dir^m.dir){return(l.dir?1:0)-(m.dir?1:0)}else{return i(l,m)||j(l,m)}}}};e=function(h){return function(k){var i,j;if(!Sort.FOLDERS_FIRST){return h(k)}j=h(k);i=k?1:-1;return function(m,n){var l;if(m.dir^n.dir){l=(m.dir?0:1)-(n.dir?0:1);return i*l}else{return j(m,n)}}}};b=function(h){return function(k){var i,j;j=Sort.FILES_BY_NAME(k);i=k?1:-1;return function(m,n){var l;if(m.is_deleted^n.is_deleted){return(m.is_deleted?1:0)-(n.is_deleted?1:0)}l=0;if(h){if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}}}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}else{if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}}}return(i*l)||j(m,n)}}};return{FILES_BY_NAME:e(d),FILES_BY_SIZE:c(f),FILES_BY_LOCATION:c(g),FILES_BY_KIND:c(b(true)),FILES_BY_EXTENSION:c(b(false)),FILES_BY_MODIFIED:c(a),FOLDERS_FIRST:!Util.is_mac(),ALL_BY_MODIFIED:a}})();var FlexColumn;FlexColumn=(function(){var i,c,l,g,d,h,b,a,k,e,j,f;i=[["FILES_BY_KIND",Sort.FILES_BY_KIND,_("Kind"),true],["FILES_BY_EXTENSION",Sort.FILES_BY_EXTENSION,_("Extension"),true],["FILES_BY_SIZE",Sort.FILES_BY_SIZE,_("Size"),false]];c={};l={};d=[];g=[];for(e=0,j=i.length;e<j;e++){f=i[e],k=f[0],b=f[1],h=f[2],a=f[3];d.push(b);c[k]=h;l[k]=a;g.push(k)}return{SORT_FUNCTIONS:d,DISPLAY:c,IS_ASC:l,LABELS:g}})();var FileSearch,SearchType;SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},init:function(j){var b,k,i,c,g,f,l,a,h,e,d;this.fulltext_search_enabled=j;if(this.fulltext_search_enabled){return}i=$("browse-search");k=$("browse-search-input");'if @fulltext_search_enabled\n  # Full-text search does not support yet partial words search.\n  # So we do not search as characters are typed but only when "Enter" is pressed.\n  input.observe "keypress", (e) =>\n    if e.keyCode == Event.KEY_RETURN\n      @search()\n      false\n  # Full-text search does not yet support advanced search.\n  # So we hide the advanced search link.\n  $("advanced-search-link").hide()';SickInput.add_interval_handler(i,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(m){return function(n){m.search();return Event.stop(n)}})(this));$("exit-search-xclose").observe("click",(function(m){return function(){return m.exit_search()}})(this));key("/",Browse.KEY_SCOPE,(function(m){return function(){if(BrowseJump.is_active()){return}if(!i.hasClassName("focused")){k.focus();return false}}})(this));key("escape",Browse.KEY_SCOPE,(function(m){return function(){if(Browse.in_search_mode()){m.exit_search();return false}if(k.getValue().strip()===""){k.blur();return false}}})(this));key("tab",Browse.KEY_SCOPE,(function(m){return function(n){if(document.activeElement===k){n.preventDefault();k.blur();if(Browse.files.length){BrowseSelection.set_selected_files(Browse.files[0])}else{if(Browse.in_search_mode()){m.toggle_advanced()}}return false}}})(this));c="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",c,this.toggle_advanced.bind(this));document.observe(FileEvents.RENAME,(function(m){return function(){return m.clear_cache()}})(this));h=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE];for(g=0,l=h.length;g<l;g++){b=h[g];document.observe(b,(function(m){return function(n){if(!Browse.inside_dir){return m.force_reload()}}})(this))}e=[UpdateEvents.ADD,UpdateEvents.MOVE,UpdateEvents.REMOVE];d=[];for(f=0,a=e.length;f<a;f++){b=e[f];d.push(document.observe(b,(function(m){return function(n){return m._update_number_results(Browse.files.length)}})(this)))}return d},get_state:function(){var g,c,f,b,e,a,d;g=$j("#browse-search");if(this.fulltext_search_enabled){f={is_advanced:false}}else{f={is_advanced:g.length&&!g.visible()}}if(f.is_advanced){d=["all_terms","any_terms","excluded_terms","exact"];for(e=0,a=d.length;e<a;e++){c=d[e];b=$j("#"+c).val();if(b){f[c]=b}}f.include_files=$j("#include_files").prop("checked");f.include_folders=$j("#include_folders").prop("checked");f.include_deleted=!Constants.can_see_trash&&$j("#include_deleted").prop("checked")}else{f.query_unnormalized=this.get_basic_query();f.query=f.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.fulltext_search_enabled){f.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return f},set_state:function(e){var b,d,a,c;if(e.is_advanced){c=["all_terms","any_terms","excluded_terms","exact"];for(d=0,a=c.length;d<a;d++){b=c[d];if(e[b]){$(b).setValue(e[b])}}$j("#include_files").prop("checked",e.include_files);$j("#include_folders").prop("checked",e.include_folders);if(!Constants.can_see_trash){$j("#include_deleted").prop("checked",e.include_deleted)}this.show_advanced();return this.search()}else{if(this.fulltext_search_enabled){this.last_fq_path=e.last_fq_path!=null?e.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";Browse.inside_dir=this.scoped_search}this.set_basic_query(e.query_unnormalized);this.show_basic();if(this.fulltext_search_enabled){return this.do_search(this.scoped_search,true)}else{return this.search()}}},state_changed:function(){var b,a;b=this.get_state();a=this.last_state;if(this.fulltext_search_enabled){if(a===false){return !!b.query}return(b.is_advanced!==a.is_advanced)||(b.query!==a.query)||(b.last_fq_path!==a.last_fq_path)}else{if(a===false){return !!b.query}return(b.is_advanced!==a.is_advanced)||(b.query!==a.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(a){if(a===this.get_basic_query()){return}this._get_browse_search_input().val(a);if(!this.fulltext_search_enabled){$("browse-search").show()}return $("advanced-search-link").__date(_("Advanced search"))},set_title:function(){var a,b;a=this.get_state();b=_("Search - Dropbox");if(a.query_unnormalized){b=""+a.query_unnormalized+" - "+b}return document.title=b},_pending_search_q:"",search_with_delay:function(){var b,c,a;c=this.search.bind(this);a=this.get_state();if(a.is_advanced){return}b=a.query;if(b.length===0&&Browse.in_search_mode()){c();return}if(b.length<=this.SHORT_PREFIX_LEN){if(b!==this._pending_search_q){this._pending_search_q=b;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(c,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return c()}}},_set_scope_path_to_browse_location:function(){if(Browse.inside_dir){return this.last_fq_path=Browse.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(c,b){var e,d,a;if(b==null){b=false}a=!b&&!Browse.in_search_mode();if(this.fulltext_search_enabled&&a){this._set_scope_path_to_browse_location()}d=this.get_state();e=""===this.get_basic_query();if(!d.is_advanced&&e){if(Browse.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=d;this._clear_on_reload=true;if(!(Browse.in_search_mode()&&!this.fulltext_search_enabled)){BrowseSelection.deselect_all();Browse.clear();BrowseUtil.set_special_mode("search");if(!this.fulltext_search_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!b){if(this.fulltext_search_enabled){DBHistory.push_state("/search",this.last_state)}else{DBHistory.push_state("/search")}}}this._prune_cache();this.set_title();if(d.is_advanced){this.ask_server_advanced()}else{if(this.fulltext_search_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();$j("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",c,0,this.MAX_RESULTS,false)}else{if(d.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return T("search")},search:function(a){if(a==null){a=false}if(a!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&a;if(this.fulltext_search_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var a;if(this.fulltext_search_enabled&&!this.end_of_results){a=this.search_pos;if(this.end_of_active_results){a=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,a,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var c,d,f,e,b,a;c=new Date();d=[];for(f in this._cache_ts){if(c-this._cache_ts[f]>this.CACHE_TIME){d.push(f)}}a=[];for(e=0,b=d.length;e<b;e++){f=d[e];delete this._cache[f];a.push(delete this._cache_ts[f])}return a},update_empty:function(){var a;a=_("No results found");if(this.scoped_search&&this.fulltext_search_enabled){a=_("No results found in '%(path)s'").format({path:FilePath.filename(this.last_fq_path)})}$j("#noresults-header").text(a);$j("#fulltext-search-all-link").hide();$j("#noresults-directions").toggle(!(this.scoped_search&&this.fulltext_search_enabled));return $j("#noresults-search-all-link").toggle(this.scoped_search&&this.fulltext_search_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(a){BrowseSelection.deselect_all();Browse.clear();Browse.reset_state();Browse.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=a;return $j("#fulltext-search-all-link").hide()},exit_search:function(){var b,d,a,c;if(Browse.in_search_mode()&&this.fulltext_search_enabled){Browse.deleted_shown=false}c=$$("#advanced-search-box .sick-input input");for(d=0,a=c.length;d<a;d++){b=c[d];b.setValue("");b.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();Browse.first_load=true;return Browse.reload_fqpath(this.last_fq_path,true)},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(b,g,d,e,f,a,c){if(b==null){b=null}if(g==null){g=null}if(d==null){d=null}if(e==null){e=null}if(f==null){f=null}if(a==null){a=null}if(c==null){c=null}"log_values = dictionary to add values to\nrequest_id = server generated ajax request_id\nstart_time = time the query was sent from the client endpoint\nstate = search state\nresult_count = number of returned results\nstatus = http status, only used for logging request failures\nfirst_file = the first file returned in the search result";if(b==null){return}if(g!=null){b.request_id=g}if(d!=null){b.latency=(new Date().getTime())-d}if(e!=null){b.query_string=e.query;if((a==null)||a===200){b.displayed=this.last_state.query===e.query?true:false}}if(f!=null){b.result_count=f}if((a!=null)&&a!==200){b.failure_type=a}if(c!=null){b.file_nsid=c.ns_id;b.file_sjid=c.sjid}return b},ask_server:function(b,g,c,h,e){var f,k,i,d,j,a;a=this.get_state();j=null;if(this.fulltext_search_enabled){d=new Date();if(e){j=SearchType.DELETED}else{if(g){j=SearchType.COMPLETION}else{j=SearchType.FULLTEXT}}}f={firefly:this.fulltext_search_enabled,infinite_scroll:c>0?true:false,path_scoped:false,search_type:j,query_string:a.query};analytics.SearchClientActivityLogger.log("query_started",Browse.active_user.id,f);assert(!a.is_advanced,"expected to be in basic search mode");if(!c){$j("#web-search-results").html(_("Searching..."))}$j("#browse").addClass("pending-search");k={query:a.query};if(this.fulltext_search_enabled){if(c){k.start=c}if(h){k.max_results=h}if(e){k.deleted=e}if(this.scoped_search){k.fq_path=this.last_fq_path}if(!g){this.last_fulltext_query=a.query}}if(g){k.filename_only=true}i=false;return new Ajax.DBRequest(b,{no_watch:true,evalJSON:false,parameters:k,log_timing:true,onSuccess:(function(l){return function(n){var o,m,q,p;if(!Browse.in_search_mode()){return}q=n.request.parameters.parent_request_id;o=JSON.parse(n.responseText);p=o.file_info.length;if(l.fulltext_search_enabled){if(a.query===l.last_fulltext_query&&d>=l.last_new_search_ts){l.search_pos=l.search_pos+p;if(l.end_of_active_results){l.deleted_search_pos=l.deleted_search_pos+p}if(p<l.MAX_RESULTS){l.end_of_results=true&&l.end_of_active_results;l.end_of_active_results=true;if(!l.end_of_results){i=true}else{$j("#fulltext-search-loading").hide()}}l.update_results(o,i,q)}}else{l._cache[a.query]=o;l._cache_ts[a.query]=new Date();if(!l.last_state.is_advanced&&(l.last_state.query===a.query)){l.update_results(null,false,q)}}if(o.file_info.length>0){m=o.file_info[0]}else{m=null}f=l.create_completion_log_dict(f,q,n.request.start_time,a,p,null,m);return analytics.SearchClientActivityLogger.log("query_completed",Browse.active_user.id,f)}})(this),onFailure:(function(l){return function(m){f=l.create_completion_log_dict(f,m.request.parameters.parent_request_id,m.request.start_time,a,null,m.status);return analytics.SearchClientActivityLogger.log("query_failed",Browse.active_user.id,f)}})(this),cleanUp:(function(l){return function(){if(i){return l.load_more_results()}else{return $j("#browse").removeClass("pending-search")}}})(this),subject_user:Browse.active_user})},ask_server_advanced:function(){var a,b;b=this.get_state();a={firefly:this.fulltext_search_enabled,query_string:b.query};analytics.SearchClientActivityLogger.log("query_started",Browse.active_user.id,a);assert(b.is_advanced,"expected to be in advanced search mode");assert(!b.query,"expected advanced search params only");delete b.is_advanced;$("web-search-results").__date(_("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:b,log_timing:true,onSuccess:(function(c){return function(e){var d,f;if(!Browse.in_search_mode()){return}f=e.request.parameters.parent_request_id;c.advanced_results=JSON.parse(e.responseText);c.update_results(null,false,f);if(c.advanced_results.file_info.length>0){d=c.advanced_results.file_info[0]}else{d=null}a=c.create_completion_log_dict(a,e.request.parameters.parent_request_id,e.request.start_time,b,c.advanced_results.file_info.length,null,d);return analytics.SearchClientActivityLogger.log("query_completed",Browse.active_user.id,a)}})(this),onFailure:(function(c){return function(d){a=c.create_completion_log_dict(a,d.request.parameters.parent_request_id,d.request.start_time,b,null,d.status);return analytics.SearchClientActivityLogger.log("query_failed",Browse.active_user.id,a)}})(this),cleanUp:(function(c){return function(d){return $("browse").removeClassName("pending-search")}})(this),subject_user:Browse.active_user})},attempt_cache_filter:function(){var a,d,b,h,c,g,f,e;g=this.get_state().query;h=this._query_to_regex(g);b=function(i){return h.match(FilePath.filename(i.ns_path).toLowerCase())};if(g.length<=1){return false}for(c=f=e=g.length-1;e<=1?f<=1:f>=1;c=e<=1?++f:--f){d=g.substr(0,c).strip();if(d in this._cache){if(this._cache[d].file_info.length<this.MAX_RESULTS){a=Object.clone(this._cache[d]);a.file_info=a.file_info.findAll(b);this.update_results(a);return true}else{return false}}}return false},_query_to_regex:function(a){return new RegExp(RegExp.escape(a).split(new RegExp(" +")).join(".*"))},update_results:function(b,a,f){var e,d,c;if(a==null){a=false}if(f==null){f=null}if(!this.fulltext_search_enabled){Browse.reset_state();Browse.reset_sort()}c=this.get_state();if(!b&&c.is_advanced){b=this.advanced_results}if(!b){d="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";assert(this.last_state&&!this.last_state.is_advanced,d);assert(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(b=this._cache[this.last_state.query]))}Browse.update(b,f);Browse.set_selection_from_fq_paths_or_index(FileSearch);e=c.is_advanced?_("Basic search"):_("Advanced search");$("advanced-search-link").__date(e);if(!a){if(this.fulltext_search_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(Browse.files.length)}if(Browse.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(b){var a,c;if(this.fulltext_search_enabled){if(b===0){a=""}else{if(this.end_of_results){a=ungettext("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",b).format({num_results:b})}else{a=ungettext("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",b).format({num_results:b})}}}else{if(b===0){a=_("No Results")}else{if(b>=this.MAX_RESULTS){b=b+"+"}a=ungettext("%(num_results)s result","%(num_results)s results",b).format({num_results:b})}}c=_("Search")+" - "+a;if(this.fulltext_search_enabled){Browse.update_header_status(a);c=_("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){c=_("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:FilePath.filename(this.last_fq_path+"'")})}}$j("#web-search-results").text(c);if(this.fulltext_search_enabled&&this.scoped_search){return $j("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(_("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(a){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(_("Advanced search"));if($("browse-search")){$("browse-search").show();if(!a){return $("browse-search-input").focus()}}},toggle_advanced:function(){var a,b;b=$("advanced-search-link");b.toggleClassName("selected");if(b.hasClassName("selected")){$j("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{a=$j("#all_terms").val();if(a){this.set_basic_query(a);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(a,b){var c;if(this.fulltext_search_enabled&&(b!=null)){this.last_state=b;this.last_state.is_advanced=false}if(!this.last_state){BrowseURL.set_path_url(Constants.root_ns,"");return}if(this.state_changed()){this.set_state(this.last_state)}key.setScope(Browse.KEY_SCOPE);if(BrowseSelection.get_selected_files().length){c=BrowseSelection.get_selected_files()[0].get_div();return Browse.scrollToWithPadding(c,c.getHeight()*2)}},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){if(this.fulltext_search_enabled){return $j("#browse-search-input input")}else{return $j("#browse-search-input")}}};var BrowseKeys;BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var c,a,b;b=this.advanced_dict;for(a in b){c=b[a];key(c.key,Browse.KEY_SCOPE,c.onPress)}this.customize_chart();if(Util.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(d){return function(f){if(f.charCode===63&&!dom.focus_in_input()){return d.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var d,b,c,a;d=(Util.is_mac()?".key-windows":".key-macos");c=0;b=void 0;a=[];while(true){b=$("keys-chart").down(d,c++);if(!b){break}a.push(b.hide())}return a},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var a,b;a=$("keys-chart");a.style.position="fixed";b=$("browse-sort");if(FileSearch.fulltext_search_enabled&&Browse.in_search_mode()){b=$("browse-header-wrapper")}else{if(b.getStyle("display")==="none"){b=$("browse-root-actions")}}$j(a).clonePosition($j(b),{setHeight:false});a.style.top=b.cumulativeOffset()[1]+b.getHeight()+"px";a.setOpacity(0.9);return a.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:_("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(b,c){var a;a=BrowseSelection.get_selected_files();if(a.length){return a.first().edit()}}},"delete":{title:_("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(d,f){var a,c,b;Event.stop(d);if(Browse.inside_read_only_shared_folder){Notify.warning(_("You don't have permission to delete files in this folder."))}b=BrowseSelection.get_selected_files();if(b.length===1){a=b.first();if(a.is_deleted){return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_delete(Browse.active_user,a.fq_path,a.dir)}}else{if(b.length>1){c=BrowseUtil.profile_files(b);if(c.deleted===b.length){return FileOps.show_bulk_purge(b)}else{if(c.deleted===0){return FileOps.show_bulk_delete(Browse.active_user,b)}}}}}},help:{title:_("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return BrowseKeys.toggle_chart()}},close_help:{title:_("Hide keyboard shorcuts"),key:"escape",onPress:function(){return BrowseKeys.hide_chart()}},up_dir:{title:_("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var a,b;Browse.keyboard_nav=true;if(!Browse.reloading){if(Browse.inside_dir){if(!Browse.containing_ns_path()&&Browse.containing_ns_id()!==Constants.root_ns){b=Constants.root_ns;a=FilePath.normalize(FilePath.parent_dir(Browse.containing_fq_path()))}else{b=Browse.containing_ns_id();a=FilePath.normalize(FilePath.parent_dir(Browse.containing_ns_path()))}if(Browse.containing_ns_path()!==a||Browse.containing_ns_id()!==b){Browse.select_fq_paths=[Browse.containing_fq_path()];return BrowseURL.set_path_url(b,a)}else{return BrowseSelection.flicker_selected()}}else{return BrowseSelection.flicker_selected()}}}},open_file:{title:_("Open highlighted file"),key:"enter",onPress:function(){var a,b;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];Browse.open_file(a,false)}return false}},open_dir:{title:_("Open highlighted folder"),key:"right",onPress:function(){var a,b;Browse.keyboard_nav=true;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];if(a.dir){Browse.select_index=0;Browse.open_folder(a)}else{BrowseSelection.flicker_selected()}}return false}},undo:{title:_("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){UndoAction.perform_undo();return false}},search:{title:_("Search"),key:"/",onPress:function(){var a;if(typeof SearchBar!=="undefined"&&SearchBar!==null){if((a=SearchBar.getInstancesWithHolderClass("top-search-bar")[0])!=null){a.focus()}}return false}}}};var BrowseSharedLink;BrowseSharedLink={store_shared_link_info:function(c,a,b){if(c.charAt(0)==="/"){c=c.substring(1)}this._shared_link_fq_dir=c;this._shared_link_file=b;return this._shared_link_url=a},shared_link_handler:function(a,b){if(BrowseSharedLink._shared_link_url==="/s/"+a){BrowseURL.load_browse_view(void 0,encodeURIComponent(BrowseSharedLink._shared_link_fq_dir));return Browse.open_preview(BrowseSharedLink._shared_link_file)}else{if(BrowseSharedLink._shared_link_url==="/sh/"+a){BrowseURL.load_browse_view(void 0,encodeURIComponent(BrowseSharedLink._shared_link_fq_dir));if(BrowseSharedLink._shared_link_file){return Browse.open_preview(BrowseSharedLink._shared_link_file)}else{return Lightbox.init([],{include_delete:true,keep_url:true,filename_in_url:true,enable_sublinks:true,share_button_experiment_variant:Browse.lightbox_share_button_experiment_variant})}}else{return location.reload()}}},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return BrowseURL.set_path_url(null,"/"+this._shared_link_fq_dir)}}};var BrowseURL;BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(a){var b;b=DBHistory.deconstruct_url().qargs;if(a in b){return !!b[a]}else{assert(a in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[a]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(a,c){var b;if(a!==Browse.active_user.root_ns&&(!(a in Browse.ns_id_to_mount_point))){a=Browse.active_user.root_ns}if(a===Browse.active_user.root_ns){return c}else{b=Browse.ns_id_to_mount_point[a];return b+c}},_make_url:function(a,f,g){var h,e,b,d,c;if(g==null){g={}}if(!a){a=Browse.active_user.root_ns}assert(typeof a==="number","expected ns_id as a number");assert(typeof f==="string","expected explicit ns_path string");h=this.ns_to_fq_path(a,f);d=URI({path:Util.get_browse_root(Browse.active_user)+h});b=DBHistory.deconstruct_url().qargs;for(e in g){c=g[e];if(e in this._DEFAULTS&&!!c!==this._DEFAULTS[e]){b[e]=c}}for(e in b){if(!(e in this._DEFAULTS)){delete b[e]}}return DBHistory.construct_url(String(d),b)},set_path_url:function(a,f,d){var e,c,b;if(!a){a=Browse.active_user.root_ns}else{c=parseInt(a,10);a=!isNaN(c)?c:Constants.root_ns}f=FilePath.normalize(f);b=d!=null?this._make_url(a,f,{d:d?1:0}):this._make_url(a,f);e=DBHistory.deconstruct_url(b);return DBHistory.push_state(e.path,e.qargs)},set_del_url:function(a){var c,d,b;b=DBHistory.deconstruct_url();c=b.path;d=b.qargs;if(a){d.d="1"}else{delete d.d}return DBHistory.push_state(c,d)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(a,d,b){var e,f,c;if(b==null){b=false}key.setScope(Browse.KEY_SCOPE);d=FilePath.normalize(d);c=false;if(!this._first_load){c=(!Browse.inside_dir)||(d!==this._last_ns_dir)||(a!==this._last_ns_id)||(Browse.in_search_mode()&&FileSearch.fulltext_search_enabled)}e=b!==Browse.deleted_shown;Browse.deleted_shown=b;if(this._first_load||c||e){Browse.reload(a,d,true)}FileSearch.show_basic(true);this._first_load=false;this._last_ns_dir=d;this._last_ns_id=a;if(BrowseSelection.get_selected_files().length){f=BrowseSelection.get_selected_files()[0].get_div();if(f){return Browse.scrollToWithPadding(f,f.getHeight()*2)}}},history_change_handler:function(c,d){var a,b;a=d.ns;b=d.d==="1";this.load_browse_view(a,c,b);if(FileViewer.shown){return FileViewer.hide()}},parse_b2_hash:function(e){var c,b,d,a,f;a=e.split(":");if(a.length!==4){return false}d=a[0];c=a[2]==="1";b=a[3];f=!b||Util.isNumber(b);if(!f){return false}b=parseInt(b,10)||Constants.root_ns;return{ns_id:b,ns_path:d,deleted:c}}};var BrowseFile;BrowseFile=Class.create({initialize:function(c){var e,b,d,a,f;e=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;b=FilePath.filename(c.fq_path);this.icon=c.icon;this.filename=b;this.filename_highlights=(d=c.filename_highlights)!=null?d:[];this.caption=Emstring.em_snippet(b,e);this.ns_id=c.ns_id;this.ns_path=c.ns_path;this.fq_path=c.fq_path;this.hash=c.hash;this.href=c.href;this.size=c.size!=="None"?c.size:"";this.bytes=c.bytes;this.is_deleted=this.bytes===-1;this.ago=c.ago;this.ts=c.ts;this.dir=c.is_dir?1:0;this.tkey=c.tkey;this.target_ns=c.target_ns;this.sort_rank=c.sort_rank||0;this.sort_key=c.sort_key||[""];this.sjid=c.sjid;this.thumbnail_url_tmpl=c.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=c.large_thumbnail_url_tmpl;this.type=c.type;this.preview_type=c.preview_type;this.activity_key=c.activity_key;if(c.last_modified_fname){this.last_modified_fname=Emstring.em_snippet(c.last_modified_fname,LAST_MODIFIED_FNAME_SNIPPET)}this.htmlified_link=c.htmlified_link;this.doc_preview_status=c.doc_preview_status;this.root_coll_item_counter=c.root_coll_item_counter;this.user_id=c.user_id;this.fulltext_search=c.fulltext_search;this.read_only=c.read_only?true:false;this.is_read_only_mount=c.is_read_only_mount?true:false;this.request_id=(a=c.request_id)!=null?a:null;return this.match_type=(f=c.match_type)!=null?f:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in BrowseFile._file_index)){Browse.add_file(this);return BrowseFile._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===FileTypes.SHARED_FOLDER},could_be_shared_folder:function(){var c,d,a,b;d=Browse.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");b=Browse.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";a=this.target_ns;c=this.ns_id!==Constants.root_ns;return this.type===FileTypes.FOLDER&&!(c||a||d||b)},is_sandbox:function(){return this.type===FileTypes.SANDBOX},video_transcode_url:function(){var a;assert(this.fq_path,"video_transcode_url: expected a non-root fq_path");if(Constants.transcoder_hls4web){a=URI({path:"/playlist"+this.fq_path})}else{a=URI({scheme:"https",authority:Constants.LIVE_TRANSCODE_SERVER,path:"/transcode_video/w/"+(this.hash+this.fq_path)})}return a.updateQuery(Constants.UID_PARAM_NAME,Browse.active_user.id).toString()},get_div:function(){return $("f_"+(this.to_key()))},rename:function(f,h,d,e,g,i){var b,j,a,c;b=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;a=this.fq_path;Browse.pre_action_selection=[a];j=Browse.find_file(f);if(j){Browse.remove_file(j)}this.filename=FilePath.filename(f);this.caption=Emstring.em_snippet(this.filename,b);this.fq_path=f;this.ns_path=h;this.htmlified_link=i;this.hash=d;this.sort_key=e;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){c=this.href.split("/");c[c.length-1]=Util.urlquote(this.filename)+("?w="+d);this.href=c.join("/");this.icon=g}else{this.href="/home"+Util.urlquote(f);if(this.target_ns){Browse.ns_id_to_mount_point[this.target_ns]=f}}if(Browse.in_search_mode()&&FileSearch.fulltext_search_enabled){this.filename_highlights=[]}BrowseFile._file_index[this.to_key()]=this;Browse.update_file_pos(this);return document.fire(FileEvents.RENAME,{old_fq_path:a,file:this})},edit:function(){var c,a,d,b,e;this.editing=true;Browse.selectable();e=(function(f){return function(n){var h,g,k,p,m,j,q,o,l,i;i=n.responseText.evalJSON(true);assert(i.new_browse_files.length===1,"No new file data returned.");k=i.new_browse_files.first();p=k.fq_path;m=k.hash;l=Util.decode_sort_key(k.sort_key);q=k.icon;o=k.ns_path;j=k.htmlified_link;h=i.changesets;g=_("Rename complete.");UndoAction.notifyWithUndo(g,h,FileOps.do_rollback);f.rename(p,o,m,l,q,j);BrowseSelection.set_selected_files([f]);f.get_div().smoothScrollIntoView();return BrowseUtil.load_visible_thumbs()}})(this);a=URI({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user).toString();d=FileSearch.fulltext_search_enabled&&Browse.in_search_mode()?".filename-col":".filename-col a";c=new Ajax.InPlaceEditor(this.get_div().down(d),a,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(f){return function(){return f.editing=false}})(this),onFailure:function(){},savingText:_("Saving..."),ajaxOptions:{job:true,subject_user:Browse.active_user,html_in_error_msg:true,progress_text:_("Renaming..."),method:"POST",onCreate:Notify.clear,onSuccess:e,onUninitialized:Browse.unselectable},callback:(function(f){return function(g,h){return{to_path:h||"",folder:(f.dir?"yes":"")}}})(this)});c.enterEditMode();b=this.get_div().down(".editor_field");if("selectionEnd" in b&&this.filename.lastIndexOf(".")>-1){return b.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var b,a;if(this.dir){if(Browse.inside_dir&&Browse.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&Browse.public_folder_enabled){b="PUBLIC_FOLDER"}}if(b==null){if(this.type===FileTypes.FOLDER){b="FOLDER"}else{if(this.type===FileTypes.PACKAGE){b="FOLDER"}else{if(this.type===FileTypes.SHARED_FOLDER){b="SHARED_FOLDER"}else{if(this.type===FileTypes.SANDBOX){b="SANDBOX"}else{if(this.target_ns){b="SHARED_FOLDER"}else{b="FOLDER"}}}}}}}if(b==null){b=BrowseFile.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}a=this.is_deleted?BrowseFile.CATEGORY_TO_DELETED_TRANSLATION[b]:BrowseFile.CATEGORY_TO_TRANSLATION[b];assert(a,"CATEGORY MISSING FOR "+b);return a},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return FilePath.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&Browse.is_shmodelable_path(this.fq_path)}});BrowseFile._CATEGORIES={IMAGE:"ai bmp cr2 eps gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"cdr csv doc docx docm fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};BrowseFile.EXTENSION_TO_CATEGORY={};BrowseFile.CATEGORY_TO_TRANSLATION={FILE:_("file"),FOLDER:_("folder"),SHARED_FOLDER:_("shared folder"),PUBLIC_FOLDER:_("folder"),IMAGE:_("image"),VIDEO:_("video"),AUDIO:_("audio"),DOCUMENT:_("document"),COMPRESSED_FILE:_("archive"),CODE:_("code"),DISK_IMAGE:_("disk image"),EXECUTABLE:_("executable"),SHORTCUT:_("shortcut"),LINK:_("link"),FONT:_("font"),SANDBOX:_("app folder")};BrowseFile.CATEGORY_TO_DELETED_TRANSLATION={FILE:_("deleted file"),FOLDER:_("deleted folder"),SHARED_FOLDER:_("deleted shared folder"),PUBLIC_FOLDER:_("deleted folder"),IMAGE:_("deleted image"),VIDEO:_("deleted video"),AUDIO:_("deleted audio"),DOCUMENT:_("deleted document"),COMPRESSED_FILE:_("deleted archive"),CODE:_("deleted code"),DISK_IMAGE:_("deleted disk image"),EXECUTABLE:_("deleted executable"),SHORTCUT:_("deleted shortcut"),LINK:_("deleted link"),FONT:_("deleted font"),SANDBOX:_("deleted app folder")};(function(){var c,e,b,d,a;d=BrowseFile._CATEGORIES;a=[];for(c in d){b=d[c];a.push((function(){var i,g,f,h;f=b.trim().split(" ");h=[];for(i=0,g=f.length;i<g;i++){e=f[i];h.push(BrowseFile.EXTENSION_TO_CATEGORY[e]=c)}return h})())}return a})();BrowseFile._file_index={};BrowseFile.from_key=function(a){return BrowseFile._file_index[a]};BrowseFile.from_elem=function(b){var a;if(!b){return}a=b.readAttribute("data-identity");if(a){return BrowseFile.from_key(a)}else{return BrowseFile.from_elem(b.up("[data-identity]"))}};var BrowseActions,BrowseActionsBasic,BrowseActionsContext,GlobalActions,GlobalActionsBasic,GlobalActionsContext;BrowseActions=Class.create({initialize:function(a){return this._set_files(a)},firefly_logging_helper:function(a){if(Browse.in_search_mode()&&a){this._firefly_log_values.action_type=a;return analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var a;a=this.get_files();if(a.length<2){return this._get_actions_single(a.first())}else{return this._get_actions_multi(a)}},get_files:function(){return this._files},get_action_by_name:function(a){return this.evaluate_action(BrowseActions.option_dict[a],a)},evaluate_action:function(c,b){var d,e,a;d=(function(f){return function(h,g){if((g!=null)&&(h==null)){return g}if($j.isFunction(h)){return h.call(f)}else{if(h!=null){return h}else{return g}}}})(this);a={icon_href:c.icon_href,target:c.target,click_handler:c.click_handler,type:c.type,name:b||c.name,is_dropdown:!!c.is_dropdown,icon:d(c.icon),text:d(c.text),detail_text:d(c.detail_text),href:d(c.href,""),kind:d(c.kind,"icon"),button_label:d(c.button_label,c.text)};if($j.isFunction(c.subactions)){a.subactions=c.subactions.call(this)}else{if($j.isArray(c.subactions)){a.subactions=(function(){var i,g,h,f;h=c.subactions;f=[];for(i=0,g=h.length;i<g;i++){e=h[i];f.push(this.get_action_by_name(e))}return f}).call(this)}else{if(c.subactions){assert(0,"subactions must be a function or an array of actions")}}}return a},_set_files:function(b){var a;this._files=$A(b);this._log_extras={};if(this.get_files().length>0){a=b.first();this._log_extras={path:a.fq_path,ns_id:a.ns_id};return this._firefly_log_values={file_nsid:a.ns_id,file_sjid:a.sjid,firefly:FileSearch.fulltext_search_enabled,match_type:a.match_type,position:a.sort_rank,request_id:a.request_id,viewport:"full-view"}}},_get_actions_single:function(c){var m,e,a,g,j,i,b,l,h,o,k,p,d,n,f;e=[];if(!c){return[]}g=Browse.public_folder_enabled&&c.fq_path.toLowerCase().startsWith("/public/");h=Browse.public_folder_enabled&&c.fq_path.toLowerCase()==="/public";b=c.target_ns;a=c.ns_id!==Constants.root_ns;k=c.type===FileTypes.SHARED_FOLDER;o=c.type===FileTypes.SANDBOX;l=c.type===FileTypes.PACKAGE;i=c.root_coll_item_counter>=0;if(c.is_deleted){e=e.concat(["restore"]);e.push("purge");if(!c.dir){e.push("revisions")}}else{if(Constants.send_a_copy_enabled){e.push("send_copy")}if(c.dir){if(o){e.push("app_info")}else{if(k){e.push("sharing_options")}else{if(!(a||b||g||h)){e.push("share")}}}if(c.is_shmodelable()){e.push("token_share")}e.push("download");if(!h){e=e.concat(["delete","rename","move"]);if(!(l||b)){e.push("copy")}}if(Browse.can_use_photos_features){if(Browse.can_use_photos_features){e.push("album_from_folder")}}}else{if(c.is_shmodelable()){e.push("token_share")}if(g||Browse.public_app_token){e.push("copy_url")}e.push("download");e=e.concat(["delete","rename","move","copy","revisions"]);if(i&&Browse.can_use_photos_features){e.push("view_in_photos")}}if(Browse.sharing_growth_experiments_variant&&Browse.sharing_growth_experiments_variant==="DROPDOWN"){p=false;f=["sharing_options","share","token_share"];for(d=0,n=f.length;d<n;d++){m=f[d];j=e.indexOf(m);if(j>-1){e.splice(j,1);p=true}}if(c.is_shared_folder()||c.could_be_shared_folder()){e.unshift("single_entry_share_dropdown_variant_menu")}else{e.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return e},_get_actions_multi:function(c){var a,b,d;if(Constants.send_a_copy_enabled){a=["send_copy","download"]}else{a=["download"]}a=a.concat(["delete","move","copy","restore","purge","view_in_photos"]);b=BrowseUtil.profile_files(c);if(b.deleted>0||b.public_folder>0){a.removeItem("move");a.removeItem("copy");a.removeItem("delete")}if(b.shared_folders>0){a.removeItem("copy")}if(b.deleted>0){a.removeItem("send_copy");a.removeItem("delete");a.removeItem("download")}if(!Browse.inside_dir){a.removeItem("download")}if(!(b.deleted===c.length&&(b.shared_folders===0||((b.shared_folders===(d=c.length)&&d===1))))){a.removeItem("restore");if(b.deleted!==c.length){a.removeItem("purge")}}if(b.in_root_coll!==c.length||!Browse.can_use_photos_features){a.removeItem("view_in_photos")}return a},get_disabled_action_names:function(){var a,c,e,b,d;a=false;d=this.get_files();for(e=0,b=d.length;e<b;e++){c=d[e];a=true;if(!c.read_only){a=false;break}}if(Browse.inside_read_only_shared_folder||a){return["move","rename","delete","restore","purge","upload","new_folder"]}else{return[]}},show_disabled_action_warning:function(a){if(Browse.inside_read_only_shared_folder){if(a==="move"){return Notify.warning(_("You don't have permission to move files in this folder."))}else{if(a==="rename"){return Notify.warning(_("You don't have permission to rename files in this folder."))}else{if(a==="delete"){return Notify.warning(_("You don't have permission to delete files in this folder."))}else{if(a==="restore"){return Notify.warning(_("You don't have permission to restore files in this folder."))}else{if(a==="purge"){return Notify.warning(_("You don't have permission to permanently delete files in this folder."))}else{if(a==="upload"){return Notify.warning(_("You don't have permission to upload files into this folder."))}else{if(a==="new_folder"){return Notify.warning(_("You don't have permission to create a new folder in this folder."))}else{return Notify.warning(_("You only have permission to view this folder."))}}}}}}}}else{return Notify.warning(_("You do not have permission to perform the requested action."))}}});Object.extend(BrowseActions,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(b){var a,c;Modal.show(BrowseUtil.append_ellipsis(_("Copy public link")),DomUtil.fromElm("copy-public-url"),{wit_group:"copy_public_link"});Modal.onHide=function(){$("flash_copy_container").remove();delete Modal.onHide;return Modal.hide()};a=clipboard.clipboard_overlay(b,$j("#real_copy"),function(){Notify.success(_("Link copied to clipboard!"));return Modal.hide()});a.css({zIndex:1001});c=$("modal-content").down("#public_url");assert(c,"Text element not found for copy pulic link");c.setValue(b);return c.select()},shortenPublicLink:function(){var a;Util.shorten_url($F("public_url"),BrowseActions.updatePublicLink);a=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small.gif",className:"right"});return $("modal-content").down("a").__date(a)},updatePublicLink:function(b){var a;$("public_url").setValue(b);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();a=clipboard.clipboard_overlay(b,$j("#real_copy"),function(){Notify.success(_("Link copied to clipboard!"));return Modal.hide()});return a.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:_("New folder"),click_handler:function(a){return Browse.new_folder()}},global_restore:{icon:"restore",text:function(){assert(Browse.inside_deleted_dir,"Global restore from not a deleted dir");if(Browse.inside_deleted_shared_folder){return BrowseUtil.append_ellipsis(_("Rejoin shared folder"))}else{if(Browse.inside_deleted_sandbox){return _("Restore app folder")}else{return _("Restore folder")}}},click_handler:function(){var d,e,b,a,c;d=Browse.containing_fq_path();b=d.toLowerCase();if(Browse.inside_deleted_sandbox){assert(Browse.old_path_to_ns_id[b],"Deleted sandbox missing nsid");return Apps.restore_sandbox(Browse.active_user,d,Browse.old_path_to_ns_id[b])}else{if(Browse.inside_deleted_shared_folder){assert(Browse.old_path_to_ns_id[b],"Deleted shared folder missing nsid");return SharingModals.show_rejoin_modal(Browse.active_user,d,Browse.old_path_to_ns_id[b])}else{e=URI.parse(location.href).setFragment("").toString();a={prev:e};a[Constants.UID_PARAM_NAME]=Browse.active_user;c=URI({path:"/restore"+d}).updateQuery(a);return window.location.href=String(c)}}}},restore:{icon:"restore",text:function(){var b,a;b=this.get_files();a=BrowseUtil.profile_files(b);if(a.shared_folders===b.length){return BrowseUtil.append_ellipsis(ungettext("Rejoin shared folder","Rejoin shared folders",b.length,{comment:"BUTTON"}))}else{return BrowseUtil.append_ellipsis(_("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var c,f,b,g,e,a,d;f=this.get_files();if(f.length===0){}else{if(f.length===1){c=f.first();if(!c.is_deleted){return}g=c.fq_path;b=g.toLowerCase();if(c.type===FileTypes.SANDBOX){assert(Browse.old_path_to_ns_id[b],"Restore missing ns");Apps.restore_sandbox(Browse.active_user,g,Browse.old_path_to_ns_id[b])}else{if(c.type===FileTypes.SHARED_FOLDER){assert(Browse.old_path_to_ns_id[b],"Rejoin missing ns");SharingModals.show_rejoin_modal(Browse.active_user,g,Browse.old_path_to_ns_id[b])}else{if(c.dir){e=URI.parse(location.href).updateQuery({select:c.filename});a={prev:String(e)};a[Constants.UID_PARAM_NAME]=Browse.active_user;d=URI({path:"/restore"+c.fq_path}).updateQuery(a);window.location=String(d)}else{FileOps.show_undelete(c)}}}}else{return FileOps.show_bulk_restore(f,Browse.active_user)}}}},global_share:{icon:function(){return BrowseUtil.get_shared_folder_icon()},text:function(){if(Browse.inside_shared_folder){return BrowseUtil.append_ellipsis(_("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(Browse.containing_fq_path()===""){return BrowseUtil.append_ellipsis(_("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return BrowseUtil.append_ellipsis(_("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(a){a.preventDefault();if(Browse.containing_fq_path()===""){return SharingModals.start_wizard_for_user(Browse.active_user)}else{if(Browse.inside_shared_folder){return SharingModals.show_shared_folder_options_modal(Browse.containing_mount_point(),Browse.active_user)}else{return SharingModals.show_share_existing_modal(Browse.containing_fq_path(),Browse.active_user)}}}},global_share_button:{icon:"rainbow_16",kind:"button",button_label:_("Share"),text:function(){return BrowseUtil.append_ellipsis(_("Share a folder"))},click_handler:function(b,a){b.preventDefault();if(Browse.containing_fq_path()===""){return SharingModals.start_wizard_for_user(Browse.active_user)}else{if(Browse.is_in_subfolder_of_shared_folder()){ShmodelUILogger.log("via-single-entry-sharing-button");return SharingShmodel.shmodel(Browse.containing_fq_path(),a+"_global_share_button")}else{return SharingModals.show_shmodel_or_invite_modal(Browse.containing_fq_path(),Browse.inside_shared_folder,Browse.active_user)}}}},sharing_options:{icon:function(){return BrowseUtil.get_shared_folder_icon()},text:BrowseUtil.append_ellipsis(_("Shared folder options",{comment:"BUTTON"})),click_handler:function(c,a){var b;b=this.get_files().first();ShmodelUILogger.log_with_target_file("sf_options",a,b);return SharingModals.show_shared_folder_options_modal(b.fq_path,Browse.active_user)}},share:{icon:function(){return BrowseUtil.get_shared_folder_icon()},text:BrowseUtil.append_ellipsis(_("Invite to folder",{comment:"BUTTON"})),click_handler:function(c,a){var b;b=this.get_files().first();ShmodelUILogger.log_with_target_file("sf_invite",a,b);return SharingModals.show_share_existing_modal(b.fq_path,Browse.active_user)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=FileOps.build_revisions_uri(this.get_files().first().fq_path,Browse.active_user)},text:_("Previous versions",{comment:"BUTTON"})},token_share:{icon:function(){return BrowseUtil.get_shared_link_icon()},text:BrowseUtil.append_ellipsis(_("Share link",{comment:"BUTTON"})),click_handler:function(d,a){var b,c;b=this.get_files().first();ShmodelUILogger.log_with_target_file("token_share",a,b);if(!Constants.disable_new_sharing||b.tkey){c=b.fq_path;assert(c,"token_share: expected non-root fq_path");return SharingShmodel.shmodel(c,a+"_token_share")}else{SharingShmodel.shmodel_disabled(b);return analytics.UserActivityLogger.log("web","over-quota-shared-link-modal-"+Constants.sharing_upsell_type,null,Viewer.get_viewer().personal_user.id)}}},global_token_share:{icon:function(){return BrowseUtil.get_shared_link_icon()},text:BrowseUtil.append_ellipsis(_("Share link",{comment:"BUTTON"})),click_handler:function(b,a){ShmodelUILogger.log("via-global-toolbar");return SharingShmodel.shmodel(Browse.containing_fq_path(),a+"_global_token_share")}},copy_url:{icon:"world_link",text:BrowseUtil.append_ellipsis(_("Copy public link",{comment:"BUTTON"})),click_handler:function(c){var b,a;b=this.get_files().first();if(Browse.public_app_token){a="/spa/"+Browse.public_app_token+b.ns_path}else{a="/u/"+Browse.active_user.id+b.fq_path.substring(BrowseActions.PUBLIC_FOLDER_PATH_LENGTH)}return BrowseActions.showCopyPublicUrlModal(String(new URI({scheme:"https",authority:Constants.PUBSERVER,path:a})))}},download:{icon:"download",text:function(){return _("Download",{comment:"BUTTON"})},click_handler:function(){var d,c,a,g,i,h,e,b,f;a=this.get_files();if(a.length===1&&!a[0].dir){c=a.first();f=[Constants.protocol,Constants.block,c.fq_path,c.hash],h=f[0],d=f[1],i=f[2],g=f[3];e={w:g,dl:1};b=URI({scheme:h,authority:d,path:"/get"+i,query:e});return window.location=String(b.updateQuery(Constants.UID_PARAM_NAME,Browse.active_user))}else{return FileOps.do_bulk_download(a)}}},view:{href:function(){var f,a,d,c,e,b;a=this.get_files().first();b=[Constants.protocol,Constants.block,Util.urlquote(a.fq_path),a.hash],e=b[0],f=b[1],c=b[2],d=b[3];return""+e+"://"+f+"/get"+c+"?w="+d},icon:"page_white_magnify",text:_("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return SharingModals.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:_("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"trash-can",text:_("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"trash-can-open",text:_("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:BrowseUtil.append_ellipsis(_("Copy",{comment:"BUTTON"})),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_copy(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_copy_bulk(b)}}}},move:{icon:"move_16",text:BrowseUtil.append_ellipsis(_("Move",{comment:"BUTTON"})),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_move(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_move_bulk(b)}}}},rename:{icon:"rename",text:_("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:BrowseUtil.append_ellipsis(_("Delete",{comment:"BUTTON"})),click_handler:function(c){var a,b;b=this.get_files();if(b.length>1){return FileOps.show_bulk_delete(Browse.active_user,b)}else{if(b.length===1){a=b.first();return FileOps.show_delete(Browse.active_user,a.fq_path,a.dir)}}}},global_purge:{icon:"cancel",text:BrowseUtil.append_ellipsis(_("Permanently delete folder")),click_handler:function(){return FileOps.show_purge(Browse.containing_fq_path(),true)}},purge:{icon:"cancel",text:BrowseUtil.append_ellipsis(_("Permanently delete",{comment:"BUTTON"})),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_bulk_purge(b)}}},upload:{icon:"upload_16",text:BrowseUtil.append_ellipsis(_("Upload")),click_handler:function(a){return FileOps.show_upload()}},app_info:{icon:"application_double",text:BrowseUtil.append_ellipsis(_("Application info")),click_handler:function(a){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:_("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:_("More actions"),click_handler:function(){GlobalActionsBasic.show_secondary();return document.body.observe("click",GlobalActionsBasic.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return _("View in Photos")},click_handler:function(){var a;a=this.get_files();return FileOps.do_bulk_photo_view(a)}},album_from_folder:{icon:"create-album",text:function(){return _("Create album")},click_handler:function(){var b,a;b=this.get_files();a=b.first();return FileOps.create_album_from_folder(a.fq_path,a.filename)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:BrowseUtil.append_ellipsis(_("Share")),click_handler:function(c,a){var b;b=this.get_files().first();ShmodelUILogger.log_with_target_file("single_entry_share_click",a,b);return SharingShmodel.shmodel(b.fq_path,a)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:BrowseUtil.append_ellipsis(_("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(c,a){var b;b=this.get_files().first();return ShmodelUILogger.log_with_target_file("single_entry_share_hover",a,b)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:BrowseUtil.append_ellipsis(_("Invite people to collaborate")),click_handler:function(d,a){var b,c;if(EmailVerification.get_for_user(Browse.active_user).verified()){b=this.get_files().first();if(b.is_shared_folder()){ShmodelUILogger.log_with_target_file("sf_options",a,b);c=new ExistingSharedFolderOptionsModal(Browse.active_user,b.fq_path)}else{ShmodelUILogger.log_with_target_file("sf_invite",a,b);c=new InviteToNewSharedFolderWizardModal(Browse.active_user,{folder_name:b.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+Browse.active_user.id})}return c.show()}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:BrowseUtil.append_ellipsis(_("Send link")),click_handler:function(c,a){var b;b=this.get_files().first();ShmodelUILogger.log_with_target_file("token_share",a,b);return SharingShmodel.shmodel(b.fq_path,a)}}}});BrowseActionsContext=Class.create(BrowseActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$j("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));$j("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));$j("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return $j("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");this.firefly_logging_helper(c);a=BrowseActions.option_dict[c];analytics.BrowseActionsContextMenuLogger.log(this.get_files(),c);if(!a.is_dropdown||b.hasAttribute("submenu-index")){ContextMenu.hide()}d.preventDefault();a.click_handler.call(this,d,"browse_actions_context");if(c==="sharing_options"){analytics.SharedFolderActivityLogger.log("web","browse_view_options",Browse.active_user,this._log_extra,true)}if(c==="share"){return analytics.SharedFolderActivityLogger.log("web","browse_view_share_existing",Browse.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return $j("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(a){return $j(a).removeClass("hover")},_enter:function(d){var c,a,b;c=$j(d.currentTarget).data("value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);return(b=a.hover_handler)!=null?b.call(this,d,"browse_actions_context"):void 0},_over:function(a){if($j(a.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return $j(a.currentTarget).addClass("hover")}},_out:function(a){if($j(a.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(b){return function(){return b._reset_submenu(a.currentTarget)}})(this),300)}}});BrowseActionsBasic=Class.create(BrowseActions,{initialize:function($super){var a;a=BrowseSelection.get_selected_files();$super(a);this._render();return this._listen()},_listen:function(){var a;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(BrowseSelection.UPDATED_EVT,this.bound_update);document.observe(ContextMenu.SHOW_EVT,this.bound_disable);document.observe(ContextMenu.HIDE_EVT,this.bound_enable);a=$("browse-root-actions");a.stopObserving("click");return a.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(BrowseSelection.UPDATED_EVT,this.bound_update);document.stopObserving(ContextMenu.SHOW_EVT,this.bound_disable);document.stopObserving(ContextMenu.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(BrowseSelection.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(c){var b,a;a="#browse-root-actions #"+c+"_action_button";b=$j(a);b.addClass("disabled");return b.click((function(d){return function(f){d.show_disabled_action_warning(c);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var B,u,w,m,y,C,E,t,v,p,a,i,j,l,k,x,h,F,r,f,o,n,q,s,g,e,c,b,z,D,A,d;i=this.get_files();w=this.get_action_names();if(Browse.sharing_growth_experiments_variant&&Browse.sharing_growth_experiments_variant==="DROPDOWN"){n=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(e=0,z=n.length;e<z;e++){u=n[e];k=w.indexOf(u);if(k>-1){w.splice(k,1);break}}}B=13.5;v="";j="";if(i.length===1){v=Emstring.em_snippet(i[0].filename,B);if(!i[0].dir&&i[0].bytes>=0){j=i[0].size}}else{if(1<i.length){f=BrowseUtil.profile_files(i);x=[];if(f.files){h=ungettext("%d file","%d files",f.files).format(f.files);x.push(h)}if(f.folders){h=ungettext("%d folder","%d folders",f.folders).format(f.folders);x.push(h)}v=Util.nice_list(x)}}C=$("browse-root-actions");y=C.getLayout().get("width");l=C.getStyle("font-size");assert(l.endsWith("px"),"Invalid font size "+l);l=parseInt(l,10);p=new Emstring(v).length*l;q=new Emstring(j).length*l;y-=p+q;s=[];o=[];y-=30;for(c=0,D=w.length;c<D;c++){F=w[c];u=this.get_action_by_name(F);g=new Emstring(u.text).length*l;E=g+16+8+10+9;if(y>E){s.push(F)}else{if(o.length===0){r=s.pop();o.push(r)}o.push(F)}y-=E}if(o.length){s.push("more_actions")}m=(function(){var I,G,H;H=[];for(I=0,G=s.length;I<G;I++){F=s[I];H.push(this.get_action_by_name(F))}return H}).call(this);if(o.length){m[m.length-1].subactions=(function(){var I,G,H;H=[];for(I=0,G=o.length;I<G;I++){F=o[I];H.push(this.get_action_by_name(F))}return H}).call(this)}t=HTML.tmpl("actions_bar_tmpl",{context:this,description:v,filesize:j,has_actions:!!w.length,actions:m});$("browse-root-actions").__date(t);a=this.get_disabled_action_names();d=[];for(b=0,A=a.length;b<A;b++){u=a[b];d.push(this._disable_action(u))}return d},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);this.firefly_logging_helper(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);d.preventDefault();a.click_handler.call(this,d,"browse_actions_basic");if(c==="sharing_options"){analytics.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",Browse.active_user,this._log_extras,true)}if(c==="share"){return analytics.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",Browse.active_user,this._log_extras,true)}}});Object.extend(BrowseActionsBasic,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos"]});GlobalActions=Class.create(BrowseActions,{initialize:function($super){return $super()},get_action_names:function(){var a;if(!Browse.inside_dir){return[]}a=[];if(!Browse.inside_deleted_dir){a=a.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){a.push("global_share")}if(this._should_show_share_link()){a.push("global_token_share")}if(this._should_show_single_entry_share()){a.push("global_share_button")}if(!Constants.can_see_trash){a.push((Browse.deleted_shown?"hide_del":"show_del"))}}else{a=a.concat(["global_restore"])}return a},_should_show_shared_folder_options:function(){return !Browse.is_in_subfolder_of_shared_folder()&&!Browse.inside_sandbox&&!this._should_show_single_entry_share()},_should_show_share_link:function(){return Browse.is_shmodelable_path(Browse.containing_fq_path())&&!this._should_show_single_entry_share()},_should_show_single_entry_share:function(){return Browse.single_share_entry_point&&Browse.containing_fq_path()!==""}});GlobalActionsBasic=Class.create(GlobalActions,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(ContextMenu.SHOW_EVT,this._disable.bind(this));return document.observe(ContextMenu.HIDE_EVT,this._enable.bind(this))},_render:function(){var d,f,h,k,m,a,b,g,j,i,e,l,c;f=this.get_action_names();i=f.intersect(GlobalActionsBasic.STANDARD_ACTIONS);g=f.without.apply(f,GlobalActionsBasic.STANDARD_ACTIONS);if(g.length===1){i=f;g=[]}if(g.length){i.push("more_global_actions")}j=(function(){var p,o,n;n=[];for(p=0,o=i.length;p<o;p++){a=i[p];n.push(this.get_action_by_name(a))}return n}).call(this);h=(function(){var p,o,n;n=[];for(p=0,o=j.length;p<o;p++){d=j[p];if(d.kind==="button"){n.push(d)}}return n})();b=(function(){var p,o,n;n=[];for(p=0,o=j.length;p<o;p++){d=j[p];if(d.kind!=="button"){n.push(d)}}return n})();k=HTML.tmpl("global_actions_tmpl",{context:this,standard_actions:h.concat(b),secondary_actions:(function(){var p,o,n;n=[];for(p=0,o=g.length;p<o;p++){a=g[p];n.push(this.get_action_by_name(a))}return n}).call(this)});$("global-actions").__date(k);$j(document).trigger("db:browse:ga_rendered");m=this.get_disabled_action_names();c=[];for(e=0,l=m.length;e<l;e++){d=m[e];c.push(this._disable_action(d))}return c},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(c){var b,a;a="#global-actions #"+c+"_button";b=$j(a);b.addClass("disabled");return b.click((function(d){return function(f){d.show_disabled_action_warning(c);return false}})(this))},_enable:function(){var d,e,c,b,a;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");e=this.get_disabled_action_names();a=[];for(c=0,b=e.length;c<b;c++){d=e[c];a.push(this._disable_action(d))}return a},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);GlobalActionsBasic.hide_secondary();BrowseSelection.deselect_all();d.preventDefault();a.click_handler.call(this,d,"global_actions_basic");if(c==="global_share"){if(this._log_extras.path===""){return analytics.SharedFolderActivityLogger.log("web","browse_view_share_button",Browse.active_user,this._log_extras,true)}else{return analytics.SharedFolderActivityLogger.log("web","folder_view_share_button",Browse.active_user,this._log_extras,true)}}}});Object.extend(GlobalActionsBasic,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge","global_share_button"],show_secondary:function(){var a,b;b=$("secondary-actions");a=$("more_global_actions_button");b.show();return a.addClassName("down")},hide_secondary:function(){var a,b;b=$("secondary-actions");if(!b){return}a=$("more_global_actions_button");b.hide();return a.removeClassName("down")}});GlobalActionsContext=Class.create(GlobalActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");this.firefly_logging_helper(c);a=BrowseActions.option_dict[c];BrowseSelection.deselect_all();if(!a.is_dropdown){ContextMenu.hide()}d.preventDefault();a.click_handler.call(this,d,"global_actions_context");if(c==="global_share"){if(this._log_extras.path===""){return analytics.SharedFolderActivityLogger.log("web","browse_view_right_click_share",Browse.active_user,this._log_extras,true)}else{if(Browse.inside_shared_folder){return analytics.SharedFolderActivityLogger.log("web","folder_view_right_click_options",Browse.active_user,this._log_extras,true)}else{return analytics.SharedFolderActivityLogger.log("web","folder_view_right_click_share",Browse.active_user,this._log_extras,true)}}}}});var BrowseClipboard;BrowseClipboard=(function(){var i,f,c,g,e,k,m,h,b,a,j,d,l;i=0;f=1;e=[];c=null;l=function(){var p,r,o,s,q,n;if(dom.focus_in_input()){return}o=BrowseSelection.get_selected_files();if(o&&o.length){for(q=0,n=o.length;q<n;q++){r=o[q];if(r.bytes<0){Notify.error(_("Deleted files cannot be added to the clipboard"));return false}else{if(r.target_ns){s=_("'%(filename)s' cannot be added to the clipboard");s=s.format({filename:r.filename});Notify.error(s);return false}}}e=o;p=o.length;s=ungettext("Added %d item to clipboard","Added %d items to clipboard",p).format(p);Notify.success(s);return true}};k=function(){if(l()){c=i;return false}};m=function(){if(l()){c=f;return false}};h=function(n){var o;assert(typeof n!=="undefined","BrowseClipboard _paste got an undefined path");if(e.length){o=c===i?FileOps.do_bulk_copy:FileOps.do_bulk_move;o(e,n);return true}};d=function(n){var o;if(dom.focus_in_input()||Browse.in_search_mode()||Browse.inside_deleted_dir){return}o=h(Browse.containing_fq_path());if(o){return false}};g=function(){return e=[]};a=function(u){var t,p,r,s,q,o,n;r=u.memo.files;for(s=0,o=r.length;s<o;s++){p=r[s];for(q=0,n=e.length;q<n;q++){t=e[q];if(t.fq_path===p.fq_path||t.fq_path.startsWith(p.fq_path+"/")){g();return}}}};b=function(n){assert((n.memo.file!=null)&&(n.memo.files==null));n.memo.files=[n.memo.file];return a(n)};j=function(){var r,n,q,o,p;document.observe(FileEvents.RENAME,b);p=[FileEvents.DELETE,FileEvents.MOVE];for(q=0,o=p.length;q<o;q++){r=p[q];document.observe(r,a)}n=key.main_modifier();key(""+n+"+c",Browse.KEY_SCOPE,k);key(""+n+"+x",Browse.KEY_SCOPE,m);return key(""+n+"+v",Browse.KEY_SCOPE,d)};return{init:function(){return j()}}})();var BrowseSelection,SharingGrowthExperimentsDropdown;BrowseSelection=(function(){var A,F,D,z,g,f,w,B,o,e,E,s,r,i,u,a,b,n,t,G,m,k,p,j,y,d,h,x,v,c,C,l,q;h=[];z=null;e=null;B=null;f=[];C=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select");return BrowseSelection.get_selected_files().invoke("get_div").findAll(function(H){return H}).invoke("addClassName","file-select")};l=function(){if(B){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(Browse.in_search_mode()&&FileSearch.fulltext_search_enabled){return}return BrowseSelection.get_selected_files().filter(function(H){return !H.editing}).invoke("get_div").findAll(function(H){return H}).invoke("writeAttribute","draggable","true")};q=function(H){H.apply(null,$A(arguments).slice(1));return document.fire(BrowseSelection.UPDATED_EVT)};x=function(J,I){var K,H;H=h.length;h=(J instanceof BrowseFile?[J]:$A(J));if(h.length!==H){T("Selected",h.length,"files")}K=I||h.last();assert(!K||K instanceof BrowseFile,"Invalid anchor type"+K);return z=K};x=x.wrap(q);A=function(I,H){if(I){h.push(I)}return z=H||I};A=A.wrap(q);k=function(H){var I;I=h.indexOf(H);if(I===-1){return}return h.splice(I,1)};k=k.wrap(q);p=function(){return h=[]};p=p.wrap(q);v=function(H){f=H;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return H.invoke("get_div").findAll(function(I){return I}).invoke("addClassName","context-select")};a=function(Q){var N,L,K,M,U,J,S,V,H,P,R,O,I;O=$(Q.target);V=O.match("li.browse-file")?O:O.up("li.browse-file");N=O.match("a")?O:O.up("a");K=BrowseFile.from_elem(V);if(Q.isRightClick()||!V||N||V.hasClassName("unselectable")){return}Browse.keyboard_nav=false;if(f.length){return}J=Util.is_mac();if((J&&Q.metaKey)||(!J&&Q.ctrlKey)){if(h.indexOf(K)===-1){return A(K)}else{return k(K)}}else{if(Q.shiftKey){L=Browse.files.indexOf(z);I=Browse.files.indexOf(K);S=Browse.files.indexOf(h.last());P=h.slice(0);U=S<L?-1:1;M=L;while(M!==S){M+=U;R=P.indexOf(Browse.files[M]);if(R!==-1){P.splice(R,1)}}U=I<L?-1:1;M=L;while(M!==I){M+=U;H=P.indexOf(Browse.files[M]);if(H!==-1){P.splice(H,1)}P.push(Browse.files[M])}return x(P,z)}else{return x(K)}}};b=function(M){var Q,J,P,N,I,H,L,K,O;if(M.isRightClick()||f.length||Util.in_scrollbar(M.pointerX())){return}N=$(M.target);if(Element.match(N,"object")){N=N.parentNode}L=["browse-box","context-menu-container","modal","modal-overlay"];I=false;for(K=0,O=L.length;K<O;K++){H=L[K];if(N.descendantOf(H)||N.match("#"+H)){I=true;break}}if(!I){x();return}P=N.match("li.browse-file")?N:N.up("li.browse-file");J=BrowseFile.from_elem(P);Q=N.match("[draggable]")||N.up("[draggable]");if(J&&!Q){e=z;if(!M.shiftKey){if(J){e=J}else{if(N.match("#browse-files")){e=Browse.files.last()}}}B=[];if(M.metaKey||M.ctrlKey){return B=BrowseSelection.get_selected_files()}}};c=function(J){var I,H;I=BrowseFile.from_elem(u(J));J.preventDefault();if(!I){return}H="browse_file_row";ShmodelUILogger.log_with_target_file("token_share",H,I);return SharingShmodel.shmodel(I.fq_path,H)};u=function(I){var H;H=$(I.target);if(H.match("li.browse-file")){return H}else{return H.up("li.browse-file")}};i=(function(H){return function(N){var K,I,J,O,L,M;L=Browse.sharing_growth_experiments_variant&&Browse.sharing_growth_experiments_variant==="DROPDOWN";I=u(N);K=BrowseFile.from_elem(I);N.preventDefault();if(!(K&&L)){return}J="browse_file_row";M=ShmodelUILogger.get_target_item(K);ShmodelUILogger.log("single_entry_share",J,M);if(K.is_shared_folder()||K.could_be_shared_folder()){O=$j(I).find(".inline-share-button")[0];return SharingGrowthExperimentsDropdown.open(K.fq_path,K.is_shared_folder(),O,Browse.active_user,M)}else{return SharingShmodel.shmodel(K.fq_path,J)}}})(this);g=function(K){var I,H,J;J=$(K.target);H=J.match("li.browse-file")?J:J.up("li.browse-file");I=BrowseFile.from_elem(H);if(I){return a(K)}};r=null;E=function(){var H;clearInterval(r);H=function(){Browse.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return r=setTimeout(H,100)};w=function(){if(!Browse.keyboard_nav){Browse.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};n=function(N){var K,J,I,M,P,H,L,O;E();if(!BrowseSelection.is_selecting()){return}K=Browse.files.indexOf(e);H=Browse.files.indexOf(BrowseFile.from_elem(N.target));assert(K<Browse.files.length&&K>=0,"anchor_index: "+K+" "+e);assert(H<Browse.files.length&&H>=0,"target_index: "+H);J=Browse.files.slice(Math.min(K,H),Math.max(K,H)+1);I=B.slice(0);for(L=0,O=J.length;L<O;L++){P=J[L];M=I.indexOf(P);if(M===-1){I.push(P)}else{I.splice(M,1)}}return x(I)};o=function(H){e=null;return B=null};m=function(J){var H,I;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}w();if(J){Event.extend(J).preventDefault()}I=h.length?h.last()===Browse.files.first()?Browse.files.first():(H=Browse.files.indexOf(h.last())-1,Browse.files[H]):Browse.files.last();x(I);if(I){return Browse.scrollTo(I.get_div())}};t=function(J){var H,I;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}w();if(J){Event.extend(J).preventDefault()}I=h.length?h.last()===Browse.files.last()?Browse.files.last():(H=Browse.files.indexOf(h.last())+1,Browse.files[H]):Browse.files.first();x(I);if(I){return Browse.scrollTo(I.get_div())}};D=function(P){var H,I,N,O,K,L,M,J;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}w();if(P){Event.extend(P).preventDefault()}if(h.length>0){O=Browse.files.indexOf(h.last());H=Browse.files.indexOf(z);if(z===h.last()||H>O){if(O>0){J=[];for(N=L=M=O-1;M<=0?L<=0:L>=0;N=M<=0?++L:--L){I=Browse.files[N];K=h.indexOf(I);A(I,z);if(K!==-1){J.push(h.splice(K,1))}else{Browse.scrollTo(I.get_div());break}}return J}}else{k(h.last());return Browse.scrollTo(h.last().get_div())}}else{return m()}};F=function(Q){var H,I,O,P,L,M,N,K,J;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}w();if(Q){Event.extend(Q).preventDefault()}if(h.length>0){P=Browse.files.indexOf(h.last());H=Browse.files.indexOf(z);if(z===h.last()||H<P){J=[];for(O=M=N=P+1,K=Browse.files.length;N<=K?M<K:M>K;O=N<=K?++M:--M){I=Browse.files[O];L=h.indexOf(I);A(I,z);if(L!==-1){J.push(h.splice(L,1))}else{Browse.scrollTo(I.get_div());break}}return J}else{k(h.last());return Browse.scrollTo(h.last().get_div())}}else{return t()}};j=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}x(Browse.files);return false};d=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}return x(null,null,null)};y=function(H){return x(Browse.find_file(H.memo.fq_path))};s=function(){$$(".file-select").invoke("removeClassName","file-select");return setTimeout(C,100)};G=function(H){return H.memo.files.each(function(I){var J;J=h.indexOf(I[0]);if(J!==-1){h.splice(J,1);return A(I[1])}})};document.observe(UpdateEvents.REMOVE,function(H){return H.memo.files.each(k)});document.observe(UpdateEvents.MOVE,G);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var H;document.observe("click",g);document.observe("mousedown",b);document.observe("mouseup",o);document.observe("dragend",o);document.observe("mouseup",l);$("browse-files").on("mouseover","li.browse-file",n);$("browse-files").on("click",".shmodel-file",c);$("browse-files").on("click",".inline-share-button",i);document.observe(BrowseSelection.UPDATED_EVT,C);document.observe(BrowseSelection.UPDATED_EVT,l);document.observe(Browse.RENDER_EVT,C);document.observe(Browse.RENDER_EVT,l);document.observe(Browse.UPDATE_EVT,x.bind(null,null,null));document.observe(BrowseSelection.LIGHTBOX_EXIT_SELECT_EVT,y);H=key.main_modifier();key("up",Browse.KEY_SCOPE,m);key("down",Browse.KEY_SCOPE,t);key(H+"+a",Browse.KEY_SCOPE,j);key("escape",Browse.KEY_SCOPE,d);key("shift+up",Browse.KEY_SCOPE,D);return key("shift+down",Browse.KEY_SCOPE,F)},set_selected_files:function(H){return x(H)},get_selected_files:function(){return h.slice(0)},get_selected_fq_paths:function(){return h.map(function(H){return H.fq_path})},is_selected:function(H){return h.indexOf(H)!==-1},is_selecting:function(){return !!e},deselect_all:p,set_context_selected:function(H){return v(H)},flicker_selected:s}})();SharingGrowthExperimentsDropdown={open:function(e,c,d,b,f){var a;this.fq_path=e;this.existing_sf=c;this.button=d;this.user=b;this.target_item=f;this.$menu=$j("#sharing-growth-experiments-dropdown-menu");a=this.$button&&this.$button.length;if(a){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var a;this.$menu.show();this.$button=$j(this.button);this.$button.addClass("pressed");a={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};dom.clone_position(this.$menu,this.$button,a);$j("#browse-box").addClass("dropdown-menu-open");return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(a){return a.stopPropagation()});$j(document).on("mousedown",$j.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",$j.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",$j.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");$j(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",$j.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",$j.proxy(this._share_link_click,this))},_sf_click:function(c){var b,a;if(EmailVerification.get_for_user(this.user).verified()){a="file_row_sharing_menu";if(this.existing_sf){ShmodelUILogger.log("sf_options",a,this.target_item);b=new ExistingSharedFolderOptionsModal(this.user,this.fq_path)}else{ShmodelUILogger.log("sf_invite",a,this.target_item);b=new InviteToNewSharedFolderWizardModal(this.user,{folder_name:this.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+this.user.id})}this._hide();return b.show()}},_share_link_click:function(b){var a;a="file_row_sharing_menu";ShmodelUILogger.log("token_share",a,this.target_item);SharingShmodel.shmodel(this.fq_path,a);return this._hide()},_clicked:function(a,b){return a.is(b.target)||a.has(b.target).length},_click_outside_menu_callback:function(a){if(!(this._clicked(this.$menu,a)||this._clicked(this.$button,a))){return this._hide()}},_hide:function(a){this._unlisten();$j("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");return this.$button=null}};var DragScroll;DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(a,b){this._exclude_move_event=a;if(b!=null){return this._scroll_window=b}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(b){var a;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(b):void 0){return this._mouse_y=0}else{a=b.pointerY();return this._mouse_y=a-dom.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var a;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}a=0;if(this._mouse_y<this._scroll_window){a=-1*this._scroll_amount}else{if(this._mouse_y>dom.viewport_dimensions().height-this._scroll_window){a=this._scroll_amount}}if(a){return dom.scroll_to(dom.scroll_offsets().left,dom.scroll_offsets().top+a)}}};var BrowseDrag;BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var a;if(!Modernizr.draganddrop){return}this.listen();a=function(c){var b;b=$j(c.target);return b.closest("#browse-location").length||b.attr("id")==="browse-location"};return DragScroll.init(a,$j("#browse-header").height())},listen:function(){var a;a=$(document.body);document.observe(Browse.UPDATE_EVT,this._update_body_data.bind(this));a.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));a.on("dragend",this._body_dragend.bind(this));a.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){a.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));a.on("mousedown",this._ie_start_drags.bind(this));a.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}a.observe("dragover",this._body_dragover.bind(this));a.observe("dragleave",this._body_dragleave.bind(this));a.observe("dragstart",this._body_dragstart.bind(this));a.observe("mousemove",this._body_mousemove.bind(this));a.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(BrowseSelection.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(Browse.RENDER_EVT,this._build_selected_drag_icon.bind(this));a.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return a.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(b){var a;if(!window.event||window.event.button!==1){return}a=b.findElement("[draggable]");if(a&&a!==document&&a.dragDrop){a.dragDrop();return BrowseDrag._ie_end_drags()}},_ie_start_drags:function(a,b){if(b.tagName!=="OBJECT"&&$(b).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var b,a;b=Browse.inside_dir?"copy move":false;a=Browse.inside_dir?Browse.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",b);return $(document.documentElement).writeAttribute("data-fq_path",a)},_body_dragover:function(d){var b,c,a;b=this._get_event_browse_files();if(b.length){return this._update_status_position(d,b)}else{if(!this._drag_from_window&&((c=d.dataTransfer)!=null?(a=c.types)!=null?a.contains("Files"):void 0:void 0)){return UploadPrep.show_drop_indicators(d)}}},_body_dragleave:function(c){var b,a,d;a=c.x||c.clientX;d=c.y||c.clientY;b=dom.viewport_dimensions();if(!((0<a&&a<b.width)&&(0<d&&d<b.height))){return UploadPrep.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();UploadPrep.hide_drop_indicators();DragScroll.end();return this._drag_from_window=false},_body_mousemove:function(){return UploadPrep.hide_drop_indicators()},_ie_mouseover:function(b,a){if(!dom.focus_in_input()){return a.focus()}},_dropzone_dragover:function(g,a){var b,c,d,f;g.preventDefault();d=this._get_event_browse_files();f=this._target_fq_path(a);if(!d.pluck("fq_path").indexOf(f===-1)){return}if(!this._can_drop(g,a)){a.addClassName("drag_nodrop");return}try{c=g.dataTransfer.effectAllowed}catch(h){}if(c==="move"||c==="copyMove"||c==="linkMove"||c==="all"){g.dataTransfer.dropEffect="move"}else{g.dataTransfer.dropEffect="copy"}g.preventDefault();b=$$(".dragover");b.removeItem(a);b.invoke("removeClassName","dragover");if(!OverQuotaUploads.disabled){a.addClassName("dragover")}return UploadPrep.folder_dragover(f)},_dropzone_dragleave:function(b,a){return this._clear_hover_state(a)},_file_dragstart:function(h,k){var l,a,m,b,g,f,d,i,c;Util.clear_selected();if(BrowseSelection.is_selecting()){return h.preventDefault()}h.dataTransfer.effectAllowed="copyMove";h.dataTransfer.setData("URL","about:blank");g=BrowseFile.from_elem(k);this._set_event_browse_files(g);f=this._get_event_browse_files();if(f.length<=1&&!g.dir){c=g.href;d=(g.filename||_("file")).replace(/:/g,"-");i="application/octet-stream";try{h.dataTransfer.setData("DownloadURL",[i,d,c].join(":"))}catch(j){}}m=new Element("img",{src:"/static/images/icons/icon_spacer.gif",width:1,height:1});l=true;try{h.dataTransfer.setDragImage(m,150,150)}catch(j){b=j;l=Util.ie8}this._add_drop_indicators(h);DragScroll.start();if(l){this._update_status_position(h,f);a=$("drag-status");a.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(f.length>1){a.addClassName("rotatein")}if(this._is_dragging_selection()){a.addClassName("selection")}return a.addClassName("fadein")}},_add_drop_indicators:function(f){var g,d,b,c,a;$(document.body).addClassName(this._STATUS_CLASS);if(!OverQuotaUploads.disabled){c=$$('[dropzone="copy move"]');a=[];for(d=0,b=c.length;d<b;d++){g=c[d];if(this._can_drop(f,g)){a.push(g.addClassName("can_drop"))}else{a.push(void 0)}}return a}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var a,d,j,c,g,k,h,b,e,l,f;b=BrowseSelection.get_selected_files();j=new Element("div",{id:"drag-selection-status"});f=b.slice(0,4);for(g=e=0,l=f.length;e<l;g=++e){d=f[g];a=d.get_div();if(!a){continue}h=a.down(".icon");h.stopObserving("load");h.observe.bind(h).defer("load",BrowseDrag._build_selected_drag_icon);k=h.cloneNode(false);Element.addClassName(k,"icon icon"+g);j.__sert(k)}c=new Element("span",{className:"badge"});c.__date(b.length);j.appendChild(c);return $("drag-selection-status").replace(j)},_build_file_drag_icon:function(f,a){var b,g,d,c;b=BrowseFile.from_elem(a);c=b.get_div().down(".icon").cloneNode(false);Element.addClassName(c,"icon icon0");d=new Element("span",{className:"badge"});d.__date("1");g=new Element("div",{id:"drag-file-status"});g.__date(c).__sert(d);return $("drag-file-status").replace(g)},_drop:function(d,g){var f,b,h,j,i,c,a;d.preventDefault();if(this._is_read_only(g)){a=_("You don't have permission to add to this folder.");Notify.error(a);return}b=this._get_event_browse_files();i=d.dataTransfer.files;c=d.dataTransfer.items;h=null;j=BrowseFile.from_elem(g);f=g.readAttribute("data-fq_path");if(j){h=j.fq_path}else{if(f||f===""){h=f}}if(i&&i.length){if(!UploadPrep.supported()){Notify.error(_("Drag and drop not supported. Please try the simple uploader."))}else{if(!UploadPrep.browse_indicators_enabled()&&!UploadPrep.modal_indicators_enabled()){Notify.error(_("You can't drag and drop upload right now."))}else{UploadPrep.upload(h,i,c)}}}else{if(b.length){if((d.dataTransfer.dropEffect==="copy")||(d.dataTransfer.effectAllowed==="copy")){FileOps.do_bulk_copy(b,h)}else{if(!Browse.inside_dir||Browse.containing_fq_path()!==h){FileOps.do_bulk_move(b,h)}}}}this._remove_drop_indicators();return UploadPrep.hide_drop_indicators()},_set_event_browse_files:function(a){var b;b=BrowseSelection.is_selected(a);return this._current_item_key=b?this._SELECTION_CONST:a.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var c,b,a;try{a=this._current_item_key;if(this._is_dragging_selection()){return BrowseSelection.get_selected_files()}else{if(a){b=BrowseFile.from_key(a);return(b?[b]:[])}}}catch(d){c=d;console.log(c)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(a){if(a.readAttribute("read_only")){return true}if(a.readAttribute("is_read_only_mount")){return true}return false},_can_drop:function(d,b){var a,c;if(this._is_read_only(b)){return false}a=this._target_fq_path(b);c=this._get_event_browse_files();if(c.length){return !FileOps.bulk_move_error(c,a)}else{if($A(d.dataTransfer.types).indexOf("Files")!==-1){return UploadPrep.supported()}else{return false}}},_target_fq_path:function(a){var b;b=BrowseFile.from_elem(a);if(b){return b.fq_path}else{return a.readAttribute("data-fq_path")}},_clear_hover_state:function(b){var e,d,a,c;c=$$("#browse .dragover");for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){e.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(a){a=Event.extend(a);return Util.scry("drag-status").setStyle({left:(a.pointerX()-dom.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(a.pointerY()-dom.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var BrowseJump;BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(a){return a.charCodeAt(0)}),update:function(){var c,f,b,e,a,d;if(!BrowseJump._listening){BrowseJump.listen();BrowseJump._listening=true}c=[];d=Browse.files;for(e=0,a=d.length;e<a;e++){b=d[e];f=BrowseJump.to_codepoint_list(b.filename);c.push([f,b])}c.sort(function(h,g){return BrowseJump.cmp_codepoints(h[0],g[0])});return BrowseJump._CODEPOINTS=c},reset:function(){return BrowseJump._active=""},is_active:function(){return BrowseJump._active},jump:function(a){if(a){BrowseSelection.set_selected_files([a]);return Browse.scrollTo(a.get_div())}},listen:function(){var e,d,b,c,a;document.observe("keypress",function(g){var f;if(key.getScope()!==Browse.KEY_SCOPE){return}if(dom.focus_in_input()||g.metaKey||g.altKey||g.altGraphKey||g.ctrlKey){return}f=g.charCode||g.keyCode;if(f<32){return}if((33<=f&&f<=40)){return}if(f===32){if(BrowseJump._active){g.preventDefault()}else{return}}if(BrowseJump._BLACKLIST.indexOf(f)!==-1){return}clearTimeout(BrowseJump._RESET_TIMER_ID);BrowseJump._active+=String.fromCharCode(f).toLowerCase();BrowseJump.jump(BrowseJump.nearest_file(BrowseJump._active));return BrowseJump._RESET_TIMER_ID=setTimeout(BrowseJump.reset,BrowseJump._RESET_WAIT)});c=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.RENAME,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE,UpdateEvents.ADD,UpdateEvents.REMOVE,UpdateEvents.MOVE];a=[];for(d=0,b=c.length;d<b;d++){e=c[d];a.push(document.observe(e,function(f){return BrowseJump.update()}))}return a},nearest_file:function(i){var f,b,a,e,h,g,d,c;if((g=BrowseJump._CODEPOINTS)!=null?g.length:void 0){f=BrowseJump.to_codepoint_list(i);d=BrowseJump._CODEPOINTS;for(e=0,h=d.length;e<h;e++){c=d[e],a=c[0],b=c[1];if(BrowseJump.cmp_codepoints(f,a)<1){return b}}BrowseJump._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(e,d){var a,c,b;assert(e.length>0&&d.length>0,"bad input to cmp_codepoints");for(a=c=0,b=e.length;0<=b?c<b:c>b;a=0<=b?++c:--c){if(d[a]==null){return 1}if(e[a]!==d[a]){return(e[a]<d[a]?-1:1)}}if(d.length>e.length){return -1}else{return 0}},to_codepoint_list:function(b){var c,a,e,d;b=b.toLowerCase();a=[];for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){a.push(b.charCodeAt(c))}return a}};var ContextMenu;ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){$j(document).click(this.hide_on_click);$j(document).on(Browse.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(a){return function(b){return ContextMenu.hide()}})(this))},unlisten:function(){$j(document).off("click",this.hide_on_click);return $j(document).off(Browse.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(a){if(!(a.which===3||$j(a.target).parents("#context-menu").length)){return ContextMenu.hide()}},show_for_file:function(a,d,c){var f,b;Browse.keyboard_nav=false;this.hide();f=BrowseFile.from_elem(c);b=BrowseSelection.is_selected(f)?BrowseSelection.get_selected_files():(BrowseSelection.deselect_all(),[f]);BrowseSelection.set_context_selected(b);return this._show(d,new a(b))},show_global:function(a,b){this.hide();return this._show(b,new a())},show_shmodel:function(f){var d,a,b,c;d=["get_original"];this.hide();b=f.findElement("img");c={get_original:{icon:"download",text:_("Download original"),href:b.readAttribute("data-original-href")}};a=Class.create({get_action_names:function(){return d},get_disabled_action_names:function(){return[]},get_action_by_name:function(e){var g;g=c[e];g.name=e;return g}});return this._show(f,new a())},show_for_lightbox:function(f){var d,a,b,c;d=["download","view_original"];this.hide();b=f.findElement("img");c={download:{icon:"download",text:_("Download"),href:URI.parse(b.readAttribute("data-original-href")).updateQuery({dl:1}).toString()},view_original:{icon:"view_original",text:BrowseUtil.append_ellipsis(_("View original")),href:b.readAttribute("data-original-href"),target:"_blank"}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){var e;e=$("context-menu-container");e.stopObserving("click");e.stopObserving("contextmenu");e.on("click",".action button",this._click.bind(this));return e.on("contextmenu",".action button",this._click.bind(this))},_click:function(k,h){var j,g,i;j=h.readAttribute("data-value");g=c[j];ContextMenu.hide();k.preventDefault();return(i=g.click_handler)!=null?i.call(this,k):void 0},get_action_names:function(){return d},get_disabled_action_names:function(){return[]},get_action_by_name:function(e){var g;g=c[e];g.name=e;return g}});return this._show(f,new a())},show_photos:function(j,n){var m,b,g,d,l,k,a,c,h,i,f;this.hide();d={divider:{type:"divider"},choose_album:{icon:"album_16",text:BrowseUtil.append_ellipsis(_("Add %(num_photos)s to album").format({num_photos:n.length})),click_handler:function(o){PhotosCollections.show_add_to_album_modal(o,n);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.PCM,{num_photos:n.length})}},remove:{icon:"album_delete_16",text:_("Remove %(num_photos)s from album").format({num_photos:n.length}),click_handler:function(){PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),n);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.PCM,{num_photos:n.length})}},set_cover:{icon:"album_16",text:_("Set as cover"),click_handler:function(){Photos.get_current_collection().set_cover(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SET_AS_COVER,PhotosTriggers.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return Photos.show_timestamps_modal(n)}}};if(Photos.in_single_collection_view()){m=["share","choose_album","remove"];if(n.length===1){m.unshift("divider");m.unshift("set_cover")}}else{m=["share","choose_album"];m.push("divider");m.push("delete");if(Photos.timestamp_edit_enabled){l=(function(){var p,o,e;e=[];for(p=0,o=n.length;p<o;p++){c=n[p];if(c.time_taken==null){e.push(c)}}return e})();if(l.length===0){m.push("edit_timestamp")}else{if(l.length===n.length){d.edit_timestamp.text="Set timestamp";m.push("edit_timestamp")}}}}if(n.length===1){i=PhotosUtil.categorize_files(n),k=i[0],a=i[1];if(k){h=BrowseUtil.append_ellipsis(_("Share photo"))}else{h=BrowseUtil.append_ellipsis(_("Share video"))}Object.extend(d,{share:{icon:"s_link",text:h,click_handler:function(o){Foshmodal.show(n,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:1})}},"delete":{text:BrowseUtil.append_ellipsis(_("Delete")),click_handler:function(){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:1})}},show_in_folder:{text:BrowseUtil.append_ellipsis(_("Show in folder")),click_handler:function(){Photos.show_in_folder(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SHOW_IN_FOLDER,PhotosTriggers.PCM,{num_photos:1})}}});if(Photos.in_single_collection_view()){m.push("divider")}m.push("show_in_folder")}else{f=PhotosUtil.categorize_files(n),k=f[0],a=f[1];if(k&&a){h=ungettext("Share %(file_count)s item","Share %(file_count)s items",n.length);g=ungettext("Delete %(file_count)s item","Delete %(file_count)s items",n.length)}else{if(k){h=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",n.length);g=ungettext("Delete %(file_count)s photo","Delete %(file_count)s photos",n.length)}else{h=ungettext("Share %(file_count)s video","Share %(file_count)s videos",n.length);g=ungettext("Delete %(file_count)s video","Delete %(file_count)s videos",n.length)}}h=h.format({file_count:n.length});g=g.format({file_count:n.length});Object.extend(d,{share:{icon:"s_link",text:h,click_handler:function(o){Photos._share_selected();return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:n.length})}},"delete":{text:g,click_handler:function(o){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:n.length})}}})}b=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(r,p){var q,o,s;q=p.readAttribute("data-value");o=d[q];if(r.clientX===0&&r.clientY===0){return}ContextMenu.hide();return(s=o.click_handler)!=null?s.call(this,r):void 0},get_action_names:function(){return m},get_disabled_action_names:function(){return[]},get_action_by_name:function(e){var o;o=d[e];o.name=e;return o}});return this._show(j,new b())},show_photo_collection:function(d,f,g){var c,a,b;this.hide();if(f.is_anonymous){c=["go_to_link","unshare"]}else{if(f.is_creator){c=["share","rename"];if(f.share_tkey!=null){c.push("unshare")}c.push("delete")}else{c=["share"]}}b={share:{icon:"s_link",text:BrowseUtil.append_ellipsis(_("Share album")),click_handler:function(h){if(f.num_items===0){Notify.error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(f,true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},unshare:{icon:"lock",text:BrowseUtil.append_ellipsis(f.is_anonymous?_("Unshare"):_("Unshare album")),click_handler:function(h){PhotosCollections.show_unshare_modal(f);return PhotosLogger.log_interaction(PhotosEvents.UNSHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},rename:{icon:"pencil",text:_("Rename album"),click_handler:function(h){f.rename(g.down(".collection-name"));return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},"delete":{icon:"album_delete_16",text:BrowseUtil.append_ellipsis(_("Delete album")),click_handler:function(h){PhotosCollections.show_delete_modal(f);return PhotosLogger.log_interaction(PhotosEvents.DELETE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},go_to_link:{icon:"s_link",text:_("Go to link"),click_handler:function(h){PhotosCollections.go_to_link(f);return PhotosLogger.log_interaction(PhotosEvents.GO_TO_ALBUM_LINK,PhotosTriggers.CCM,{num_photos:f.num_photos})}}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(l,i){var k,h,j;k=i.readAttribute("data-value");h=b[k];ContextMenu.hide();return(j=h.click_handler)!=null?j.call(this):void 0},get_action_names:function(){return c},get_disabled_action_names:function(){return[]},get_action_by_name:function(e){var h;h=b[e];h.name=e;return h}});return this._show(d,new a())},_show:function(t,l,s){var r,q,h,a,j,u,b,p,o,y,m,f,d,c,v,x,w,k,i,g;if(s==null){s=false}m=((t!=null?(k=t.target)!=null?k.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((t!=null?(i=t.target)!=null?i.type.toUpperCase():void 0:void 0)==="TEXT")||((t!=null?(g=t.target)!=null?g.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");p=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay"];y=$(t.target);if($j(y).parents("#context-menu").length){return}r=$j("#file-preview-modal");if(!(r.find(y).length&&$j(y).is("img"))){for(f=0,v=p.length;f<v;f++){b=p[f];u=$$(b);if(u){for(d=0,x=u.length;d<x;d++){j=u[d];if(y.descendantOf(j)||y.match(b)){return}}}}}if((t!=null?t.shiftKey:void 0)||m){return}else{Event.stop(t)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=HTML.tmpl("context_menu_tmpl")}if(!l.get_action_names().length){return}FreshDropdown.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:l,actions:(function(){var z,e,A,n;A=l.get_action_names();n=[];for(z=0,e=A.length;z<e;z++){o=A[z];n.push(l.get_action_by_name(o))}return n})(),big:s}));a=l.get_disabled_action_names();for(c=0,w=a.length;c<w;c++){q=a[c];this.disable_action(q=q,h=l)}this.position_at(t.clientX,t.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(c,f){var b,a,d,e;e=dom.viewport_dimensions();a=parseInt($("context-menu").getStyle("width"),10);b=parseInt($("context-menu").getStyle("height"),10);d=15;if(c+a>e.width-d){$("context-menu").setStyle({left:(e.width-a-d)+"px"})}else{$("context-menu").setStyle({left:c+"px"})}if(f+b>e.height-d){return $("context-menu").setStyle({top:(e.height-b-d)+"px"})}else{return $("context-menu").setStyle({top:f+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();BrowseSelection.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}},disable_action:function(d,b){var c,a;a="#context-menu-container #"+d+"_button";c=$j(a);c.addClass("disabled");return c.click(function(f){b.show_disabled_action_warning(d);return false})}};var BROWSE_SNIPPET_LEN,Browse,BrowseUpdate,FILE_PPREVIEW_MODAL_FOR_DOCS,LAST_MODIFIED_FNAME_SNIPPET,SEARCH_SNIPPET_LEN;BROWSE_SNIPPET_LEN=25;SEARCH_SNIPPET_LEN=20;LAST_MODIFIED_FNAME_SNIPPET=4;FILE_PPREVIEW_MODAL_FOR_DOCS=false;Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:[Sort.FILES_BY_NAME,true],folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,init:function(b,g,d,f,a,e,c){this.browse_actions_ctor=g;this.global_actions_ctor=d;this.browse_actions_context_ctor=f;this.global_actions_context_ctor=a;this.ns_id_to_mount_point=e;assert(typeof c==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=Viewer.get_viewer().get_user_by_id(c);window.active_user_loaded=true;assert(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();dom.viewport_dimensions();if(Browser.chrome){this.browser_supports_previews=b&&Util.pdf_plugins().length}else{this.browser_supports_previews=b}if(Viewer.get_viewer().is_paired){SharingState.set_role(this.active_user.role)}return this.subscribe_sfj_callbacks={}},setup:function(b,g){var f,e,d,a,c;if(g==null){g=null}this.ns_id_to_mount_point=b.ns_id_to_mount_point;this.old_path_to_ns_id=b.old_path_to_ns_id;this.compiled_tmpl=HTML.tmpl("list_item_tmpl");this.compiled_search_tmpl=HTML.tmpl("search_list_item_tmpl");this.render_timeout=null;this.inside_dir=b.inside_dir;this.inside_deleted_dir=b.inside_deleted_dir;this.inside_shared_folder=b.inside_shared_folder;this.inside_read_only_shared_folder=b.inside_read_only_shared_folder;this.inside_sandbox=b.inside_sandbox;this.public_app_token=b.public_app_token;this.public_folder_enabled=b.public_folder_enabled;this.inside_deleted_sandbox=b.inside_deleted_sandbox;this.inside_deleted_shared_folder=b.inside_deleted_shared_folder;this.is_read_only=b.is_read_only;this.ns_map=b.ns_map;this.contents_cache_key=b.contents_cache_key;e="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(e)}else{$("browse").removeClassName(e)}this.block_hash=b.block_hash;this.block_hash_param=b.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=b.containing_ns_id;this._containing_ns_path=b.containing_ns_path;this._containing_fq_path=b.containing_fq_path;this._containing_mount_point=b.containing_mount_point;this.breadcrumb();c=[this.browse_actions,this.global_actions];for(d=0,a=c.length;d<a;d++){f=c[d];if(f!=null){f.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!b.file_info){this.show_message(_('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}return this._push_files(b.file_info,g)},_push_files:function(c,f){var b,d,e,a;if(f==null){f=null}for(e=0,a=c.length;e<a;e++){d=c[e];b=BrowseUtil.make_browsefile(d,f);b.track_in_browse()}return BrowseJump.update()},_get_helper:function(a){assert(this.inside_dir,"accessed "+a+", but not inside a directory");return Browse[a]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_fq_path:function(){return this._get_helper("_containing_fq_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},listen:function(){var b,f,m,i,h,e,k,c,a,l,j,g,d;$j("#fulltext-search-all-link").click(this.unscoped_search);$j("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","a.location-link",this.click.bind(this));$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",ContextMenu.show_for_file.bind(ContextMenu,this.browse_actions_context_ctor));this.enable_sorting();f="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover($("name-sorter"),true,f,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",ContextMenu.show_global.bind(ContextMenu,this.global_actions_context_ctor));document.observe(BrowseSelection.UPDATED_EVT,this.selection_handler.bind(this));document.observe(FileEvents.COPY,(function(n){return function(o){if(n.inside_dir&&o.memo.to_fq_path===n.containing_fq_path()){return n.force_reload()}}})(this));j=[FileEvents.MOVE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE,FileEvents.LINKS_ADD];for(i=0,k=j.length;i<k;i++){b=j[i];document.observe(b,(function(n){return function(o){if(n.inside_dir&&!(FileSearch.fulltext_search_enabled&&Browse.in_search_mode())){return n.force_reload()}}})(this))}g=[FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE];for(h=0,c=g.length;h<c;h++){b=g[h];document.observe(b,(function(n){return function(o){if(n.inside_dir){if(o.memo.target_ns_id===n.containing_ns_id()){if(o.memo.folder_deleted){return n.reload_fqpath("")}else{return n.reload_fqpath(n.containing_fq_path())}}else{return n.force_reload()}}}})(this))}d=[FileEvents.DELETE,FileEvents.PURGE];for(e=0,a=d.length;e<a;e++){b=d[e];document.observe(b,(function(n){return function(w){var t,v,p,u,o,r,s,q;if(n.inside_dir){if(w.eventName===FileEvents.PURGE||(w.eventName===FileEvents.DELETE&&!BrowseURL.get_del())){for(v=u=s=n.files.length-1;s<=0?u<=0:u>=0;v=s<=0?++u:--u){if(w.memo.files.indexOf(n.files[v])===-1){p=n.files[v]}else{break}}BrowseSelection.deselect_all();q=w.memo.files;for(r=0,o=q.length;r<o;r++){t=q[r];t.get_div().remove();n.files.removeItem(t)}if(n.files.length){if(p!=null){return BrowseSelection.set_selected_files(p)}else{return BrowseSelection.set_selected_files(n.files.last())}}else{return n.show_empty()}}else{if(n.keyboard_nav){n.select_fq_paths=[n.containing_fq_path()+"/"+w.memo.files.last().filename]}if(Lightbox.shown){return Lightbox.reload=true}else{return n.force_reload()}}}}})(this))}document.observe(ContextMenu.SHOW_EVT,this.disable_sorting.bind(this));document.observe(ContextMenu.HIDE_EVT,this.enable_sorting.bind(this));l=function(){var o,n;o=$("browse-header");n=o.cumulativeOffset().top+o.getHeight();return dom.viewport_dimensions().height-n};key("pagedown",this.KEY_SCOPE,(function(n){return function(o){Event.extend(o).preventDefault();return window.scrollBy(0,l())}})(this));key("pageup",this.KEY_SCOPE,(function(n){return function(o){Event.extend(o).preventDefault();return window.scrollBy(0,-1*l())}})(this));m=function(){var n;n=Browse.in_search_mode()?FileSearch:Browse;if(Browse.files.length===0){return n.show_empty()}else{return n.hide_empty()}};document.observe(UpdateEvents.ADD,(function(n){return function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];n.insert_file(p,true)}return m()}})(this));document.observe(UpdateEvents.REMOVE,(function(n){return function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];n.remove_file(p)}return m()}})(this));return document.observe(UpdateEvents.MOVE,(function(n){return function(u){var w,t,v,x,r,o,q,p,s;t=n.in_search_mode()&&FileSearch.fulltext_search_enabled;q=u.memo.files;s=[];for(r=0,o=q.length;r<o;r++){p=q[r],w=p[0],x=p[1];if(t){if(w!=null){v=n.get_file_pos(w)}else{continue}}n.remove_file(w);n.insert_file(x);if(t&&v>=0){s.push(n.update_file_pos(x,v))}else{s.push(void 0)}}return s}})(this))},add_subscribe_sfj_callback:function(a){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=a},remove_sfj_callback:function(a){return delete this.subscribe_sfj_callbacks[a]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(c,f){var a,d,b;b=$(c.target);if(b.match("a.filename-link")||b.match("img.icon")||b.up("a.filename-link")){this._click(c,f)}if(b.match("a.location-link")){a=BrowseFile.from_elem(f);if(a){d={file_nsid:a.ns_id,file_sjid:a.sjid,firefly:FileSearch.fulltext_search_enabled,match_type:a.match_type,position:a.sort_rank,request_id:a.request_id,viewport:"full-view",action_type:"click_path_link"};return analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,d)}}},dblclick:function(a,b){if($(a.target).match("a")){return}return this._click(a,b)},open_file:function(d,a,b){var e,g,c,f;if(b==null){b=false}c={mode:"get",file_ext:FilePath.file_extension_for_logging(d.filename),file_bytes:d.bytes};g={file_nsid:d.ns_id,file_sjid:d.sjid,firefly:FileSearch.fulltext_search_enabled,match_type:d.match_type,position:d.sort_rank,request_id:d.request_id,viewport:b?"dropdown-view":"full-view"};if(d.dir){if(this.in_search_mode()||b){g.action_type="folder_open";analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,g)}if(a){return this.open_folder_in_new_window(d)}else{return this.open_folder(d)}}else{if(!a&&!((d.preview_type==="video")&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX)){if(this.browser_supports_previews||((f=d.preview_type)==="photo"||f==="video")){if(this.in_search_mode()||b){g.action_type="file_view";analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,g)}return this.open_preview(d,e=true,b)}else{if(this.in_search_mode()||b){g.action_type="file_view";analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,g)}analytics.UserActivityLogger.log("web","file_view",Object.toJSON(c));return window.open(d.href,"_blank")}}else{if(this.in_search_mode()||b){g.action_type="file_view";analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,g)}analytics.UserActivityLogger.log("web","file_view",Object.toJSON(c));return window.open(d.href,"_blank")}}},close_preview_callback:function(){$j(document).off("db:filepreview:close",this.close_preview_callback);document.stopObserving(Lightbox.EXIT_SELECT_EVT,this.close_preview_callback);BrowseSharedLink.close_shared_link_view();return Browse.set_title()},open_preview:function(c,d,b){var a,f,e;if(d==null){d=false}if(b==null){b=false}f=c.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;a=this.browser_supports_previews||((e=c.preview_type)==="photo"||e==="video");if(!f&&a){BrowseUtil.filepreview_from_selected("fileclick",c,!d,b);$j(document).on("db:filepreview:close",this.close_preview_callback);return document.observe(Lightbox.EXIT_SELECT_EVT,this.close_preview_callback)}},_click:function(c,d){var b,a;this.keyboard_nav=false;b=BrowseFile.from_elem(d);if(b.editing){return}a=(c.which===2)||(Util.is_mac()&&c.metaKey);Browse.open_file(b,a);c.preventDefault()},crumb_click:function(d,a){var c,b;this.keyboard_nav=false;d.preventDefault();b=a.readAttribute("data-fq_path");c=this.details_from_fq_path(b);return BrowseURL.set_path_url(c.ns_id,c.ns_path)},parent_click:function(f,d){var c,g,a,b;this.keyboard_nav=false;f.preventDefault();b=d.readAttribute("data-parent_ns_path");a=parseInt(d.readAttribute("data-parent_ns_id"),10);BrowseURL.set_path_url(a,b);c=BrowseFile.from_elem(d);if(c){g={file_nsid:c.ns_id,file_sjid:c.sjid,firefly:FileSearch.fulltext_search_enabled,match_type:c.match_type,position:c.sort_rank,request_id:c.request_id,viewport:"full-view",action_type:"click_path_link"};return analytics.SearchClientActivityLogger.log("result_action",Browse.active_user.id,g)}},selection_handler:function(){if(BrowseSelection.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var a,b,d,c;if(FileSearch.fulltext_search_enabled&&this.in_search_mode()&&!FileSearch.end_of_results){c=BrowseUtil.get_files_in_view(),d=c[0],b=c[1];a=this.files.length-(d+b);if(a<=50&&!$("browse").hasClassName("pending-search")){FileSearch.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(BrowseUtil.load_visible_thumbs.bind(BrowseUtil),this.POST_SCROLL_WAIT)},unscoped_search:function(){return FileSearch.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var b,a;this.last_sort=[Sort.FILES_BY_NAME,true];a="#browse-sort a.sortable-column-header";b=$$(a)[0];Util.add_sort_arrow_mouseover(b,true,a,false);$("kind-sorter-label").__date(FlexColumn.DISPLAY.FILES_BY_KIND);return Sprite.src(b.down("img"),"web","arrow-up-gray")},sort_handler:function(h,i,d){var f,a,g,b,j,c;i=$(i);i.blur();f=i.readAttribute("data-sort");if(d==null){d=this.last_sort[0]===Sort[f]?i.readAttribute("data-ascending")==="false":true}if(FlexColumn.LABELS.indexOf(f)!==-1){j=FlexColumn.SORT_FUNCTIONS.indexOf(this.last_sort[0])!==-1;if(j){g=(FlexColumn.LABELS.indexOf(f)+1)%FlexColumn.LABELS.length;f=FlexColumn.LABELS[g];a=FlexColumn.DISPLAY[f];$("kind-sorter-label").__date(a)}i.writeAttribute("data-sort",f);d=FlexColumn.IS_ASC[f]}else{i.writeAttribute("data-ascending",(d?"true":"false"))}c="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover(i,d,c,true);b=Sort[f];this.sort(b,d);if(h){return h.stop()}},toggle_deleted:function(){var a;a=!BrowseURL.get_del();return BrowseURL.set_del_url(a)},new_folder:function(){var c,d,q,i,b,f,j,p,a,e,l,o,k,n,g,m,h;if(this.reloading||this.creating_folder){return}this.hide_empty();this.selectable();d=_("New folder");b=[];h=this.files;for(g=0,m=h.length;g<m;g++){f=h[g];if(f.dir&&f.filename.indexOf(d)!==-1){b.push(f.filename)}}p=d;c=1;while(true){if(b.indexOf(p)===-1){break}p=d+" ("+c+")";c++}n=HTML.tmpl("new_folder_tmpl",{name:p});j=-1;if(this.files.length){k=dom.scroll_offsets();if(k.top>0){o=this.files[0].get_div().getLayout().get("margin-box-height");j=Math.floor(k.top/o)}}if(j>0){this.files[j].get_div().__sert({after:n})}else{$("browse-files").__sert({top:n})}a=$$("#browse-files .browse-new-folder .name").first();assert(a!=null,"expected new_folder_name to be defined");q=this.containing_fq_path();l=(function(r){return function(u){var t,s,v;v=u.responseText.evalJSON(true);assert(v.new_browse_files.length===1,"No new file data returned.");t=FilePath.filename(v.new_browse_files.first().fq_path);s=_("Created folder '%(folder_name)s'");s=s.format({folder_name:Emstring.em_snippet(t,25)});Notify.success(s);r.select_fq_paths=[v.new_browse_files.first().fq_path];return r.force_reload()}})(this);e=(function(r){return function(t){var s;s=$$("#browse-files li.browse-new-folder").first();if(s){s.remove()}return r.creating_folder=false}})(this);i=new Ajax.InPlaceEditor(a,"/cmd/new"+(Util.urlquote(q)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:e,savingText:_("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:l,subject_user:Browse.active_user},callback:(function(r){return function(s,t){r.creating_folder=true;return{to_path:t||"",folder:"yes"}}})(this)});return i.enterEditMode()},open_folder:function(b){var d,a,c;assert(b.dir,"Only open directories, not files");if(Browse.inside_dir&&Browse.containing_ns_path()===b.ns_path&&!(this.in_search_mode()&&FileSearch.fulltext_search_enabled)){return}if(!(BrowseSelection.get_selected_files().length===1&&BrowseSelection.get_selected_files().indexOf(b)===0)){BrowseSelection.deselect_all();d=b.get_div();if(d){d.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(e){return function(){var f;f=_("Loading %(filename)s...");f=f.format({filename:Emstring.em_snippet(b.filename,50)});return e.folder_loading_notification=Notify.success(f,60,true)}})(this),1000);if(b.target_ns){a=b.target_ns;c=""}else{a=b.ns_id;c=b.ns_path}if(b.is_deleted){return BrowseURL.set_path_url(a,c,true)}else{return BrowseURL.set_path_url(a,c)}},open_folder_in_new_window:function(a){return window.open(BrowseURL._make_url(a.ns_id,a.ns_path),"_blank")},show_message:function(c){var b,a;if((typeof c)!==(typeof"string")){a=$("browse-files").down(".browse-message");if(a){a.show()}return}this.msg=c;b=new Element("div",{"class":"browse-message"});b.__date(c);return $("browse-files").__sert(b)},sort:function(a,d,c){var b;if(!c&&a===this.last_sort[0]&&d===this.last_sort[1]){return}this.last_sort=[a,d];b=a(d);this.files.sort(b);this.smartfill();return BrowseUtil.load_visible_thumbs()},resort:function(){var c,a,b;a=this.last_sort;b=a[0];c=a[1];return this.sort(b,c,true)},in_search_mode:function(){return $("browse").hasClassName("search")},flex_column:function(){return $("kind-sorter").readAttribute("data-sort")},smartfill:function(){var b,e,c,f,d,h,a,g;b=$("browse-files");d=[];f=this.in_search_mode();g=this.files;for(h=0,a=g.length;h<a;h++){e=g[h];c=this.flex_column();d.push(this.compiled_tmpl({file:e,in_search_mode:f,flex_column:c,sharing_growth_experiments_variant:Browse.sharing_growth_experiments_variant,share_link_icon_src:BrowseUtil.get_shared_link_icon()}))}b.__date(d);document.fire(this.RENDER_EVT);return $j(document).trigger(this.RENDER_EVT)},search_smartfill:function(d,i){var e,h,c,b,g,a;if(i==null){i=null}b=[];for(g=0,a=d.length;g<a;g++){e=d[g];c=BrowseUtil.make_browsefile(e,i);c.track_in_browse();h=$j((this.compiled_search_tmpl({file:c})).toHTML());b.push(h)}$j("#browse-files").append(b);document.fire(this.RENDER_EVT);$j(document).trigger(this.RENDER_EVT);return BrowseUtil.load_visible_thumbs()},add_file:function(a){this.files.push(a);if(a.target_ns){Browse.ns_id_to_mount_point[a.target_ns]=a.fq_path}if(a.bytes<0){return this.deleted_shown=true}},insert_file:function(c,b){var a;if(!c){return}b=b||0;a=this.find_file(c.fq_path);if(a&&a!==c){this.remove_file(a);BrowseFile._file_index[c.to_key()]=c}this.update_file_pos(c);if(b){c.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(a){return Browse._push_files(a.file_info)},get_file_pos:function(a){var b;b=this.files.indexOf(a);assert(b!==-1,"file not present in @files");assert(a.to_key() in BrowseFile._file_index,"file not present in BrowseFile._file_index");return b},remove_file:function(a){var b;if(!a){return}b=this.files.indexOf(a);if(b!==-1){this.files.splice(b,1);delete BrowseFile._file_index[a.to_key()];return a.get_div().remove()}},update_file_pos:function(f,h){var a,j,d,e,g,c,b,i;if(h==null){h=-1}i=this.files.indexOf(f);if(i!==-1){this.files.splice(i,1)}delete f.sort_rank;c=this.last_sort[0];g=this.last_sort[1];if(h>=0){i=h}e=this.in_search_mode()&&FileSearch.fulltext_search_enabled?i:Util.bsearch(this.files,f,c(g),true);this.files.splice(e,0,f);d=f.get_div();a=$("browse-files");if(d){d.remove()}if(this.in_search_mode()&&FileSearch.fulltext_search_enabled){b=this.compiled_search_tmpl({file:f})}else{b=this.compiled_tmpl({file:f,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),sharing_growth_experiments_variant:Browse.sharing_growth_experiments_variant,share_link_icon_src:BrowseUtil.get_shared_link_icon()})}j=a.childElements();if(e<j.length){return a.childElements()[e].__sert({before:b})}else{return a.__sert(b)}},find_file:function(a){return this.files.find(function(b){return b.fq_path.toLowerCase()===a.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];BrowseFile._file_index={};return BrowseDrag._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return FileSearch.hide_empty()},show_empty:function(){var b,a;if(this.is_read_only){if((b=$("browse-empty-drag-prompt"))!=null){b.hide()}}else{if((a=$("browse-empty-drag-prompt"))!=null){a.show()}}if(!(Browse.in_search_mode()&&FileSearch.fulltext_search_enabled)){return $("browse-empty").show()}},hide_empty:function(){return $("browse-empty").hide()},update:function(a,b){if(b==null){b=null}$("browse-box").show();if(FileSearch.fulltext_search_enabled&&this.in_search_mode()){return this.search_smartfill(a.file_info,b)}else{this.clear();if(typeof a==="string"){this.setup(JSON.parse(a),b)}else{this.setup(a,b)}this.resort();document.fire(this.UPDATE_EVT);return $j(document).trigger(this.UPDATE_EVT)}},reload_fqpath:function(b,a){return this.reload(null,Util.urlquote(b),a)},force_reload:function(){return this.reload(this.containing_ns_id(),Util.urlquote(this.containing_ns_path()),true)},set_title:function(){var a;if(Browse.in_search_mode()){FileSearch.set_title();return}if(!Browse.inside_dir){return}a=this.containing_fq_path();return document.title=a?FilePath.filename(a)+" - Dropbox":Viewer.get_viewer().is_paired&&Browse.active_user.role===Constants.ROLE_WORK?Viewer.get_viewer().team_name+" - Dropbox":Viewer.get_viewer().is_paired&&Browse.active_user.role===Constants.ROLE_PERSONAL?_("Personal")+" - Dropbox":_("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(i){var c,b,g,f,a,d,e,h;a=i.select_fq_paths;d=i.select_index;if(a||d>-1){b=[];if(a){for(e=0,h=a.length;e<h;e++){g=a[e];f=this.find_file(g);if(f){b.push(f)}}}if(!b.length&&d>-1){c=this.files[d];if(c){b.push(c)}}if(b.length){BrowseSelection.set_selected_files(b);this.scrollToWithPadding(b.first().get_div(),100)}i.select_fq_paths=false;return i.select_index=-1}else{if(!FileSearch.fulltext_search_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var b,h,e,k,f,d,j,a,g,c;if(this.select_item_counters!=null){e={};g=this.select_item_counters;for(f=0,j=g.length;f<j;f++){h=g[f];e[h]=true}k=[];c=this.files;for(d=0,a=c.length;d<a;d++){b=c[d];if(b.root_coll_item_counter in e){k.push(b)}}BrowseSelection.set_selected_files(k);return this.select_item_counters=null}},reload:function(d,i,b){var k,e,j,c,g,f,h,a;c="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+i+")";assert(i.search(DBHistory.URL_ESCAPE_REGEX)===-1,c);if(d==null){d=Browse.active_user.root_ns}i=FilePath.normalize(i);if(BrowseUtil.get_mode()!==BrowseUtil.BROWSE_MODE){this.clear();BrowseUtil.set_browse_mode()}if(FileSearch._clear_on_reload){FileSearch.clear_searchbox()}if(!FileQueue.uploading){InlineUploadStatus.hide()}if(this.reloading){return}if(this.inside_dir&&i===this.containing_ns_path()&&d===this.containing_ns_id()&&!b){return}h=this.first_load?Constants.referrer:"";j=this.deleted_shown?"?show_deleted=yes":"";f={ns_id:d,referrer:h};f=Object.extend(f,this.extra_reload_args);T("Browse.reload:",i);this.reloading=true;a="/browse"+i+j;k=2;e=["browse",d,i,j,Browse.active_user.id,k];g=(function(l){return function(m){l.reset_state();l.update(m);(l.files.length?l.hide_empty.bind(l):l.show_empty.bind(l))();clearTimeout(l.folder_loading_timeout);if(Notify.isShown()&&Notify.current()===l.folder_loading_notification){Notify.clear()}dom.scroll_clear_cache();l.set_selection_from_fq_paths_or_index(Browse);if(!FileViewer.shown){return l.set_title()}}})(this);new Ajax.DBRequest(a,{allow_retries:true,subject_user:Browse.active_user,parameters:f,log_timing:true,on304:(function(l){return function(m){}})(this),onSuccess:(function(l){return function(q){var t,p,n,s,o,r,m;if(l.in_search_mode()){return}p=JSON.parse(q.responseText);o=null;s=null;g(p);if(o){n=[];for(r=0,m=o.length;r<m;r++){t=o[r];n.push(Browse.find_file(t.fq_path))}BrowseSelection.set_selected_files(n);return window.scrollTo(s[0],s[1])}else{return Browse.set_selection_from_item_counters()}}})(this),onFailure:(function(l){return function(){Lightbox.update_with_error();if(l.first_load){l.reload.bind(l).defer(Constants.root_ns,"")}return clearTimeout(l.folder_loading_timeout)}})(this),cleanUp:(function(l){return function(){l.first_load=false;return l.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return Browse.inside_shared_folder&&Browse.containing_ns_path()},is_shmodelable_path:function(a){var b;if(Browse.public_app_token){return false}if(a===""){return false}if(Browse.public_folder_enabled){b=a.toLowerCase();if(b.startsWith("/public/")){return false}}return true},can_get_details_from_fq_path:function(c){var b,a;b=this.containing_fq_path();a=this.containing_mount_point();return(a&&c.startsWith(a))||b.startsWith(c)},details_from_fq_path:function(d){var e,b,a,c;assert(this.can_get_details_from_fq_path(d));b=this.containing_mount_point();if(b&&d.startsWith(b)){a=this.containing_ns_id();c=d.slice(b.length);e=FilePath.filename(d,this._get_root_name())}else{a=Constants.root_ns;c=d;e=FilePath.filename(d,this._get_root_name())}return{ns_id:a,ns_path:c,fq_path:d,folder_name:e||this._get_root_name(),url:""+(Util.get_browse_root(Browse.active_user))+d,icon:(d.length?"folder_32":this._get_root_icon())}},update_header_status:function(a){return $j("#browse-header-status").text(a)},_make_breadcrumbs_data:function(){var f,g,b,e,a,d,c;g=this.containing_fq_path();f=[];a=g.split("/");for(b=d=0,c=a.length;0<=c?d<c:d>c;b=0<=c?++d:--d){e=FilePath.normalize(a.slice(0,b+1).join("/"));f.push(this.details_from_fq_path(e))}return f},_get_root_icon:function(){if(!Viewer.get_viewer().is_paired){return"glyph"}if(Browse.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(Browse.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return Viewer.get_root_name(Browse.active_user)},_get_max_breadcrumb_width:function(d){var b,c,a;c=d?this._DROPDOWN_WIDTH:new Emstring(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){b=$j("#browse-rightmenu").width();a=$j("#browse-global-actions-bar").width();return((a-b)*this._FUDGE_FACTOR/this._PX_TO_EM)-c}else{return this._MAX_BREADCRUMB_WIDTH-c}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var k,b,d,l,g,j,a,m,h,c,e,f;b=this._make_breadcrumbs_data();c=b.collect(function(i){return new Emstring(i.fq_path?i.folder_name:"").length});h=0;d=0;assert(b.length>0,"expected at least one breadcrumb");m=this._get_max_breadcrumb_width();for(g=e=f=b.length-1;f<=0?e<=0:e>=0;g=f<=0?++e:--e){h+=c[g];if(h>m){break}d+=1;h+=this._CONNECT_WIDTH}l=b.slice(0,b.length-Math.max(1,d));b=b.slice(l.length,b.length);if(!l.length&&b.length>1){b.shift()}j=b.pop();k=HTML.tmpl("breadcrumb_tmpl",{breadcrumbs:b,dropdown:l,containing_fq_path:this.containing_fq_path(),url_root:Util.get_browse_root(Browse.active_user),root_name:this._get_root_name()});a=j.folder_name;if(j.fq_path!==""){a=Emstring.em_snippet(a,this._get_max_breadcrumb_width(l.length>1))}$("browse-location").__date(k);$("browse-location").__sert(" "+a);if(l.length>1){return this._render_breadcrumbs_dropdown(l)}},_render_breadcrumbs_dropdown:function(e){var a,c,b,d;a=$("breadcrumbs-box");e.reverse();b=HTML.tmpl("breadcrumb_li_tmpl",{breadcrumbs:e});$("browse-location").__sert(b);c=$("breadcrumb-dropdown");d=(function(f){return function(h){var g;h.stopPropagation();c.show();g=$j(a);return $j(c).clonePosition(g,{setWidth:0,setHeight:0,offsetTop:g[0].offsetHeight,offsetLeft:parseInt(g.css("padding-left"),10)})}})(this);a.observe("click",d);a.observe("dragover",d);return document.observe("click",(function(f){return function(){a.removeClassName("down");return c.hide()}})(this))},viewportOffset:function(){var a,c,b;if(!this.files.length){return}if(!this.div_parent){c=this.files[0].get_div().offsetParent;if(!c){return}this._viewportOffset={};this.div_parent=$(c);this._cumulativeOffset=this.div_parent.cumulativeOffset()}a=Util.scrollLeft(this.div_parent);b=Util.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==b||this.scrollLeft!==a){this._viewportOffset.top=this._cumulativeOffset.top-b;this._viewportOffset.left=this._cumulativeOffset.left-a;this.scrollLeft=a;this.scrollTop=b}return this._viewportOffset},selectable:function(){return Util.enableSelection($("browse-files"))},unselectable:function(){return Util.disableSelection($("browse-files"))},_header_offset:(function(){var a;a=$("browse-header");return a.getHeight()+a.cumulativeOffset().top}).cached(1000),scrollTo:function(a){return this.scrollToWithPadding(a,3)},scrollToWithPadding:function(d,f){var c,g,b,e,a;if(!d){return}e=dom.viewport_dimensions();a=dom.scroll_offsets();g=d.cumulativeOffset().top-a.top;c=d.getHeight();b=this._header_offset();if(g<b){dom.scroll_to(0,a.top+g-b-f)}else{if(g+c>e.height){dom.scroll_to(0,a.top+g+c-e.height+f)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return Modal.fix_position()}}};BrowseUpdate=(function(){var a,h,g,d,f,e,c,b;c=function(j){var k,l,i;if(!Browse.inside_dir){return}l=j.parent_changes;if(l.change_to_fq_path!=null){if(l.change_type==="moved"){if(l.is_changing_view){k=_("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been moved")}}else{if(l.change_type==="renamed"){if(l.is_changing_view){k=_("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been renamed to '%s'.");i=l.change_to_fq_path.split("/");k=k.format(i[i.length-1].escapeHTML())}}else{k=_("The folder '%s' has been deleted.");k=k.format(l.old_fq_path.escapeHTML())}}if(l.is_changing_view){Notify.error(new HTML(k))}else{if(l.old_fq_path===Browse.containing_fq_path()){Notify.success(new HTML(k))}}Browse.reload_fqpath(l.change_to_fq_path);return}return e(j)};b=function(n){var j,q,p,i,s,o,l,r,m,k;q=[];o=[];if(!Browse.in_search_mode()){return}FileSearch.clear_cache();for(i in Browse.ns_id_to_mount_point){if(!(i in n.mount_points)){n.mount_points[i]=null}}m=n.mount_points;for(i in m){p=m[i];i=parseInt(i,10);s=Browse.ns_id_to_mount_point[i];if(p===s){continue}if(p){Browse.ns_id_to_mount_point[i]=p}else{delete Browse.ns_id_to_mount_point[i]}k=Browse.files;for(l=0,r=k.length;l<r;l++){j=k[l];if(j.fq_path.indexOf(s)===0&&j.target_ns!==i){if(p){j.fq_path=p+j.fq_path.slice(s.length);j.href=Util.get_browse_root(Browse.active_user)+p+j.href.slice(5+s.length);q.push([j,j])}else{o.push(j)}}}}return e(n,[],o,q)};e=function(F,q,z,p){var t,o,A,u,y,v,x,w,C,r,l,j,i,B,E,D,s,n,m,k;if(q==null){q=[]}if(z==null){z=[]}if(p==null){p=[]}s=F.added;for(l=0,B=s.length;l<B;l++){A=s[l];o=FilePath.normalize(FilePath.parent_dir(A.ns_path));if(Browse.in_search_mode()||(A.ns_id===Browse.containing_ns_id()&&o===Browse.containing_ns_path())){t=BrowseUtil.make_browsefile(A);t.track_in_browse();q.push(t)}}n=F.removed;for(j=0,E=n.length;j<E;j++){u=n[j];z.push(Browse.find_file(u))}m=F.moved;for(i=0,D=m.length;i<D;i++){k=m[i],y=k[0],r=k[1];C=FilePath.normalize(FilePath.parent_dir(r.ns_path));w=null;x=Browse.in_search_mode()||(r.ns_id===Browse.containing_ns_id()&&C===Browse.containing_ns_path());v=Browse.in_search_mode()&&FileSearch.fulltext_search_enabled;if(x&&!(v&&Browse.find_file(r.ns_path))){w=BrowseUtil.make_browsefile(r);w.track_in_browse()}p.push([Browse.find_file(y),w])}document.fire(UpdateEvents.ADD,{files:q});$j(document).trigger(UpdateEvents.ADD,{files:q});document.fire(UpdateEvents.MOVE,{files:p});BrowseUtil.load_visible_thumbs();return f(q,z,p)};a=function(l,j,k,i){l.css("background","");$j(document).trigger("db:browse:update_rendered");return document.fire(UpdateEvents.REMOVE,{files:k})};f=function(s,r,t){var k,v,p,w,o,n,l,u,j,i,q,m;p=(s.length+r.length)<=10;for(o=0,u=s.length;o<u;o++){k=s[o];if(!(k&&k.get_div())){continue}h(k,p,s,r,t)}for(n=0,j=r.length;n<j;n++){k=r[n];if(!(k&&k.get_div())){continue}d(k,p,s,r,t)}m=[];for(l=0,i=t.length;l<i;l++){q=t[l],v=q[0],w=q[1];if(v){d(v,p,s,r,t)}if(w){m.push(h(w,p,s,r,t))}else{m.push(void 0)}}return m};g=function(i){var j;j=BrowseSelection.is_selected(i)?"#83B8DC":"#CCEAFF";return $j(i.get_div()).css("background-color",j)};d=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.show().slideUp("normal",function(){return a(n,k,m,j)})}else{n.hide();return a(n,k,m,j)}};h=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.hide().slideDown("normal",function(){return a(n,k,m,j)})}else{n.show();return a(n,k,m,j)}};return{init:function(){var k,j,i;i=NOTCLIENTS[Browse.active_user.id];k=(function(l){return function(){return Lightbox.refresh_file_list(Browse.files)}})(this);document.observe(Browse.UPDATE_EVT,k);return j=i.subscribe_sfj({name:"BrowseUpdater",handler:function(){var t,o,q,s,p,u,n,m,l,r;u=Browse.in_search_mode();t=u?b:c;l=u?"/update/list_search":"/update/list_dir";if(!(Browse.inside_dir||u)){i.handler_failure(j);return}if(u){m=FileSearch.get_state();if(m.is_advanced){p=m}else{p={all_terms:m.query}}}else{p={fq_dir:Browse.containing_fq_path(),show_deleted:Browse.deleted_shown}}p.ns_map=((function(){var w,v;w=i.get_ns_map();v=[];for(s in w){n=w[s];v.push(""+s+"_"+n)}return v})()).join(",");assert(Browse.active_user,"No active_user was set before calling "+l+". Active user loaded? "+(window.active_user_loaded||false)+". Error before loading? "+(window.an_error_happened_before_loading||false)+". Error after loading? "+(window.an_error_happened_after_loading||false)+".",true,[],false);r=Browse.subscribe_sfj_callbacks;for(q in r){o=r[q];o()}return new $j.ajax(l,{data:p,dataType:"json",type:"POST",subject_user:Browse.active_user,success:(function(v){return function(w){t(w);return i.handler_success(j,{ns_map:w.ns_map})}})(this),error:function(){return i.handler_failure(j)}})}})}}})();var FileEvents;FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add"};var ProgressWatcher;ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(a,e){var d,c,b;if(a.async_task_id){if(!a.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}c=a.async_task_id}else{c=a.job_id}ProgressWatcher.job_info[c]={};d=ProgressWatcher.job_info[c];d.subject_user=a.subject_user||((b=a.parameters)!=null?b[Constants.UID_PARAM_NAME]:void 0);d.req=a;d.is_async_task=!!a.async_task_id;d.poll_int=ProgressWatcher.INIT_POLL_INT;d.poll_count=0;d.int_id=setInterval(ProgressWatcher.update_for(c),d.poll_int);d.failures=0;d.start_time=datetime.time();return d.dont_hide=e},update_for:function(a){return function(){return ProgressWatcher.update(a)}},backoff:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);a.poll_int=Math.min(Math.floor(a.poll_int*1.5),30000);return a.int_id=setInterval(ProgressWatcher.update_for(b),a.poll_int)},update:function(c){var a,b;b=ProgressWatcher.job_info[c];if(Job.peek(c)){return ProgressWatcher.done(c)}b.poll_count++;if(b.poll_count%10===0){ProgressWatcher.backoff(c)}if(!b.modaled&&datetime.time()-b.start_time>ProgressWatcher.MODAL_WAIT_MS){a=b.req.options;ModalProgress.show(a.progress_text);a.onProgress=ModalProgress.update;if(a.on_modal_shown!=null){a.on_modal_shown()}b.modaled=true}if(b.is_async_task){return ProgressWatcher.get_async_task_status(c)}else{return ProgressWatcher.get_job_status(c)}},get_job_status:function(a){return new Ajax.DBRequest("/job_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},subject_user:ProgressWatcher.job_info[a].subject_user,onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(b.indexOf("err")===0){ProgressWatcher.done(a);if(d.req.options.onFailure&&!Job.handled(a)){d.req.options.onFailure(c)}return}if(b.indexOf("done")===0){d.req.options.job=false;if(!Job.peek(a)){new Ajax.Request("/job_results/"+a,{method:"post",parameters:{t:Constants.TOKEN},onSuccess:function(f){if(Job.handled(a)){return}RequestWatcher.clearWorkingMessage();if(d.req.options.onSuccess){return d.req.options.onSuccess(f)}},onFailure:function(f){if(Job.handled(a)){return}RequestWatcher.clearWorkingMessage();if(d.req.options.onFailure){return d.req.options.onFailure(f)}}})}return ProgressWatcher.done(a)}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){if(c.req.options.onFailure){c.req.options.onFailure(b,true)}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},get_async_task_status:function(a){return new Ajax.DBRequest("/async_task_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},subject_user:ProgressWatcher.job_info[a].subject_user,onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(b.indexOf("done:")===0||b.indexOf("err:")===0){Job.handled(a);RequestWatcher.clearWorkingMessage();if(b.indexOf("done:")===0){c.responseText=b.substr(5)}if(d.req.options.onSuccess){d.req.options.onSuccess(c)}if(d.req.options.onComplete){d.req.options.onComplete(c)}return ProgressWatcher.done(a)}else{if(b.indexOf("async_task_err:")===0){Notify.error(new HTML(b.substr(15)));Job.handled(a);RequestWatcher.clearWorkingMessage();ProgressWatcher.done(a);return Browse.force_reload()}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){try{if(c.req.options.onFailure){c.req.options.onFailure(b,true)}}catch(d){}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},done:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);if(!a.dont_hide){delete ProgressWatcher.job_info[b];if(!(a.req.async_task_id&&a.req.async_task_id!==b)){return ModalProgress.hide(b)}}else{return ModalProgress.update("1/1")}}};var EventDatePicker,Events,NamespaceEvents,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};NamespaceEvents=(function(){function a(b){this.ns_id=b;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return a})();EventDatePicker=(function(){function a(c){var b,d,e;this.on_change=c;$j(document.body).on("click",(function(f){return function(g){return f.hide_calendar(g)}})(this));e=new Element("div",{id:"cal_container"});$j(e).bind("click",function(f){return f.preventDefault()});$j(document.body).append(e);this.calendar=new DBCalendar("cal_container",{onDateChange:(function(f){return function(g){return f.on_change(g)}})(this),disable_future:true});$j(e).css("position","fixed");d=$j("#cal_date");b=$j("#cal_container");b.clonePosition(d,{setWidth:false,setHeight:false,offsetTop:d.height(),offsetLeft:d.width()-b.children().first()[0].offsetWidth});this.hide_calendar()}a.prototype.show_calendar=function(b){if(this.shown){$j("#cal_container").hide();this.shown=false;return}$j("#cal_container").show();return this.shown=true};a.prototype.hide_calendar=function(b){if(b&&$j(b.target).closest("#cal_date").length>0){return}$j("#cal_container").hide();this.shown=false;return true};return a})();Events={ns:null,role:"all",now:Number(new Date()),timestamp:Util.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(a,f,g,c){var d,e,b;b=DBHistory.deconstruct_url();this.first_event_map=a;this.roles=f;this.rss_data=g;this.role_has_events=c;this.role_picker=$j("#role-selector").controller();if(this.roles.length===1){this.role=this.roles[0].role}else{if(b.qargs.role){this.role=b.qargs.role;this.role_picker.set_state(this.role)}}this.date_picker=new EventDatePicker((function(h){return function(i){h.change_date(i);h.set_url();return analytics.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(h){return function(){h.role=h.role_picker.get_state();if(h.ns&&!$u(h.valid_roles()).any(function(i){return i.ns_ids.contains(h.ns.ns_id)})){h.ns=null;ULSelectMenu.set_selected_by_value($j("#namespace-list")[0],"false")}h.set_url();return h.get_more(true)}})(this);MultiaccountLogin.set_during_login_callback((function(h){return function(j,i){return window.location.reload()}})(this));$j(window).bind("beforeunload",(function(h){return function(){h.user_navigated_away=true;return void 0}})(this));if($j("#namespace-list-container")[0]){$j("#namespace-list-container")[0].observe("db:change",(function(h){return function(i){h.ns=h.namespaces[JSON.parse(i.memo)];h.set_url();h.get_more(true);return analytics.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}$j(window).on("scroll",(function(h){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-dom.viewport_dimensions().height-10);return h.get_more()}})(this));if(b.qargs.ns){ULSelectMenu.set_selected_by_value($j("#namespace-list")[0],b.qargs.ns);this.ns=this.namespaces[b.qargs.ns]}if(b.qargs.date){e=b.qargs.date.split("-").map(Number);d=new Date(e[2],e[1]-1,e[0]);this.date_picker.calendar.selected_date=d;this.change_date(d)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var b,e,h,f,d,c,g,a;this.namespaces={};g=$u(this.roles).values();for(h=0,d=g.length;h<d;h++){e=g[h];a=e.ns_ids;for(f=0,c=a.length;f<c;f++){b=a[f];this.namespaces[b]=new NamespaceEvents(b)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(a){this.timestamp=Number(a)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}$j("#cur_date_text").text(DateUtil.localize(a));return this.get_more(true)},is_scrolled_down:function(){var a,c,b;b=dom.scroll_offsets().top;c=dom.viewport_dimensions().height;a=$j("#events").height();return b+c+50>=a},get_more:function(c){var a,b;if(this.request_in_flight){return}if($u(this.valid_nss()).all(function(d){return d.done})){this.render();return}if(!(c||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();b=(function(d){return function(){return $u(d.valid_nss()).map(function(e){return e.ns_id}).join(",")}})(this);a=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:{page_size:25,ns_ids:b(),timestamp:a},onSuccess:(function(d){return function(r){var p,f,s,h,q,n,m,j,t,g,e,o,l,i,k;p=JSON.parse(r.responseText);d.request_in_flight=false;o=p.events;for(n=0,t=o.length;n<t;n++){f=o[n];f.html=$j(f.html)[0];q=f.pkey+" "+(f.html.textContent||f.html.innerText);s=d.namespaces[f.ns_id];if(!s.seen[q]){s.events.push(f);s.seen[q]=true;s.earliest=f.timestamp}}if(p.events.length>0){l=p.ns_ids;for(m=0,g=l.length;m<g;m++){h=l[m];d.namespaces[h].earliest=$u(p.events).map(function(u){return u.timestamp}).min()}}d.render();if(p.events.last()){return d.get_more()}else{if($u(p.ns_ids).join(",")!==b()){return d.get_more()}else{i=p.ns_ids;k=[];for(j=0,e=i.length;j<e;j++){h=i[j];k.push(d.namespaces[h].done=true)}return k}}}})(this),onError:(function(d){return function(){d.request_in_flight=false;if(!d.user_navigated_away){return Notify.error(_("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return $u(this.roles).filter((function(a){return function(b){return b.role===a.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return $u(this.valid_roles()).map((function(a){return function(b){return b.ns_ids}})(this)).flatten().map((function(a){return function(b){return a.namespaces[b]}})(this)).uniq()}},earliest:function(){return $u(this.valid_nss()).map((function(a){return function(b){return b.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=Util.start_of_day(new Date($u(this.valid_nss()).map((function(a){return function(b){return a.first_event_map[b.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=Util.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var b,c,a;a=new Date(this.timestamp-this.one_day);c=this.now-this.timestamp>0;b={};if(this.ns){b.ns=this.ns.ns_id}if(this.role!=="all"){b.role=this.role}if(c){b.date=""+(a.getDate())+"-"+(a.getMonth()+1)+"-"+(a.getFullYear())}return DBHistory.push_state("/events",b)},render:function(){var a,o,p,j,q,t,n,c,i,l,h,m,b,g,e,d,r,s,k,f;if(this.role_has_events[this.role]){this.update_calendar_first_day()}a=$u(this.valid_nss()).map((function(u){return function(v){return v.events}})(this)).flatten();o=this.earliest();b=$u(a).sortBy(function(u){return -u.timestamp});j=$u(b).filter((function(u){return function(v){return v.timestamp>=o&&v.timestamp<u.timestamp/1000&&(u.ns!==null||!v.is_dup)}})(this));if(this.role_has_events[this.role]){$j("#event-table").empty();for(e=0,r=j.length;e<r;e++){i=j[e];p=$j(i.html);l=$u(this.valid_roles()).filter((function(u){return function(v){return v.ns_ids.contains(i.ns_id)}})(this)).map((function(u){return function(v){return v.name}})(this)).join(" & ");p.find("span.role-label > span").text(l);$j("#event-table").append(p)}$j("#events-container").show();$j("#events-sub-header").show();$j("#events-sub-header").css("visibility","visible");$j("#events-empty-state").hide();$j(".empty-explanation").hide()}else{if(!this.request_in_flight){$j("#events-container").hide();$j("#events-sub-header").hide();$j("#events-empty-state").show();$j(".empty-explanation").show()}}if(!this.request_in_flight){$j("#more-loading").hide()}else{$j("#more-loading").show()}$j("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");k=$j("#namespace-list > li");for(d=0,s=k.length;d<s;d++){q=k[d];c=$u(this.valid_roles()).map((function(u){return function(v){return v.ns_ids}})(this)).flatten().any((function(u){return function(v){return v===$j(q).data("value")}})(this));n=$j(q).data("value")===false;g=n||c;$j(q).css("display",g?"":"none")}m=__indexOf.call((function(){var x,v,u,w;u=this.valid_roles();w=[];for(x=0,v=u.length;x<v;x++){t=u[x];w.push(t.ns_ids.length>1)}return w}).call(this),true)>=0;if(!this.request_in_flight){if(m){$j("#namespace-list-container").css("visibility","visible");$j("#namespace-list-container").show()}else{$j("#namespace-list-container").hide()}h=this.rss_data[(f=this.ns)!=null?f.ns_id:void 0]||this.rss_data[this.role];if(h&&this.role_has_events[this.role]){$j("#rss-feed a").attr("data-title",h.title);$j("#rss_url").val(h.url);$j("#reset-rss-link").on("click",(function(u){return function(v){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:h.ns_id},onSuccess:function(){Notify.success(_("RSS feed url successfully reset."));return Browser.redirect("/events")}});return false}})(this));$j("#rss_url").focus();$j("#rss-feed").show();return $j("#rss-feed").css("visibility","visible")}else{return $j("#rss-feed").hide()}}},show_rss_modal:function(){var a,b;Modal.show(_("Subscribe to this RSS feed"),$j("#rss-modal")[0]);b=$j("#rss_url").val();a=clipboard.clipboard_overlay(b,$j("#real_copy"),function(){Notify.success(_("Link copied to clipboard!"));return Modal.hide()},$j(".modal-buttons"));return a.css({zIndex:1001})}};var DateUtil;DateUtil={fromSecondsSinceEpochUTC:function(a){var b;b=new Date(1970,0,1);b.setSeconds(a);return b},applyTimezoneOffset:function(b,d){var a,c;a=parseInt(d,10);c=60*(d-a);b.setHours(b.getHours()+a);return b.setMinutes(b.getMinutes()+c)},contextualFormat:function(b){var d,f,a,c,e;a=new Date(Date.now());c=(a.getTime()-b.getTime())/1000;d=0;if(c<8*3600){return datetime.ago(b)}this.applyTimezoneOffset(a,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(b,Constants.TIMEZONE_OFFSET);e=new Date(Date.now());this.applyTimezoneOffset(e,Constants.TIMEZONE_OFFSET);e.setDate(e.getDate()-1);if(b.getYear()===a.getYear()&&b.getMonth()===a.getMonth()&&b.getDate()===a.getDate()){f=_("Today %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{if(b.getYear()===e.getYear()&&b.getMonth()===e.getMonth()&&b.getDate()===e.getDate()){f=_("Yesterday %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{return DateUtil.format(b,Constants.datetime_format)}}},toUTCDate:function(a){return new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds())},differenceStr:function(d,g){var i,h,b,c,e,a,f;e=(d.getTime()-g.getTime())/1000;if(e<60){return ungettext("%d sec","%d secs",e).format(e)}else{if(e<3600){b=parseInt(e/60,10);return ungettext("%d min","%d mins",b).format(b)}else{if(e<86400){h=parseInt(e/3600,10);return ungettext("%d hour","%d hours",h).format(h)}else{if(e<2592000){i=parseInt(e/(60*60*24),10);return ungettext("%d day","%d days",i).format(i)}else{if(e<4838400){a=parseInt(e/(60*60*24*7),10);return ungettext("%d week","%d weeks",a).format(a)}else{if(e<31536000){c=parseInt(e/(60*60*24*30),10);return ungettext("%d month","%d months",c).format(c)}else{f=parseInt(e/(60*60*24*365),10);return ungettext("%d year","%d years",f).format(f)}}}}}}},localize:function(a){assert(Constants.date_format!=null,"Date format missing.");return DateUtil.format(a,Constants.date_format)},format:function(a,b){var c;assert(typeof b==="string","Date format requires a format string");c={yy:(function(d){return function(){return a.getFullYear().toString().substring(2)}})(this),yyyy:(function(d){return function(){return a.getFullYear().toString()}})(this),M:(function(d){return function(){return(a.getMonth()+1).toString()}})(this),MM:(function(d){return function(){return(a.getMonth()+1).toString().lpad(2)}})(this),d:(function(d){return function(){return a.getDate().toString()}})(this),dd:(function(d){return function(){return a.getDate().toString().lpad(2)}})(this),h:(function(d){return function(){return(a.getHours()%12||12).toString()}})(this),H:(function(d){return function(){return a.getHours().toString()}})(this),HH:(function(d){return function(){return a.getHours().toString().lpad(2)}})(this),m:(function(d){return function(){return a.getMinutes().toString()}})(this),mm:(function(d){return function(){return a.getMinutes().toString().lpad(2)}})(this),a:(function(d){return function(){if(a.getHours()>11){return _("PM",{comment:"PM as in evening"})}else{return _("AM",{comment:"AM as in morning"})}}})(this)};return b.replace(/([a-zA-Z]+)/g,function(d){if(c[d]!=null){return c[d]()}else{return d}})}};var Timezone;Timezone={check_timezone:function(){var a;if(!Viewer.get_viewer().is_signed_in){return}a=Timezone.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==a){return Timezone.update(a)}},get_current_timezone:function(){var d,c,a,b;c=new Date();c.setSeconds(0);c.setMilliseconds(0);b=c.toGMTString();d=new Date(b.substring(0,b.lastIndexOf(" ")));a=(c-d)/(1000*60*60);return a},update:function(a){assert(typeof a==="number","Timezone offset was not a number: "+a);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:a},noAutonotify:true})},update_timezones_dropdown:function(b,d){var c,a;if(d==null){d=null}a=Timezone.timezones_by_country[b];$j("#timezone_id").empty();$j("#timezone_id").append((function(){var g,f,e;e=[];for(g=0,f=a.length;g<f;g++){c=a[g];e.push($j('<option value="'+c.id+'">'+c.name+"</option>").prop("selected",c.id===d))}return e})());return Util.syncHeight()},auto:function(){var a;a=$F("timezone_auto");if(a){$j("#tz").hide()}else{if(Timezone.default_country){$j("#timezone_country").val(Timezone.default_country);Timezone.update_timezones_dropdown(Timezone.default_country)}$j("#tz").show()}return Util.syncHeight()},load_data:function(b,a){Timezone.timezones_by_country=b;return Timezone.default_country=a}};var Apps,CreateApp;CreateApp={init:function(d,b){var c,e,a;this.accepted_tos_by_uid=d;this.form=c=$j("#create-app-form");this.email_verification=null;if(!Viewer.get_viewer().is_paired){a=Viewer.get_viewer().get_users()[0];this.select_user(a.id)}e=(function(f){return function(g){var h;h=g.target.name;return c.find("input[name="+h+"]").each(function(){$j(this).parents("label").removeClass("active");return c.removeClass($j(this).data("next"))})}})(this);c.find("input[type=radio]").change(function(f){e(f);$j(f.target).parents("label").addClass("active");return c.addClass($j(this).data("next"))});c.find("input[type=checkbox]").change(function(f){var g;if($j(this).filter("#accept-tos").length){return}$j(f.target).parents("label").toggleClass("active");g=c.find("input[name="+($j(this).attr("name"))+"]:checked");c.toggleClass($j(this).data("next"),g.length!==0)});c.find(".role-choice input").change((function(f){return function(h){var g,i;g=c.find(".role-choice input:checked");i=g.val();if(!Viewer.get_viewer().is_uid_signed_in(i)){g.prop("checked",false);e(h);MultiaccountLogin.show_modal({user_id:i,on_success:function(){return g.prop("checked",true).trigger("change")}});return false}else{return f.select_user(i)}}})(this));c.find("input:checked").trigger("change");c.find("input[name=tos_accept]").change((function(f){return function(g){return f.update_submit_enabled()}})(this));c.find("#send-verify-email, #resend-verify-email").click((function(f){return function(g){f.email_verification.send_email(b,function(){c.addClass("verify-email-sent");f.email_verification.flash_email_sent_notification();return f.email_verification.ensure_polling(function(){if(!f.email_verification.user.is_email_verified){return}c.addClass("email-verified");c.removeClass("verifiy-email-sent");return f.update_submit_enabled()})});return false}})(this));return c.submit(function(f){c=$j(f.target);Forms.ajax_submit(c[0],false,(function(g){return window.location.href=g.responseText}));return false})},select_user:function(a){this.email_verification=EmailVerification.get_for_user(Viewer.get_viewer().get_user_by_id(a));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[a]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var b,a;a=this.email_verification.user;b=this.accepted_tos_by_uid[a.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!b)}};Apps={init_apps:function(){return $j("#show-disabled-apps").click(function(){$j(this).parent().hide();$j("#disabled-apps").show();return false})},init_app_info:function(b,c,a){this.user_email=a;$j("#app-info .icon-container").each(function(e,f){var d;d=$j(f);return d.append(Dropbox.createChooseButton({success:function(g){d.find(".icon").attr("src",g[0].thumbnailLink);return d.find("input[type=hidden]").val(g[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=HTML.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=HTML.tmpl("webhook_info_row_tmpl");$j("#domain-list").on("click",".img-container",function(d){Apps.remove_domain(d.currentTarget.parentNode,b)});$j("#oauth-uri-list").on("click",".img-container",function(d){Apps.remove_oauth_uri(d.currentTarget.parentNode,b)});$j("#webhook-list").on("click",".img-container",function(d){Apps.remove_webhook(d.currentTarget.parentNode,b)});$j("#generate-token-button").on("click",function(d){Apps.generate_access_token(b)});$j("#delete-app-button").on("click",function(d){Apps.confirm_disable(c,b,0)});$j("#webhook_url").on("click change paste focus",function(d){$j("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return $j("#oauth2-allow-implicit-grant").on("change",function(d){return Apps.set_oauth2_allow_implicit_grant(d.currentTarget,b)})},init_app_info_add_redirect_uri:function(){var a,b,c,d;b=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!b){return}d=window.decodeURIComponent(b[1]);a=$j("#oauth-add-uri-form");$j("input[name=oauth_uri]",a).val(d);c=$j("#add-redirect-uri-modal")[0];$j("#add-redirect-uri-modal-uri").text(d);Modal.show(_("Add OAuth redirect URI"),c,{doit:function(){var e;if(window.history&&window.history.replaceState){e=window.location.href;e=e.substring(0,e.indexOf("#"));window.history.replaceState({},document.title,e)}else{window.location.hash=""}Modal.hide();return Apps.submit_new_oauth_uri($j("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(a){this.ds_info=a;if(Viewer.get_viewer().is_paired){this.role_picker=$j("#role-selector").controller();this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return MultiaccountLogin.set_during_login_callback((function(b){return function(d,c){return b.app_datastores_browse_reload_info(function(){return c()},function(){c("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(b,a){$j.ajax({url:"/developers/apps/datastores/info",success:(function(c){return function(d){c.ds_info=d;c.app_datastores_browse_render();return typeof b==="function"?b():void 0}})(this),error:(function(c){return function(d){return typeof a==="function"?a(d):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var c,b,a,d;b=$j("#no_apps_container").empty();if($j("#apps_developed_container").children().length!==0||$j("#apps_used_container").children().length!==0){return}c=$j("<div class='empty-state'></div>").appendTo(b);switch((d=this.role_picker)!=null?d.get_state():void 0){case RolePickerState.PERSONAL:case RolePickerState.WORK:a=Viewer.get_viewer().get_user_by_role(this.role_picker.get_state());return c.append("You don't have any datastores in your "+Viewer.get_role_title(a)+" Dropbox.");default:return c.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(h){var b,g,d,f,e,c,a;f=this.app_datastores_browse_get_id_info(h);g=$j(h);g.empty();b="";for(c=0,a=f.length;c<a;c++){d=f[c];if(this.app_datastores_should_render(d.uid)){b+=d.html}}if(b){g.append(this.app_datastores_browse_get_id_header(h));e=$j("<div class='app-list clearfix'/>").appendTo(g);return e.html(b)}},app_datastores_should_render:function(b){var a;if(this.role_picker!=null){a=Viewer.get_viewer().get_user_by_id(b);return this.role_picker.is_role_visible(a.role)}else{return true}},app_datastores_browse_get_id_info:function(a){switch(a){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return assert(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(a){switch(a){case"#apps_developed_container":return $j("<h2>Apps you develop</h2>");case"#apps_used_container":return $j("<h2>Apps you use</h2>");default:return assert(false,"invalid ds group id")}},generate_access_token:function(b){var d,c,a;a=this;d=$j("#generate-token-button");c=$j("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");d.replaceWith(c);return $j.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:b},dataType:"json",success:function(g){var e,f;e=$j("<div>").append($j("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(g.token));f=g.warning;e.append($j("<div>").addClass("detail-text").text(f));return c.replaceWith(e)},error:function(){return Notify.error("Unable to complete your request.")}})},confirm_disable:function(d,c,b){var e,a;e=(b?_("Are you sure you want to disable '%(app_name)s'?"):_("Are you sure you want to delete '%(app_name)s'?"));DomUtil.fillVal(e.format({app_name:d.escapeHTML()}),"app-disable-text");Modal.show((b?_("Confirm disable"):_("Confirm delete")),$("app-disable-modal"));a="/developers/disable_app/"+c;$("app-disable-modal").down("form").action=a;return $("disable-app-button").setValue((b?_("Disable"):_("Delete")))},enable_app:function(b){var a;a="/developers/enable_app/"+b;return window.location.href=a},show_uninstall:function(g,f,c,b,d,a){var h;if(g){Event.stop(g)}Modal.vars={app_id:c,user_id:a};h=$j("#delete-"+b+"-app-confirm");if(b==="sandbox"){if(!d){Apps.do_uninstall();return}$j(".app_folder",h).text(d)}$j(".app_name",h).text(f);Modal.show(_("Remove %(app_name)s?").format({app_name:Emstring.em_snippet(f,22)}),h[0],Modal.vars);return null},do_uninstall:function(){var a;a=Modal.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(b){var c;Notify.success(b.responseText);c=$j(".apps-"+a);$j("#inst-app-"+Modal.vars.app_id+"-row",c).hide().removeClass("active_app");if($j(".active_app",c).length===0){c.hide()}if($j(".active_app").length===0){$j("#empty-explanation").text(_("You have no apps linked to your Dropbox."));return $j("#applications-explanation",c).remove()}},subject_user:a});return Modal.hide()},enable_users_in_dev:function(a,b){new Ajax.DBRequest("/developers/enable_users_in_dev/"+a,{onSuccess:function(c){Modal.show(_("Limit raised to %d users").format(b),$("increased-dev-user-limit-modal"));$j("#users-in-dev-none, #users-in-dev-some").hide();return $j("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(a){Modal.show(_("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+a,{onSuccess:function(b){$j("#current-app-users-1, #current-app-users-2").text("0");return Modal.hide()}})}});return false},unlink_all_teams_in_dev:function(a){Modal.show(_("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return $j.ajax({url:"/developers/unlink_all_teams/"+a,method:"POST",success:function(b){$j("#current-app-teams").text("0");return Modal.hide()}})}});return false},restore_sandbox:function(b,d,a){var f,c,e;f=$j("#restore-sandbox")[0];Modal.show(_("Restore app folder '%(filename)s'").format({filename:Emstring.em_snippet(FilePath.filename(d),17)}),f);e=$j("#restore-sandbox-form")[0];c={ns_id:a};c[Constants.UID_PARAM_NAME]=b.id;return Forms.add_vars(e,c)},submit_restore_sandbox:function(b){var a;a=$("restore-sandbox-form");Forms.ajax_submit(a,false,(function(c){Modal.hide();Notify.success(_("Restored app folder"));if(c.responseText.length){return Browse.reload_fqpath(c.responseText)}else{return Browse.reload("","",true)}}),false,b.target);return false},submit_app_info:function(a){var b;b=$j(a).find("input[name=name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.success("App info updated.");if(b){return $j("#app-info h1").text(b)}}))},submit_folder_name:function(a){var b;b=$j(a).find("input[name=folder]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.success("App folder name updated.");$j("#folder-name .text").text(b);return Apps.hide_folder_input()}))},submit_new_webhook:function(b){var c,m,k,f,i,h,l,j,d,a,g,e;m=$j(b);i=$j("#webhook-list");f=$j("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");k=m.find("input[name=webhook_url]");d=function(o,n){if(n){n.remove()}if(i.find(".hoverable-url").length===0){i.addClass("hide-status")}$j("#webhook-form-error").text(o);return $j("#webhook-form").addClass("error")};l=k.val();if(l===""){d("Empty URI");return}j=URI.parse(l);if((g=j.scheme)!=="http"&&g!=="https"){d("URI scheme must be http or https");return}if(!j.authority){d("Improperly formatted URI (typo maybe?)");return}if((e=j.authority)==="localhost"||e==="127.0.0.1"){d("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(i.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){d("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}c=$j(this._webhook_info_row_tmpl({url:l,status:"Verifying"}).toHTML());c.find(".status").append(f);i.append(c);i.removeClass("hide-status");$j("#webhook-form").removeClass("error");h=Forms.collect_form_vars(b);k.val("");a=new Date().getTime();return $j.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:h,success:function(p){var n,o;if(p.status==="invalid"){d(p.failure_text,c);return k.val(l)}else{o=new Date().getTime()-a;n=Math.max(0,1000-o);return setTimeout((function(){if(p.status==="ok"){return c.find(".status").text("Enabled")}else{if(p.status==="error"){c.find("textarea").text(p.failure_text);c.find(".status").text(p.status_text).addClass("error");c.find(".timestamp").text("Just now");return c.find(".webhook-failure-info").css("display","")}}}),n)}},error:function(){Notify.error("Unable to complete your request.");c.remove();return k.val(l)}})},remove_webhook:function(c,b){var d,a;$j("#webhook-form").removeClass("error");a=$j(c).find(".value").text();d=$j("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");$j(c).find(".status").text("Removing").removeClass("error").append(d);return $j.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:b,webhook_url:a},dataType:"json",success:function(g){var e,f;e=c.parentNode;f=e.parentNode;f.removeChild(e);if(f.getElementsByClassName("hoverable-url").length===0){$j(f).addClass("hide-status")}if(!$j("#webhook_url").val()){return $j("#webhook_url").val(a)}},error:function(){return Notify.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(b,a){return $j.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:a,allow:$j(b).val()},dataType:"json",success:function(c){return Notify.success("OAuth 2 allow implicit grant updated.")},error:function(){return Notify.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(b){var a;a=$j(b).find("input[name=oauth_uri]").val();Forms.clear_errors(b);return Forms.ajax_submit(b,false,(function(){Notify.success("OAuth URI added.");Apps.add_oauth_uri(a);return $j(b).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(b){var a;a=$j("#oauth-uri-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_oauth_uri:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.success("OAuth URI removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:a,oauth_uri:d},dataType:"json",success:c,error:function(){return Notify.error("Unable to complete your request.")}})},submit_new_domain:function(a){var b;b=$j(a).find("input[name=domain_name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.success("Domain added.");Apps.add_domain(b);return $j(a).find("input[name=domain_name]").val("")}))},add_domain:function(b){var a;a=$j("#domain-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_domain:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.success("Domain removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:a,domain_name:d},dataType:"json",success:c,error:function(){return Notify.error("Unable to complete your request.")}})},show_need_users_modal:function(a){Modal.show(_("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(a){return Modal.show(_("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(a){Modal.show(_("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},hide_folder_input:function(){$j("#folder-name").show();return $j("#folder-input").hide()},show_folder_input:function(){$j("#folder-name").hide();$j("#folder-input").show();return $j("#folder-input input[name=folder]").focus()}};var Twitter;window.twitter_auth_complete=function(a){assert(a!=null,"user_id must be provided");if(Twitter.onLoginSuccessCallback){Twitter.onLoginSuccessCallback(a)}else{window.location.reload()}return false};Twitter={is_authed:function(a){a=parseInt(a);if(Twitter._authed_users==null){Twitter._authed_users={}}return Twitter._authed_users[a]},set_is_authed:function(a,b){a=parseInt(a);if(Twitter._authed_users==null){Twitter._authed_users={}}return Twitter._authed_users[a]=b},get_progress_container:function(){var a;assert(Twitter.progress_container,"Twitter is missing progress_container");a=$(Twitter.progress_container);assert(a,"Missing progress_container elm");return a},follow_dropbox:function(b,a){var c;assert(a!=null,"user_id must be provided");if(b.showWorking){b.showWorking()}c=function(){if(b.onFailure){return b.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(d){if(!d.responseText.startsWith("ok")){return c()}else{if(b.onSuccess){return b.onSuccess()}}},onFailure:function(){return c()},subject_user:a})},do_auth:function(d,a){var c,b;assert(a!=null,"user_id must be provided");b=URI({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,a).toString();window.open(b,"twitter_auth","width=800,height=400");c=function(e){Twitter.set_is_authed(e,true);return typeof d==="function"?d(e):void 0};return Twitter.onLoginSuccessCallback=c},show_auth:function(a){if(a){Twitter.onLoginSuccessCallback=a}return DomUtil.updateFromElm(Twitter.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(Twitter.should_hide_modal()){Modal.hide()}return Twitter.get_progress_container().update(DomUtil.fromElm("sharing-progress"))},show_complete:function(b){var a;a=Twitter.get_progress_container();a.update(DomUtil.fromElm("sharing-posted"));return Twitter.show_complete_into(b,a)},show_complete_into:function(g,a){var d,e,c,f,b;d="twitter";f=_("View tweet");b=void 0;if(g.startsWith("ok")){b="http://www.twitter.com/"}else{b=g}e=a.down("#view-post");e.href=b;e.update(f);c=Sprite.make("web",d);return e.__sert({top:c})},post:function(d,f,c,a){var e,b;assert(a!=null,"user_id must be provided");assert(d,"Twitter message is empty");e={message:d,from_referrals:Twitter.from_referrals,from_getspace:Twitter.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:e,onSuccess:function(g){var h,i;if(g.responseText==="login"){Twitter.onLoginSuccessCallback=function(){return Twitter.post(d,null,null,a)};h=Twitter.custom_show_auth||Twitter.show_auth;return h()}else{if(Twitter.should_hide_modal()){Modal.hide()}i=Twitter.onPostSuccessCallback||Twitter.show_complete;return i(g.responseText)}},subject_user:a});b=Twitter.custom_show_posting||Twitter.show_posting;return b()},custom_post:function(b,c,a){assert(a!=null,"user_id must be provided");if(c){Twitter.onPostSuccessCallback=c}if(!b){return}assert(b,"Twitter message doesn't exist");if(!Viewer.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(b))}else{return Twitter.post(b,null,null,a)}},get_user_info:function(b,a){assert(a!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(c){return b(JSON.parse(c.responseText))},subject_user:a})},should_hide_modal:function(){if(typeof Twitter.hide_modal==="undefined"){return true}else{return Twitter.hide_modal}}};var AllPhotosPhotoPreview,AllPhotosVideoPreview,LightboxPreviewBase,PhotoPreview,SingleCollectionPhotoPreview,SingleCollectionVideoPreview,VideoPreview,get_timeline_preview_classes,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};LightboxPreviewBase=(function(){function a(b){this.link_hash=b.link_hash;this.filename=b.filename;this.fq_path=b.fq_path;this.thumbnail_url_tmpl=b.thumbnail_url_tmpl;this.dl_url=b.dl_url;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.activity_key=b.activity_key;this.display_time=b.display_time||null;this.more_actions_item_tmpl=HTML.tmpl("lightbox_more_actions_item_tmpl")}a.prototype.shutdown=function(){};a.prototype.preload=function(){};a.prototype.render=function(){};a.prototype.image_size=function(){var b;b=document.viewport.getDimensions();return image_best_fit_size(b.width,b.height)};a.prototype.get_more_actions_above_divider=function(c){var d,b;b=[];d=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,sprite_name:"lightbox_download",item_text:_("Download"),more_classes:"more-actions-item"});b.push(d);return b};a.prototype.get_more_actions_below_divider=function(b){return[]};a.prototype.is_a_timeline_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof AllPhotosPhotoPreview||this instanceof SingleCollectionVideoPreview||this instanceof AllPhotosVideoPreview};a.prototype.is_an_album_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof SingleCollectionVideoPreview};a.prototype.is_a_photo_preview=function(){return this instanceof PhotoPreview};a.prototype.is_a_video_preview=function(){return this instanceof VideoPreview};a.prototype.get_actions=function(d){var f,h,i,c,g,b,e;c=[];if(!this.is_a_timeline_preview()&&d.enable_sublinks){if(d.share_button_experiment_variant==="WHITE_BUTTON"){i=$j("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){e=(function(j){return function(k){ShmodelUILogger.log("via-shmodel-lightbox");return window.open(URI.parse(j.shmodel_link).updateQuery("m","1"))}})(this)}else{e=(function(j){return function(k){k.preventDefault();ShmodelUILogger.log("via-browse-lightbox");return SharingShmodel.shmodel(j.fq_path,"browse_lightbox")}})(this)}}else{i=$j("<a />",{id:"lightbox_share_link","class":"title_bubble black"});i.html(Sprite.make("web","link_white"));if(this.is_a_photo_preview()){i.attr("title",_("Share link to photo"))}else{if(this.is_a_video_preview()){i.attr("title",_("Share link to video"))}else{assert(false,"preview needs to be a photo or video")}}if(this.shmodel_link){i.attr("href",URI.parse(this.shmodel_link).updateQuery("m","1"));i.attr("target","_blank");e=(function(j){return function(k){return ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{i.attr("href","#");e=(function(j){return function(k){k.preventDefault();ShmodelUILogger.log("via-browse-lightbox");return SharingShmodel.shmodel(j.fq_path,"browse_lightbox")}})(this)}}i.on("click",e);c.push(i[0])}if(d.include_delete){g=Photos.in_single_collection_view()?_("Remove"):_("Delete");if(d.share_button_experiment_variant==="WHITE_BUTTON"){f=$j("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");f.find(".sprite-text-inner").text(g);f.on("click",(function(j){j.preventDefault();return Lightbox.delete_current()}))}else{f=$j("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:g});f.html(Sprite.make("web","lightbox_delete_16"));f.on("click",(function(j){j.preventDefault();return Lightbox.toggle_delete()}))}c.push(f[0])}if(d.share_button_experiment_variant==="WHITE_BUTTON"){b=(function(j){return function(k){k.preventDefault();return Lightbox.toggle_more_actions_menu()}})(this);h=$j("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",b);c.push(h[0])}else{assert(Lightbox.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");c.push(Lightbox.more_actions_button)}return c};a.prototype.delete_pressed=function(){var b;b=_("Deleting...");if(this.is_a_timeline_preview()){if(Photos.in_single_collection_view()){b=_("Removing...");Photos.get_current_collection().remove_photos([this.photo])}else{Photos._delete_photos([this.photo])}}else{document.fire(Lightbox.PHOTO_DELETE_EVT,this)}return Notify.success(b)};a.prototype.set_more_actions_event_handlers=function(b){};return a})();PhotoPreview=(function(b){__extends(a,b);function a(c){a.__super__.constructor.call(this,c);this.original_url=String(URI.parse(c.original_url).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user));this.shmodel_link=c.shmodel_link;this.fail_image_src="/static/images/preview_fail.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false}a.prototype.show_fail=function(d){var c;return c=$j(d).find(".lightbox_fail_text").text(_("Unable to preview this item."))};a.prototype.fallback=function(d){var c,f;c=$(d.target);c.writeAttribute({src:this.fail_image_src,width:128,height:128});f=c.up("div.content-item");if(f){return this.show_fail(f)}};a.prototype.is_gif=function(){return"gif"===FilePath.file_extension(this.filename).toLowerCase()};a.prototype.preload=function(e){var d,f,c;c=URI.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){c=this.thumbnail_url_tmpl}f=(function(g){return function(){if(typeof e==="function"){e()}return g.loaded=true}})(this);Util.preload_image(c,this.fallback.bind(this),f);d=$(Util.preloaded_images[c]);d.writeAttribute("data-original-href",this.original_url);d.writeAttribute("class","thumbnail");return d};a.prototype.render=function(h,e){var f,d,g,c,i;if(this.loaded){e()}d=this.preload(e);i=$j("<div />",{"class":"content-item"}).append(d);f=$j("<div />",{"class":"lightbox_fail_text"});i.append(f);g=d.getAttribute("src").length;c=d.getAttribute("src").substring(g-this.fail_image_src.length,g);if(c===this.fail_image_src){this.show_fail(i)}h.appendChild(i[0]);return i[0]};a.prototype.advance_on_click=true;a.prototype.get_more_actions_above_divider=function(e){var d,c;c=a.__super__.get_more_actions_above_divider.call(this,e);d=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:_("View original"),more_classes:"more-actions-item"});c.push(d);return c};return a})(LightboxPreviewBase);VideoPreview=(function(a){__extends(b,a);function b(c){this._player_error=__bind(this._player_error,this);this._player_ready=__bind(this._player_ready,this);b.__super__.constructor.call(this,c);this.preview_url=c.preview_url;this.shmodel_link=c.shmodel_link;this.thumbnail_div=null;this.metadata_link=c.metadata_link!=null?c.metadata_link:void 0;this.metadata=null;this.player=null}b.prototype.render_error=function(f){var h,d,c,e,g;d=$j("<div/>");c=$j("<img/>",{src:"/static/images/preview_fail.png","class":"video-preview-fail"});e=$j("<div/>",{"class":"video-preview-fail"});if(f==="needflash"){e.html(_('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{e.text(_("Unable to preview this item.",g="web",h="preview means showing the item in the same browser window without downloading a copy."))}d.append(c,e);return d[0]};b.prototype._player_ready=function(){var c;c=function(){$j(".vjs-poster").show();$j(".vjs-big-play-button").show();return $j(".vjs-big-play-button").focus()};return c.defer()};b.prototype._onPlay=function(){$j(".vjs-poster").hide();return $j(".vjs-big-play-button").hide()};b.prototype._onEnded=function(){$j(".vjs-poster").show();$j(".vjs-big-play-button").show();return $j(".vjs-loading-spinner").hide()};b.prototype._player_error=function(c){this.shutdown();this.div=this.render_error(c);return $j("#file-preview-modal .content-item").html(this.div)};b.prototype.preload=function(){};b.prototype.render=function(d,c){this.div=this.render_video(d);return this.div};b.prototype.render_video=function(i){var c,g,e,d,h,f;f=new Element("div",{"class":"video-player content-item"});h=this.image_size().split("x")[0]*0.8;d=parseInt(h*0.55,10);g=false;e=URI.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();c=(function(j){return function(k){return j.metadata=k}})(this);this.player=VideoUtil.embed(f,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:h,height:d,controls:true,preload:"auto",poster:e,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:c});i.appendChild(f);$j(".vjs-poster").hide();$j(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return f};b.prototype.shutdown=function(){var d,c;if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((c=this.player.tech.sourceBuffer)!=null){c.abort()}}this.player.dispose()}catch(f){d=f}return this.player=null}};return b})(LightboxPreviewBase);get_timeline_preview_classes=function(c){var a,b;a=(function(e){__extends(d,e);function d(f){f.ns_id=f.photo.ns_id;f.ns_path=f.photo.ns_path;d.__super__.constructor.call(this,f);this.photo=f.photo;TitleBubble.set_vertical_space(3);if(Photos.in_single_collection_view()){$j("#lightbox-delete-photo").val(_("Remove"))}else{$j("#lightbox-delete-photo").val(_("Delete"))}}d.prototype.get_more_actions_above_divider=function(h){var g,f;f=d.__super__.get_more_actions_above_divider.call(this,h);g=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:_("Add to album"),more_classes:"more-actions-item"});f.push(g);return f};d.prototype.toggle_select_button_off=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Select video"))}}f.html(Sprite.make("web","lightbox_unselected"));f.removeClass("selected");f.addClass("elbboggiw");return setTimeout((function(){return f.removeClass("elbboggiw")}),540)};d.prototype.toggle_select_button_on=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Un-select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Un-select video"))}}f.html(Sprite.make("web","lightbox_selected"));f.addClass("selected");f.addClass("wiggobble");return setTimeout((function(){return f.removeClass("wiggobble")}),540)};d.prototype.toggle_select=function(g){var f;g.preventDefault();f=$j("#lightbox-select-button");TitleBubble.hide_all();if(PhotosSelection.contains(this.photo)){PhotosSelection._remove(this.photo);return this.toggle_select_button_off(f)}else{PhotosSelection._add(this.photo);return this.toggle_select_button_on(f)}};d.prototype.get_actions=function(h){var g,f,i;g=[];i=$j("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});Lightbox.update_share_button_text(null,$j(i));i.on("click",((function(j){return function(l){var k;l.preventDefault();k=PhotosSelection.get();if(k.length===0){return Foshmodal.show([j.photo],false)}else{return Foshmodal.show(PhotosSelection.get(),false)}}})(this)));f=$j("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:_("Select this photo")});if(PhotosSelection.contains(this.photo)){f.html(Sprite.make("web","lightbox_selected"))}else{f.html(Sprite.make("web","lightbox_unselected"))}f.on("click",this.toggle_select.bind(this));g.push(i[0]);g.push(f[0]);return g.concat(d.__super__.get_actions.call(this,h))};d.prototype.set_more_actions_event_handlers=function(f){$("lightbox_add_to_album").observe("click",((function(g){return function(h){h.preventDefault();return PhotosCollections.show_add_to_album_modal(h,[g.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(g){return function(h){h.preventDefault();return Photos.show_in_folder(g.photo)}})(this)));return d.__super__.set_more_actions_event_handlers.call(this,f)};d.prototype.get_more_actions_below_divider=function(h){var g,f;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:_("Show in folder"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};return d})(c);b=(function(e){__extends(d,e);function d(){return d.__super__.constructor.apply(this,arguments)}d.prototype.get_more_actions_below_divider=function(h){var f,g;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:_("Remove from album"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};d.prototype.set_more_actions_event_handlers=function(f){$("lightbox_remove_from_album").observe("click",((function(g){return function(h){h.preventDefault();return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),[g.photo])}})(this)));return d.__super__.set_more_actions_event_handlers.call(this,f)};return d})(a);return[a,b]};_ref=get_timeline_preview_classes(PhotoPreview),AllPhotosPhotoPreview=_ref[0],SingleCollectionPhotoPreview=_ref[1];_ref1=get_timeline_preview_classes(VideoPreview),AllPhotosVideoPreview=_ref1[0],SingleCollectionVideoPreview=_ref1[1];var Lightbox;Lightbox=(function(){var u,s,ab,aa,M,i,b,z,I,af,Z,h,H,U,p,S,E,N,ae,o,F,m,R,W,g,V,f,x,Y,r,G,j,A,O,B,K,d,t,a,J,X,ad,Q,q,w,e,v,L,c,k,P,C,D,n,y,l,ac;aa=[];u=0;M=false;ab=true;C=void 0;b=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;i=false;Y=void 0;U=void 0;L=-1;c=null;N=null;F=false;a=false;g=false;m=null;o=function(ag){return ag.complete!==false};e=function(){var ag;if($$("#file-preview-modal .loading-image").length){return}ag=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black.gif"});return $$("#file-preview-modal .preview-content").first().__sert(ag)};E=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};B=function(){var am,al,ai,ag,ak,aj,ah;al=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!al||!o(al)){return}ag=$$("#file-preview-modal .preview").first().getDimensions();am=void 0;if(!al.naturalHeight){am=al.getDimensions();al.naturalHeight=am.height;al.naturalWidth=am.width}else{am={width:al.naturalWidth,height:al.naturalHeight}}ai=am.width/ag.width;ah=am.height/ag.height;aj=Math.max(ai,ah);al.style.visibility="";if(aj<1){al.style.width="";al.style.height=""}else{al.style.width=Math.floor(am.width/aj)+"px";al.style.height=Math.floor(am.height/aj)+"px"}ak=$j("#file-preview-modal .paging-block").position().left-16;return $j("#file-preview-modal .filename").css("max-width",ak)};H=void 0;V=function(){var an,ai,am,al,ak,ah,aj,ag;ai=$("file-preview-modal");al=ai.down(".menu");am=ai.down(".header");aj=$$(".lightbox-not-important");ag=[];for(ak=0,ah=aj.length;ak<ah;ak++){an=aj[ak];ag.push(an.addClassName("opacity-zero"))}return ag};v=function(){var ak,aj,ah,ai,ag;if(H){clearTimeout(H)}ai=$$(".lightbox-not-important");ag=[];for(aj=0,ah=ai.length;aj<ah;aj++){ak=ai[aj];ag.push(ak.removeClassName("opacity-zero"))}return ag};K=function(ah){var ag;v();ag=ah&&$(ah.target).descendantOf("file-preview-menu");if(H!=null){clearTimeout(H)}if(ab){if(!i&&!ag){return H=setTimeout(V,3112)}}};P=function(){if(H!=null){clearTimeout(H)}return ab=false};k=function(){ab=true;return K()};ae=function(ah){var ag;ag=aa.length;return(ag+(u+ah)%ag)%ag};G=function(ah){var ag,ai;if(Y.no_preload){return}ag=q.bind(null,ah);return typeof(ai=aa[ah]).preload==="function"?ai.preload(ag):void 0};j=function(){var ai,ak,ah,aj,ag;aj=[1,2,3,4,5,6,-1,-2];ag=[];for(ak=0,ah=aj.length;ak<ah;ak++){ai=aj[ak];if(Math.abs(ai)<aa.length){ag.push(G(ae(ai)))}else{ag.push(void 0)}}return ag};t=function(ag){if(!Y.filename_in_url){return}if(ag!=null){HashRouter.replace_hash("lh",ag)}else{HashRouter.replace_hash("")}return m=ag};O=function(){var ag,ah;ag=$j("#file-preview-modal");ah=Y.num_previews||aa.length;if(F&&a&&g){ag.find(".lightbox-index-text-container").text(_("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(F){if(a){ag.find(".lightbox-index-text-container").text(_("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{ag.find(".lightbox-index-text-container").text("")}}else{ag.find(".lightbox-index-text-container").text(_("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:u+1,num_total_files:ah}))}}if(aa.length===1){ag.find(".prev").addClass("opacity-zero");return ag.find(".next").addClass("opacity-zero")}else{if(u===0&&Y.no_wrap){ag.find(".prev").addClass("opacity-zero");return ag.find(".next").removeClass("opacity-zero")}else{if(u===aa.length-1&&Y.no_wrap){ag.find(".prev").removeClass("opacity-zero");return ag.find(".next").addClass("opacity-zero")}else{ag.find(".prev").removeClass("opacity-zero");return ag.find(".next").removeClass("opacity-zero")}}}};J=function(ai,aA){var ao,ap,aq,aw,ak,ag,av,az,ay,au,am,at,al,ar,ax,ah,aB,an,aj;L=datetime.time();assert(u<aa.length,"Invalid index "+u);ar=aa[u];if(typeof ar!=="object"){if(c){clearTimeout(c)}c=setTimeout((function(){if((Lightbox.shown!=null)&&Lightbox.shown){return J(ai,aA)}}),100);return}$j("#file-preview-modal").trigger(Lightbox.LIGHTBOX_SHOW_EVT,{preview:ar});av={mode:"lightbox"};analytics.UserActivityLogger.log("web","file_view",Object.toJSON(av));ay=$j("#file-preview-modal");ax=ay.find(".preview-content");al=ai?Q:q;ax.empty();ak=ar.render(ax[0],al);ay=ay[0];if(!N){N=ay.on("contextmenu","img.thumbnail",ContextMenu.show_for_lightbox.bind(ContextMenu))}t(ar.link_hash);O();if(ar.display_time){if(ar.filename.match(b)){ay.down(".filename").__date(ar.display_time)}else{ay.down(".filename").__date(ar.display_time+" - "+ar.filename)}}else{ay.down(".filename").__date(ar.filename)}ay.down(".filename").writeAttribute("title",ar.filename);if(Photos.in_single_collection_view()&&((an=Photos.get_current_collection().member_fnames)!=null?an.length:void 0)>1&&(((aj=ar.photo)!=null?aj.item_owner_fname:void 0)!=null)){aw="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";aw+=_("Added by %(fname)s").format({fname:Emstring.em_snippet(ar.photo.item_owner_fname,7)});ay.down(".added-by").__date(new HTML(aw));ay.down(".added-by").show()}else{ay.down(".added-by").hide()}am=HTML.tmpl("lightbox_more_actions_item_tmpl");au=ar.get_more_actions_above_divider(Y);aq=ar.get_more_actions_below_divider(Y);if(aq.length){au.push(am({divider:true}));au=au.concat(aq)}$("lightbox-more-actions-list").__date(au);ar.set_more_actions_event_handlers(Y);ap=ar.get_actions(Y);ag=document.createDocumentFragment();for(ah=0,aB=ap.length;ah<aB;ah++){ao=ap[ah];ag.appendChild(ao)}ay.down(".actions").__date();ay.down(".actions").appendChild(ag);if(Y.share_button_experiment_variant==="WHITE_BUTTON"){at=$j("#lightbox-more-actions-button .sprite-div").width();$j("#lightbox-more-actions-menu").css("right",at/2)}document.fire(Lightbox.ACTIONS_ADDED);if(Photos.in_single_collection_view()){ay.down(".album-name").show().__date(Emstring.em_snippet(Photos.get_current_collection().name,15,1));ay.down(".filename").addClassName("faded")}else{ay.down(".album-name").hide();ay.down(".filename").removeClassName("faded")}ak=ak.down("img.thumbnail");if(ak){if(!o(ak)){ak.hide();e();ak.observe("load",function(){E();ak.style.visibility="hidden";ak.show();return B()})}else{ak.show();B()}}az={preview_obj:ar,index:u,direction:aA};return document.fire(Lightbox.PHOTO_CHANGE_EVT,az)};ad=function(al){var ah,ai,ag,aj,ak;if(L===-1){return}ak=datetime.time()-L;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){ah=PhotosLogger.get_current_view()}else{if(typeof SharingModel!=="undefined"&&SharingModel!==null?SharingModel.is_album:void 0){ah="album_shmodel"}else{ah="not_photos"}}ai={current_view:ah};ag=$j("#file-preview-modal .content-item img.thumbnail")[0];if((ag!=null)&&(ag.src!=null)){aj=URI.parse(ag.src).getQuery();if("size" in aj){ai.size=aj.size}}WebTimingLogger.log_ajax_transition(ak,al,ai);L=-1;return j()};Q=function(){return ad("file-preview-lightbox-load-initial")};q=function(ag){var ah;if(typeof ag==="number"){if((ah=aa[ag])!=null){ah.loaded=true}if(ag===u){return ad("file-preview-lightbox-load")}}else{return ad("file-preview-lightbox-load")}};X=function(ag){var ah;ah=$j("#lightbox-click-catcher");if(!ah.length){ah=$j("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});ah.appendTo("#file-preview-modal .modal-preview-content");if(Browser.msie_version_at_most(10)){ah.css("background","black");ah.fadeTo(0,0)}}ah.off("click");ah.on("click",(function(ai){ai.preventDefault();return ag()}));return ah.show()};p=function(){return $j("#lightbox-click-catcher").hide()};af=function(){var ag;ag=$j("#lightbox-more-actions-button");if(ag.hasClass("toggled")){p();ag.removeClass("toggled");$("lightbox-more-actions-menu").hide();$j(document).trigger("dropdownClosed",[1]);k();return true}return false};x=function(){var ag;ag=$j("#lightbox-more-actions-button");if(!ag.hasClass("toggled")){S();ag.addClass("toggled");TitleBubble.hide_all();$j("#lightbox-more-actions-menu").show();$j(document).trigger("dropdownOpened",[1]);P();return X(Lightbox.close_more_actions_menu)}};n=function(){if($j("#lightbox-more-actions-button").hasClass("toggled")){return af()}else{return x()}};f=function(ah){var ag;if(F){a=true;O()}af();if(ah){ah.preventDefault()}if(u===aa.length-1&&Y.no_wrap){return}if((ag=aa[u])!=null){ag.shutdown()}u=ae(1);if(u===0){K()}return J(null,Lightbox.NEXT)};A=function(ah){var ag;if(F){a=true;O()}af();if(ah){ah.preventDefault()}if(u===0&&Y.no_wrap){return}if((ag=aa[u])!=null){ag.shutdown()}u=ae(-1);return J(null,Lightbox.PREV)};I=function(ag){if(ag){ag.preventDefault()}if(aa[u].advance_on_click){if(ag.clientX<$j(window).width()/10){return A()}else{return f()}}};Z=function(am){var aj,ai,al,an,ak,ah,ag;aj=aa.dict_by("fq_path");an=void 0;if(am.memo.files){an=am.memo.files.collect(function(ao){return ao.fq_path})}else{an=am.memo.fq_paths}ag=[];for(ak=0,ah=an.length;ak<ah;ak++){al=an[ak];if(aj[al]){ai=aa.indexOf(aj[al]);aa.splice(ai,1);if(Y.num_previews){Y.num_previews--}if(!Y.num_previews&&!aa.length){ag.push(U())}else{if(ai===aa.length){ag.push(A())}else{ag.push(J())}}}else{ag.push(void 0)}}return ag};d=function(ag){if(aa[u].is_a_timeline_preview()){return aa[u].toggle_select(ag)}};y=function(){Event.stopObserving(document,"mousemove",K);Event.stopObserving(document,"click",K);document.stopObserving(Lightbox.PHOTO_DELETE_EVT,r);document.stopObserving(FileEvents.DELETE,Z);document.stopObserving(PhotosSelection.CHANGE_EVT,l);return clearInterval(C)};U=function(aj){var ah,ai,ag,ak;if(aj){aj.preventDefault()}if(!Lightbox.shown){return}if((ai=aa[u])!=null){ai.shutdown()}ah=$("file-preview-modal");ah.hide();ah.down(".preview-content").__date();dom.scroll_unlock_document();y();t();Lightbox.shown=0;ah.stopObserving("click",Lightbox.back);if((ag=$$(".preview-content"))!=null){if((ak=ag.first())!=null){ak.stopObserving("click")}}$j("#file-preview-modal").trigger(Lightbox.LIGHTBOX_HIDE_EVT);if(Lightbox.reload){return Browse.force_reload()}};s="db:filepreview:exitselect";z=function(ah){var ag;if(Y.keep_url){U()}else{if((ag=aa[u])!=null){ag.shutdown()}window.history.go(-1)}if(ah!=null){if(ah.originalEvent){ah=ah.originalEvent}Event.extend(ah).stop()}return document.fire(s,aa[u])};r=(function(ag){return function(ah){return FileOps.do_delete(Browse.active_user,ah.memo.fq_path)}})(this);W=function(){var ag;if(!M){ag=$j("#file-preview-modal");ag.on("click",".close",z);key("esc",Lightbox.KEY_SCOPE,(function(ah){if($j("#lightbox-more-actions-button").hasClass("toggled")){return af()}else{if(i){return S()}else{return z(ah)}}}));ag.on("click",".next",f);ag.on("click",".prev",A);ag.on("click",".preview-container",I);key("left, k",Lightbox.KEY_SCOPE,function(ah){return A()});key("right, j",Lightbox.KEY_SCOPE,function(ah){f();return false});key("up, down",Lightbox.KEY_SCOPE,function(ah){return false});key("x, s, space",Lightbox.KEY_SCOPE,function(ah){d(ah);return false});if(Y.include_delete&&Y.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",Lightbox.KEY_SCOPE,function(ah){Event.extend(ah).preventDefault();return Lightbox.toggle_delete()});$j("#lightbox-delete-photo").on("click",(function(ah){D();return aa[u].delete_pressed()}));$j("#lightbox-delete-cancel").on("click",S)}DBHistory.add_exit_callback("/lightbox",function(){return U()});Util.disableSelection(ag.find(".preview-container")[0]);Util.disableSelection(ag.find(".header")[0]);M=true}Event.observe(document,"mousemove",K);Event.observe(document,"click",K);document.observe(FileEvents.DELETE,Z);document.observe(Lightbox.PHOTO_DELETE_EVT,r);document.observe(PhotosSelection.CHANGE_EVT,l);key.setScope(Lightbox.KEY_SCOPE);return C=setInterval(B,500)};R=function(){var ai,ak,aj,ah,ag;if(!m){return}ag=[];for(ai=aj=0,ah=aa.length;aj<ah;ai=++aj){ak=aa[ai];if(ak.link_hash&&ak.link_hash.toLowerCase()===m.toLowerCase()){u=ai;if(!Lightbox.shown){ag.push(Lightbox.show())}else{ag.push(J())}}else{ag.push(void 0)}}return ag};ac=function(){return on_script_loaded(function(){HashRouter.watch("lh",function(ag){m=ag;return R()});return HashRouter.watch("f",function(ai){var aj,al,ak,ah,ag;ag=[];for(aj=ak=0,ah=aa.length;ak<ah;aj=++ak){al=aa[aj];if(al.filename.toLowerCase()===ai.toLowerCase()){u=aj;if(!Lightbox.shown){ag.push(Lightbox.show())}else{ag.push(J())}}else{ag.push(void 0)}}return ag})})};l=function(ak,am){var ai,al,ah,aj,ag;if(am==null){am=$j("#lightbox_share")}ah=PhotosSelection.get();aj=PhotosUtil.categorize_files(ah),ai=aj[0],al=aj[1];if(ah.length===0){am.text(_("Share"));return(ag=aa[u])!=null?ag.toggle_select_button_off($j("#lightbox-select-button")):void 0}else{if(ah.length===1){if(ai){return am.text(_("Share 1 photo"))}else{return am.text(_("Share 1 video"))}}else{if(ai&&al){return am.text(_("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:ah.length}))}else{if(ai){return am.text(_("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:ah.length}))}else{return am.text(_("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:ah.length}))}}}}};w=function(){TitleBubble.hide_all();$j("#file-preview-modal .delete-file-prompt").show();$j(document).trigger("dropdownOpened",[1]);v();i=true;X(Lightbox.toggle_delete);return $j("#lightbox-delete-photo").focus()};S=function(){var ah,ag;if(i){ah=$j("#file-preview-modal .delete-file-prompt");ah.hide();$j(document).trigger("dropdownClosed",[1]);if((ag=ah.find(":focus")[0])!=null){ag.blur()}K();i=false;return p()}};D=function(){af();if(i){return S()}else{return w()}};h=function(){return aa[u].delete_pressed()};return{init_from_preview_objs:function(aj,an,ai){var am,al,ag,ak,ah;if(ai==null){ai=true}ag=[];for(ak=0,ah=aj.length;ak<ah;ak++){am=aj[ak];if(am.is_video){al=new VideoPreview({filename:am.filename,fq_path:am.path,thumbnail_url_tmpl:am.thumbnail_url,preview_url:am.preview_url,dl_url:am.dl_url,shmodel_link:am.shmodel_link,ns_id:am.ns_id,ns_path:am.path,link_hash:am.item_id+"-"+am.filename,metadata_link:am.metadata_link,activity_key:am.activity_key})}else{al=new PhotoPreview({filename:am.filename,fq_path:am.path,thumbnail_url_tmpl:am.thumbnail_url,dl_url:am.dl_url,original_url:am.orig_url,shmodel_link:am.shmodel_link,ns_id:am.ns_id,ns_path:am.ns_path,link_hash:am.item_id+"-"+am.filename,activity_key:am.activity_key})}ag.push(al)}Lightbox.init(ag,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:ai});return document.on(Lightbox.EXIT_SELECT_EVT,(function(ao){return function(aq){var ap;key.setScope("all");ap=$j(an)[ag.indexOf(aq.memo)];Util.scroll_to_thumb(ap);$j(ap).addClass("wiggobble");return setTimeout((function(){return $j(ap).removeClass("wiggobble")}),1000)}})(this))},init:function(ag,ah){if(Lightbox.shown){return}Lightbox.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:_("More actions")});Lightbox.more_actions_button.observe("click",((function(ai){return function(aj){aj.preventDefault();return Lightbox.toggle_more_actions_menu()}})(this)));Lightbox.more_actions_button.__date(Sprite.make("web","lightbox_more"));ah=ah||{};Y={include_delete:ah.include_delete||false,keep_url:ah.keep_url||false,num_previews:ah.num_previews||null,filename_in_url:ah.filename_in_url||false,no_wrap:(ah.no_wrap||false)||true,no_preload:ah.no_preload||false,enable_sublinks:ah.enable_sublinks!=null?ah.enable_sublinks:true,share_button_experiment_variant:ah.share_button_experiment_variant||false};F=ah.is_loading||false;assert(!Y.filename_in_url||Y.keep_url,"filename_in_url cannot be used with keep_url off");aa=ag;if(ah.start_index!=null){Lightbox.show(ah.start_index)}if(Y.filename_in_url){ac()}return $(document.body).on("click",".more-actions-item",function(ai,aj){if(aj.down("a").getAttribute("href").length<2){ai.preventDefault()}return Lightbox.close_more_actions_menu()})},update_previews:function(ag){return aa=ag},show:function(ag){var ah;if(Lightbox.shown){return}assert(aa&&aa.length,"Lightbox.show() requires file preview objects to show");W();if(ag!=null){u=ag}$j("#file-preview-modal").trigger("lightbox-init-show",{preview:aa[u]});assert(!Lightbox.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();dom.scroll_lock_document();J(true);Lightbox.shown=1;if(!Y.keep_url){ah=DBHistory.deconstruct_url(DBHistory.get_url());if(ah.path.indexOf("/lightbox/")!==0){DBHistory.push_state("/lightbox"+ah.path,ah.qargs)}}return K()},jump_to:function(ag){assert(Lightbox.shown,"Lightbox should be showing");u=ag;J();return K()},set_no_wrap:function(ag){return Y.no_wrap=ag},refresh_file_list:function(aj){var ai,al,ah,ak,ag;if(Lightbox.shown){al=aa[u].fq_path}aa=BrowseUtil.browsefile_to_filepreview(aj);R();if(!Lightbox.shown){return}for(ah=ak=0,ag=aa.length;ak<ag;ah=++ak){ai=aa[ah];if(ai.fq_path===al){u=ah;break}}F=false;a=false;return O()},update_with_error:function(){g=true;return O()},num_previews:function(){return Y.num_previews||aa.length},get_previews:function(){return aa},current_index:function(){return u},close_more_actions_menu:af,toggle_more_actions_menu:n,update_share_button_text:l,toggle_delete:D,delete_current:h,back:z,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:s,reload:false,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var Tour;Tour=(function(){var d,c,f,g,k,i,j,h,e,l,b,a;c=6;d=0;b=function(m){var v,u,t,o,n,p,r,s,q;$$(".page-end").each(Element.remove);n=m;r=c-m-1;v=document.createDocumentFragment();for(u=s=0;0<=n?s<n:s>n;u=0<=n?++s:--s){o=new Element("img",{src:"/static/images/page-left.png","class":"page-end-left page-end"});o.style.left=(28-u*5)+"px";o.style.zIndex=c-u;v.appendChild(o)}for(t=q=0;0<=r?q<r:q>r;t=0<=r?++q:--q){p=new Element("img",{src:"/static/images/page-right.png","class":"page-end-right page-end"});p.style.right=(31-t*5)+"px";p.style.zIndex=c-t;v.appendChild(p)}return $("book").appendChild(v)};a=function(m){(m>0?Element.show:Element.hide)("tour-page-back");return(m+1<c?Element.show:Element.hide)("tour-page-forward")};e=function(m){$$(".pages").invoke("hide");return $("page-"+m).show()};f=function(m){a(m);b(m);e(m);return d=m};h=function(n){var m;Event.extend(n).preventDefault();m=d-1;if(m<0){return}f(m);return DBHistory.push_state("/tour/"+m)};i=function(n){var m;Event.extend(n).preventDefault();m=d+1;if(m>=c){return}f(m);return DBHistory.push_state("/tour/"+m)};l=function(n,o){var m;n.preventDefault();m=parseInt(o.href.split("/").last(),10);f(m);return DBHistory.push_state("/tour/"+m)};k=function(){$("tour-page-back").observe("click",h);$("tour-page-forward").observe("click",i);key("right",i);key("left",h);return $("toc").on("click","a",l)};g=function(n,o){var m;m=parseInt(n,10)||0;return f(m)};j=function(){var q,p,n,o,m;o=$$(".page-right img");m=[];for(p=0,n=o.length;p<n;p++){q=o[p];m.push(Util.preload_image(q.src))}return m};return{setup:function(){return $j(function(){DBHistory.add_callback("/tour",g);k();return j()})}}})();var Photos,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(g,b,d,k,h,c,a,i,m){var f,j,l,e;this.event_metadata_cache=a;this.initialized=true;this.disable_selection();Util.disable_ie_image_dragging();this._tmpl=HTML.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=HTML.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=h!=null?h.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=i.include_shared_folders;this.show_hidden=i.show_hidden;this.timestamp_edit_enabled=m.timestamp_edit_enabled;this.undo_enabled=m.undo_enabled;this.local_storage_enabled=m.local_storage_enabled;j=DBHistory.deconstruct_url();e="share" in j.qargs;for(l in k){if(k.hasOwnProperty(l)){PhotosSelection.inc_num_loading_events_before_select(e)}}this._init_timeline(g,b,d,k);this._init_lightbox();f=[];if(h!=null){f.push(new PhotoCollection(h,false))}PhotosCollections.init(f,c);PhotosSelection.drag_select_enabled=m.drag_select_enabled;if(i.show_photos_tour){PhotosTour.next()}delete j.qargs.selr;delete j.qargs.user_email;delete j.qargs.uid;delete j.qargs.share;delete j.qargs.m;if("uuid" in j.qargs){delete j.qargs.uuid;delete j.qargs.id}if(HTML5_HISTORY){DBHistory.replace_state(j.path,j.qargs)}else{if(!URI.parse(window.location.href).fragment){DBHistory.push_state("/photos",j.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(Lightbox.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(Lightbox.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(Lightbox.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(Lightbox.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(ContextMenu.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));DBHistory.add_callback("/photos",this._history_change_handler.bind(this));document.observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(PhotoEvent.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(PhotoTimeline.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(PhotoTimeline.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));$j("#photos-nav-item").on("click",this.show_all_photos.bind(this));$j("#back-to-photos").on("click",this._back_to_photos.bind(this));$j("#back-to-albums").on("click",this._back_to_albums.bind(this));$j("#share-selected").on("click",this._share_selected.bind(this));$j("#clear-selected").on("click",this._clear_selected.bind(this));$j("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){$j("#do-include-shared-folders").prop("checked",true)}else{$j("#dont-include-shared-folders").prop("checked",true)}PhotosCollections.listen();PhotosSelection.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return $j(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(i){var d,h,c,g,b,f,a;h=$(i.target).up(".cu-month-header").identify().slice(2);d=this.get_timeline().events.valueFromKey(h);f=d.photos;a=[];for(g=0,b=f.length;g<b;g++){c=f[g];a.push(PhotosSelection._add(c))}return a},_share_event:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return this._share_selected()},_add_event_to_album:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return PhotosCollections.show_add_to_album_modal(h,PhotosSelection.get())},_init_timeline:function(h,c,d,j){var b,k,i,a,l,g,f,e;if(!h.length){this.show_empty_state();return}b=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");g=$("cu-view").cumulativeOffset().top+b.getLayout().get("margin-top")+b.getLayout().get("padding-top");i=$("cu-view").cumulativeOffset().left+b.getLayout().get("margin-left")+b.getLayout().get("padding-left");k={top_offset:g,left_offset:i,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};a={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};l=new PhotoTimeline(b,null,h,c,d,j,this._tmpl,k,a);if(this.in_single_collection_view()){if((f=this._single_collection_timeline)!=null){f.unlisten()}this._single_collection_timeline=l}else{if((e=this._all_photos_timeline)!=null){e.unlisten()}this._all_photos_timeline=l}return this.get_timeline().render()},_init_lightbox:function(){var b,a;if(this.get_timeline()==null){return}if(Lightbox.shown){a=this.get_timeline().get_preview_objs();if(a.length){Lightbox.update_previews(a);b=Math.min(Lightbox.current_index(),a.length-1);return Lightbox.jump_to(b)}else{return Lightbox.back()}}else{return Lightbox.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(b){var a;if((a=this.get_timeline())!=null){a.unlisten()}PhotosSelection.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(b);return window.scrollTo(0,0)},_refresh_photo_events:function(a){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(b){return function(c){var d;d=JSON.parse(c.responseText);if(d==="deleted_collection"){b._current_collection_gid=null;PhotosCollections.reload();b.show_all_collections();Notify.error(_("This album has been deleted!"));return}b._init_timeline(d.header_ids,d.header_id_to_name,d.header_id_to_num_photos,{});b._init_lightbox();return typeof a==="function"?a():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(a){if(a.duplicates_info!=null){return this._show_duplicates_modal(a,false)}else{return window.open(this._get_browse_link(a),"_blank")}},_get_browse_link:function(b){var a;a=Util.get_browse_root(Viewer.get_viewer().photos_user);return String(URI({path:""+a+(FilePath.normalize(FilePath.parent_dir(b.fq_path))),query:{select:b.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return PhotosCollections.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return Util.enableSelection($(document.body))},disable_selection:function(){return Util.disableSelection($(document.body))},show_collection:function(c){var b,a;PhotosLogger.log_transition_to(PhotosViews.SINGLE_COLLECTION_VIEW);a=DBHistory.deconstruct_url();b="/lightbox";if(a.path.indexOf(b)===0){a.path=a.path.slice(b.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(__indexOf.call(a.path,"/album/")<0){if(a.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(c!=null){a.path=PhotosCollections.get(c).url}return DBHistory.push_state(a.path,a.qargs)},show_all_collections:function(){PhotosLogger.log_transition_to(PhotosViews.ALBUMS_VIEW);return DBHistory.push_state("/photos/all_albums")},show_all_photos:function(b){var a;b.preventDefault();PhotosLogger.log_transition_to(PhotosViews.PHOTOS_VIEW);a=DBHistory.deconstruct_url();if(a.path==="/photos"){return this._refresh_view()}else{PhotosSelection.clear();return DBHistory.push_state("/photos")}},_back_to_photos:function(a){PhotosSelection.clear();return this.show_all_photos(a)},_back_to_albums:function(a){PhotosSelection.clear();return this.show_all_collections()},get_thumb_click_event_data:function(c,a){var b;b=c.event;return{timeline_photo_index:a,event_photo_index:b.photos.indexOf(c),num_photos_in_event:b.photos.length,event_index:this.get_timeline().events.list.indexOf(b.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(b){var a;a=this.get_timeline().get_photo_for_thumb_elm($(b.target));if(PhotosSelection._drag_drop.ignore_next_click){return PhotosSelection._drag_drop.ignore_next_click=false}else{return PhotosSelection.photo_click(b,a)}},_thumb_double_click:function(d){var c,b,a;b=this.get_timeline().get_photo_for_thumb_elm($(d.target));a=this.get_timeline().index_of_photo(b);this._preview(a);c=this.get_thumb_click_event_data(b,a);return PhotosLogger.log_interaction(PhotosEvents.OPEN_LIGHTBOX,PhotosTriggers.DBL_CLICK,c)},_thumb_context_menu:function(g){var c,h,f,b,d,a;c=this.get_timeline().get_photo_for_thumb_elm($(g.target));if(g.shiftKey){PhotosSelection.photo_click(g,c);return}if(PhotosSelection.contains(c)){h=PhotosSelection.get()}else{h=[c]}ContextMenu.show_photos(g,h);a=[];for(f=0,b=h.length;f<b;f++){c=h[f];a.push((d=this.get_timeline().get_thumb_elm_for_photo(c))!=null?d.addClassName("context-selected"):void 0)}return a},_context_menu_hide:function(a){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(b){var a;a=PhotosSelection.get();if(!a.length){return}Foshmodal.show(a,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.SAH,{num_photos:a.length})},_clear_selected:function(b){var a;a=PhotosSelection.get().length;PhotosSelection.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.SAH,{num_photos:a})},_share_collection:function(b){var a;assert(this.in_single_collection_view(),"_share_collection can only happen in single collection view");a=this.get_current_collection();if(a.num_items===0){Notify.error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(this.get_current_collection(),true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.SCA)},toggle_mem_lane_settings:function(a){var c,b;if(a){Event.extend(a).preventDefault()}if(!$j("#memory-lane-settings-menu").visible()){b=$j("#memory-lane-settings-menu");FreshDropdown.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));c=function(d){return d.stopPropagation()};b.off("mousedown");b.off("click");b.on("mousedown",c);return b.on("click",c)}},show_delete_photos_modal:function(i){var j,f,c,g,a,b,d,h,e;if(i.length===1){b=i[0];if(b.duplicates_info!=null){this._show_duplicates_modal(b,true);return}}else{j=[];for(d=0,h=i.length;d<h;d++){b=i[d];if(b.duplicates_info!=null){f=b.duplicates_info.slice(0);f.push(b);f.sort(function(l,k){return k.mtime-l.mtime});j=j.concat(f)}}if(j.length){this._show_delete_multiple_duplicates_modal(i,j);return}}e=PhotosUtil.categorize_files(i),g=e[0],a=e[1];if(g&&a){c=ungettext("Delete %(file_count)s item?","Delete %(file_count)s items?",i.length)}else{if(g){c=ungettext("Delete %(file_count)s photo?","Delete %(file_count)s photos?",i.length)}else{c=ungettext("Delete %(file_count)s video?","Delete %(file_count)s videos?",i.length)}}return SimpleModal.show({title_text:c.format({file_count:i.length}),body_html:_("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:PhotosUtil.file_desc(i)}),confirm_text:_("Delete"),cancel_text:_("Cancel"),confirm_callback:(function(k){return function(){return k._delete_photos(i)}})(this)})},_delete_photos:function(p){var l,j,d,m,a,b,o,i,g,f,n,c,h,e,k;p=p.slice(0);o=[];for(g=0,n=p.length;g<n;g++){b=p[g];o.push(b.fq_path);if(b.duplicates_info!=null){h=b.duplicates_info;for(f=0,c=h.length;f<c;f++){d=h[f];o.push(d.fq_path)}}}e=PhotosUtil.categorize_files(p),m=e[0],a=e[1];if(m&&a){j=ungettext("Deleting file","Deleting files",o.length);l=ungettext("Deleted file.","Deleted files.",o.length)}else{if(m){j=ungettext("Deleting photo","Deleting photos",o.length);l=ungettext("Deleted photo.","Deleted photos.",o.length)}else{j=ungettext("Deleting video","Deleting videos",o.length);l=ungettext("Deleted video.","Deleted videos.",o.length)}}k=function(q){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(q)},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(r){var s;s=_("Undo complete");Notify.success(s);return Photos._all_photos_timeline.restore_removed_photos()},subject_user:Viewer.get_viewer().photos_user})};i=(function(q){return function(r){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:o},job:o.length>Photos.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:Viewer.get_viewer().photos_user,progress_text:j,onSuccess:function(u){var s,v,t;v=u.responseText.evalJSON();t=Photos.undo_enabled&&(Photos._all_photos_timeline!=null);s=t?v.changesets:null;UndoAction.notifyWithUndo(j,s,k);Photos.get_timeline().remove_photos(p);if(r.length>0){return PhotosCollections.refresh_album_views(r)}},subject_user:Viewer.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(o)},onSuccess:(function(q){return function(t){var s,r,u,v;r=JSON.parse(t.responseText);u=[];for(v in r){s=r[v];u=u.concat(s)}return i(u)}})(this)})},_preview:function(a){return Lightbox.show(a)},_lightbox_delete:function(a){var b;b=a.memo.photo;PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.LIGHTBOX);return this.show_delete_photos_modal([b])},_lightbox_remove:function(b){var a;a=b.memo.photo;this.get_current_collection().remove_photos([a]);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.LIGHTBOX)},_show_duplicates_modal:function(b,q){var i,p,g,k,j,d,m,c,h,l,a,o,e,n,f;j=b.duplicates_info.slice(0);j.push(b);j.sort(function(s,r){return r.mtime-s.mtime});k=$("cu-duplicate-files");d=[];for(e=0,n=j.length;e<n;e++){g=j[e];p="Dropbox"+FilePath.normalize(FilePath.parent_dir(g.fq_path));d.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:Emstring.em_snippet(g.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:Emstring.em_snippet(p,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}k.__date(d);if(j.length>=5){k.addClassName("scroll")}else{k.removeClassName("scroll")}f=PhotosUtil.categorize_files([b]),l=f[0],a=f[1];if(l){c=_("There are multiple copies of this photo.");h=_("Delete all copies of this photo?")}else{c=_("There are multiple copies of this video.");h=_("Delete all copies of this video?")}if(q){m="delete_32";o=h;i=c+" "+_("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{m="folder_32";o=_("Show in folder");i=c+" "+_("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}DomUtil.fillVal(i,"cu-duplicates-desc");return Modal.show(o,$("cu-duplicates-modal"),{action:this._delete_photos.curry([b])})},_show_delete_multiple_duplicates_modal:function(n,i){var m,g,j,c,b,h,f,k,a,d,l,e;j=$("cu-multiple-duplicate-files");c=[];for(d=0,l=i.length;d<l;d++){g=i[d];m="Dropbox"+FilePath.normalize(FilePath.parent_dir(g.fq_path));c.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:Emstring.em_snippet(g.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:Emstring.em_snippet(m,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}j.__date(c);if(i.length>=5){j.addClassName("scroll")}else{j.removeClassName("scroll")}e=PhotosUtil.categorize_files(n),k=e[0],a=e[1];if(k&&a){b=_("Delete %(num_files)s files and all copies?").format({num_files:n.length});h=_("There are multiple copies of these files in your Dropbox.");f=_("Show files with multiple copies")}else{if(k){b=_("Delete %(num_photos)s photos and all copies?").format({num_photos:n.length});h=_("There are multiple copies of these photos in your Dropbox.");f=_("Show photos with multiple copies")}else{b=_("Delete %(num_videos)s videos and all copies?").format({num_videos:n.length});h=_("There are multiple copies of these videos in your Dropbox.");f=_("Show videos with multiple copies")}}DomUtil.fillVal(h,"cu-multiple-duplicates-desc");DomUtil.fillVal(f,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return Modal.show(b,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(n)})},show_timestamps_modal:function(f){var b,c,d,a,e;f.sort_by_key((function(g){return g.time_taken}),true);a=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.time_taken)}return g})();b=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.item_counter)}return g})();c=(function(){var i,h,g;g=[];for(i=0,h=a.length;i<h;i++){e=a[i];if(e==null){g.push(e)}}return g})();if(c.length===a.length){return this._show_add_timestamps_modal(f,a,b)}else{if(c.length===0){return this._show_edit_timestamps_modal(f,a,b)}else{return assert(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(a,b){return this._refresh_photo_events((function(c){return function(){var d,e;e=("m_"+(b.getFullYear()))+(""+(b.getMonth()+1)).lpad(2);d=c.get_timeline().events.valueFromKey(e);assert(d!=null,"Event is missing after a timestamp edit!");ModalProgress.update("2/3");d.on_load_all_metadata=function(){c.get_timeline().scroll_to_photo_with_key(a.uniqueness_key);ModalProgress.hide();return Notify.success("New timestamps have been saved!")};if(d.has_loaded_metadata()){d.on_load_all_metadata();return d.on_load_all_metadata=null}else{return d.load_metadata()}}})(this))},_show_add_timestamps_modal:function(e,b,a){var d,c;c=$j("#add-timestamp-modal");d=new DBCalendar("date_picker",{disable_future:true});return Modal.show("Set Timestamps",c[0],{action:(function(f){return function(){var k,o,m,n,h,j,l,g;m=Util.to_iso8601_date(d.selected_date,false,true);n=(function(){var q,p,i;i=[];for(j=q=0,p=e.length;0<=p?q<p:q>p;j=0<=p?++q:--q){i.push(m)}return i})();h={};for(k=l=0,g=a.length;l<g;k=++l){o=a[k];h[o]=n[k]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(h)},onSuccess:function(i){ModalProgress.update("1/3");return f._scroll_to_photo_after_timestamp_edit(e[0],d.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(i,h,d){var a,g,c,e,f,b;g=$j("#edit-timestamp-modal");a=(function(){var l,k,j;j=[];for(l=0,k=h.length;l<k;l++){e=h[l];j.push(DateUtil.toUTCDate(new Date(e)))}return j})();c={year:0,month:0,day:0,hour:0};f=function(j){return _("%(date)s at %(time)s").format({date:DateUtil.localize(j),time:DateUtil.format(j,Constants.time_format)})};b=function(j,n,o,m){var l,k;if(j==null){j=0}if(n==null){n=0}if(o==null){o=0}if(m==null){m=0}c.year+=j;c.month+=n;c.day+=o;c.hour+=m;k=datetime.increment_date(new Date(a[0]),c.year,c.month,c.day,c.hour,0);l=datetime.increment_date(new Date(a[a.length-1]),c.year,c.month,c.day,c.hour,0);if(i.length===1){return g.find("#timestamp-new").text(f(k))}else{g.find("#timestamp-new-start").text(f(k));return g.find("#timestamp-new-end").text(f(l))}};if(i.length===1){g.find("#edit-timestamp-single").show();g.find("#edit-timestamp-multi").hide();g.find("#timestamp-current").text(f(a[0]))}else{g.find("#edit-timestamp-single").hide();g.find("#edit-timestamp-multi").show();g.find("#timestamp-current-start").text(f(a[0]));g.find("#timestamp-current-end").text(f(a[a.length-1]))}b();$j("#timestamp-year-plus").on("click",b.curry(1,0,0,0));$j("#timestamp-year-minus").on("click",b.curry(-1,0,0,0));$j("#timestamp-month-plus").on("click",b.curry(0,1,0,0));$j("#timestamp-month-minus").on("click",b.curry(0,-1,0,0));$j("#timestamp-day-plus").on("click",b.curry(0,0,1,0));$j("#timestamp-day-minus").on("click",b.curry(0,0,-1,0));$j("#timestamp-hour-plus").on("click",b.curry(0,0,0,1));$j("#timestamp-hour-minus").on("click",b.curry(0,0,0,-1));Modal.onHide=function(){var j,m,k,l;l=["year","month","day","hour"];for(m=0,k=l.length;m<k;m++){j=l[m];$j("#timestamp-"+j+"-plus").off("click");$j("#timestamp-"+j+"-minus").off("click")}Modal.onHide=null;return Modal.hide()};return Modal.show("Edit Timestamps",g[0],{action:(function(j){return function(){var u,q,k,l,r,w,s,o,v,p,n,m;if((((c.year===(m=c.month)&&m===(n=c.day))&&n===(p=c.hour))&&p===0)){return}PhotosLogger.log_interaction(PhotosEvents.EDIT_TIMESTAMP,PhotosTriggers.PCM,{num_photos:i.length});l=(function(){var y,x,t;t=[];for(y=0,x=a.length;y<x;y++){u=a[y];t.push(datetime.increment_date(u,c.year,c.month,c.day,c.hour,0))}return t})();r=(function(){var y,x,t;t=[];for(y=0,x=l.length;y<x;y++){w=l[y];t.push(Util.to_iso8601_date(w,false,true))}return t})();s={};for(q=o=0,v=d.length;o<v;q=++o){k=d[q];s[k]=r[q]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(s)},job:i.length>j.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:Viewer.get_viewer().photos_user,onSuccess:function(t){ModalProgress.update("1/3");return j._scroll_to_photo_after_timestamp_edit(i[0],l[0])}})}})(this)})},_preload_file_previews:function(d){var k,h,c,a,p,o,l,j,m,g,f,n,b,e;m=this.get_timeline().get_photos();if(d[0]<=d[d.length-1]){j=null;for(g=0,n=d.length;g<n;g++){h=d[g];a=m[h];if(a.status!==Photo.PLACEHOLDER){continue}p=a.event;if(j==null){j=p;l=a}if(p===j){continue}if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}j.load_metadata();j=p;l=a}if((j!=null)&&!j.has_loaded_metadata()){k=j.photos.indexOf(l);c=j.photos.indexOf(a);if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return j.load_metadata_range(k,c)}}else{e=[];for(f=0,b=d.length;f<b;f++){h=d[f];a=m[h];if(a.status!==Photo.PLACEHOLDER){continue}p=a.event;o=p.photos.indexOf(a);e.push(p.load_metadata(o))}return e}},_lightbox_photo_change:function(j){var a,l,g,k,h,f,i,d,c,b;this._last_lightbox_photo=j.memo.preview_obj.photo;a=j.memo.index;g=Lightbox.num_previews();if(a===0||a===g-1){return}if(j.memo.direction===Lightbox.NEXT||(j.memo.direction==null)){l=Math.min(a+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,g-1);return this._preload_file_previews((function(){c=[];for(var e=i=a+1;i<=l?e<=l:e>=l;i<=l?e++:e--){c.push(e)}return c}).apply(this))}else{if(j.memo.direction===Lightbox.PREV){k=Math.max(a-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){b=[];for(var e=d=a-1;d<=k?e<=k:e>=k;d<=k?e++:e--){b.push(e)}return b}).apply(this))}}},_lightbox_exit:function(a){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var c,b,d,a;b=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");c=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((d=this._all_photos_timeline)!=null){d.update_offsets(b,c)}return(a=this._single_collection_timeline)!=null?a.update_offsets(b,c):void 0},_history_change_handler:function(n,m){var i,j,k,f,d,g,l,h,e,c,b,a;if(this._init_finished){if(Modal.shown()){Modal.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((h=this.get_timeline())!=null){h.unlisten()}if(n==="all_albums"){PhotosCollections.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((e=$("all-albums-sidebar"))!=null){e.addClassName("selected")}PhotosSelection.clear();document.title=_("Albums")+" - Dropbox";PhotosCollections.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(n.startsWith("album/")){i=PhotosCollections.get_from_url("/photos/"+n);c=$$(".sidebar-album");for(g=0,l=c.length;g<l;g++){k=c[g];if(k.readAttribute("data-gid")===i.gid){k.addClassName("selected");break}}$("single-collection-title").__date(Emstring.em_snippet(i.name,PhotosCollections.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(i.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",i.shmodel_url);if(((b=i.member_fnames)!=null?b.length:void 0)>1){j=_("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:PhotosUtil.album_desc(i),album_members:Util.nice_list(i.member_fnames)});$("single-collection-share-status").__date(j)}else{$("single-collection-share-status").__date(_("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!i.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+i.name+" - Dropbox";AlbumsLogger.log_event("show_collection",i.gid,i.num_photos,i.is_anonymous)}else{i=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=_("Photos")+" - Dropbox"}f=false;if(i!=null){if(i.gid!==this._current_collection_gid){f=true}}else{if(this._all_photos_timeline==null){f=true}}this._current_collection_gid=i!=null?i.gid:null;if(f){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){d=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(d);if((a=$(d))!=null){a.addClassName("wiggobble")}setTimeout((function(){return $(d).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var PhotosTour;PhotosTour={_frame:0,next:function(){var a;Modal.show("",$j("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);a=this._frame;PhotosLogger.log_interaction(PhotosTourEvents.SHOW_MODAL,"",{frame:a});$j("#modal-x").off("click");$j("#modal-x").on("click",((function(b){return function(){return PhotosLogger.log_interaction(PhotosTourEvents.EXIT_MODAL,"",{frame:a})}})(this)));return this._frame=(this._frame+1)%4},hide:function(a){PhotosLogger.log_interaction(a,"");return Modal.hide()}};var PhotosUtil;PhotosUtil={categorize_files:function(b){var c,a;c=b.filter(function(d){return d.preview_type==="photo"});a=b.filter(function(d){return d.preview_type==="video"});return[c.length,a.length]},file_desc:function(f,c,a){var b,e,d;if(c==null){c=false}if(a==null){a=false}d=this.categorize_files(f),b=d[0],e=d[1];return this._photo_video_desc(b,e,c,a)},album_desc:function(c,b,a){if(b==null){b=false}if(a==null){a=false}return this._photo_video_desc(c.num_photos,c.num_videos,b,a)},_photo_video_desc:function(b,g,c,a){var d,f,e;f=ungettext("%d photo","%d photos",b,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(b);e=ungettext("%d video","%d videos",g,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(g);if(b&&g){if(c){d=b+g;return ungettext("%d item","%d items",d).format(d)}else{if(a){return new HTML(""+f+"<br/>"+e)}else{return _("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:f,num_videos:e})}}}else{if(b){return f}else{if(g){return e}else{return""}}}}};var PhotosSelection,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(a){return function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&a._last_mouseover&&!dom.focus_in_input()){return a._highlight_range(a._last_selected,a._last_mouseover)}}})(this));$(document.body).on("keyup",(function(a){return function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&!a._marquee.active){return a.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",Photos.KEY_SCOPE,(function(a){return function(b){b.preventDefault();if(Photos.in_single_collection_view()){if(a._selected.length){return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),a._selected)}}else{if(a._selected.length){return Photos.show_delete_photos_modal(a._selected)}}}})(this));key("esc",Photos.KEY_SCOPE,(function(a){return function(c){var b;if(typeof c.preventDefault==="function"){c.preventDefault()}if(a._drag_drop.active){a._drag_drop.active=false;if((b=$("albums-sidebar-list"))!=null){b.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{a.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return DragScroll.init(null,$j("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(b){var a,d,c;d=(function(){var h,f,g,e;g=this._selected;e=[];for(h=0,f=g.length;h<f;h++){a=g[h];e.push(a.uniqueness_key)}return e}).call(this);return c=b.uniqueness_key,__indexOf.call(d,c)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");FreshDropdown.hide_all();return document.fire(PhotosSelection.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(b,a){if(b.isRightClick()&&!b.shiftKey){return}if(b.shiftKey){return this._select_highlighted()}else{if(this.contains(a)){return this._remove(a)}else{return this._add(a)}}},num_selected:function(){return this._selected.length},refresh:function(d){var f,g,c,h,e,b,a;h=(function(){var l,j,k,i;k=this._selected;i=[];for(l=0,j=k.length;l<j;l++){c=k[l];i.push(c.uniqueness_key)}return i}).call(this);a=[];for(e=0,b=d.length;e<b;e++){g=d[e];f=h.indexOf(g.uniqueness_key);if(f>=0){a.push(this._selected[f]=g)}else{a.push(void 0)}}return a},inc_num_loading_events_before_select:function(a){if(!this._show_share_after_loading_selected){ModalProgress.show(_("Loading photos..."))}this._show_share_after_loading_selected=a;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;ModalProgress.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){ModalProgress.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return Photos._share_selected()}}}},_photo_mouseover:function(a){this._last_mouseover=Photos.get_timeline().get_photo_for_thumb_elm($(a.target));if(a.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(a){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(d){var a,b,c;if(Photos.in_all_collections_view()||d.isRightClick()||this._invalid_mouse_target($(d.target))){return}ContextMenu.hide();FreshDropdown.hide_all();a=(c=Photos.get_timeline())!=null?c.get_photo_for_thumb_elm($(d.target)):void 0;if(a!=null){if(this.contains(a)||!PhotosSelection.drag_select_enabled){b=dom.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=d.clientX+b.left;this._drag_drop.start_y=d.clientY+b.top;this._drag_drop.anchor=$(d.target);this._drag_drop.single_photo=this.contains(a)?null:a;this._build_drag_status(a);this._update_drag_status_position(d)}else{this._drag_select.active=true;this._drag_select.anchor=a}}else{b=dom.scroll_offsets();if((d.clientX+b.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=d.clientX+b.left;this._marquee.start_y=d.clientY+b.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return DragScroll.start()},_body_mousemove:function(d){var b,a,f,c;b=dom.scroll_offsets();a=d.clientX+b.left;f=d.clientY+b.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(a-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=a;this._marquee.end_y=f;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(a-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(d);$$(".sidebar-album").invoke("removeClassName","album-flash");if((c=$("albums-sidebar-list"))!=null){c.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(c){var b,a;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();b=this._highlighted.length;this._select_highlighted();if(b){PhotosLogger.log_interaction(PhotosEvents.MARQUEE_SELECT,PhotosTriggers.DRAG,{num_selected:b})}}if(this._drag_drop.active){if($(c.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((a=$("albums-sidebar-list"))!=null){a.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return DragScroll.end()},_body_double_click:function(a){if(Photos.get_timeline().get_photo_for_thumb_elm($(a.target))||this._invalid_mouse_target($(a.target))){return}this.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.DBL_CLICK)},_draw_marquee:function(){var a,e,d,c,b;b=Math.abs(this._marquee.start_x-this._marquee.end_x);a=Math.abs(this._marquee.start_y-this._marquee.end_y);d=Math.min(this._marquee.start_y,this._marquee.end_y);e=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:b+"px",height:a+"px",top:d+"px",left:e+"px"});$("marquee").show();c=false;if(Photos.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);c=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);c=true}if(c){return this._update_marquee_highlight(d,e,b,a)}}},_update_marquee_highlight:function(m,c,a,o){var k,l,h,b,g,f,n,j,e,d;this.clear_highlighted();b=[];l=Photos.get_timeline().grid.photo_col_offsets.length;j=Photos.get_timeline().grid.photo_col_offsets.slice(0,l-1);for(k=g=0,n=j.length;g<n;k=++g){h=j[k];if(h<=c+a&&Photos.get_timeline().grid.photo_col_offsets[k+1]>=c){b.push(k)}}d=[];for(k=f=0,e=Photos.get_timeline().events.length();0<=e?f<e:f>e;k=0<=e?++f:--f){d.push(Photos.get_timeline().events.valueAtIndex(k).marquee_highlight(m,m+o,b))}return d},_update_marquee_x_bounds:function(a){var d,g,h,f,c,e,b;g=$(document.body).getWidth();if(a<Photos.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=Photos.get_timeline().grid.photo_col_offsets.first()}else{if(a>Photos.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=g}else{e=Photos.get_timeline().grid.photo_col_offsets;b=[];for(d=f=0,c=e.length;f<c;d=++f){h=e[d];if(h>a){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets[d-1];this._marquee.x_max_boundary=h;break}else{b.push(void 0)}}return b}}},_update_marquee_y_bounds:function(h){var a,e,d,g,c,f,b;d=$(document.body).getHeight();if(h<Photos.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=Photos.get_timeline().grid.photo_row_offsets.first()}else{if(h>Photos.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=d}else{f=Photos.get_timeline().grid.photo_row_offsets;b=[];for(e=g=0,c=f.length;g<c;e=++g){a=f[e];if(a>h){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets[e-1];this._marquee.y_max_boundary=a;break}else{b.push(void 0)}}return b}}},_build_drag_status:function(d){var c,a,b;a=Photos.get_timeline().get_thumb_elm_for_photo(d);b=a.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(b);c=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(PhotosUtil.file_desc(c,false,true))},_update_drag_status_position:function(a){return $("photos-drag-status").setStyle({left:(a.pointerX()-dom.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(a.pointerY()-dom.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(n,m,c){var l,a,d,h,k,j,b,f,g,e;if(c==null){c=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=n;this._last_highlight_to_photo=m;d=Photos.get_timeline().index_of_photo(n);b=Photos.get_timeline().index_of_photo(m);l=!c&&this.contains(m)&&!this.contains(n);e=[];for(h=f=d;d<=b?f<=b:f>=b;h=d<=b?++f:--f){j=Photos.get_timeline().photo_at_index(h);if(j.status===Photo.PLACEHOLDER){if(j.event!==k){a=j.event;if(!a.has_loaded_metadata()){a.on_load_all_metadata=this._highlight_range_incremental.bind(this);a.load_metadata();if(g=a.unique_id,__indexOf.call(this._events_highlighting,g)<0){this._events_highlighting.push(a.unique_id)}e.push(k=a)}else{e.push(void 0)}}else{e.push(void 0)}}else{if(this.contains(j)){if(l){e.push(this._dehighlight(j))}else{e.push(void 0)}}else{if(!l){e.push(this._highlight(j))}else{e.push(void 0)}}}}return e},_highlight_range_incremental:function(a){var h,c,j,e,f,b,g,d;j=this._last_highlight_from_photo;g=this._last_highlight_to_photo;if(!((j!=null)&&(g!=null))){return}c=Photos.get_timeline().index_of_photo(j);b=Photos.get_timeline().index_of_photo(g);for(e=d=c;c<=b?d<=b:d>=b;e=c<=b?++d:--d){f=Photos.get_timeline().photo_at_index(e);if(f.status!==Photo.PLACEHOLDER&&!this.contains(f)&&this._highlighted.indexOf(f)===-1){this._highlight(f)}}h=this._events_highlighting.indexOf(a.unique_id);if(h>=0){this._events_highlighting.splice(h,1)}if(this._select_highlighted_waiting){ModalProgress.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(d){var c,e,b,a;this.clear_highlighted();a=[];for(e=0,b=d.length;e<b;e++){c=d[e];if(!this.contains(c)){a.push(this._highlight(c))}else{a.push(void 0)}}return a},_select_highlighted:function(){var d,g,e,c,b,f,a;if(this._events_highlighting.length>0){ModalProgress.show(_("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}f=this._highlighted;for(g=0,c=f.length;g<c;g++){d=f[g];this._add(d)}a=this._dehighlighted;for(e=0,b=a.length;e<b;e++){d=a[e];this._remove(d)}if(this._select_highlighted_waiting){ModalProgress.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(b){var a;this._highlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("highlighted"):void 0},_dehighlight:function(b){var a;this._dehighlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("dehighlighted"):void 0},_add:function(b){var a;assert(b.status!==Photo.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);a=Photos.get_timeline().get_thumb_elm_for_photo(b);if(a!=null){a.addClassName("selected")}this._selected.push(b);this._last_selected=b;DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(PhotosSelection.CHANGE_EVT)},_remove:function(c){var b,a;a=Photos.get_timeline().get_thumb_elm_for_photo(c);if(a!=null){a.removeClassName("selected")}b=this._selected.indexOf(c);if(b!==-1){this._selected.splice(b,1);this._last_selected=c;if(this._selected.length){DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(PhotosSelection.CHANGE_EVT)},_invalid_mouse_target:function(c){var a,b;a=c.classNames().toArray().concat(c.up().classNames().toArray());return(__indexOf.call(a,"freshbutton")>=0)||(__indexOf.call(a,"freshbutton-blue")>=0)||(__indexOf.call(a,"freshbutton-lightblue")>=0)||(__indexOf.call(a,"freshbutton-blue-on-gray")>=0)||(__indexOf.call(a,"timeline-elm")>=0)||(c.up(".no-marquee")!=null)||(c.up("#context-menu")!=null)||(c.up(".freshdropdown-menu")!=null)||c.nodeName==="A"||((b=c.tagName.toUpperCase())==="INPUT"||b==="TEXTAREA"||b==="SELECT")||Modal.shown()||$("modal-progress-content").visible()||Lightbox.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var PhotosCollections,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new HTML('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(b,a){this._collections=b;this._gid_to_collection=b.dict_by("gid");this._url_to_collection=b.dict_by("url");this._collection_list_item_tmpl=HTML.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=HTML.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var a;a=DBHistory.deconstruct_url();if(a.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(a){if(this._num_loading_collections!==null&&(this._num_loading_collections<a||a===null)){this._num_loading_collections=a;return new Ajax.DBRequest("/collections",{parameters:{limit:a},allow_retries:true,onSuccess:(function(b){return function(e){var i,h,d,g,c,f;d=JSON.parse(e.responseText);for(g=0,c=d.length;g<c;g++){h=d[g];if(!(h.gid in b._gid_to_collection)&&!(f=h.gid,__indexOf.call(b._removed_pre_load,f)>=0)){i=new PhotoCollection(h,false);b._collections.push(i);b._gid_to_collection[i.gid]=i;b._url_to_collection[i.url]=i}}if(a===null||d.length<a){b._all_collections_loaded=true;b._sidebar_collections_loaded=true}if(a>=5){b._sidebar_collections_loaded=true}return b.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(a){return function(b){if(!Photos.get_current_collection().is_creator){return}a.header_rename();return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(ContextMenu.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(PhotoCollection.CREATE_EVT,this._collection_created.bind(this));document.observe(PhotoCollection.ADD_EVT,this._collection_photos_added.bind(this));document.observe(PhotoCollection.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(PhotoCollection.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(PhotoCollection.RENAME_EVT,this._collection_renamed.bind(this));document.observe(PhotoCollection.DELETE_EVT,this._collection_deleted.bind(this));document.observe(PhotoCollection.SHARE_EVT,this._collection_shared.bind(this));document.observe(PhotoCollection.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(PhotoCollection.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var e,b,d,a,c;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}b=[];c=this._collections;for(d=0,a=c.length;d<a;d++){e=c[d];b.push(this._collection_list_item_tmpl({collection:e,additional_class:"albums-list-item show-collection-target"}))}$("albums-list").__date(b);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var f,b,c,e,a,d;b=[];c={name:_("Create new album"),thumbnail_url_256:"/static/images/new_album_big.png"};b.push(this._collection_list_item_tmpl({collection:c,additional_class:"create-album-target",hide_icons:true}));d=this._collections;for(e=0,a=d.length;e<a;e++){f=d[e];b.push(this._collection_list_item_tmpl({collection:f,additional_class:"add-to-album-target"}))}$("add-to-album-modal-list").__date(b);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var g,i,e,h,f,d,b,a,c;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();i=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5)});if((f=$("albums-sidebar"))!=null){f.__date(i)}if((d=$("all-albums-sidebar"))!=null){d.observe("click",Photos.show_all_collections)}if((b=$("all-albums-sidebar"))!=null){b.observe("mouseup",(function(j){return function(k){var l;if(!PhotosSelection._drag_drop.active){return}if(PhotosSelection._drag_drop.single_photo!=null){l=[PhotosSelection._drag_drop.single_photo]}else{l=PhotosSelection.get()}j.show_add_to_album_modal(k,l);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}})(this))}if(Photos.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(Photos.in_single_collection_view()){a=$$(".sidebar-album");c=[];for(e=0,h=a.length;e<h;e++){g=a[e];if(g.readAttribute("data-gid")===Photos.get_current_collection().gid){g.addClassName("selected");break}else{c.push(void 0)}}return c}}},refresh_album_views:function(b){var a;if(b==null){b=null}a=(function(c){return function(){c.render_all_albums_view();c.render_albums_sidebar();return c.render_add_to_album_modal()}})(this);if(b!=null?b.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:JSON.stringify(b.unique())},onSuccess:(function(c){return function(n){var m,l,e,k,h,g,o,d,j,f;j=JSON.parse(n.responseText);for(h=0,o=j.length;h<o;h++){e=j[h];l=new PhotoCollection(e,false);c._gid_to_collection[l.gid]=l;c._url_to_collection[l.url]=l;f=c._collections;for(k=g=0,d=f.length;g<d;k=++g){m=f[k];if(m.gid===l.gid){c._collections[k]=l;break}}}return a()}})(this)})}else{return a()}},show_add_to_album_modal:function(a,b){if(b!==PhotosSelection.get()&&(PhotosSelection._drag_drop.single_photo==null)){PhotosSelection._context_selected=b}Modal.onHide=function(){PhotosSelection._context_selected=null;delete Modal.onHide;return Modal.hide()};Modal.show(_("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(c,e,b){var a,d;if(b==null){b=true}d=null;if(Photos.in_single_collection_view()){d=Photos.get_current_collection().gid}a=e.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;Notify.success(_("Adding to album..."));return c.add_photos(e,d,a,b)},show_remove_photos_modal:function(d,f){var c,a,e,b;b=PhotosUtil.categorize_files(f),a=b[0],e=b[1];if(a&&e){c=ungettext("Remove %(file_count)s item?","Remove %(file_count)s items?",f.length)}else{if(a){c=ungettext("Remove %(file_count)s photo?","Remove %(file_count)s photos?",f.length)}else{c=ungettext("Remove %(file_count)s video?","Remove %(file_count)s videos?",f.length)}}c=c.format({file_count:f.length});DomUtil.fillVal(PhotosUtil.file_desc(f),"collection-remove-files");DomUtil.fillVal(d.name.escapeHTML(),"collection-remove-name");return Modal.show(c,DomUtil.fromElm("collection-remove-modal"),{action:(function(g){return function(){var h;f=f.slice(0);h=f.length>g.NUM_PHOTOS_LONG_RUNNING_REMOVES;return d.remove_photos(f,h)}})(this)})},header_rename:function(){if($j("#single-collection-title-container").hasClass("editing")){return}$j("#single-collection-title-container").addClass("editing");return Photos.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-delete-name");a=_("Delete album?");return Modal.show(a,DomUtil.fromElm("collection-delete-modal"),{action:function(){if(b.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){Notify.success(_("Deleting '%(collection_name)s'...").format({collection_name:b.name}),100)}return b["delete"]()}})},show_unshare_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-unshare-name");a=_("Unshare album?");return Modal.show(a,DomUtil.fromElm("collection-unshare-modal"),{action:function(){return b.unshare()}})},create:function(j,i,n,b){var d,f,c,g,l,m,k,a,h;if(b==null){b=false}if(j){Event.extend(j).preventDefault();h=$(j.target);if(h.hasClassName("inplaceeditor-form")||(h.up(".inplaceeditor-form")!=null)){return}if(h.up("#context-menu")){d=true}else{if(h.up(".freshdropdown-menu")){c=true}}}Photos.enable_selection();if(!n){n=PhotosSelection.get()}g=(function(){var p,o,e;e=[];for(p=0,o=n.length;p<o;p++){a=n[p];e.push(a.item_counter)}return e})();n.sort_by_key(function(e){return e.time_taken});l=n.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;k=(function(e){return function(p){var s,q,o,r;q=JSON.parse(p.responseText);s=new PhotoCollection(q);PhotosSelection.clear();FreshDropdown.hide_all();ContextMenu.hide();Modal.hide();Photos.disable_selection();r=_("Created '%(collection_name)s'");o=s.name.escapeHTML();r=r.format({collection_name:"<a data-gid='"+s.gid+"' class='show-collection-target'>"+o+"</a>"});Notify.success(new HTML(r));return e.flash_sidebar_album(s.gid)}})(this);m=function(){if(!c){FreshDropdown.hide_all()}if(!d){ContextMenu.hide()}PhotosCollections.render_albums_sidebar();return Photos.disable_selection()};f=new Ajax.InPlaceEditor(i,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:b,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:m,onFailure:function(){},savingText:_("Creating..."),onLeaveEditMode:Photos.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:k,job:l,job_user:Viewer.get_viewer().photos_user,progress_text:_("Creating album...")},callback:function(e,p){var o;Notify.success(_("Creating album..."));o={collection_name:p,item_counters:JSON.stringify(g)};if(Photos.in_single_collection_view()){o.source_collection_gid=Photos.get_current_collection().gid}return o}});f.enterEditMode();if(!b){return f._controls.editor.observe("blur",m)}},toggle_more_selected_actions:function(a){if(a){Event.extend(a).preventDefault()}if(!$("more-selected-actions-menu").visible()){return FreshDropdown.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(a){var b;if(a){Event.extend(a).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(Photos.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(Browser.msie_version_at_most(10)){b=$j("#more-collection-actions-menu");if(!b.parent().is("body")){$j(document.body).append(b.remove())}}return FreshDropdown.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(a){var b;b=a.memo.collection;if(!b.is_anonymous){this._collections.unshift(b)}this._gid_to_collection[b.gid]=b;this._url_to_collection[b.url]=b;return this.refresh_album_views()},_collection_changed:function(a){this._collections.removeItem(a);this._collections.unshift(a);return this.refresh_album_views()},_collection_photos_added:function(i){var h,f,d,j,k,c,a,b,l,g;h=i.memo.collection;l=i.memo.photos;j=i.memo.num_items_added;c=i.memo.num_photos_added;b=i.memo.num_videos_added;if(i.memo.promote_collection&&j>0){this._collection_changed(h)}else{this.refresh_album_views()}if(l===PhotosSelection.get()){PhotosSelection.clear()}if(j<1){g=PhotosUtil.categorize_files(l),k=g[0],a=g[1];if(k&&a){d=ungettext("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",l.length)}else{if(k){d=ungettext("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",l.length)}else{d=ungettext("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",l.length)}}}else{if(c&&b){d=ungettext("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",l.length)}else{if(c){d=ungettext("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",l.length)}else{d=ungettext("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",l.length)}}}f=h.name.escapeHTML();d=d.format({collection_name:"<a data-gid='"+h.gid+"' class='show-collection-target'>"+f+"</a>"});return Notify.success(new HTML(d))},_collection_photos_removed:function(b){var c,d,a;c=b.memo.collection;d=b.memo.photos;a=Photos.undo_enabled?b.memo.undo_changeset:null;Photos.get_timeline().remove_photos(d);this._collection_changed(c);return Notify.success(_("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:PhotosUtil.file_desc(d),collection_name:c.name}),null,null,a,(function(){return c.undo_remove(a)}))},_collection_undid_remove:function(a){var b;b=a.memo.collection;Photos.get_timeline().restore_removed_photos();PhotosCollections.refresh_album_views([b.gid]);return Notify.success(_("Undo complete"))},_collection_renamed:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-title").text(Emstring.em_snippet(c.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+c.name+" - Dropbox"}this._collection_changed(c);return Notify.success(_("Renamed '%(collection_name)s'").format({collection_name:c.name}))},_collection_deleted:function(b){var c,a;c=b.memo.collection;this._collections.removeItem(c);if(!this._all_collections_loaded){this._removed_pre_load.push(c.gid)}this.refresh_album_views();if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){Photos.show_all_collections()}delete this._gid_to_collection[c.gid];delete this._url_to_collection[c.url];return Notify.success(_("Deleted '%(collection_name)s'").format({collection_name:c.name}))},_collection_shared:function(b){var c,a;c=b.memo.collection;this._collection_changed(c);if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text(_("Shared"));return $j("#single-collection-share-status").attr("href",c.shmodel_url)}},_collection_unshared:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text("")}return Notify.success(_("Unshared '%(collection_name)s'").format({collection_name:c.name}))},_collection_cover_changed:function(a){var c,b;c=a.memo.collection;this._collection_changed(c);b=_("Changed cover photo for '%(collection_name)s'");b=b.format({collection_name:c.name.escapeHTML()});return Notify.success(b)},_albums_list_item_contextmenu:function(b,a){ContextMenu.show_photo_collection(b,this.get(a.readAttribute("data-gid")),a);a.removeClassName("album-flash");return a.addClassName("context-selected")},_show_collection_click:function(c,a){var b;b=$(c.target);if(b.hasClassName("inplaceeditor-form")||(b.up(".inplaceeditor-form")!=null)){return}return Photos.show_collection(a.readAttribute("data-gid"))},_collection_shmodel_click:function(b,a){return this.go_to_link(this.get(a.readAttribute("data-gid")))},_add_to_album_click:function(b,a){if(PhotosSelection._context_selected){this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection._context_selected);PhotosSelection._context_selected=null}else{this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection.get())}delete Modal.onHide;Modal.hide();return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.SAH,{num_photos:PhotosSelection.get().length})},_drop_target_mouseover:function(b,a){if(PhotosSelection._drag_drop.active){a.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(b,a){if(PhotosSelection._drag_drop.active){a.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(b,a){var c;if(a.hasClassName("hovered")){a.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(PhotosSelection._drag_drop.single_photo!=null){c=[PhotosSelection._drag_drop.single_photo]}else{c=PhotosSelection.get()}if(a.readAttribute("data-gid")!=null){this.add_photos(this.get(a.readAttribute("data-gid")),c,false)}if(a.identify()==="add-to-album-sidebar-new"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_NEW_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{if(a.identify()==="all-albums-sidebar"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}}}},_create_album_click:function(a,b){if(PhotosSelection._context_selected){this.create(a,b.down(".collection-name"),PhotosSelection._context_selected,true);return PhotosSelection._context_selected=null}else{return this.create(a,b.down(".collection-name"),PhotosSelection.get(),true)}},_window_scroll:function(){if(Photos.in_all_collections_view()){return this._all_albums_scroll_position=dom.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(a){return this._url_to_collection[a]},get:function(a){return this._gid_to_collection[a]},go_to_link:function(a){return window.open(a.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(c,b){var a,e,d;a=Emstring.em_snippet(c,b,1);e=a.lastIndexOf(" ");if(e===-1){return a}else{a=a.slice(0,+e+1||9000000000);d=Emstring.em_snippet(c.slice(e+1),b,1);return a+d}},get_default_album_name:function(){var a;a=_("Untitled album");return this.increment_collection_name_until_valid(a)},collection_name_in_use:function(b){var e,d,a,c;c=this.get_all();for(d=0,a=c.length;d<a;d++){e=c[d];if(e.name===b.trim()){return true}}return false},increment_collection_name_until_valid:function(b){var c,a;c=this.collection_name_in_use(b);a=0;while(c){a++;c=this.collection_name_in_use(b+(" ("+a+")"))}return(a===0?b:b+(" ("+a+")"))},flash_sidebar_album:function(e){var f,d,b,c,a;c=$$(".sidebar-album");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];if(f.readAttribute("data-gid")===e){f.removeClassName("album-flash");f.addClassName("album-flash");break}else{a.push(void 0)}}return a}};var PhotoTimeline;PhotoTimeline=(function(){a.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";a.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";a.prototype.THUMB_SIZE=null;a.prototype.HEADER_HEIGHT=null;a.prototype.THUMBS_PER_ROW=4;a.prototype.RENDER_SCROLL_WAIT=100;a.prototype.RENDER_SCROLL_MAX_WAIT=750;a.prototype.HIDE_TIMELINE_NAV_DELAY=1500;a.prototype.THUMBS_BATCH_SIZE=12;a.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;a.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;a.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;a.prototype.TIMELINE_NAV_ELM_HEIGHT=20;a.prototype.TIMELINE_DOT_HTML=Sprite.html("web","timeline_dot");a.container;a.scroll_container;a.events;a.current_event;a.key_to_photo;a.preview_objs;a.tmpl;a.last_render_scroll_timeout;a.start_render_scroll_time;a.last_scroll_position;a.hide_timeline_nav_timeout;a.grid;a._skip_scroll_update;a.header_id_to_sel_items;a.event_remove_info;a.opts;function a(c,d,g,e,f,h,i,j,b){this.container=c;this.scroll_container=d;this.tmpl=i;this.opts=b;this.THUMB_SIZE=j.thumb_size;this.HEADER_HEIGHT=j.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=h;this.event_remove_info=[];this._init_events(g,e,f);this.update_offsets(j.top_offset,j.left_offset);this.listen();Velocity.start_capture(this.scroll_container)}a.prototype._init_events=function(j,d,f){var c,h,m,e,g,k,b,i,l;if(j.length<1){this.events=new OrderedDictionary([],{});return}h=[];g={};m=false;for(i=0,l=j.length;i<l;i++){e=j[i];e=String(e);b=e in this.header_id_to_sel_items?this.header_id_to_sel_items[e]:[];k=false;if(b.length&&!m){m=true;k=true}c=new PhotoEvent(this,e,d[e],f[e],b,k);h.push(e);g[e]=c}return this.events=new OrderedDictionary(h,g)};a.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};a.prototype.unlisten=function(){var c,b,d;if((c=this._body_mousemove_handler)!=null){c.stop()}if((b=this._timeline_elm_click_handler)!=null){b.stop()}if((d=this._show_missing_timestamp_bucket_handler)!=null){d.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(PhotoEvent.EVENT_MISCOUNT_EVT)};a.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};a.prototype.update_offsets=function(d,c){var e,g,f,b;this.top_offset=d;this.refresh_row_offsets();this.left_offset=c;this.grid.photo_col_offsets=[];b=[];for(e=g=0,f=this.THUMBS_PER_ROW;0<=f?g<=f:g>=f;e=0<=f?++g:--g){b.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*e))}return b};a.prototype.refresh_row_offsets=function(){var h,e,d,g,c,f,b;this.grid.photo_row_offsets=[];h=this.top_offset;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];e.top_offset=h;h+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(h);b.push((function(){var k,i,j;j=[];for(d=k=0,i=e.get_num_rows();0<=i?k<i:k>i;d=0<=i?++k:--k){h+=this.THUMB_SIZE;j.push(this.grid.photo_row_offsets.push(h))}return j}).call(this))}return b};a.prototype._render_empty_grid=function(){var c,f,e,b,d;this.container.__date();d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!(c.is_missing_timestamp_bucket()&&this.events.length()>1)){c.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){f=$j('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(_("Show photos with missing dates"));return $j(this.container).append(f)}};a.prototype._render_viewport=function(e){var c,n,f,m,p,k,j,h,o,d,b,l,i,g;if(e==null){e=false}this.start_render_scroll_time=-1;p=this.get_viewport_info();n=[];l=this.events.getValues();for(k=0,o=l.length;k<o;k++){c=l[k];if(!(c.has_loaded_metadata()||c.loading_metadata||(c.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(c.in_current_viewport(p,false)){n.unshift(c)}else{if(c.in_current_viewport(p,true)){n.push(c)}}}}for(j=0,d=n.length;j<d;j++){c=n[j];i=c.get_photo_range_to_render(p,true),f=i[0],m=i[1];c.load_metadata_range(f,m)}if(e){p=this.get_viewport_info();g=this.events.getValues();for(h=0,b=g.length;h<b;h++){c=g[h];if(c.in_current_viewport(p,false)){c.timing_stopped_scrolling_on_event=datetime.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};a.prototype._load_metadata_for_sel_events=function(){var d,f,b,e,c;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}e=this.header_id_to_sel_items;c=[];for(f in e){b=e[f];d=this.events.valueFromKey(f);if(d!=null){d.load_metadata()}c.push(assert(d!=null,"Missing "+f+" in list of events with selected photos"))}return c};a.prototype._load_visible_photos=function(){var d,f,c,e,b;e=this.events.getValues();b=[];for(f=0,c=e.length;f<c;f++){d=e[f];if(!(d.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){b.push(d.update_photo_divs())}else{b.push(void 0)}}return b};a.prototype._body_mousemove=function(b){if(!this.opts.uses_timeline_nav){return}if((b.clientX+dom.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};a.prototype._timeline_elm_click=function(f,d){var b,c;c=d.readAttribute("data-event-id");if(c){b=this.events.valueFromKey(c)}this._update_timeline_position(b);if(b.is_missing_timestamp_bucket()){PhotosLogger.log_interaction(PhotosViews.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(b)};a.prototype._scroll_to_event=function(d,b){var c;if(b==null){b=false}c=d.top_offset-this.top_offset;if(d&&(dom.scroll_offsets().top!==c)){if(b){return $j("html, body").animate({scrollTop:c},200)}else{this._skip_scroll_update=true;return window.scrollTo(dom.scroll_offsets().left,c)}}};a.prototype._window_scroll=function(){var e,d,h,g,c,f,b;d=datetime.time();LegacyBatchThumbLoader.clear_all_pending_batches();if(this.start_render_scroll_time===-1||d-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=d}h=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),h);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(i){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=dom.scroll_offsets().top;Photos.scroll_count++;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];b.push(e.logged_thumbs_arrived=false)}return b};a.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};a.prototype.init_timeline_nav=function(){var c,e,b,d;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();d=this.events.getValues().reverse();for(e=0,b=d.length;e<b;e++){c=d[e];c.add_to_timeline_nav(c===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};a.prototype._resize_timeline_nav=function(){var b;if(!this.opts.uses_timeline_nav){return}b=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:b+"px"})};a.prototype._update_timeline_position=function(h){var l,i,b,k,f,e,j,c,g,d;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(h==null){k=this.get_viewport_info();if(this.scroll_container==null){k.top=document.viewport.getScrollOffsets().top}l=k.top+k.height/2;g=this.events.getValues();for(f=0,j=g.length;f<j;f++){b=g[f];if(b.top_offset>l){break}h=b}}if((h==null)||h===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");d=$$(".timeline-elm");for(e=0,c=d.length;e<c;e++){i=d[e];if(i.readAttribute("data-event-id")===h.unique_id){i.addClassName("current");break}}return this.current_event=h};a.prototype._show_hide_timeline_elms=function(){var i,f,d,e,h,c,g,b;if(!this.opts.uses_timeline_nav){return}d=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();f=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();g=$$(".timeline-elm");b=[];for(h=0,c=g.length;h<c;h++){i=g[h];i.show();e=i.cumulativeOffset();if(e.top<f&&e.left<d){b.push(i.hide())}else{b.push(void 0)}}return b};a.prototype._event_miscount=function(b){this.refresh_row_offsets();return this._load_visible_photos()};a.prototype.remove_photos=function(i){var e,g,h,d,c,f,b;i=i.slice(0);this.event_remove_info=[];h={};for(f=0,b=i.length;f<b;f++){d=i[f];g=d.event.unique_id;if(g in h){h[g].push(d)}else{h[g]=[d]}}for(g in h){i=h[g];e=this.events.valueFromKey(g);c=e.remove_photos(i);this.event_remove_info.push({event:e,remove_info:c})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_REMOVED_EVT,this)};a.prototype.restore_removed_photos=function(){var c,q,m,p,n,e,l,j,i,g,o,d,b,k,h,f;PhotosSelection.clear();k=this.event_remove_info.reverse();for(j=0,o=k.length;j<o;j++){q=k[j];c=q.event;n=q.remove_info;if(n.removed_event_index!=null){this.events.insertAtIndex(n.removed_event_index,c.unique_id,c);c.restore()}c.add_photos(n.removed_photos_and_indexes.reverse());h=n.removed_photos_and_indexes;for(i=0,d=h.length;i<d;i++){p=h[i];PhotosSelection._add(p.photo)}}e=null;l=null;f=this.event_remove_info;for(g=0,b=f.length;g<b;g++){q=f[g];c=q.event;n=q.remove_info;m=this.events.indexOfKey(c.unique_id);if((e==null)||e>m){e=m;l=n.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(l!=null){this.scroll_to_photo_with_key(l.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_ADDED_EVT,this)};a.prototype.get_photos=function(){var c,f,e,b,d;f=[];d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];f=f.concat(c.photos)}return f};a.prototype.num_photos=function(){var d,c,f,b,e;c=0;e=this.events.getValues();for(f=0,b=e.length;f<b;f++){d=e[f];c+=d.photos.length}return c};a.prototype.get_preview_objs=function(){var b,c,i,g,f,j,d,h,e;i=[];h=this.events.getValues();for(g=0,j=h.length;g<j;g++){b=h[g];e=b.photos;for(f=0,d=e.length;f<d;f++){c=e[f];i.push(c.preview_obj)}}return i};a.prototype.index_of_photo=function(d){var e,c,g,b,f;c=0;f=this.events.getValues();for(g=0,b=f.length;g<b;g++){e=f[g];if(e===d.event){c+=e.photos.indexOf(d);break}else{c+=e.photos.length}}return c};a.prototype.photo_at_index=function(d){var b,e,g,c,f;b=0;f=this.events.getValues();for(g=0,c=f.length;g<c;g++){e=f[g];if(b+e.photos.length>d){return e.photos[d-b]}else{b+=e.photos.length}}return null};a.prototype.get_thumb_elm_for_photo=function(b){return $(b.uniqueness_key)};a.prototype.get_photo_for_thumb_elm=function(b){if(!b.hasClassName("cu-thumb")){b=b.up(".cu-thumb")}if(b){return this.key_to_photo[b.identify()]}else{return null}};a.prototype.get_viewport_info=function(){var b,c;if(this.scroll_container!=null){c=this.scroll_container.scrollTop;b=this.scroll_container.getHeight()}else{c=dom.scroll_offsets().top;b=dom.viewport_dimensions().height}return{top:c,height:b,bottom:c+b}};a.prototype.scroll_to_photo_with_key=function(c){var g,d,b,f,e;dom.scroll_unlock_document();g=$(c);if(g!=null?g.visible():void 0){Util.scroll_to_thumb(g)}else{b=this.key_to_photo[c];d=b.event;if(b.event!=null){f=Math.floor(d.photos.indexOf(b)/this.THUMBS_PER_ROW);e=this.get_viewport_info().height;dom.scroll_to(0,d.top_offset+this.HEADER_HEIGHT+f*this.THUMB_SIZE-e/2)}}return this._load_visible_photos()};a.prototype.restore_scroll_position=function(){dom.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};a.prototype.visible_thumbs_loaded=function(){var c,e,b,d;d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!c.visible_thumbs_loaded()){return false}}return true};a.prototype.has_missing_timestamp_bucket=function(){var b;b=this.events.getValues();return b[b.length-1].is_missing_timestamp_bucket()};a.prototype.is_missing_timestamp_bucket_shown=function(){var b,c;if(!this.has_missing_timestamp_bucket()){return false}b=this.events.getValues();c=b[b.length-1].unique_id;return $j("#p-"+c).length>0};a.prototype._show_missing_timestamp_bucket=function(b,e){var d,c;if(b==null){b=true}if(e==null){e=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}c=this.events.getValues();d=c[c.length-1];$j("#show-missing-timestamps-button").hide();d.add_html_elements_to(this.container);if(!e){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(d,b);this._render_viewport()}return this.init_timeline_nav()};return a})();var PhotoEvent;PhotoEvent=(function(){a.EVENT_MISCOUNT_EVT="db:photoevent:miscount";a.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";a.prototype.MONTH_PREFIX="m_";a.prototype.COLLECTION_PREFIX="c_";a.prototype.EVENT_PREFIX="e_";a.prototype.MISSING_TIMESTAMP_PREFIX="a_";a.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;a.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;a.timeline;a.unique_id;a.name;a.init_num_photos;a.photos;a.header_html;a.placeholder_html;a.top_offset;a.loading_metadata;a.cursor;a.num_photos_loaded;a.prototype.LOADING_ORDER_NOT_DECIDED=-1;a.prototype.LOADING_ORDER_TOP_DOWN=0;a.prototype.LOADING_ORDER_BOTTOM_UP=1;a.loading_order;a.num_photos_to_load;a.on_load_all_metadata;a.init_sel_items;a.scroll_to_first_sel;a.num_to_select;a.logged_thumbs_arrived;a.timing_metadata_received;a.timing_stopped_scrolling_on_event;a.scroll_count;function a(k,g,c,h,b,f){var e,l,d,j;this.timeline=k;this.unique_id=g;this.name=c;this.init_num_photos=h;this.photos=(function(){var m,i;i=[];for(e=m=0;0<=h?m<h:m>h;e=0<=h?++m:--m){i.push(new Photo(this))}return i}).call(this);this.init_sel_items={};for(d=0,j=b.length;d<j;d++){l=b[d];this.init_sel_items[l]=true}this.num_to_select=b.length;this.scroll_to_first_sel=f;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(h===0){$("single-album-empty").show()}}a.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};a.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};a.prototype.get_month=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(6,8),10);assert(!isNaN(b),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.get_year=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(2,6),10);assert(!isNaN(b),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};a.prototype.get_collection_gid=function(){assert(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};a.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};a.prototype._generate_container_html=function(){var e,c,f,h,d,b,g;h=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(h);e=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});e.__date(Sprite.html("web","event_add_to_album"));this.header_html.__sert(e);g=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});g.__date(Sprite.html("web","event_share"));this.header_html.__sert(g);b=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});b.__date(Sprite.html("web","event_select"));this.header_html.__sert(b)}else{this.header_html=new HTML("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+h+"</span></h1>")}c=this.get_content_height();d=this.photos.length%this.timeline.THUMBS_PER_ROW;f=d===0?0:(this.timeline.THUMBS_PER_ROW-d)*this.timeline.THUMB_SIZE;return this.placeholder_html=new HTML('<div style="height: '+c+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+c+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+f+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};a.prototype.add_html_elements_to=function(c){var b;if(this.is_event()){b=new Element("div",{"class":"photo-event"});b.__sert(this.header_html);b.__sert(this.placeholder_html);return c.__sert(b)}else{c.__sert(this.header_html);return c.__sert(this.placeholder_html)}};a.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};a.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};a.prototype.add_to_timeline_nav=function(i){var b,g,j,c,k,f,e,h,d;if(i==null){i=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}d=this.timeline.get_viewport_info().height;k=this.timeline.TIMELINE_NAV_ELM_HEIGHT;f=$(document.body).getHeight();e=this.top_offset/f*100;if(this.is_event()){c=this.name}else{if(this.is_missing_timestamp_bucket()){c=_("Missing dates")}else{c=datetime.month_abbr_with_year(this.get_month()-1,this.get_year())}}j=false;for(h in this.timeline.grid.side_nav){b=Math.abs(this.timeline.events.valueFromKey(h).top_offset-this.top_offset);if(b/f*d<k){j=true;if(i){$j("#timeline-nav-"+h).remove()}}}g=$j("#timeline-nav-"+this.unique_id);if(!j||i){if(g.length){g.css("top",""+e+"%")}else{g=$j("<div/>");g.addClass("timeline-elm");g.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});g.css("top",""+e+"%");g.text(c);$j("#timeline-nav").append(g)}return this.timeline.grid.side_nav[this.unique_id]=e}else{if(g.length){return g.remove()}}};a.prototype.marquee_highlight=function(b,i,f){var d,j,c,k,m,e,h,g,l;if(this.top_offset>i||this.top_offset+this.get_height()<b){return}if(b<this.top_offset){i-=this.top_offset;if(i<this.timeline.HEADER_HEIGHT){return}e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(i>this.top_offset+this.get_height()){b-=this.top_offset;m=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(b<this.timeline.HEADER_HEIGHT){e=0}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{b-=this.top_offset;i-=this.top_offset;if(b<this.timeline.HEADER_HEIGHT&&i<this.timeline.HEADER_HEIGHT){return}else{if(b<this.timeline.HEADER_HEIGHT){e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(k=h=e;e<=m?h<=m:h>=m;k=e<=m?++h:--h){for(g=0,l=f.length;g<l;g++){d=f[g];j=this.timeline.THUMBS_PER_ROW*k+d;if(j<this.photos.length){c=this.photos[j];if(c.status!==Photo.PLACEHOLDER&&!PhotosSelection.contains(c)){PhotosSelection._highlight(c)}}}}};a.prototype.add_photos=function(e){var d,c,f,g,b;for(g=0,b=e.length;g<b;g++){f=e[g];c=f.photo;d=f.index;assert(d<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(d,0,c);if(c.status>=Photo.LOADED){c.status=Photo.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};a.prototype.remove_photos=function(j){var g,b,f,h,c,d,i,e;g=this.timeline.events.indexOfKey(this.unique_id);c=[];for(d=0,i=j.length;d<i;d++){b=j[d];f=this.photos.indexOf(b);assert(f>-1,"Photo not found in the photos array!");this.photos.splice(f,1);if(b.status>=Photo.LOADED){this.num_photos_loaded--;if((e=$(b.uniqueness_key))!=null){e.remove()}b.status=Photo.LOADED}PhotosSelection._remove(b);c.push({photo:b,index:f})}this._num_photos_changed();h={removed_photos_and_indexes:c};if(this.photos.length===0){h.removed_event_index=g}return h};a.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};a.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};a.prototype._update_placeholder_container=function(){var c,b;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});b=this.photos.length%this.timeline.THUMBS_PER_ROW;c=b!==0?(this.timeline.THUMBS_PER_ROW-b)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+c+"px"})};a.prototype.load_metadata=function(i){var d,c,h,b,f,g,e;b=0;if((!this._is_valid_photo_index(i))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}b=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=i*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}b=this._is_loading_from_bottom()?this.photos.length-i:i+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,b);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;f={show_hidden:Photos.show_hidden};if(this.cursor!=null){f.cursor=this.cursor}if(this._is_loading_from_bottom()){f.chron_order=true}f.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(f.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){f.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){g=this.unique_id.split("_");d=g[2];c=g[1];f.filters=JSON.stringify({date_begin:d,date_end:c},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){f.filters=JSON.stringify({other:true})}else{if(this.is_month()){e=this.get_year();h=this.get_month();d=Util.to_iso8601_date(new Date(e,h-1,1,0,0,0,0),false,true);c=Util.to_iso8601_date(new Date(e,h,1,0,0,0),false,true);f.filters=JSON.stringify({date_begin:d,date_end:c},{year:e,month:h})}else{if(this.is_collection()){f.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{assert(false,"invalid photo event id: "+this.unique_id)}}}}return new Ajax.DBRequest("/photos_event_metadata",{parameters:f,allow_retries:true,onSuccess:(function(j){return function(k){var l;l=JSON.parse(k.responseText);j.timing_metadata_received=datetime.time();j.cursor=l.cursor;return j._load_metadata_callback(l.photos,l.key_to_duplicates,(l.more!=null)&&l.more)}})(this)})};a.prototype.load_metadata_range=function(c,b){if(!(this._is_valid_photo_index(c)&&this._is_valid_photo_index(b))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=c*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(c)}else{return this.load_metadata(b)}};a.prototype.load_cached_metadata=function(){var b,c;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((c=Photos.event_metadata_cache)!=null?c[this.unique_id]:void 0)==null)){return false}b=Photos.event_metadata_cache[this.unique_id];this.cursor=b.cursor;this._load_metadata_callback(b.photos,b.key_to_duplicates,b.more);return true};a.prototype._load_metadata_callback=function(o,g,h){var n,j,t,k,u,d,l,r,f,p,e,m,c,b,q,s;k=[];f=[];m=false;for(n=c=0,q=o.length;c<q;n=++c){l=o[n];if(this.has_loaded_metadata()){d=new Photo(this);if(this._is_loading_from_bottom()){this.photos.unshift(d)}else{this.photos.push(d)}m=true}else{if(this.num_photos_loaded<this.photos.length){j=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;d=this.photos[j]}else{assert(false,"num_photos_loaded should never be greater than photos.length")}}d.init_metadata(l);if(d.uniqueness_key in g){d.set_duplicates(g[d.uniqueness_key])}if(n<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){f.push(d.preview_obj)}k.push(d)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var x,w,v,i;i=[];for(w=0,v=f.length;w<v;w++){x=f[w];i.push(x.preload())}return i}),500)}PhotosSelection.refresh(k);for(b=0,s=k.length;b<s;b++){d=k[b];if(d.item_counter in this.init_sel_items){PhotosSelection._add(d);this.num_to_select--;if(this.num_to_select===0){PhotosSelection.dec_num_loading_events_before_select()}delete this.init_sel_items[d.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;e=this.timeline;t=d.uniqueness_key;$j(document).ready(function(){return e.scroll_to_photo_with_key(t)})}}}if(!h){if(this.num_photos_loaded<this.photos.length){u=this.photos.length-this.num_photos_loaded;p=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(p,u);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(m||u){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(a.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){r=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(r)}};a.prototype._fix_photo_miscount=function(){var d,c,b;d=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);c=this.get_num_rows()-d;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){PhotosLogger.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}b=dom.scroll_offsets().top;if(this.top_offset+this.get_height()<b){dom.scroll_to(0,b+c*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(a.EVENT_MISCOUNT_EVT,this)};a.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};a.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};a.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};a.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};a.prototype.visible_thumbs_loaded=function(d){var h,g,c,b,f,e;if(d==null){d=this.timeline.get_viewport_info()}e=this.get_photo_range_to_render(d,false),h=e[0],g=e[1];if(h===null&&g===null){return true}for(b=f=h;h<=g?f<=g:f>=g;b=h<=g?++f:--f){c=this.photos[b];if((c==null)||!(c.status>=Photo.RENDERED)){return false}}return true};a.prototype._is_loaded=function(b){var c,d;if(this._is_loading_from_bottom()){d=this.photos.length-this.num_photos_loaded;c=this.photos.length-1}else{d=0;c=this.num_photos_loaded-1}return(d<=b&&b<=c)};a.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};a.prototype._is_valid_photo_index=function(b){return(b!=null)&&(b>=0)&&(b<=this.photos.length-1)};a.prototype.update_photo_divs=function(){var d,c,s,r,w,z,t,o,i,A,q,x,m,j,g,e,B,C,b,y,p,n,l,h,f,k,v,u;if(!this.num_photos_loaded){return}x=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(x)){return}y=this.get_photo_range_to_render(x),s=y[0],r=y[1];assert((s!=null)&&(r!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(s))||(!this._is_loaded(r)))){this.load_metadata_range(s,r);if(this._is_loading_from_bottom()){s=Math.max(s,this.photos.length-this.num_photos_loaded)}else{r=Math.min(r,this.num_photos_loaded-1)}if(s>r){return}}z=Math.floor(s/this.timeline.THUMBS_PER_ROW);q=z*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:q+"px"});w=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(r/this.timeline.THUMBS_PER_ROW);c=w*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:c+"px"});this._hide_photos((function(){k=[];for(var D=0;0<=s?D<s:D>s;0<=s?D++:D--){k.push(D)}return k}).apply(this));this._hide_photos((function(){v=[];for(var D=p=r+1,E=this.photos.length;p<=E?D<E:D>E;p<=E?D++:D--){v.push(D)}return v}).apply(this));this._show_photos((function(){u=[];for(var D=s;s<=r?D<=r:D>=r;s<=r?D++:D--){u.push(D)}return u}).apply(this));l=PhotosSelection.get();for(e=0,B=l.length;e<B;e++){o=l[e];if((h=$(o.uniqueness_key))!=null){h.addClassName("selected")}}this.scroll_count=Photos.scroll_count;d=[];f=this.get_thumb_indexes_to_load(x);for(b=0,C=f.length;b<C;b++){i=f[b];o=this.photos[i];if((o!=null)&&o.status>=Photo.RENDERED){A=$(o.uniqueness_key);if((A!=null?A.down("img"):void 0)!=null){d.push(A.down("img"))}}}t=function(D){return D.up(".cu-thumb").addClassName("thumb-loaded")};return LegacyBatchThumbLoader.batch_load_thumbs(d,this.timeline.THUMBS_BATCH_SIZE,t,this.log_thumb_load.bind(this))};a.prototype._hide_photos=function(f){var d,e,c,b;b=[];for(e=0,c=f.length;e<c;e++){d=f[e];b.push(this._hide_photo(d))}return b};a.prototype._hide_photo=function(b){var c;c=this.photos[b];if((c==null)||!(c.status===Photo.DISPLAYED)){return}$(c.uniqueness_key).hide();return c.status=Photo.RENDERED};a.prototype._show_photos=function(s){var o,n,r,f,p,l,e,m,k,h,g,q,d,c,b,j;f=[];for(m=0,q=s.length;m<q;m++){n=s[m];p=this._get_photo_insert_info(n);if(!p){continue}r=p[0],e=p[1];l=false;for(k=0,d=f.length;k<d;k++){o=f[k];if(o.after===r){o.photos.push(e);l=true;break}}if(!l){f.push({after:r,photos:[e]})}}for(h=0,c=f.length;h<c;h++){o=f[h];o.after.__sert({after:o.photos})}j=[];for(g=0,b=s.length;g<b;g++){n=s[g];j.push(this.photos[n].status=Photo.DISPLAYED)}return j};a.prototype._get_photo_insert_info=function(b){var e,c,d,j,f,h,g;d=this.photos[b];if((d==null)||d.status===Photo.DISPLAYED){return}if(d.status===Photo.RENDERED){$(d.uniqueness_key).show()}else{c=$("p-top-"+this.unique_id);if(b!==0){for(e=h=g=b-1;g<=0?h<=0:h>=0;e=g<=0?++h:--h){j=this.photos[e];if((j!=null)&&j.status>=Photo.RENDERED){f=$(j.uniqueness_key);assert(f!=null,"photo "+e+" was marked as rendered, but its thumb elm doesn't exist");c=f;break}}}return[c,d.thumb_html]}};a.prototype.in_y_range=function(c,b){return !(this.top_offset+this.timeline.HEADER_HEIGHT>b||this.top_offset+this.get_height()<c)};a.prototype.in_current_viewport=function(d,f){var b,c,e;if(d==null){d=this.timeline.get_viewport_info()}if(f==null){f=true}c=d.top;b=d.top+d.height;if(f){e=this._blur_range(c,b,d),c=e[0],b=e[1]}return this.in_y_range(c,b)};a.prototype.hide_photos_if_not_in_current_viewport=function(e){var c,g,d,f,b,h;if(!this.in_current_viewport(e)){if(this._is_loading_from_bottom()){for(c=g=f=this.photos.length-this.num_photos_loaded,b=this.photos.length;f<=b?g<b:g>b;c=f<=b?++g:--g){this._hide_photo(c)}}else{for(c=d=0,h=this.num_photos_loaded;0<=h?d<h:d>h;c=0<=h?++d:--d){this._hide_photo(c)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};a.prototype._blur_range=function(e,b,g){var d,c,f;if(g==null){g=this.timeline.get_viewport_info()}f=Velocity.get();if(f>=0){c=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;d=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(f<0){c=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;d=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}e-=c*g.height;b+=d*g.height;return[e,b]};a.prototype.get_photo_range_to_render=function(j,d){var h,c,g,i,f,b,e;if(d==null){d=true}b=j.top;f=j.bottom;if(d){e=this._blur_range(b,f,j),b=e[0],f=e[1]}if(!this.in_y_range(b,f)){return[null,null]}i=Math.floor((b-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);h=Math.floor((f-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);c=Math.min(this.photos.length-1,i*this.timeline.THUMBS_PER_ROW);g=Math.min(this.photos.length-1,(h+1)*this.timeline.THUMBS_PER_ROW-1);assert(!isNaN(g),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+j.bottom+" ")+("viewport_data.height="+j.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+h+" "),true,["photo_event_nan_limit"]);return[Math.max(0,c),g]};a.prototype.get_photo_range_to_render_with_blur=function(e){var c,h,d,g,f,b;f=this.get_photo_range_to_render(e,true),h=f[0],g=f[1];b=this.get_photo_range_to_render(e,false),c=b[0],d=b[1];return[h,c,d,g]};a.prototype.get_thumb_indexes_to_load=function(o){var v,l,j,i,s,u,r,t,p,f,d,c,b,q,h,g,e,n,m,k;q=this.get_photo_range_to_render_with_blur(o),l=q[0],v=q[1],j=q[2],i=q[3];if(v==null){s=(function(){e=[];for(var w=l;l<=i?w<=i:w>=i;l<=i?w++:w--){e.push(w)}return e}).apply(this);if(this.top_offset>o.bottom){return s}else{return s.reverse()}}t=(function(){n=[];for(var w=v;v<=j?w<=j:w>=j;v<=j?w++:w--){n.push(w)}return n}).apply(this);u=[];r=[];if(l<v){u=(function(){m=[];for(var w=h=v-1;h<=l?w<=l:w>=l;h<=l?w++:w--){m.push(w)}return m}).apply(this)}if(i>j){r=(function(){k=[];for(var w=g=j+1;g<=i?w<=i:w>=i;g<=i?w++:w--){k.push(w)}return k}).apply(this)}p=Velocity.get();if(p>=0){return t.concat(r).concat(u)}else{return t.concat(u).concat(r)}};a.prototype.log_thumb_load=function(c,d){var f,b,e;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===Photos.scroll_count&&!this.logged_thumbs_arrived){if((c+1)%this.timeline.THUMBS_PER_ROW===0||c+1===d){if(this.visible_thumbs_loaded()){b=this.timeline.get_viewport_info();f=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<b.bottom&&b.bottom<this.top_offset+this.get_height())||f){if(Photos.scroll_count<2&&((e=PhotosLogger.get_current_view())===PhotosViews.PHOTOS_VIEW||e===PhotosViews.CAMERA_VIEW)){this.log_timing_event(PhotosTimingEvents.viewport_initial_load);Photos.scroll_count+=2}else{this.log_timing_event(PhotosTimingEvents.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};a.prototype.log_timing_event=function(e){var b,c,f,d;c=datetime.time();b={};if(e===PhotosTimingEvents.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(d=performance.timing)!=null?d.navigationStart:void 0:void 0)!=null){f=datetime.time()-performance.timing.navigationStart;b={current_view:PhotosLogger.get_current_view()};WebTimingLogger.log_ajax_transition(f,e,b,e)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(e===PhotosTimingEvents.viewport_loaded){f=c-this.timing_stopped_scrolling_on_event}return WebTimingLogger.log_ajax_transition(f,e,b,e)};return a})();var Photo;Photo=(function(){a.PLACEHOLDER=0;a.LOADED=1;a.RENDERED=2;a.DISPLAYED=3;a.uniqueness_key;a.item_counter;a.filename;a.ns_id;a.ns_path;a.fq_path;a.href;a.thumbnail_url;a.large_thumbnail_url;a.time_taken;a.display_time_taken;a.preview_type;a.mtime;a.video_streaming_url;a.is_visible;a.user_id;a.event;a.status;a.thumb_html;a.preview_obj;a.duplicates_info;function a(b){this.event=b;this.status=a.PLACEHOLDER;this.preview_obj=b.unique_id}a.prototype.init_metadata=function(b){this.uniqueness_key=b.uniqueness_key;this.item_counter=b.item_counter;this.filename=b.filename;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.fq_path=b.path;this.href=b.href;this.thumbnail_url=b.thumbnail_url;this.large_thumbnail_url=b.large_thumbnail_url;this.time_taken=b.time_taken;this.display_time_taken=b.display_time_taken;this.preview_type=b.preview_type;this.mtime=b.mtime;this.video_streaming_url=b.video_streaming_url;this.is_visible=b.is_visible;this.user_id=b.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true});this.preview_obj=this._get_preview_obj();this.status=a.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};a.prototype.set_duplicates=function(d){var c,e,b;for(e=0,b=d.length;e<b;e++){c=d[e];c.fq_path=c.path}return this.duplicates_info=d};a.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(Photos.in_single_collection_view()){return new SingleCollectionPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new AllPhotosPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(Photos.in_single_collection_view()){return new SingleCollectionVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new AllPhotosVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};a.prototype._get_display_date=function(){var b;if(this.time_taken!=null){b=new Date(this.time_taken);return datetime.nice_date_with_month_name(b,b.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return a})();var PhotoCollection;PhotoCollection=(function(){a.CREATE_EVT="db:photocollection:create";a.ADD_EVT="db:photocollection:add";a.REMOVE_EVT="db:photocollection:remove";a.UNDO_REMOVE_EVT="db:photocollection:undo_remove";a.RENAME_EVT="db:photocollection:rename";a.DELETE_EVT="db:photocollection:delete";a.SHARE_EVT="db:photocollection:share";a.UNSHARE_EVT="db:photocollection:unshare";a.COVER_CHANGE_EVT="db:photocollection:cover_change";a.gid;a.name;a.num_items;a.num_photos;a.num_videos;a.thumbnail_url_32;a.thumbnail_url_256;a.is_anonymous;a.share_tkey;a.shmodel_url;a.short_url;a.is_creator;a.member_fnames;function a(c,b){if(b==null){b=true}assert((c.gid!=null)&&(c.url!=null)&&(c.name!=null)&&(c.num_items!=null)&&(c.num_photos!=null)&&(c.num_videos!=null),"missing required PhotoCollection params");this.gid=c.gid;this.url=c.url;this.name=c.name;this.num_items=c.num_items;this.num_photos=c.num_photos;this.num_videos=c.num_videos;this.thumbnail_url_32=c.thumbnail_url_32||null;this.thumbnail_url_256=c.thumbnail_url_256||null;this.is_anonymous=c.is_anonymous!=null?c.is_anonymous:false;this.share_tkey=c.share_tkey||null;this.shmodel_url=c.shmodel_url||null;this.short_url=c.short_url||null;this.is_creator=c.is_creator!=null?c.is_creator:true;this.member_fnames=c.member_fnames||[_("You")];if(b){document.fire(a.CREATE_EVT,{collection:this})}}a.prototype.add_photos=function(h,g,d,f){var b,e,c;if(g==null){g=null}if(d==null){d=false}if(f==null){f=true}b=(function(){var k,j,i;i=[];for(k=0,j=h.length;k<j;k++){c=h[k];i.push(c.item_counter)}return i})();assert(b.length,"Have to add at least one photo");e={collection_gid:this.gid,item_counters:JSON.stringify(b)};if(g!=null){e.source_collection_gid=g}return new Ajax.DBRequest("/collection_add",{parameters:e,job:d,job_user:Viewer.get_viewer().photos_user,progress_text:_("Adding to album..."),onSuccess:(function(i){return function(l){var j,m,k,n;n=JSON.parse(l.responseText);i.thumbnail_url_32=n.thumbnail_url_32;i.thumbnail_url_256=n.thumbnail_url_256;m=n.new_num_photos-i.num_photos;k=n.new_num_videos-i.num_videos;j=n.new_num_items-i.num_items;i.num_photos=n.new_num_photos;i.num_videos=n.new_num_videos;i.num_items=n.new_num_items;return document.fire(a.ADD_EVT,{collection:i,photos:h,num_items_added:j,num_photos_added:m,num_videos_added:k,promote_collection:f})}})(this)})};a.prototype.remove_photos=function(e,d){var b,c;if(d==null){d=false}b=(function(){var h,g,f;f=[];for(h=0,g=e.length;h<g;h++){c=e[h];f.push(c.item_counter)}return f})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(b),is_shared:this.share_tkey!=null,num_items:this.num_items},job:d,job_user:Viewer.get_viewer().photos_user,progress_text:_("Removing from album..."),onSuccess:(function(f){return function(g){var h;h=JSON.parse(g.responseText);f.thumbnail_url_32=h.thumbnail_url_32;f.thumbnail_url_256=h.thumbnail_url_256;f.num_photos=h.new_num_photos;f.num_videos=h.new_num_videos;f.num_items=h.new_num_items;return document.fire(a.REMOVE_EVT,{collection:f,photos:e,undo_changeset:h.undo_changeset})}})(this)})};a.prototype.undo_remove=function(b){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:b},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:(function(c){return function(){return document.fire(a.UNDO_REMOVE_EVT,{collection:c})}})(this)})};a.prototype.rename=function(c){var b;Photos.enable_selection();b=new Ajax.InPlaceEditor(c,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return $j("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:_("Saving..."),onLeaveEditMode:Photos.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(d){return function(e){d.name=e.responseText;return document.fire(a.RENAME_EVT,{collection:d})}})(this)},callback:(function(d){return function(e,f){return{collection_gid:d.gid,new_collection_name:f,is_shared:d.share_tkey!=null}}})(this)});return b.enterEditMode()};a.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:Viewer.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:Viewer.get_viewer().photos_user,onSuccess:(function(b){return function(){return document.fire(a.DELETE_EVT,{collection:b})}})(this)})};a.prototype.attach_to_token=function(d,f,c,e,b){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:d,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(g){return function(){g.share_tkey=d;g.shmodel_url=f;g.short_url=c;if(typeof e==="function"){e()}return document.fire(a.SHARE_EVT,{collection:g})}})(this),onFailure:function(){return typeof b==="function"?b():void 0}})};a.prototype.send_link=function(c,e,i,d,h,b){var g,f;g=(function(j){return function(){j.share_tkey=e;j.shmodel_url=i;j.short_url=d;if(typeof h==="function"){h()}return document.fire(a.SHARE_EVT,{collection:j})}})(this);f={collection_gid:this.gid,share_tkey:e,num_items:this.num_items};return Forms.ajax_submit(c,"/collection_share",g,b,c.down(".tokenizer-submit-button"),f)};a.prototype.unshare=function(){assert(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(b){return function(){b.share_tkey=null;b.shmodel_url=null;b.short_url=null;return document.fire(a.UNSHARE_EVT,{collection:b})}})(this),subject_user:Viewer.get_viewer().photos_user})};a.prototype.set_cover=function(b){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:b.item_counter},onSuccess:(function(c){return function(d){var e;e=JSON.parse(d.responseText);c.thumbnail_url_32=e.thumbnail_url_32;c.thumbnail_url_256=e.thumbnail_url_256;return document.fire(a.COVER_CHANGE_EVT,{collection:c})}})(this)})};return a})();var FilePreview;FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(e,d,b){var a,c;this._log_pdf_render_time(e);if(e==="pdf-native"||e==="pdf-embedded"||e==="pdf-js"){event_load.window_load((function(f){return function(){$j("#pdf-embed-iframe").attr("src",d);$j("#pdf-embed-iframe").attr("type","application/pdf");$j("#pdf-embed-iframe").attr("allowfullscreen","");return f._fire_pdf_render_event()}})(this));this.preview_status=b;if(Browser.chrome){c=function(){var f;f=$j('link[rel="shortcut icon"]').remove();return $j("head").append(f)};setTimeout(c,1000)}a=$$("#pdf-embed-container iframe");return window.setTimeout(((function(f){return function(){return a.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(){return event_load.window_load(function(){return $j("#excel-embed-form").submit()})},init_font:function(){return $j((function(a){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_photo:function(d,g){var i,e,h,f,c,a,b;$("preview-img").observe("error",this._preview_failed.bind(this));if((f=window.performance)!=null?(c=f.timing)!=null?c.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var j;j=datetime.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(j,"file-preview-photo")})}$("full-img").src=d;a=$$("#preview-img, #full-img");b=[];for(e=0,h=a.length;e<h;e++){i=a[e];i.setAttribute("data-original-href",g);b.push(i.on("contextmenu","img",ContextMenu.show_shmodel.bind(ContextMenu)))}return b},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this._preview_failed();return}return setTimeout(((function(a){return function(){if(!window.htmlified_height){return a._preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var a;if((a=$("htmlified-loading"))!=null){a.remove()}$("htmlified").style.height=window.htmlified_height+"px";return $("htmlified").style.visibility=""},init_video:function(d,b,c,e,g,f,i){var h,a;a=i.width()*0.9;h=a*0.55;return $j((function(j){return function(){var k;k=j._video_preview_failed;if(e==="hls"){j.player=VideoUtil.embed("#video",{src:c,type:"application/vnd.apple.mpegurl",width:a,height:h,controls:true,poster:g,onError:k,onReady:j._player_ready,metadata_link:f})}else{$j("#video").empty();if(d){if(b){j.player=VideoUtil.embed("#video",{src:c,type:"video/mp4",width:a,height:h,controls:true,poster:g,onError:k,onReady:j._player_ready,metadata_link:f})}else{k()}}else{j.player=VideoUtil.embed("#video",{src:c,type:"video/flv",width:a,height:h,controls:true,poster:g,onError:k,onReady:j._player_ready,metadata_link:f})}}$j(".vjs-poster").hide();$j(".vjs-big-play-button").hide();j.player.on("play",j._onPlay);return j.player.on("ended",j._onEnded)}})(this))},photo_loaded:function(c){var b,a;if((b=window.performance)!=null?(a=b.timing)!=null?a.navigationStart:void 0:void 0){c=c-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(c,"file-preview-photo")}},_player_ready:function(){var a;a=function(){$j(".vjs-poster").show();$j(".vjs-big-play-button").show();return $j(".vjs-big-play-button").focus()};return a.defer()},_onPlay:function(){$j(".vjs-poster").hide();return $j(".vjs-big-play-button").hide()},_onEnded:function(){$j(".vjs-poster").show();$j(".vjs-big-play-button").show();return $j(".vjs-loading-spinner").hide()},_video_preview_failed:function(a){if(a==="needflash"){$j("#video-preview-flash-message").show()}return FilePreview._preview_failed()},_preview_failed:function(){var a;a=$j(document.body);if(a.hasClass("shmodel-body")){a.removeClass("file-preview-body")}Notify.error(_("Preview failed."));return $j(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var a;if(document.createEvent&&window.dispatchEvent){a=document.createEvent("UIEvents");a.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(a)}},_log_pdf_render_time:function(b){var a;a=function(f){var d,e,c;if((e=window.performance)!=null?(c=e.timing)!=null?c.navigationStart:void 0:void 0){d=datetime.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(d,f)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return a(b)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return a(""+b+"-parse")})}};var parse_color_to_rgba;Effect.BlindFadeUp=function(d,c){var b,a;b=new Effect.BlindUp(d,c);a=new Effect.Fade(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.BlindFadeDown=function(d,c){var b,a;b=new Effect.BlindDown(d,c);a=new Effect.Appear(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.Flash=function(c,b,a){assert(b.startcolor&&b.endcolor,"Start and end colors must be specified");assert(b.cycles,"Fade cycles must be specified");a=a||0;return new Effect.Highlight(c,{duration:1,startcolor:b.startcolor,endcolor:b.endcolor,restorecolor:b.endcolor,afterFinish:function(){return new Effect.Highlight(c,{duration:1,startcolor:b.endcolor,endcolor:b.startcolor,restorecolor:b.startcolor,afterFinish:function(){if(a<b.cycles){return Effect.Flash(c,b,a+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var r,p,x,l,q,s,m,n,h,e,c,b,y,D,B,z,w,v,u,t,a,E,C,A,o,j,i,g,d,f;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};o=["top","left","width","height","fontSize"];for(h=0,y=o.length;h<y;h++){s=o[h];this.originalStyle[s]=this.element.style[s]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;l=this.element.getStyle("font-size")||"100%";j=["em","px","%","pt"];for(e=0,D=j.length;e<D;e++){q=j[e];if(l.indexOf(q)>0){this.fontSize=parseFloat(l);this.fontSizeType=q}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;p=["border%sWidth","margin%s","padding%s"];for(c=0,B=p.length;c<B;c++){m=p[c];i=["Top","Bottom","Left","Right"];for(b=0,z=i.length;b<z;b++){x=i[b];n=m.format(x);this.dims[n]=parseFloat(this.element.getStyle(n));if(x==="Top"||x==="Bottom"){this.full_height+=this.dims[n]}else{this.full_width+=this.dims[n]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(a=0,w=p.length;a<w;a++){r=p[a];this.attrs_horizontal.push(r.format("Left"))}this.attrs_horizontal.push("width");g=p.reverse();for(E=0,v=g.length;E<v;E++){r=g[E];this.attrs_horizontal.push(r.format("Right"))}}if(this.options.scaleY){for(C=0,u=p.length;C<u;C++){r=p[C];this.attrs_vertical.push(r.format("Top"))}this.attrs_vertical.push("height");d=p.reverse();f=[];for(A=0,t=d.length;A<t;A++){r=d[A];f.push(this.attrs_vertical.push(r.format("Bottom")))}return f}},update:function(a){var b;b=(this.options.scaleFrom/100)+(this.factor*a);b=(-0.5+1/(1+Math.exp((0.5-b)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*b+this.fontSizeType})}return this.setDimensions(b)},setDimensions:function(f){var k,n,l,i,j,b,g,e,m,a,h,c;l={};h=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(g=0,m=h.length;g<m;g++){c=h[g],i=c[0],n=c[1];j=i*f;for(e=0,a=n.length;e<a;e++){k=n[e];b=this.dims[k];if(b<j){l[k]=b+"px";j-=b}else{l[k]=j.round()+"px";j=0}}}return this.element.setStyle(l)}});Effect.BlindUpComprehensive=function(a){a=$(a);a.makeClipping();return new Effect.ScaleComprehensive(a,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(b){return b.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(b){var a;b=$(b);a=b.getDimensions();return new Effect.ScaleComprehensive(b,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:a.height,originalWidth:a.width},restoreAfterFinish:true,afterSetup:function(c){return c.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(c){return c.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var k,h,c,g,j,d,l,f,b,a;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{h=new Element("div");j="rgba(1, 1, 1, 0)";h.setStyle({backgroundColor:j});this._supports_alpha=(h.getStyle("background-color"))===j}catch(m){}this._base=parse_color_to_rgba(this.options.startcolor);if((f=this.options.endcolor)==="transparent"||f==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){c=this._base.slice(0);c[3]=0}else{c=[255,255,255,1]}}else{c=parse_color_to_rgba(this.options.endcolor)}this._delta=[];b=this._base;a=[];for(g=d=0,l=b.length;d<l;g=++d){k=b[g];a.push(this._delta.push(c[g]-k))}return a},update:function(a){var h,c,g,d,f,b,e;g=[];e=this._base;for(d=f=0,b=e.length;f<b;d=++f){h=e[d];c=h+this._delta[d]*a;if(!(d>2)){c=Math.round(c)}g.push(c)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(g.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(g.slice(0,3).join(", "))+")"})}}});parse_color_to_rgba=function(c){var d,g,f,e,a,b,h,j,i;b=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;a=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;e=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;g=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;f=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;d=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(j=c.match(b)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})()}else{if(j=c.match(a)){i=(function(){var n,l,m,k;m=j.slice(1,4);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})();i[3]=parseFloat(j[4])}else{if(j=c.match(e)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(g)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(f)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}else{if(j=c.match(d)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}}}}}}i=i||[255,255,255,1];h=i.length;if(h===3){i.push(1)}else{if(h===4&&i[h-1]>1){i[h-1]=i[h-1]/255}}return i};var ClientDownload;ClientDownload=(function(){function a(){}a.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(b){var c;c=$j("<div",{"class":"brodal-header",text:_("Install Dropbox")});return Modal.show(c[0],$("client-download"),{},false,450)},subject_user:Browse.active_user})};return a})();var AlbumsLogger,PhotosEvents,PhotosLogger,PhotosTimingEvents,PhotosTourEvents,PhotosTriggers,PhotosViews;AlbumsLogger={log_share:function(b,e,d,c,a){return AlbumsLogger.log(b,e,true,d,c,a)},log_event:function(a,d,c,b){return AlbumsLogger.log(a,d,false,c,b)},log:function(b,g,d,f,e,a){var c;c={evt:b,collection_gid:g,is_anonymous:e};if(d!=null){c.share_event=d}if(f!=null){c.num_items=f}if(a!=null){c.on_create=a}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:c})}};PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var a,c,b;a=((b=$("modal"))!=null?b.visible():void 0)&&$("shmodal").visible();c=a?"-foshmodal":"";if(Photos.in_single_collection_view()){return PhotosViews.SINGLE_COLLECTION_VIEW+c}else{if(Photos.in_all_collections_view()){return PhotosViews.ALBUMS_VIEW+c}else{if(Photos.initialized){return PhotosViews.PHOTOS_VIEW+c}else{return PhotosViews.NOT_PHOTOS}}}},log_interaction:function(a,b,c){return PhotosLogger.log(a,b,null,PhotosLogger.get_current_view(),c)},log_transition_to:function(a){return PhotosLogger.log(a,null,null,PhotosLogger.get_current_view(),null,true)},log:function(b,c,a,g,e,f){var d;d={evt:b,trigger:c,view:a};if(e!=null){d.data=JSON.stringify(e)}if(g!=null){d.start_view=g}if(f!=null){d.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:d})}};PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var RegistrationLogger,ShmodelLogger,ShmodelUILogger;ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(a){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:a,url:window.location.href}})},attachLogListener:function(a,b){if(b==null){return}return b.observe("click",function(c){ShmodelLogger.log(a);if(b.href&&b.href!=="#"&&b.target!=="_blank"){Event.stop(c);return(function(){return window.location.href=b.href}).defer()}})}};ShmodelUILogger={log:function(a,b,c){return new Ajax.DBRequest("/shmuilog",{method:"post",noAutonotify:true,parameters:{evt:a,origin:b,target_item:c}})},get_target_item:function(a){if(a.dir){if(a.is_shared_folder()){return"folder-is-sf"}else{if(a.could_be_shared_folder()){return"folder-can-sf"}else{return"folder-no-sf"}}}else{return"file"}},log_with_target_file:function(a,b,c){return this.log(a,b,this.get_target_item(c))},attachLogListener:function(a,b){if(b==null){return}return b.observe("click",function(c){ShmodelLogger.log(a);if(b.href&&b.href!=="#"&&b.target!=="_blank"){Event.stop(c);return(function(){return window.location.href=b.href}).defer()}})}};RegistrationLogger={log:function(a){var b;b=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:a,url:b}})},attachLogListener:function(a,b){if(b==null){return}return b.observe("click",function(c){RegistrationLogger.log(a);if(b.href&&b.href!=="#"&&b.target!=="_blank"){Event.stop(c);return(function(){return window.location.href=b.href}).defer()}})}};var TwoFactorAuth;TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(a){this._user=Viewer.get_viewer().get_user_by_id(a);assert(this._user,""+a+" is invalid");return $j("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){$j("#resend-link").on("click",this.resend_phone_code.bind(this));return $j("#code").focus()},init:function(a){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();return Util.async_load_script(a)},account_listen:function(){var g,a,b,d,e,j,k,c,i,f,h;i={name:"delivery_choice",enter:(function(l){return function(m){var n;l.hide_error();n=0;$j(".delivery-choice").each(function(){var o;o=$j(this).height();return n=Math.max(o,n)});$j(".delivery-choice").height(n);return $j(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:$j("#twofactor-delivery-choice"),onSubmit:(function(l){return function(m,n,o){m.vars.sms=!!($j("#use-sms")[0].getValue()==="on");if(!m.vars.sms){return l.fetch_offline_key(m,n)}else{return n.next()}}})(this)};f={name:"enter_phone_number",enter:(function(l){return function(n){var o,m;l.hide_error();l._is_offline_setup=false;l._phone_number=null;o=$("twofactor-enter-phone");m=l.fill_phone_number_for_edit(o,$j("#twofactor-row-"+l._user.role+" #twofactor-sms-number").text());return m.focus()}})(this),contents:$j("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};h={name:"offline_setup",enter:(function(l){return function(m){l.hide_error();l._is_offline_setup=true;return l._phone_number=null}})(this),contents:$j("#twofactor-offline-setup")};c={name:"confirm_phone",enter:(function(l){return function(m){var n;l._invalid_code_count=0;if(l._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{n=m.vars.phone_number;assert(n,"expected a display_phone argument");$("phone-number-placeholder").__date(n);$("twofactor-enable-confirm").removeClassName("offline")}l.hide_error();$("phone-code").clear().focus();return l.fill_delivery_choice(n)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:$j("#twofactor-enable-confirm")};k={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:$j("#twofactor-enter-backup-phone")};e=new ModalFlow(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:$j("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(l){return function(m,n){l.successfully_enabled=false;m.vars.mode="ENABLE";m.vars.passed_password=true;return n.next()}})(this)),contents:$j("#twofactor-enter-password")},i,f,h,c,k,{name:"recovery_code",enter:(function(l){return function(){l.fill_backup_phone(l._backup_phone);return l.hide_error.bind(l)}})(this),onSubmit:this.submit_finish.bind(this),contents:$j("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:_("Congrats! You've enabled two-step verification!"),contents:$j("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:((function(l){return function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(l){if(l.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});e.addExitListener((function(l){return function(m){if(e.vars.passed_password&&m&&!l.successfully_enabled){return Notify.error(_("Two-step verification is not enabled"))}}})(this));d=new ModalFlow(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(l){return function(n,o){var m;l.successfully_enabled=false;$j(".delivery-choice").removeClass("selected");m=!$j("#twofactor-row").hasClass("with-sms");$j(m?"#app-choice":"#sms-choice").addClass("selected");$j("#twofactor-recovery").addClass("edit-mode");n.vars.passed_password=true;return o.next()}})(this)),contents:$j("#twofactor-enter-password")},i,f,h,c,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:((function(l){return function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(l){if(l.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});d.addExitListener((function(l){return function(m){if(d.vars.passed_password&&m&&!l.successfully_enabled){return Notify.error(_("Two-step verification has not been changed"))}}})(this));a=new ModalFlow(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(l){return function(m,n){l.successfully_disabled=false;m.vars.passed_password=true;return n.next()}})(this)),contents:$j("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:$j("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});a.addExitListener((function(l){return function(m){if(a.vars.passed_password&&m&&!l.successfully_disabled){return Notify.error(_("Two-step verification is still enabled"))}}})(this));g=new ModalFlow(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(l){return function(m,n){return n.next()}})(this)),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");b=new ModalFlow(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(l){return function(m,n){return n.next()}})(this)),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");j=new ModalFlow(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(l){return function(m,n){return new Ajax.DBRequest(l.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:l._checkpoint_token},onSuccess:function(o){var p;p=o.responseText.strip();if(p.startsWith("OK:")){l.fill_recovery_code(p.substr(3),"backup-code-div-edit");return n.next()}else{switch(p){case"EXPIRED":return l.show_error_expired();case"ALREADY_DISABLED":$j("#twofactor-row").removeClass("twofactor-enabled");Notify.success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:l.show_error500.bind(l),cleanUp:l.hide_loading.bind(l),subject_user:l._user})}})(this)),contents:$j("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:$j("#twofactor-recovery-edit"),onSubmit:(function(l){return function(m,n){l._checkpoint_token=null;return n.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");$j(".enable-twofactor").on("click",(function(l){return function(m){return l.start_flow(m,e)}})(this));$j(".disable-twofactor").on("click",(function(l){return function(m){return l.start_flow(m,a)}})(this));$j(".add-twofactor-backup-link").on("click",(function(l){return function(m){return l.start_flow(m,g)}})(this));$j(".edit-twofactor-backup").on("click",(function(l){return function(m){return l.start_flow(m,b)}})(this));$j(".edit-twofactor-recovery").on("click",(function(l){return function(m){return l.start_flow(m,j)}})(this));$j(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(l){return function(m){return l.start_flow(m,d)}})(this));$j("#generate-new-recovery-code").on("click",(function(l){return function(m){l.show_loading();return new Ajax.DBRequest(l.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:l._checkpoint_token},onSuccess:function(n){var o;o=n.responseText.strip();if(o.startsWith("OK:")){return l.fill_recovery_code(o.substr(3),"backup-code-div-edit")}else{switch(o){case"EXPIRED":j.to_state("password");return l.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.success(_("Two-step verification is disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:l.show_error500.bind(l),cleanUp:l.hide_loading.bind(l),subject_user:l._user})}})(this));$j("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));$j("#resend-link").on("click",this.enable_resend_phone_code.bind(this));$j("#twofactor-delivery-choice input").change(function(){$j(".delivery-choice").removeClass("selected");return $j(this).parents(".delivery-choice").addClass("selected")});$j("#show-qr").on("click",(function(l){return function(m){$j("#twofactor-offline-setup").addClass("showing-qr");return false}})(this));$j("#hide-qr").on("click",(function(l){return function(m){$j("#twofactor-offline-setup").removeClass("showing-qr");return false}})(this));if(window.location.hash==="#backup2fa"&&$j("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(g)}},start_flow:function(c,b){var a;c.preventDefault();a=$j(c.target).data("uid");TwoFactorAuth.set_user(Viewer.get_viewer().get_user_by_id(a));this._current_flow=b;b.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return $j("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(b){var a;if(this.is_resending()){return}this.show_resending();a="/twofactor_resend";if($j("#twofactor-confirm").hasClass("backup")){a=URI.parse(a).updateQuery({backup:true}).toString()}new Ajax.DBRequest(a,{onSuccess:(function(c){return function(d){switch(d.responseText.strip()){case"OK":c.hide_error();return c.notify_resent();case"UNREACHABLE":return c.show_error_unreachable(true);case"BADCARRIER":return c.show_error_bad_carrier();case"INVALIDNUMBER":return c.show_error_invalid_number();case"NOTAMOBILE":return c.show_error_not_a_mobile();case"RATELIMIT":return Notify.error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(a){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(b){return function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return Notify.error(error_unreachable(true));case"BADCARRIER":return Notify.error(error_bad_carrier());case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return Notify.error(error_not_a_mobile());case"RATELIMIT":return Notify.error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(b){return function(c){return Notify.error(b.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(a){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(b){return function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return b.show_error_unreachable();case"BADCARRIER":return b.show_error_bad_carrier();case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return b.show_error_not_a_mobile();case"RATELIMIT":return Notify.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":b._current_flow.to_state("password");return b.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:_("Enable two-step verification"),DEFAULT_EDIT_TITLE:_("Edit two-step verification"),DEFAULT_DISABLE_TITLE:_("Disable two-step verification"),ADD_BACKUP_TITLE:_("Add a backup phone number"),EDIT_BACKUP_TITLE:_("Edit backup phone number"),EDIT_RECOVERY_TITLE:_("View recovery code"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var a;this.hide_error();$j("#twofactor-recovery").removeClass("edit-mode");a=$("twofactor-enter-password");$j("#password",a).val("").focus();return false},submit_password:function(c,g,a,d,f){var b;b=$("password").getValue();if(!b){this.show_error(_("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(c,{parameters:{password:b},onSuccess:(function(e){return function(h){var i;i=h.responseText.strip();if(i.startsWith("OK:")){e._checkpoint_token=i.substr(3);return g(a,d)}else{switch(i){case"EXPIRED_PASSWORD":return e.show_error_expired_password();case"INVALID":return e.show_error(_("Invalid password"));case"RATELIMIT":return e.show_error(_("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");Notify.success(_("Two-step verification is already enabled. Did you maybe enable it in another window?"));return Modal.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(a,b){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(c){return function(d){var e;e=d.responseText.strip();if(e.startsWith("OK:")){c.fill_key(e.substr(3));return b.next()}else{switch(e){case"EXPIRED":a.to_state("password");return c.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(b){var a,d,c;b=b.replace(new RegExp("=+$"),"");a=b.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(a);$("qr-div").__date();c=Constants.IS_PROD?"Dropbox":"DropboxDev";d={text:"otpauth://totp/"+c+":"+this._user.email+"?secret="+b+"&issuer="+c,width:200,height:200};if(!Modernizr.canvas){d.render="table"}$j("#qr-div").qrcode(d);if(!Modernizr.canvas){return $j("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(b,d,f){var a,c;a=$j("#twofactor-enter-phone .twofactor-phone-number");if(!a.controller().validate_on_submit()){return}c=a.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:c},onSuccess:(function(e){return function(g){switch(g.responseText.strip()){case"OK":e._phone_number=c;b.vars.phone_number=c;return d.next();case"EXPIRED":b.to_state("password");return e.show_error_expired();case"UNREACHABLE":return e.show_error_unreachable(a);case"BADCARRIER":return e.show_error_bad_carrier(a);case"INVALIDNUMBER":return e.show_error_invalid_number(a);case"NOTAMOBILE":return e.show_error_not_a_mobile(a);case"RATELIMIT":return e.show_error(_("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(a,b,d){var c;c=$("phone-code").getValue().strip();if(!c){this.show_error(_("Please enter the security code"));return}if(c.search(/^\d{6}$/)===-1){this.show_error(_("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:c},onSuccess:(function(e){return function(f){var h,g;g=f.responseText.strip();if(g.startsWith("OK:")){e.fill_recovery_code(g.substr(3),"backup-code-div");return b.next()}else{switch(g){case"INVALID":e._invalid_code_count+=1;h=e._invalid_code_count<=2?_("Invalid code"):e._is_offline_setup?_("Invalid code. Check the clock on your phone: it must be accurate to the minute."):_("Invalid code");return e.show_error(h);case"EXPIRED":a.to_state("password");return e.show_error_expired();case"RATELIMIT":return e.show_error(_("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(d,b){var c,a;this.hide_error();c=$("twofactor-enter-backup-phone");a=this.fill_phone_number_for_edit(c,$j("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());a.focus();if(d==="back_next"){$j("#twofactor-backup-back-next").show();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").hide()}else{if(d==="cancel_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").show();return $j("#twofactor-backup-back-save").hide()}else{if(d==="back_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(f,d,b,g,h){var a,c;a=$j("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!a.controller().validate_on_blur()){return}c=a.val();if(c){if(this.is_primary_number(c)){a.controller().show_error(_("You can't use your primary phone as your backup",a));return}}else{if(f){a.controller().show_error(_("Please enter phone number",a));return}}this._backup_phone=c;if(d==="save_backup_phone"){this.save_added_backup_phone(b,f,c)}else{if(d==="save_everything"){this.submit_finish(b,g,h)}else{if(d==="save_none"){return g.next()}}}},is_same_phone_number:function(b,a){if(!b||!a){return false}return b.replace(/\D+/g,"")===a.replace(/\D+/g,"")},is_primary_number:function(a){var b;b=$j("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(a,b.data("primary_phone"))){return true}if(this.is_same_phone_number(a,$j("#twofactor-sms-number",b).text())){return true}return false},save_added_backup_phone:function(a,c,b){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:b},onSuccess:(function(d){return function(e){var f;switch(e.responseText.strip()){case"OK":d.hide_error();f="#twofactor-row-"+d._user.role;$j(""+f+" #twofactor-backup-number").text(b);$j(f).toggleClass("with-backup",!!b);Util.syncHeight();if(!b){Notify.success(_("Backup phone number removed"))}else{if(!c){Notify.success(_("Backup phone number updated"))}else{Notify.success(_("Backup phone number added"))}}return Modal.hide();case"EXPIRED":a.to_state("password");return d.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(d,f){var e,b,c,a;b=$j(".sick-input > input",d);if(!f){return b.val("")}a=$j('select[name="country_code"]',d);e=/^\+\d+/.exec(f);e=e?e[0]:"";c=this.option_for_country_code(a,e);if(c!=null){c.selected=true}b.val($j.trim(f.slice(e.length)));if(b.length){b[0].select()}return b},option_for_country_code:function(a,c){var b;if(c){b=$j('option[value="'+c+'"]',a);if(b.length>1){b=b.filter("[selected]")}if(b.length){return b[0]}}return $j("option[selected]",a)[0]},fill_delivery_choice:function(a){$j("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!a);$j("#twofactor-delivery-offline-label").toggle(!a);$j("#confirm-phone-primary-number").text(a);return $j("#twofactor-row-"+this._user.role).data("primary_phone",a)},fill_backup_phone:function(a){$j("#confirm-phone-backup").toggle(!!a);return $j("#confirm-phone-backup-number").text(a)},fill_recovery_code:function(b,a){b=b.toLowerCase().replace(/(.{4})/g,"$1 ");return $(a).__date(b)},submit_finish:function(a,b,c){var d;this.show_loading();d={checkpoint_token:this._checkpoint_token};if(this._backup_phone){d.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:d,onSuccess:(function(e){return function(f){switch(f.responseText.strip()){case"OK":e.successfully_enabled=true;if(a.vars.mode!=="ENABLE"){return e.after_enabled(a,b)}else{return b.next()}break;case"EXPIRED":a.to_state("password");return e.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(b,c){var a;this._checkpoint_token=null;this.hide_error();a=$j("#twofactor-row-"+this._user.role);a.toggleClass("with-sms",!!this._phone_number);$j("#twofactor-sms-number",a).text(this._phone_number||"");a.toggleClass("with-backup",!!this._backup_phone);$j("#twofactor-backup-number",a).text(this._backup_phone||"");a.addClass("twofactor-enabled");Util.syncHeight();if(b.vars.mode!=="ENABLE"){Notify.success(_("Two-step verification updated"));return c!=null?c.next():void 0}},disable_submit:function(a,b){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(c){return function(e){var d;switch(e.responseText.strip()){case"OK":c.successfully_disabled=true;c._checkpoint_token=null;d=$j("#twofactor-row-"+c._user.role);d.removeClass("twofactor-enabled with-sms with-backup");$j("#twofactor-sms-number, #twofactor-backup-number",d).text("");Util.syncHeight();Notify.success(_("Two-step verification is now disabled."));return b.next();case"EXPIRED":a.to_state("password");return c.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(c,a){var b;if(a){a.controller().show_error(c);return}b=$$(this._error_selector);if(c===this.error_expired_password()||c===this.error_unreachable(true)){b.invoke("update",c)}else{b.invoke("__date",c)}return b.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(a){return this.show_error(this.error_bad_carrier(),a)},show_error_invalid_number:function(a){return this.show_error(this.error_invalid_number(),a)},show_error_not_a_mobile:function(a){return this.show_error(this.error_not_a_mobile(),a)},show_error_unreachable:function(a,b){if(b==null){b=false}return this.show_error(this.error_unreachable(b),a)},show_error_expired:function(a){return this.show_error(this.error_expired(),a)},show_error_expired_password:function(a){return this.show_error(this.error_expired_password(),a)},error_500:function(){return _("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return _("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return _("That is not a valid phone number.")},error_not_a_mobile:function(){return _("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(a){if(a==null){a=false}if(a){return _('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return _("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return _("Since it's been a while, please enter your password again.")},error_expired_password:function(){return _('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return Notify.success(_("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(b){var a,c;a=b.element();c=$j(".sick-input",a.form);$j("input",c).val("").focus();return this.fill_example_phone_number(a,c)},fill_example_phone_number:function(a,d){var c,b;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){c=$j(a).val().substr(1);b=phone_helpers.get_example_mobile_number(c);return $j("label",d).text(_("Example: ")+b)}},reset_phone_field_and_backup_country:function(b){var a;this.reset_phone_field(b);if($j("#backup-phone-number").val()===""){a=$j("#twofactor-enter-backup-phone #country-code");a.val(b.element().getValue());return this.fill_example_phone_number(a,$j(".sick-input",a[0].form))}}};var PseudoLocalStorage;PseudoLocalStorage={_store:{},getItem:function(a){return this._store[a]},setItem:function(a,b){return this._store[a]=b},removeItem:function(a){return delete this._store[a]},clear:function(){return this._store={}}};var DBLocalStorage;DBLocalStorage={dbstore:Modernizr.localstorage?window.localStorage:PseudoLocalStorage,_access_order_key:"ao",_get_access_order:function(){var a,b;a=this.dbstore.getItem(this._access_order_key);try{a=JSON.parse(a)}catch(c){b=c;a=[]}if(a instanceof Array){return a}else{return[]}},_to_key:function(a){return JSON.stringify(a)},attemptWrite:function(h,d){var j,b,c,e,i,g,k,a;j=0;c=10;g=0;a=[];while(j<c&&!g){e=this._get_access_order();e.push(h);try{this.dbstore.setItem(h,d);this.dbstore.setItem(this._access_order_key,JSON.stringify(e));g=1}catch(f){b=f;i=this._get_access_order();if(i.length){k=i.shift();this.dbstore.removeItem(k);this.dbstore.setItem(this._access_order_key,JSON.stringify(i))}else{this.dbstore.clear()}}a.push(j+=1)}return a},getItem:function(b){var c,a,d;b=this._to_key(b);d=this.dbstore.getItem(b);if(d){c=this._get_access_order();c.removeItem(b);c.push(b);this.dbstore.setItem(this._access_order_key,JSON.stringify(c));a=JSON.parse(d);return a}},setItem:function(a,b){return this.attemptWrite(this._to_key(a),JSON.stringify(b))},removeItem:function(a){var b;a=this._to_key(a);b=this._get_access_order();b.removeItem(a);this.dbstore.setItem(this._access_order_key,JSON.stringify(b));return this.dbstore.removeItem(a)},clear:function(){return this.dbstore.clear()}};var FileViewer;FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,shown:false,is_loaded:false,has_key_listener:false,history_length:null,preview_status_timeout_obj:null,preview_status_request:null,active_user:null,in_browse:true,_get_extension:function(b){var a;a=b.lastIndexOf(".");return(a===-1?"":b.substr(a+1))},show:function(b,a,c){this.file=b;this.active_user=a;this.in_browse=c;this._start_time=Date.now();this.shown=true;this.history_length=window.history.length;if(this.file.preview_type==="download"){return window.location.href=this.file.href}else{document.title=this.file.filename;this._render_viewer();return $j("#file-viewer").show().trigger("db:filepreview:open",[this.file])}},render_file_failed:function(){this._hide();this.file=this.last_file;this.file.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._render_viewer();return $j("#file-viewer").show()},_log_view:function(a,b){var c;c={mode:"file-preview",file_ext:FilePath.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:a,file_bytes:this.file.bytes,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,in_progress:b,ns_id:this.file.ns_id,ns_path:this.file.ns_path,sjid:this.file.sjid,user_id:this.active_user.id};return analytics.UserActivityLogger.log("web","file_view",JSON.stringify(c))},_render_viewer:function(){var g,b,j,k,d,m,a,l,i,p,c,o,e,h,f,n;dom.scroll_lock_document();b=$j("#file-viewer");g=b.find(".download-button");k=URI.parse(this.file.href).updateQuery({dl:1}).toString();h=(function(q){return function(w){var s,u,r,t,v;if(w==null){w=true}r=Emstring.em_snippet(q.file.filename,35);s=b.find(".title-bar .filename");v={"class":"icon",alt:q.file.caption};t=Sprite.html("web",q.file.icon,v).toHTML();u=$j("<span />",{"class":"filename-text"}).text(r);s.html(t).append(u);b.addClass("has-preview");if(q.file.htmlified_link){}else{if(q.file.preview_type==="excel"){b.addClass("html-preview");b.find(".loading").css("z-index","-1")}else{b.addClass(""+q.file.preview_type+"-preview")}}if(w){b.find(".loading").show()}g.on("click",function(){return window.location.href=k});if(q.file.tkey!=null){q._show_more_button()}q.modal_type=q._MODAL_PREVIEW;q._first_render_completed=false;return q._listen()}})(this);n=(function(q){return function(s){var r;if(typeof UnityFeatures!=="undefined"&&UnityFeatures!==null){r=_("Open",{comment:"Open a file natively on the user's computer"});s.text(r);return s.off("click").on("click",function(v){var t,u;v.preventDefault();u=q.file.ns_id+":"+q.file.ns_path;t=function(w){if(!w){return Notify.error(_("Error opening file"))}};return UnityFeatures.open_file(u,q.file.user_id,t)})}}})(this);o=(function(q){return function(s){var r;if((s!=null?s.length:void 0)&&b.attr("data-is-unity-allowed")==="True"&&(typeof UnityFeatures!=="undefined"&&UnityFeatures!==null)){r=function(t){if(t){return n(s)}};return UnityFeatures.check_file(q.file.ns_id+":"+q.file.ns_path,q.file.user_id,r)}}})(this);m=(function(q){return function(){b.removeClass();b.find(".loading").hide();return q._unlisten()}})(this);e=(function(q){return function(r,u,t,s){if(r==null){r=false}if(u==null){u=true}if(t==null){t=false}if(s==null){s=false}q._log_view(Date.now()-q._start_time,s);if(!r){h(u);o(g)}q._render_preview(t);return q._initial_resize()}})(this);c=(function(q){return function(r){var s;if(r==null){r=false}s=Emstring.em_snippet(q.file.filename,20);b.find(".title-bar .filename").text(s);b.addClass("no-preview");b.find(".file-thumbnail img").attr({src:"/static/images/icons128/"+(FilePath.file_icon(q.file.filename))+".png"});b.find(".file-type").text(s);b.find(".file-size").text(q.file.size);b.find(".file-modified").text(q.file.ago||"");g.attr({href:k});q.modal_type=q._MODAL_FILEINFO;q._listen();q._log_view(Date.now()-q._start_time,r);o(g);return q._initial_resize()}})(this);d=this._get_extension(this.file.fq_path);p=(this.file.preview_type==="doc"||this.file.preview_type==="excel")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||FilePath.file_extension(this.file.filename).toLowerCase()!=="pdf");this.has_preview=(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(p&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE);a=p&&this._preview_progressive_try(d);if(this.has_preview||a){return e(false,!(this.file.preview_type==="doc"))}l=p&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS;if(!l){return c()}h();i=URI({path:"/doc_preview_status"+this.file.fq_path}).toString();f=Date.now();return(j=(function(q){return function(){var r;r=Date.now();if(r-f>=5000){m();return c(true)}return q.preview_status_request=$j.ajax(i,{success:function(s){if(q.file){return q.file.doc_preview_status=parseInt(s,10)}},complete:function(s,t){if(t==="abort"){return}if(q.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){q.has_preview=true;return e(true,false,true,true)}else{if(q.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return q.preview_status_timeout_obj=setTimeout(j,1000)}else{m();return c(true)}}},timeout:5000-(r-f),subject_user:q.active_user})}})(this))()},_remove_loading:function(a){if(a==null){a=true}$j("#file-viewer .loading").hide();return this.is_loaded=a},_show_more_button:function(){var c,b,a;a=$j("#file-viewer");c=a.find(".more-options-button");if(c.is(":visible")){return}c.show();b=a.find(".more-options-dropdown");c.on("click",(function(d){return function(f){if(b.is(":visible")){return}FreshDropdown.show(b,c,null,true);return f.stopPropagation()}})(this));$j("#file-viewer-container").on("click",FreshDropdown.hide_all);return b.find(".remove-link").on("click",(function(d){return function(f){FreshDropdown.hide_all();return SharingModel.confirm_remove(d.file.filename,d.file.tkey,0,0,0,d.file.user_id)}})(this))},_hide_more_button:function(){var b,a;a=$j("#file-viewer");b=a.find(".more-options-button");b.off("click").hide();$j("#file-viewer-container").off("click",FreshDropdown.hide_all);return a.find(".remove-link").off("click")},_initial_resize:function(){if(this.is_loaded){return}return setTimeout($j.proxy(this._resize,this),100)},_get_progressive_url:function(e,d){var f,a,c,b;b=this.active_user;e=e.substring(0,3).replace("rtf","doc").replace("pps","ppt");c=URI.parse(d);a=false;if(e==="doc"&&b.progressive_previews_doc){}else{if(e==="ppt"&&b.progressive_previews_ppt){f="private_progressive_viewer";a=true}else{if(e==="xls"&&b.progressive_previews_xls){if(b.xls_edit){f="xls/edit"}else{f="xls/preview"}}}}if(f){if(a){c.setAuthority(Constants.WEBSERVER)}else{c.setAuthority(c.getAuthority().replace("dl-web","dl-doc"))}c.setPath(c.getPath().replace("/get/","/"+f+"/"))}c=c.updateQuery({get_preview:1});return c},_preview_is_progressive:function(b){var a;b=b.substring(0,3).replace("rtf","doc").replace("pps","ppt");a=this.active_user;return(b==="doc"&&a.progressive_previews_doc)||(b==="ppt"&&a.progressive_previews_ppt)||(b==="xls"&&a.progressive_previews_xls)},_preview_progressive_try:function(a){if(!this._preview_is_progressive(a)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}a=a.substring(0,3).replace("rtf","doc").replace("pps","ppt");return this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&(a==="ppt"||a==="pps")&&this.active_user.progressive_previews_ppt_try_failed},_set_previews_sandbox_params:function(b,a){b=b.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(b!=="xls"){return""}else{return null}},_render_preview:function(b){var g,c,d,f,a,e;if(b==null){b=false}if(b){this._remove_loading(false)}f=$j("#file-viewer .preview");if(this.file.htmlified_link){d=$j("<iframe/>",{src:this.file.htmlified_link});f.append(d);return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){g=this._get_extension(this.file.filename);a=this._get_progressive_url(g,this.file.href);if(this._preview_is_progressive(g)){d=$j("<iframe/>",{src:a.toString(),allowfullscreen:"",type:"application/pdf"});f.append(d)}else{if(this.active_user.inline_commenting){$j("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});a.setAuthority(a.getAuthority().replace("dl-web","dl-doc"));a.setPath(a.getPath().replace("/get/","/dochax_private_commentless_preview/"));c=a.toString();a=URI.parse(Constants.static_url_pdfjs_hack_viewer);a.setQuery({file:c})}else{if(Constants.PDF_PREVIEW_MODE==="pdf-js"){c=a.toString();a=URI.parse(Constants.static_url_pdfjs_viewer);a.setQuery({file:c})}}e=String(a.updateQuery(Constants.UID_PARAM_NAME,this.active_user));d=$j("<iframe/>",{src:e,type:"application/pdf"});f.append(d)}return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){d=$j("<iframe/>",{src:this.file.href,sandbox:""});f.append(d);return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){a=this._get_progressive_url("xls",this.file.href);d=$j("<iframe/>",{src:a,type:"application/pdf"});this._set_previews_sandbox_params("xls",d);f.append(d);return d.on("load",this._remove_loading)}}}}},post_preview_message:function(i){var h,e,f,j,b,a,d,g,c;f=$j("#file-viewer .preview iframe");c=[];for(d=0,g=f.length;d<g;d++){e=f[d];a=e.src;b="://";j=a.indexOf(b);if(j===-1){h=a.indexOf("/")}else{h=a.indexOf("/",j+b.length)}if(h!==-1){a=a.substring(0,h)}c.push(e.contentWindow.postMessage(i,a))}return c},notify_preview_sfj:function(){return FileViewer.post_preview_message('{"action":"notify_sfj"}')},_listen:function(){var b,a,c;b=$j("#file-viewer");b.on("click",$j.proxy(this._hide,this));b.find("#file-viewer-container").on("click",function(d){return d.stopPropagation()});b.find(".close-img-button").on("click",$j.proxy(this._hide,this));if(this.in_browse){this.sfj_callback_handle=Browse.add_subscribe_sfj_callback(FileViewer.notify_preview_sfj)}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,$j.proxy(this._hide,this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){b.find(".share-button").on("click",$j.proxy(this._share,this));c=(function(d){return function(f){if(d.file.fq_path.toLowerCase()===f.memo.fq_path.toLowerCase()){d.file.tkey=f.memo.tkey;return d._show_more_button()}}})(this);a=(function(d){return function(f){if(d.file.tkey===f.memo.token){d.file.tkey=null;return d._hide_more_button()}}})(this);this.share_link_callback=c.bind(this);this.remove_link_callback=a.bind(this);document.observe(FileEvents.LINKS_ADD,this.share_link_callback);document.observe(FileEvents.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){b.find(".share-button").on("click",$j.proxy(this._share,this))}}$j(window).on("resize",$j.proxy(this._resize,this));this.preview_lock_listener=function(i){var h,f,g,d;f={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true,"https://dl-doc.dropboxusercontent.com":true,"https://dl.dropboxusercontent.com":true,"https://www.dropboxstatic.com":true};if(!(typeof Constants!=="undefined"&&Constants!==null?Constants.IS_PROD:void 0)){f["https://block-dbdev.dev.corp.dropbox.com"]=true}if(f[i.origin]){g={};try{g=JSON.parse(i.data);h=g.action}catch(j){d=j;h=i.data}switch(h){case"lock_preview":return FileViewer.preview_locked=true;case"unlock_preview":return FileViewer.preview_locked=false;case"toggle_preview_lock":return FileViewer.preview_locked=!FileViewer.preview_locked;case"hide_iframe":return FileViewer._hide();case"loaded":return FileViewer.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return FileViewer._handle_page_rendered(g.stats)}}};window.addEventListener("message",this.preview_lock_listener,false);return window.onbeforeunload=function(d){if(FileViewer.preview_locked){return""}else{return void 0}}},_unlisten:function(){var a;a=$j("#file-viewer");a.off("click",$j.proxy(this._hide,this));a.find("#file-viewer-container").off("click",function(b){return b.stopPropagation()});a.find(".close-img-button").off("click",$j.proxy(this._hide,this));if(this.modal_type===this._MODAL_PREVIEW){a.find(".share-button").off("click",$j.proxy(this._share,this));a.find(".download-button").off("click");$j(document).off("click",FreshDropdown.hide_all);document.stopObserving(FileEvents.LINKS_ADD,this.share_link_callback);document.stopObserving(FileEvents.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){a.find(".share-button").off("click",$j.proxy(this._share,this))}}$j(window).off("resize",$j.proxy(this._resize,this));key.setScope(this.prev_scope);if(this.in_browse){Browse.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(c){var b,a;b=$j("#file-viewer");a=b.find("#file-viewer-container").height()-(b.find(".title-bar").height()+1);b.find(".preview").height(a);return b.trigger("height-resize",{height:a})},_share:function(a){ShmodelUILogger.log("via-browse-file-viewer");a.preventDefault();return SharingShmodel.shmodel(this.file.fq_path,"file_viewer")},_hide:function(){var c,a,b;if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this.in_browse){BrowseSelection.set_selected_files(this.file)}dom.scroll_unlock_document();a=$j("#file-viewer");a.trigger("db:filepreview:close");if(typeof UnityFeatures!=="undefined"&&UnityFeatures!==null){b=_("Download");c=a.find(".download-button");c.text(b);c.off("click")}this._hide_more_button();a.hide().removeClass("has-preview").removeClass("no-preview");a.find(".preview").empty();a.find(".file-thumbnail img").attr({src:""});a.find(".title-bar .filename").text("");a.attr({"class":""});this._unlisten();this._remove_loading();this.last_file=this.file;this.file=null;this.preview_locked=false;window.removeEventListener("message",this.preview_lock_listener);this.shown=false;return this.is_loaded=false},_handle_page_rendered:function(d){var a,c,e,f,b;if(!this._first_render_completed){a={total_time:Date.now()-this._start_time,file_ext:FilePath.file_extension_for_logging(this.file.filename)};for(f=0,b=d.length;f<b;f++){e=d[f];c=(function(){switch(e.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();a[c]=e.end-e.start}analytics.UserActivityLogger.log("web","file_view_first_page_rendered",JSON.stringify(a));return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._hide()}};var Index2;Index2={init:function(i,e){var g,b,j,f,a,d,c,h;PasswordStrengthWatcher.watch("#password-field");if(e){$j("#sign-in").on("click",function(p){var k,n,m,l,o;p.preventDefault();m=$j("#sign-in-form");Modal.show(_("Sign in"),m[0],false,false,416,false,"sign-in-modal");n=m.find("#login_email");n.focus();return new SsoLoginChecks(k=n,o=function(){m.find("#password-field").hide();m.find("#remember-me").hide();m.find("#login_submit").val(_("Continue"));m.find("#forgot_password_link").hide();return m.find("#sso_description_footer").show()},l=function(){m.find("#password-field").show();m.find("#remember-me").show();m.find("#login_submit").val(_("Sign in"));m.find("#forgot_password_link").show();return m.find("#sso_description_footer").hide()})})}g=function(){if(!$j("#signup-form").hasClass("form_shown")){return $j.when($j("#register-partial-container").animate({height:251},{easing:"easeInOutCubic",duration:500}).promise(),$j("#signup-form").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){$j("#signup-form").addClass("form_shown");return $j("#register-partial input").filter(":visible").first().focus()})}};if(!i){$j("#register-submit").on("click",function(k){if(!$j("#signup-form").hasClass("form_shown")){k.preventDefault();return g()}});Index2.animate()}else{$j(".photo").show();$j("#register-partial input").filter(":visible").first().focus()}$j(".buttons .freshbutton-blue").on("click",function(k){k.preventDefault();$j("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:g});return false});$j("#learn-more").on("click",function(k){k.preventDefault();$j("html, body").animate({scrollTop:$j("#divider").offset().top},{queue:false,duration:500});return false});if(Cookies.are_enabled()){analytics.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{Notify.error(_("Please enable browser-cookies to use the Dropbox website."))}a=["#devices-background","#register-submit","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];d=function(k){return $j(k).on("click",function(){return analytics.WebMiscActivityLogger.log("index_page",{event_name:"click",id:k})})};for(c=0,h=a.length;c<h;c++){b=a[c];d(b)}f=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];j={};return $j(window).scroll(function(){var q,r,p,n,m,o,l,k;k=[];for(o=0,l=f.length;o<l;o++){p=f[o];if($j(p).length&&!j[p]){r=$j(window).scrollTop();q=r+$j(window).outerHeight();m=$j(p).offset().top;n=m+$j(p).outerHeight();if(n<=q){analytics.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:p});k.push(j[p]=true)}else{k.push(void 0)}}else{k.push(void 0)}}return k})},_animate_points:function(g,h,k,b,m,f,a){var d,c,e,l;if(a==null){a=0}a=Math.min(Math.max(a,0),1);e=f(a);l=[(function(){var n,j,i;i=[];for(d=n=0,j=h.length;0<=j?n<j:n>j;d=0<=j?++n:--n){i.push([(function(){var p,o;o=[];for(c=p=0;p<2;c=++p){o.push(h[d][c]+(k[d][c]-h[d][c])*e)}return o})()])}return i})()];g.attr("points",Index2.points_array_to_str(l));if(a>=1){return m.resolve()}else{return setTimeout(function(){return Index2._animate_points(g,h,k,b,m,f,a+(10/b))},10)}},animate_points:function(b,g,f,c,e,d){var a;if(d==null){d=jQuery.easing.linear}a=$j.Deferred();Index2._animate_points(b,g,f,c,a,d);return a.done(function(){return typeof e==="function"?e():void 0}).promise()},animate_hide_rects:function(b,f,h){var a,c,g,e,d;a=$j.Deferred().resolve().promise();g=function(j){var o,l,n,k,m;k=$j(b[j]);o=Index2.points_str_to_array(k.attr("points"));m=[o[1],o[1],o[2],o[2]];l=Index2.inverse(jQuery.easing.linear);n=f*(l((j+1)/b.length)-l(j/b.length));return a=a.then(function(){return Index2.animate_points(k,o,m,n)})};for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){g(c)}return a.done(function(){return typeof h==="function"?h():void 0}).promise()},animate_delay:function(b){var a;a=$j.Deferred();setTimeout(a.resolve,b);return a.promise()},animate:function(){return $j.Deferred().resolve().promise().then(function(){return Index2.animate_docs()}).then(function(){return Index2.animate_graphs()}).then(function(){return Index2.animate_photos()})},inverse:function(b,a){if(a==null){a=0.000001}return function(f){var d,e,c;e=0;d=1;while(d-e>a){c=(e+d)/2;if(b(c)<f){e=c}else{d=c}}return e}},points_str_to_array:function(g){var c,f,e,b,d,a;d=g.split(" ");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];a.push((function(){var k,i,h,j;h=f.split(",");j=[];for(k=0,i=h.length;k<i;k++){c=h[k];j.push(parseFloat(c))}return j})())}return a},points_array_to_str:function(b){var a;return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push(a.join(","))}return c})()).join(" ")},animate_docs:function(){var g,a,d,c,f,b,e;b=[[5,6],[177,1],[184,157],[13,180]];a="";for(f=e=0.475;e<=0.625;f=e+=0.05){g=f+0.05;d=[[b[0][0]+(b[3][0]-b[0][0])*f,b[0][1]+(b[3][1]-b[0][1])*f],[b[1][0]+(b[2][0]-b[1][0])*f,b[1][1]+(b[2][1]-b[1][1])*f],[b[1][0]+(b[2][0]-b[1][0])*g,b[1][1]+(b[2][1]-b[1][1])*g],[b[0][0]+(b[3][0]-b[0][0])*g,b[0][1]+(b[3][1]-b[0][1])*g]];d=Index2.points_array_to_str(d);a+="<polygon points='"+d+"' style='fill:#f5f9fc;stroke:none;' />"}c=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+a+"\n</svg>");return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".comp.doc").append(c);return $j(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return Index2.animate_hide_rects(c.find("polygon"),2500,c.remove)}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return Index2.animate_delay(1500)}).then(function(){return $j(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var b,a;b=[[83,98],[158,37],[241,77],[171,145]];a=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');a.find("polygon").attr("points",Index2.points_array_to_str(b));return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".tablet.graph .graph-grid").hide();$j(".tablet.graph").append(a);return $j(".tablet.graph").show("fade",{},500).promise()}).then(function(){var c;c=[b[0],b[1],b[1],b[0]];return Index2.animate_points(a.find("polygon"),b,c,600,a.remove)}).then(function(){if(!Browser.msie_version_at_most(8)){return $j(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return Index2.animate_delay(2000)}).then(function(){return $j(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});$j(".phone.photo").show();return $j.when((function(){if(!Browser.msie_version_at_most(8)){return $j(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return $j.Deferred().resolve().promise().then(function(){return $j(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return Index2.animate_delay(750)}).then(function(){return $j(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var PasswordStrengthWatcher;PasswordStrengthWatcher={watch:function(h){var d,b,f,a,g,e,c;h=$j(h);d=_("Good passwords are hard to guess. Use uncommon words or inside jokes, non-standard uPPercasing, creative spelllling, and non-obvious numbers and symbols.");b=$j('<div class="db-password-bubble db-left-arrow">\n  <div class="db-arrow-border" />\n  <div class="db-arrow" />\n  <div class="password-bubble-title"></div>\n  <div class="password-bubble-desc">'+d+"</div>\n</div>").hide();e=function(){var i;i=$j(window).width()-($j("#password-field").offset().left+$j("#password-field").outerWidth())-40;b.width(Math.min(Math.max(120,i),160));return DbBubble.position(b,h,"right+4px")};g=$j('<div class="db-password-meter"/>').append((function(){var j,i;i=[];for(f=j=0;j<4;f=++j){i.push($j('<div class="db-password-dot"/>'))}return i})()).hover((function(){b.show();return e()}),(function(){return b.hide()}));if(Browser.msie_version_at_most(9)){g.css("background-color","white")}h.append(b).append(g);a="";c=(function(i){return function(){var k,m,l,j;k=h.find("input").val();if(a===k){return}a=k;if(k==="correcthorsebatterystaple"||k==="Tr0ub4dour&3"||k==="Tr0ub4dor&3"){m=0;l=_("lol",{comment:"a pithy phrase used to indicate something was funny"});$j(".password-bubble-title").text(l);if(k==="correcthorsebatterystaple"){$j(".password-bubble-desc").text(_("Whoa there, don't take advice from a webcomic too literally ;)",{comment:"Displayed upon selecting a particular password from a comic"}))}else{$j(".password-bubble-desc").text(_("Guess again",{comment:"Select another password"}))}}else{j=["",_("Weak"),_("So-so"),_("Good"),_("Great!")];m=i.score(k);l=j[m];$j(".password-bubble-title").text(l);$j(".password-bubble-desc").text(d)}e();return g.find("div").css("background-color","#cce6f9").slice(4-m,4).css("background-color","#4093e0")}})(this);return setInterval(c,200)},get_user_inputs:function(){var b,a;a=["dropbox"];return a.concat((function(){var f,d,e,c;e=$j("#fname, #lname, #email");c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push($j(b).val())}return c})())},score:function(a){if(!(window.zxcvbn&&a)){return 0}return Math.max(1,zxcvbn(a,this.get_user_inputs()).score)}};var NotificationUIButton,UserNotifier,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var b,c,a;this.refresh_feed();$j("#event-feed-container").scroll(function(){if(UserNotifier._has_more){if(UserNotifier._scroller_within_offset_to_bottom(UserNotifier.SCROLLING_OFFSET)){return UserNotifier._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));$j("#event-feed").on("click",this._mouseclick.bind(this));a=[];for(c in NOTCLIENTS){b=NOTCLIENTS[c];a.push(this._subscribe_user(b))}return a},refresh_feed:function(a,b){var d,e,c;c=(function(f){return function(h){var k,i,j,g;f._unread_count=h.unread_count;f._notifications=h.notifications;if(h.meta_notification){i=h.meta_notification;j=f._identifier(i);if(j!==f._get_last_acked_meta_not_id()){f._unread_count++}f._current_meta_not_id=j;f._notifications.push(i)}f._has_acked=false;f._notifications.sort(f._sort_key);f._append_event_rows(true);f.update_jewel_ui(f._unread_count);if((a!=null)&&(b!=null)){g=a.get_user_id();k=h.latest_nid[g];a.handler_success(b,{nid:h.latest_nid[g]})}if(Sharing){return Sharing.refresh_inbox_counts()}}})(this);e=(function(f){return function(){return f._is_retrieving_feed=false}})(this);d=(function(f){return function(){var g;f._is_retrieving_feed=true;g={count:f.MAX_ROWS_TO_RETRIEVE};return new $j.ajax("/web/notifications/retrieve",{data:g,dataType:"json",type:"POST",success:c,error:function(){if((a!=null)&&(b!=null)){return a.handler_failure(b)}},complete:e})}})(this);return d()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new $j.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(a){return function(d){var e,g,f,c,b;b=[];for(f=0,c=d.length;f<c;f++){g=d[f];e=a._identifier(g);a._acked_ids[e]=true;b.push(a._append_event_rows())}return b}})(this)});return this._has_acked=true}},update_jewel_ui:function(a){$j("#new-notification-count").text(a).toggleClass("show",a>0);if(a>0){$j(".notifications-bell").addClass("shake")}return setTimeout((function(){return $j(".notifications-bell").removeClass("shake")}),500)},scrolling:function(a){var b;if(a.originalEvent){a=a.originalEvent}b=a.detail?a.detail*(-40):a.wheelDelta;if(!this._has_more&&b<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(a)}else{if(b>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(a)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(a){if(typeof a.preventDefault==="function"){a.preventDefault()}return a.returnValue=false},_subscribe_user:function(a){var b;return b=a.subscribe_user({name:"NotificationFeedUpdater",handler:(function(c){return function(){return c.refresh_feed(a,b)}})(this)})},_append_event_rows:function(j){var a,n,q,c,l,h,k,i,g,m,b,e,p,d,o,f;if(j==null){j=false}if(j){$j("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}m=$j(".feed-row").size();n=[];f=this._notifications;for(k=d=0,o=f.length;d<o;k=++d){g=f[k];if(m>=this._num_event_rows){break}l=this._identifier(g);if(l in this._shown){continue}this._shown[l]=true;e=g.status;c=$j(g.notification_div);$j("#event-feed").append(c);m++;h=c.find("img").get(0);if(h){a=$j(h);q=a.attr("data-src");if(q){if(this._thumb_cache[q]){i=this._thumb_cache[q];a.attr("src",i);if(!i.endsWith(Sprite.SPACER)){this._add_thumbnail_frame(a)}}else{if(!(q in this._thumb_cache)){this._thumb_cache[q]=false;p=g.user_id;a.data("uid",p);a.data("not-identifier",l);n.push($(h))}}}}if(!c.hasClass("feed-row")){c=c.find(".feed-row")}if(g.type_id===Constants.NOTIFICATION_TYPE_META){c.addClass("meta-feed");if((!(l in this._acked_ids))&&(l===this._get_last_acked_meta_not_id())){c.addClass("read")}}if(e===this.USER_NOTIFICATION_STATUS_INVISIBLE){c.addClass("invisible");if(l in this._acked_ids){delete this._acked_ids[l]}}if(e===this.USER_NOTIFICATION_STATUS_READ){if(!(l in this._acked_ids)){c.addClass("read")}}}b=(function(r){return function(v){var t,s,u;if(!v.src.endsWith(Sprite.SPACER)){t=$j(v);r._add_thumbnail_frame(t);l=t.data("not-identifier");u=t.attr("data-src");s=t.attr("src");return r._thumb_cache[u]=s}}})(this);LegacyBatchThumbLoader.batch_load_thumbs(n,this.THUMBS_BATCH_SIZE,b);this._has_more=this._num_event_rows<this._notifications.length;if($j(".feed-row").length===0){return $j("#event-feed-container").addClass("empty")}else{return $j("#event-feed-container").removeClass("empty")}},_identifier:function(a){return""+a.user_id+" "+a.type_id+" "+a.target_object_key},_sort_key:function(d,c){if(d.sticky&&!c.sticky){return -1}if(c.sticky&&!d.sticky){return 1}if(d.status===UserNotifier.USER_NOTIFICATION_STATUS_UNREAD&&c.status!==UserNotifier.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(c.status===UserNotifier.USER_NOTIFICATION_STATUS_UNREAD&&d.status!==UserNotifier.USER_NOTIFICATION_STATUS_UNREAD){return 1}return c.feed_time-d.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(a){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,a)}},_add_thumbnail_frame:function(a){$j(a).addClass("thumbnail");return $j(a).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(c){var b,a;b=$j(c.target);if(b.is("a")){if(b.hasClass("view")){c.preventDefault();a=b.attr("data-mount");return window.open(a)}}},_scroller_within_offset_to_bottom:function(b){var a;a=$("event-feed-container");return a.scrollTop+a.offsetHeight+b>=a.scrollHeight}};NotificationUIButton=(function(b){__extends(a,b);a.prototype.selector=function(){return".notification-button"};function a(){this.clear=__bind(this.clear,this);this.active=__bind(this.active,this);this._clear_sticky_notification_on_popover_close=__bind(this._clear_sticky_notification_on_popover_close,this);a.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}a.prototype._clear_sticky_notification_on_popover_close=function(){if(!$j(this.selector())[0].hasClassName("active")){return UserNotifier.clear_cached_client_states()}};a.prototype.active=function(c,f){var d;d=c.target.hasClassName("feed-row")?c.target:$(c.target).up(".feed-row");if(d){if(!d.hasClassName("clickable")){return}}a.__super__.active.call(this,c,f);return this._clear_sticky_notification_on_popover_close()};a.prototype.clear=function(c){a.__super__.clear.call(this,c);return this._clear_sticky_notification_on_popover_close()};return a})(UIButton);var BetaLocaleNotificationBar,ExpiredCCNotificationBar,UnsupportedBrowser;UnsupportedBrowser={init:function(){return $j("#unsupported-browser-dismiss").on("click",function(a){a.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};ExpiredCCNotificationBar={init:function(a){return $j(".expired-dismiss").on("click",function(b){b.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:a}})})}};BetaLocaleNotificationBar={init:function(a){return $j(".beta-locale-dismiss").on("click",function(b){b.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:a}})})}};window.viewer=Viewer.get_viewer();var handler,listener,_i,_j,_len,_len1,_ref,_ref1;if(!Constants.is_test){$j(Timezone.check_timezone)}if(window._document_observe_listeners){_ref=window._document_observe_listeners;for(_i=0,_len=_ref.length;_i<_len;_i++){listener=_ref[_i];if(document.loaded){listener.func()}else{document.observe(listener.event,listener.func)}}}if(window._jquery_ready_handlers){_ref1=window._jquery_ready_handlers;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){handler=_ref1[_j];$j(handler)}}window.LoadedJsSuccessfully=true;$j(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});